This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.agents/skills/supabase-postgres-best-practices/AGENTS.md
.agents/skills/supabase-postgres-best-practices/references/advanced-full-text-search.md
.agents/skills/supabase-postgres-best-practices/references/advanced-jsonb-indexing.md
.agents/skills/supabase-postgres-best-practices/references/conn-idle-timeout.md
.agents/skills/supabase-postgres-best-practices/references/conn-limits.md
.agents/skills/supabase-postgres-best-practices/references/conn-pooling.md
.agents/skills/supabase-postgres-best-practices/references/conn-prepared-statements.md
.agents/skills/supabase-postgres-best-practices/references/data-batch-inserts.md
.agents/skills/supabase-postgres-best-practices/references/data-n-plus-one.md
.agents/skills/supabase-postgres-best-practices/references/data-pagination.md
.agents/skills/supabase-postgres-best-practices/references/data-upsert.md
.agents/skills/supabase-postgres-best-practices/references/lock-advisory.md
.agents/skills/supabase-postgres-best-practices/references/lock-deadlock-prevention.md
.agents/skills/supabase-postgres-best-practices/references/lock-short-transactions.md
.agents/skills/supabase-postgres-best-practices/references/lock-skip-locked.md
.agents/skills/supabase-postgres-best-practices/references/monitor-explain-analyze.md
.agents/skills/supabase-postgres-best-practices/references/monitor-pg-stat-statements.md
.agents/skills/supabase-postgres-best-practices/references/monitor-vacuum-analyze.md
.agents/skills/supabase-postgres-best-practices/references/query-composite-indexes.md
.agents/skills/supabase-postgres-best-practices/references/query-covering-indexes.md
.agents/skills/supabase-postgres-best-practices/references/query-index-types.md
.agents/skills/supabase-postgres-best-practices/references/query-missing-indexes.md
.agents/skills/supabase-postgres-best-practices/references/query-partial-indexes.md
.agents/skills/supabase-postgres-best-practices/references/schema-data-types.md
.agents/skills/supabase-postgres-best-practices/references/schema-foreign-key-indexes.md
.agents/skills/supabase-postgres-best-practices/references/schema-lowercase-identifiers.md
.agents/skills/supabase-postgres-best-practices/references/schema-partitioning.md
.agents/skills/supabase-postgres-best-practices/references/schema-primary-keys.md
.agents/skills/supabase-postgres-best-practices/references/security-privileges.md
.agents/skills/supabase-postgres-best-practices/references/security-rls-basics.md
.agents/skills/supabase-postgres-best-practices/references/security-rls-performance.md
.agents/skills/supabase-postgres-best-practices/SKILL.md
.gitignore
eslint.config.mjs
migration_add_amount_received.sql
migration_add_godown.sql
migration_add_proof_url.sql
migration_apply_report_fixes.sql
migration_create_cylinders.sql
migration_create_daily_rates.sql
migration_disable_triggers.sql
migration_final_cleanup.sql
migration_final_schema_fix.sql
migration_fix_auth_schema.sql
migration_fix_constraints.sql
migration_fix_cylinders_rls.sql
migration_fix_driver_access.sql
migration_fix_drivers.sql
migration_fix_wallets_rls.sql
migration_init_wallets.sql
migration_standardize_emails.sql
migration_trip_returns.sql
migration_update_cylinder_type.sql
migration_wallets_handovers.sql
next.config.ts
package.json
postcss.config.mjs
public/file.svg
public/globe.svg
public/next.svg
public/vercel.svg
public/window.svg
README_SETUP.md
README.md
scripts/audit_users.js
src/app/(dashboard)/admin/approvals/page.tsx
src/app/(dashboard)/admin/customers/[id]/page.tsx
src/app/(dashboard)/admin/customers/page.tsx
src/app/(dashboard)/admin/cylinders/page.tsx
src/app/(dashboard)/admin/expenses/page.tsx
src/app/(dashboard)/admin/finance/page.tsx
src/app/(dashboard)/admin/layout.tsx
src/app/(dashboard)/admin/orders/new/page.tsx
src/app/(dashboard)/admin/orders/page.tsx
src/app/(dashboard)/admin/page.tsx
src/app/(dashboard)/admin/settings/page.tsx
src/app/(dashboard)/admin/users/page.tsx
src/app/(dashboard)/driver/expenses/page.tsx
src/app/(dashboard)/driver/history/page.tsx
src/app/(dashboard)/driver/layout.tsx
src/app/(dashboard)/driver/orders/page.tsx
src/app/(dashboard)/driver/page.tsx
src/app/(dashboard)/driver/profile/page.tsx
src/app/(dashboard)/recovery/history/page.tsx
src/app/(dashboard)/recovery/loading.tsx
src/app/(dashboard)/recovery/page.tsx
src/app/actions/adminActions.ts
src/app/actions/adminExpenseActions.ts
src/app/actions/authActions.ts
src/app/actions/createEmployee.ts
src/app/actions/customerActions.ts
src/app/actions/cylinderActions.ts
src/app/actions/driverActions.ts
src/app/actions/driverExpenseActions.ts
src/app/actions/financeActions.ts
src/app/actions/manageUser.ts
src/app/actions/orderActions.ts
src/app/actions/recoveryActions.ts
src/app/actions/settingsActions.ts
src/app/actions/superAdminActions.ts
src/app/auth/callback/route.ts
src/app/favicon.ico
src/app/globals.css
src/app/health/page.tsx
src/app/invoice/[id]/page.tsx
src/app/layout.tsx
src/app/login/page.tsx
src/app/page.tsx
src/app/signup/page.tsx
src/app/super-admin/page.tsx
src/components/admin/AdminSidebar.tsx
src/components/admin/customers/AddCustomerModal.tsx
src/components/admin/customers/CustomerImportModal.tsx
src/components/admin/customers/EditCustomerModal.tsx
src/components/admin/DashboardChart.tsx
src/components/admin/inventory/PlantOperationsModal.tsx
src/components/admin/inventory/StockImportModal.tsx
src/components/admin/QRCodeGenerator.tsx
src/components/admin/TransactionModal.tsx
src/components/BottomNav.tsx
src/components/LogoutBtn.tsx
src/components/recovery/CollectionDrawer.tsx
src/components/recovery/CustomerDebtCard.tsx
src/components/recovery/EmptyRecoveryState.tsx
src/components/recovery/HandoverDialog.tsx
src/components/recovery/LogoutButton.tsx
src/components/recovery/RecoveryList.tsx
src/components/recovery/RecoverySkeleton.tsx
src/components/recovery/RecoveryStats.tsx
src/components/ReturnCheckInModal.tsx
src/components/ui/alert-dialog.tsx
src/components/ui/badge.tsx
src/components/ui/button.tsx
src/components/ui/calendar.tsx
src/components/ui/card.tsx
src/components/ui/dialog.tsx
src/components/ui/drawer.tsx
src/components/ui/dropdown-menu.tsx
src/components/ui/form.tsx
src/components/ui/IconBtn.tsx
src/components/ui/input.tsx
src/components/ui/label.tsx
src/components/ui/popover.tsx
src/components/ui/radio-group.tsx
src/components/ui/select.tsx
src/lib/shifts.ts
src/lib/utils.ts
src/middleware.ts
src/types/database.types.ts
src/utils/supabase/admin.ts
src/utils/supabase/client.ts
src/utils/supabase/middleware.ts
src/utils/supabase/server.ts
supabase/migrations/20250101000000_saas_baseline.sql
supabase/migrations/20250101000001_fix_auth_trigger.sql
supabase/migrations/20250101000002_fix_cylinder_schema.sql
supabase/migrations/20250101000003_secure_tenant_isolation.sql
supabase/migrations/20250101000004_iron_dome_rls.sql
supabase/migrations/20250102000001_add_created_by_to_orders.sql
supabase/migrations/20260102000200_reset_sequence.sql
supabase/migrations/20260103000000_add_handover_flow.sql
supabase/migrations/20260104000000_add_org_settings.sql
supabase/migrations/20260104000001_customer_ledger_upgrade.sql
supabase/migrations/20260104000002_customer_dashboard_upgrade.sql
supabase/migrations/20260105_auto_update_last_order.sql
supabase/migrations/20260105_handover_rpc.sql
supabase/migrations/20260109120000_fix_expenses_fk.sql
supabase/migrations/20260115000000_remove_wallet_deduction.sql
supabase/migrations/20260117000000_company_treasury.sql
supabase/migrations/20260117100000_expand_ledger.sql
supabase/migrations/20260118110000_fix_handle_new_user.sql
supabase/migrations/20260118120000_verify_payment_rpc.sql
supabase/migrations/20260126000000_critical_fixes.sql
supabase/migrations/20260127000000_fix_users_rls.sql
supabase/migrations/20260128000000_audit_performance_fixes.sql
supabase/migrations/20260128000001_fix_multi_tenancy_critical.sql
supabase/migrations/20260128000002_fix_profiles_rls.sql
tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".agents/skills/supabase-postgres-best-practices/AGENTS.md">
# Supabase Postgres Best Practices

**Version 1.1.0**
Supabase
January 2026

> This document is optimized for AI agents and LLMs. Rules are prioritized by performance impact.

---

## Abstract

Comprehensive Postgres performance optimization guide for developers using Supabase and Postgres. Contains performance rules across 8 categories, prioritized by impact from critical (query performance, connection management) to incremental (advanced features). Each rule includes detailed explanations, incorrect vs. correct SQL examples, query plan analysis, and specific performance metrics to guide automated optimization and code generation.

---

## Table of Contents

1. [Query Performance](#query-performance) - **CRITICAL**
   - 1.1 [Add Indexes on WHERE and JOIN Columns](#11-add-indexes-on-where-and-join-columns)
   - 1.2 [Choose the Right Index Type for Your Data](#12-choose-the-right-index-type-for-your-data)
   - 1.3 [Create Composite Indexes for Multi-Column Queries](#13-create-composite-indexes-for-multi-column-queries)
   - 1.4 [Use Covering Indexes to Avoid Table Lookups](#14-use-covering-indexes-to-avoid-table-lookups)
   - 1.5 [Use Partial Indexes for Filtered Queries](#15-use-partial-indexes-for-filtered-queries)

2. [Connection Management](#connection-management) - **CRITICAL**
   - 2.1 [Configure Idle Connection Timeouts](#21-configure-idle-connection-timeouts)
   - 2.2 [Set Appropriate Connection Limits](#22-set-appropriate-connection-limits)
   - 2.3 [Use Connection Pooling for All Applications](#23-use-connection-pooling-for-all-applications)
   - 2.4 [Use Prepared Statements Correctly with Pooling](#24-use-prepared-statements-correctly-with-pooling)

3. [Security & RLS](#security-rls) - **CRITICAL**
   - 3.1 [Apply Principle of Least Privilege](#31-apply-principle-of-least-privilege)
   - 3.2 [Enable Row Level Security for Multi-Tenant Data](#32-enable-row-level-security-for-multi-tenant-data)
   - 3.3 [Optimize RLS Policies for Performance](#33-optimize-rls-policies-for-performance)

4. [Schema Design](#schema-design) - **HIGH**
   - 4.1 [Choose Appropriate Data Types](#41-choose-appropriate-data-types)
   - 4.2 [Index Foreign Key Columns](#42-index-foreign-key-columns)
   - 4.3 [Partition Large Tables for Better Performance](#43-partition-large-tables-for-better-performance)
   - 4.4 [Select Optimal Primary Key Strategy](#44-select-optimal-primary-key-strategy)
   - 4.5 [Use Lowercase Identifiers for Compatibility](#45-use-lowercase-identifiers-for-compatibility)

5. [Concurrency & Locking](#concurrency-locking) - **MEDIUM-HIGH**
   - 5.1 [Keep Transactions Short to Reduce Lock Contention](#51-keep-transactions-short-to-reduce-lock-contention)
   - 5.2 [Prevent Deadlocks with Consistent Lock Ordering](#52-prevent-deadlocks-with-consistent-lock-ordering)
   - 5.3 [Use Advisory Locks for Application-Level Locking](#53-use-advisory-locks-for-application-level-locking)
   - 5.4 [Use SKIP LOCKED for Non-Blocking Queue Processing](#54-use-skip-locked-for-non-blocking-queue-processing)

6. [Data Access Patterns](#data-access-patterns) - **MEDIUM**
   - 6.1 [Batch INSERT Statements for Bulk Data](#61-batch-insert-statements-for-bulk-data)
   - 6.2 [Eliminate N+1 Queries with Batch Loading](#62-eliminate-n1-queries-with-batch-loading)
   - 6.3 [Use Cursor-Based Pagination Instead of OFFSET](#63-use-cursor-based-pagination-instead-of-offset)
   - 6.4 [Use UPSERT for Insert-or-Update Operations](#64-use-upsert-for-insert-or-update-operations)

7. [Monitoring & Diagnostics](#monitoring-diagnostics) - **LOW-MEDIUM**
   - 7.1 [Enable pg_stat_statements for Query Analysis](#71-enable-pgstatstatements-for-query-analysis)
   - 7.2 [Maintain Table Statistics with VACUUM and ANALYZE](#72-maintain-table-statistics-with-vacuum-and-analyze)
   - 7.3 [Use EXPLAIN ANALYZE to Diagnose Slow Queries](#73-use-explain-analyze-to-diagnose-slow-queries)

8. [Advanced Features](#advanced-features) - **LOW**
   - 8.1 [Index JSONB Columns for Efficient Querying](#81-index-jsonb-columns-for-efficient-querying)
   - 8.2 [Use tsvector for Full-Text Search](#82-use-tsvector-for-full-text-search)

---

## 1. Query Performance

**Impact: CRITICAL**

Slow queries, missing indexes, inefficient query plans. The most common source of Postgres performance issues.

### 1.1 Add Indexes on WHERE and JOIN Columns

**Impact: CRITICAL (100-1000x faster queries on large tables)**

Queries filtering or joining on unindexed columns cause full table scans, which become exponentially slower as tables grow.

**Incorrect (sequential scan on large table):**

```sql
-- No index on customer_id causes full table scan
select * from orders where customer_id = 123;

-- EXPLAIN shows: Seq Scan on orders (cost=0.00..25000.00 rows=100 width=85)
```

**Correct (index scan):**

```sql
-- Create index on frequently filtered column
create index orders_customer_id_idx on orders (customer_id);

select * from orders where customer_id = 123;

-- EXPLAIN shows: Index Scan using orders_customer_id_idx (cost=0.42..8.44 rows=100 width=85)
-- Index the referencing column
create index orders_customer_id_idx on orders (customer_id);

select c.name, o.total
from customers c
join orders o on o.customer_id = c.id;
```

For JOIN columns, always index the foreign key side:

Reference: https://supabase.com/docs/guides/database/query-optimization

---

### 1.2 Choose the Right Index Type for Your Data

**Impact: HIGH (10-100x improvement with correct index type)**

Different index types excel at different query patterns. The default B-tree isn't always optimal.

**Incorrect (B-tree for JSONB containment):**

```sql
-- B-tree cannot optimize containment operators
create index products_attrs_idx on products (attributes);
select * from products where attributes @> '{"color": "red"}';
-- Full table scan - B-tree doesn't support @> operator
```

**Correct (GIN for JSONB):**

```sql
-- GIN supports @>, ?, ?&, ?| operators
create index products_attrs_idx on products using gin (attributes);
select * from products where attributes @> '{"color": "red"}';
-- B-tree (default): =, <, >, BETWEEN, IN, IS NULL
create index users_created_idx on users (created_at);

-- GIN: arrays, JSONB, full-text search
create index posts_tags_idx on posts using gin (tags);

-- BRIN: large time-series tables (10-100x smaller)
create index events_time_idx on events using brin (created_at);

-- Hash: equality-only (slightly faster than B-tree for =)
create index sessions_token_idx on sessions using hash (token);
```

Index type guide:

Reference: https://www.postgresql.org/docs/current/indexes-types.html

---

### 1.3 Create Composite Indexes for Multi-Column Queries

**Impact: HIGH (5-10x faster multi-column queries)**

When queries filter on multiple columns, a composite index is more efficient than separate single-column indexes.

**Incorrect (separate indexes require bitmap scan):**

```sql
-- Two separate indexes
create index orders_status_idx on orders (status);
create index orders_created_idx on orders (created_at);

-- Query must combine both indexes (slower)
select * from orders where status = 'pending' and created_at > '2024-01-01';
```

**Correct (composite index):**

```sql
-- Single composite index (leftmost column first for equality checks)
create index orders_status_created_idx on orders (status, created_at);

-- Query uses one efficient index scan
select * from orders where status = 'pending' and created_at > '2024-01-01';
-- Good: status (=) before created_at (>)
create index idx on orders (status, created_at);

-- Works for: WHERE status = 'pending'
-- Works for: WHERE status = 'pending' AND created_at > '2024-01-01'
-- Does NOT work for: WHERE created_at > '2024-01-01' (leftmost prefix rule)
```

**Column order matters** - place equality columns first, range columns last:

Reference: https://www.postgresql.org/docs/current/indexes-multicolumn.html

---

### 1.4 Use Covering Indexes to Avoid Table Lookups

**Impact: MEDIUM-HIGH (2-5x faster queries by eliminating heap fetches)**

Covering indexes include all columns needed by a query, enabling index-only scans that skip the table entirely.

**Incorrect (index scan + heap fetch):**

```sql
create index users_email_idx on users (email);

-- Must fetch name and created_at from table heap
select email, name, created_at from users where email = 'user@example.com';
```

**Correct (index-only scan with INCLUDE):**

```sql
-- Include non-searchable columns in the index
create index users_email_idx on users (email) include (name, created_at);

-- All columns served from index, no table access needed
select email, name, created_at from users where email = 'user@example.com';
-- Searching by status, but also need customer_id and total
create index orders_status_idx on orders (status) include (customer_id, total);

select status, customer_id, total from orders where status = 'shipped';
```

Use INCLUDE for columns you SELECT but don't filter on:

Reference: https://www.postgresql.org/docs/current/indexes-index-only-scans.html

---

### 1.5 Use Partial Indexes for Filtered Queries

**Impact: HIGH (5-20x smaller indexes, faster writes and queries)**

Partial indexes only include rows matching a WHERE condition, making them smaller and faster when queries consistently filter on the same condition.

**Incorrect (full index includes irrelevant rows):**

```sql
-- Index includes all rows, even soft-deleted ones
create index users_email_idx on users (email);

-- Query always filters active users
select * from users where email = 'user@example.com' and deleted_at is null;
```

**Correct (partial index matches query filter):**

```sql
-- Index only includes active users
create index users_active_email_idx on users (email)
where deleted_at is null;

-- Query uses the smaller, faster index
select * from users where email = 'user@example.com' and deleted_at is null;
-- Only pending orders (status rarely changes once completed)
create index orders_pending_idx on orders (created_at)
where status = 'pending';

-- Only non-null values
create index products_sku_idx on products (sku)
where sku is not null;
```

Common use cases for partial indexes:

Reference: https://www.postgresql.org/docs/current/indexes-partial.html

---

## 2. Connection Management

**Impact: CRITICAL**

Connection pooling, limits, and serverless strategies. Critical for applications with high concurrency or serverless deployments.

### 2.1 Configure Idle Connection Timeouts

**Impact: HIGH (Reclaim 30-50% of connection slots from idle clients)**

Idle connections waste resources. Configure timeouts to automatically reclaim them.

**Incorrect (connections held indefinitely):**

```sql
-- No timeout configured
show idle_in_transaction_session_timeout;  -- 0 (disabled)

-- Connections stay open forever, even when idle
select pid, state, state_change, query
from pg_stat_activity
where state = 'idle in transaction';
-- Shows transactions idle for hours, holding locks
```

**Correct (automatic cleanup of idle connections):**

```ini
-- Terminate connections idle in transaction after 30 seconds
alter system set idle_in_transaction_session_timeout = '30s';

-- Terminate completely idle connections after 10 minutes
alter system set idle_session_timeout = '10min';

-- Reload configuration
select pg_reload_conf();
# pgbouncer.ini
server_idle_timeout = 60
client_idle_timeout = 300
```

For pooled connections, configure at the pooler level:

Reference: https://www.postgresql.org/docs/current/runtime-config-client.html#GUC-IDLE-IN-TRANSACTION-SESSION-TIMEOUT

---

### 2.2 Set Appropriate Connection Limits

**Impact: CRITICAL (Prevent database crashes and memory exhaustion)**

Too many connections exhaust memory and degrade performance. Set limits based on available resources.

**Incorrect (unlimited or excessive connections):**

```sql
-- Default max_connections = 100, but often increased blindly
show max_connections;  -- 500 (way too high for 4GB RAM)

-- Each connection uses 1-3MB RAM
-- 500 connections * 2MB = 1GB just for connections!
-- Out of memory errors under load
```

**Correct (calculate based on resources):**

```sql
-- Formula: max_connections = (RAM in MB / 5MB per connection) - reserved
-- For 4GB RAM: (4096 / 5) - 10 = ~800 theoretical max
-- But practically, 100-200 is better for query performance

-- Recommended settings for 4GB RAM
alter system set max_connections = 100;

-- Also set work_mem appropriately
-- work_mem * max_connections should not exceed 25% of RAM
alter system set work_mem = '8MB';  -- 8MB * 100 = 800MB max
select count(*), state from pg_stat_activity group by state;
```

Monitor connection usage:

Reference: https://supabase.com/docs/guides/platform/performance#connection-management

---

### 2.3 Use Connection Pooling for All Applications

**Impact: CRITICAL (Handle 10-100x more concurrent users)**

Postgres connections are expensive (1-3MB RAM each). Without pooling, applications exhaust connections under load.

**Incorrect (new connection per request):**

```sql
-- Each request creates a new connection
-- Application code: db.connect() per request
-- Result: 500 concurrent users = 500 connections = crashed database

-- Check current connections
select count(*) from pg_stat_activity;  -- 487 connections!
```

**Correct (connection pooling):**

```sql
-- Use a pooler like PgBouncer between app and database
-- Application connects to pooler, pooler reuses a small pool to Postgres

-- Configure pool_size based on: (CPU cores * 2) + spindle_count
-- Example for 4 cores: pool_size = 10

-- Result: 500 concurrent users share 10 actual connections
select count(*) from pg_stat_activity;  -- 10 connections
```

Pool modes:
- **Transaction mode**: connection returned after each transaction (best for most apps)
- **Session mode**: connection held for entire session (needed for prepared statements, temp tables)

Reference: https://supabase.com/docs/guides/database/connecting-to-postgres#connection-pooler

---

### 2.4 Use Prepared Statements Correctly with Pooling

**Impact: HIGH (Avoid prepared statement conflicts in pooled environments)**

Prepared statements are tied to individual database connections. In transaction-mode pooling, connections are shared, causing conflicts.

**Incorrect (named prepared statements with transaction pooling):**

```sql
-- Named prepared statement
prepare get_user as select * from users where id = $1;

-- In transaction mode pooling, next request may get different connection
execute get_user(123);
-- ERROR: prepared statement "get_user" does not exist
```

**Correct (use unnamed statements or session mode):**

```sql
-- Option 1: Use unnamed prepared statements (most ORMs do this automatically)
-- The query is prepared and executed in a single protocol message

-- Option 2: Deallocate after use in transaction mode
prepare get_user as select * from users where id = $1;
execute get_user(123);
deallocate get_user;

-- Option 3: Use session mode pooling (port 5432 vs 6543)
-- Connection is held for entire session, prepared statements persist
-- Many drivers use prepared statements by default
-- Node.js pg: { prepare: false } to disable
-- JDBC: prepareThreshold=0 to disable
```

Check your driver settings:

Reference: https://supabase.com/docs/guides/database/connecting-to-postgres#connection-pool-modes

---

## 3. Security & RLS

**Impact: CRITICAL**

Row-Level Security policies, privilege management, and authentication patterns.

### 3.1 Apply Principle of Least Privilege

**Impact: MEDIUM (Reduced attack surface, better audit trail)**

Grant only the minimum permissions required. Never use superuser for application queries.

**Incorrect (overly broad permissions):**

```sql
-- Application uses superuser connection
-- Or grants ALL to application role
grant all privileges on all tables in schema public to app_user;
grant all privileges on all sequences in schema public to app_user;

-- Any SQL injection becomes catastrophic
-- drop table users; cascades to everything
```

**Correct (minimal, specific grants):**

```sql
-- Create role with no default privileges
create role app_readonly nologin;

-- Grant only SELECT on specific tables
grant usage on schema public to app_readonly;
grant select on public.products, public.categories to app_readonly;

-- Create role for writes with limited scope
create role app_writer nologin;
grant usage on schema public to app_writer;
grant select, insert, update on public.orders to app_writer;
grant usage on sequence orders_id_seq to app_writer;
-- No DELETE permission

-- Login role inherits from these
create role app_user login password 'xxx';
grant app_writer to app_user;
-- Revoke default public access
revoke all on schema public from public;
revoke all on all tables in schema public from public;
```

Revoke public defaults:

Reference: https://supabase.com/blog/postgres-roles-and-privileges

---

### 3.2 Enable Row Level Security for Multi-Tenant Data

**Impact: CRITICAL (Database-enforced tenant isolation, prevent data leaks)**

Row Level Security (RLS) enforces data access at the database level, ensuring users only see their own data.

**Incorrect (application-level filtering only):**

```sql
-- Relying only on application to filter
select * from orders where user_id = $current_user_id;

-- Bug or bypass means all data is exposed!
select * from orders;  -- Returns ALL orders
```

**Correct (database-enforced RLS):**

```sql
-- Enable RLS on the table
alter table orders enable row level security;

-- Create policy for users to see only their orders
create policy orders_user_policy on orders
  for all
  using (user_id = current_setting('app.current_user_id')::bigint);

-- Force RLS even for table owners
alter table orders force row level security;

-- Set user context and query
set app.current_user_id = '123';
select * from orders;  -- Only returns orders for user 123
create policy orders_user_policy on orders
  for all
  to authenticated
  using (user_id = auth.uid());
```

Policy for authenticated role:

Reference: https://supabase.com/docs/guides/database/postgres/row-level-security

---

### 3.3 Optimize RLS Policies for Performance

**Impact: HIGH (5-10x faster RLS queries with proper patterns)**

Poorly written RLS policies can cause severe performance issues. Use subqueries and indexes strategically.

**Incorrect (function called for every row):**

```sql
create policy orders_policy on orders
  using (auth.uid() = user_id);  -- auth.uid() called per row!

-- With 1M rows, auth.uid() is called 1M times
```

**Correct (wrap functions in SELECT):**

```sql
create policy orders_policy on orders
  using ((select auth.uid()) = user_id);  -- Called once, cached

-- 100x+ faster on large tables
-- Create helper function (runs as definer, bypasses RLS)
create or replace function is_team_member(team_id bigint)
returns boolean
language sql
security definer
set search_path = ''
as $$
  select exists (
    select 1 from public.team_members
    where team_id = $1 and user_id = (select auth.uid())
  );
$$;

-- Use in policy (indexed lookup, not per-row check)
create policy team_orders_policy on orders
  using ((select is_team_member(team_id)));
create index orders_user_id_idx on orders (user_id);
```

Use security definer functions for complex checks:
Always add indexes on columns used in RLS policies:

Reference: https://supabase.com/docs/guides/database/postgres/row-level-security#rls-performance-recommendations

---

## 4. Schema Design

**Impact: HIGH**

Table design, index strategies, partitioning, and data type selection. Foundation for long-term performance.

### 4.1 Choose Appropriate Data Types

**Impact: HIGH (50% storage reduction, faster comparisons)**

Using the right data types reduces storage, improves query performance, and prevents bugs.

**Incorrect (wrong data types):**

```sql
create table users (
  id int,                    -- Will overflow at 2.1 billion
  email varchar(255),        -- Unnecessary length limit
  created_at timestamp,      -- Missing timezone info
  is_active varchar(5),      -- String for boolean
  price varchar(20)          -- String for numeric
);
```

**Correct (appropriate data types):**

```sql
create table users (
  id bigint generated always as identity primary key,  -- 9 quintillion max
  email text,                     -- No artificial limit, same performance as varchar
  created_at timestamptz,         -- Always store timezone-aware timestamps
  is_active boolean default true, -- 1 byte vs variable string length
  price numeric(10,2)             -- Exact decimal arithmetic
);
-- IDs: use bigint, not int (future-proofing)
-- Strings: use text, not varchar(n) unless constraint needed
-- Time: use timestamptz, not timestamp
-- Money: use numeric, not float (precision matters)
-- Enums: use text with check constraint or create enum type
```

Key guidelines:

Reference: https://www.postgresql.org/docs/current/datatype.html

---

### 4.2 Index Foreign Key Columns

**Impact: HIGH (10-100x faster JOINs and CASCADE operations)**

Postgres does not automatically index foreign key columns. Missing indexes cause slow JOINs and CASCADE operations.

**Incorrect (unindexed foreign key):**

```sql
create table orders (
  id bigint generated always as identity primary key,
  customer_id bigint references customers(id) on delete cascade,
  total numeric(10,2)
);

-- No index on customer_id!
-- JOINs and ON DELETE CASCADE both require full table scan
select * from orders where customer_id = 123;  -- Seq Scan
delete from customers where id = 123;          -- Locks table, scans all orders
```

**Correct (indexed foreign key):**

```sql
create table orders (
  id bigint generated always as identity primary key,
  customer_id bigint references customers(id) on delete cascade,
  total numeric(10,2)
);

-- Always index the FK column
create index orders_customer_id_idx on orders (customer_id);

-- Now JOINs and cascades are fast
select * from orders where customer_id = 123;  -- Index Scan
delete from customers where id = 123;          -- Uses index, fast cascade
select
  conrelid::regclass as table_name,
  a.attname as fk_column
from pg_constraint c
join pg_attribute a on a.attrelid = c.conrelid and a.attnum = any(c.conkey)
where c.contype = 'f'
  and not exists (
    select 1 from pg_index i
    where i.indrelid = c.conrelid and a.attnum = any(i.indkey)
  );
```

Find missing FK indexes:

Reference: https://www.postgresql.org/docs/current/ddl-constraints.html#DDL-CONSTRAINTS-FK

---

### 4.3 Partition Large Tables for Better Performance

**Impact: MEDIUM-HIGH (5-20x faster queries and maintenance on large tables)**

Partitioning splits a large table into smaller pieces, improving query performance and maintenance operations.

**Incorrect (single large table):**

```sql
create table events (
  id bigint generated always as identity,
  created_at timestamptz,
  data jsonb
);

-- 500M rows, queries scan everything
select * from events where created_at > '2024-01-01';  -- Slow
vacuum events;  -- Takes hours, locks table
```

**Correct (partitioned by time range):**

```sql
create table events (
  id bigint generated always as identity,
  created_at timestamptz not null,
  data jsonb
) partition by range (created_at);

-- Create partitions for each month
create table events_2024_01 partition of events
  for values from ('2024-01-01') to ('2024-02-01');

create table events_2024_02 partition of events
  for values from ('2024-02-01') to ('2024-03-01');

-- Queries only scan relevant partitions
select * from events where created_at > '2024-01-15';  -- Only scans events_2024_01+

-- Drop old data instantly
drop table events_2023_01;  -- Instant vs DELETE taking hours
```

When to partition:
- Tables > 100M rows
- Time-series data with date-based queries
- Need to efficiently drop old data

Reference: https://www.postgresql.org/docs/current/ddl-partitioning.html

---

### 4.4 Select Optimal Primary Key Strategy

**Impact: HIGH (Better index locality, reduced fragmentation)**

Primary key choice affects insert performance, index size, and replication
efficiency.

**Incorrect (problematic PK choices):**

```sql
-- identity is the SQL-standard approach
create table users (
  id serial primary key  -- Works, but IDENTITY is recommended
);

-- Random UUIDs (v4) cause index fragmentation
create table orders (
  id uuid default gen_random_uuid() primary key  -- UUIDv4 = random = scattered inserts
);
```

**Correct (optimal PK strategies):**

```sql
-- Use IDENTITY for sequential IDs (SQL-standard, best for most cases)
create table users (
  id bigint generated always as identity primary key
);

-- For distributed systems needing UUIDs, use UUIDv7 (time-ordered)
-- Requires pg_uuidv7 extension: create extension pg_uuidv7;
create table orders (
  id uuid default uuid_generate_v7() primary key  -- Time-ordered, no fragmentation
);

-- Alternative: time-prefixed IDs for sortable, distributed IDs (no extension needed)
create table events (
  id text default concat(
    to_char(now() at time zone 'utc', 'YYYYMMDDHH24MISSMS'),
    gen_random_uuid()::text
  ) primary key
);
```

Guidelines:
- Single database: `bigint identity` (sequential, 8 bytes, SQL-standard)
- Distributed/exposed IDs: UUIDv7 (requires pg_uuidv7) or ULID (time-ordered, no
  fragmentation)
- `serial` works but `identity` is SQL-standard and preferred for new
  applications
- Avoid random UUIDs (v4) as primary keys on large tables (causes index
  fragmentation)
[Identity Columns](https://www.postgresql.org/docs/current/sql-createtable.html#SQL-CREATETABLE-PARMS-GENERATED-IDENTITY)

---

### 4.5 Use Lowercase Identifiers for Compatibility

**Impact: MEDIUM (Avoid case-sensitivity bugs with tools, ORMs, and AI assistants)**

PostgreSQL folds unquoted identifiers to lowercase. Quoted mixed-case identifiers require quotes forever and cause issues with tools, ORMs, and AI assistants that may not recognize them.

**Incorrect (mixed-case identifiers):**

```sql
-- Quoted identifiers preserve case but require quotes everywhere
CREATE TABLE "Users" (
  "userId" bigint PRIMARY KEY,
  "firstName" text,
  "lastName" text
);

-- Must always quote or queries fail
SELECT "firstName" FROM "Users" WHERE "userId" = 1;

-- This fails - Users becomes users without quotes
SELECT firstName FROM Users;
-- ERROR: relation "users" does not exist
```

**Correct (lowercase snake_case):**

```sql
-- Unquoted lowercase identifiers are portable and tool-friendly
CREATE TABLE users (
  user_id bigint PRIMARY KEY,
  first_name text,
  last_name text
);

-- Works without quotes, recognized by all tools
SELECT first_name FROM users WHERE user_id = 1;
-- ORMs often generate quoted camelCase - configure them to use snake_case
-- Migrations from other databases may preserve original casing
-- Some GUI tools quote identifiers by default - disable this

-- If stuck with mixed-case, create views as a compatibility layer
CREATE VIEW users AS SELECT "userId" AS user_id, "firstName" AS first_name FROM "Users";
```

Common sources of mixed-case identifiers:

Reference: https://www.postgresql.org/docs/current/sql-syntax-lexical.html#SQL-SYNTAX-IDENTIFIERS

---

## 5. Concurrency & Locking

**Impact: MEDIUM-HIGH**

Transaction management, isolation levels, deadlock prevention, and lock contention patterns.

### 5.1 Keep Transactions Short to Reduce Lock Contention

**Impact: MEDIUM-HIGH (3-5x throughput improvement, fewer deadlocks)**

Long-running transactions hold locks that block other queries. Keep transactions as short as possible.

**Incorrect (long transaction with external calls):**

```sql
begin;
select * from orders where id = 1 for update;  -- Lock acquired

-- Application makes HTTP call to payment API (2-5 seconds)
-- Other queries on this row are blocked!

update orders set status = 'paid' where id = 1;
commit;  -- Lock held for entire duration
```

**Correct (minimal transaction scope):**

```sql
-- Validate data and call APIs outside transaction
-- Application: response = await paymentAPI.charge(...)

-- Only hold lock for the actual update
begin;
update orders
set status = 'paid', payment_id = $1
where id = $2 and status = 'pending'
returning *;
commit;  -- Lock held for milliseconds
-- Abort queries running longer than 30 seconds
set statement_timeout = '30s';

-- Or per-session
set local statement_timeout = '5s';
```

Use `statement_timeout` to prevent runaway transactions:

Reference: https://www.postgresql.org/docs/current/tutorial-transactions.html

---

### 5.2 Prevent Deadlocks with Consistent Lock Ordering

**Impact: MEDIUM-HIGH (Eliminate deadlock errors, improve reliability)**

Deadlocks occur when transactions lock resources in different orders. Always
acquire locks in a consistent order.

**Incorrect (inconsistent lock ordering):**

```sql
-- Transaction A                    -- Transaction B
begin;                              begin;
update accounts                     update accounts
set balance = balance - 100         set balance = balance - 50
where id = 1;                       where id = 2;  -- B locks row 2

update accounts                     update accounts
set balance = balance + 100         set balance = balance + 50
where id = 2;  -- A waits for B     where id = 1;  -- B waits for A

-- DEADLOCK! Both waiting for each other
```

**Correct (lock rows in consistent order first):**

```sql
-- Explicitly acquire locks in ID order before updating
begin;
select * from accounts where id in (1, 2) order by id for update;

-- Now perform updates in any order - locks already held
update accounts set balance = balance - 100 where id = 1;
update accounts set balance = balance + 100 where id = 2;
commit;
-- Single statement acquires all locks atomically
begin;
update accounts
set balance = balance + case id
  when 1 then -100
  when 2 then 100
end
where id in (1, 2);
commit;
-- Check for recent deadlocks
select * from pg_stat_database where deadlocks > 0;

-- Enable deadlock logging
set log_lock_waits = on;
set deadlock_timeout = '1s';
```

Alternative: use a single statement to update atomically:
Detect deadlocks in logs:
[Deadlocks](https://www.postgresql.org/docs/current/explicit-locking.html#LOCKING-DEADLOCKS)

---

### 5.3 Use Advisory Locks for Application-Level Locking

**Impact: MEDIUM (Efficient coordination without row-level lock overhead)**

Advisory locks provide application-level coordination without requiring database rows to lock.

**Incorrect (creating rows just for locking):**

```sql
-- Creating dummy rows to lock on
create table resource_locks (
  resource_name text primary key
);

insert into resource_locks values ('report_generator');

-- Lock by selecting the row
select * from resource_locks where resource_name = 'report_generator' for update;
```

**Correct (advisory locks):**

```sql
-- Session-level advisory lock (released on disconnect or unlock)
select pg_advisory_lock(hashtext('report_generator'));
-- ... do exclusive work ...
select pg_advisory_unlock(hashtext('report_generator'));

-- Transaction-level lock (released on commit/rollback)
begin;
select pg_advisory_xact_lock(hashtext('daily_report'));
-- ... do work ...
commit;  -- Lock automatically released
-- Returns immediately with true/false instead of waiting
select pg_try_advisory_lock(hashtext('resource_name'));

-- Use in application
if (acquired) {
  -- Do work
  select pg_advisory_unlock(hashtext('resource_name'));
} else {
  -- Skip or retry later
}
```

Try-lock for non-blocking operations:

Reference: https://www.postgresql.org/docs/current/explicit-locking.html#ADVISORY-LOCKS

---

### 5.4 Use SKIP LOCKED for Non-Blocking Queue Processing

**Impact: MEDIUM-HIGH (10x throughput for worker queues)**

When multiple workers process a queue, SKIP LOCKED allows workers to process different rows without waiting.

**Incorrect (workers block each other):**

```sql
-- Worker 1 and Worker 2 both try to get next job
begin;
select * from jobs where status = 'pending' order by created_at limit 1 for update;
-- Worker 2 waits for Worker 1's lock to release!
```

**Correct (SKIP LOCKED for parallel processing):**

```sql
-- Each worker skips locked rows and gets the next available
begin;
select * from jobs
where status = 'pending'
order by created_at
limit 1
for update skip locked;

-- Worker 1 gets job 1, Worker 2 gets job 2 (no waiting)

update jobs set status = 'processing' where id = $1;
commit;
-- Atomic claim-and-update in one statement
update jobs
set status = 'processing', worker_id = $1, started_at = now()
where id = (
  select id from jobs
  where status = 'pending'
  order by created_at
  limit 1
  for update skip locked
)
returning *;
```

Complete queue pattern:

Reference: https://www.postgresql.org/docs/current/sql-select.html#SQL-FOR-UPDATE-SHARE

---

## 6. Data Access Patterns

**Impact: MEDIUM**

N+1 query elimination, batch operations, cursor-based pagination, and efficient data fetching.

### 6.1 Batch INSERT Statements for Bulk Data

**Impact: MEDIUM (10-50x faster bulk inserts)**

Individual INSERT statements have high overhead. Batch multiple rows in single statements or use COPY.

**Incorrect (individual inserts):**

```sql
-- Each insert is a separate transaction and round trip
insert into events (user_id, action) values (1, 'click');
insert into events (user_id, action) values (1, 'view');
insert into events (user_id, action) values (2, 'click');
-- ... 1000 more individual inserts

-- 1000 inserts = 1000 round trips = slow
```

**Correct (batch insert):**

```sql
-- Multiple rows in single statement
insert into events (user_id, action) values
  (1, 'click'),
  (1, 'view'),
  (2, 'click'),
  -- ... up to ~1000 rows per batch
  (999, 'view');

-- One round trip for 1000 rows
-- COPY is fastest for bulk loading
copy events (user_id, action, created_at)
from '/path/to/data.csv'
with (format csv, header true);

-- Or from stdin in application
copy events (user_id, action) from stdin with (format csv);
1,click
1,view
2,click
\.
```

For large imports, use COPY:

Reference: https://www.postgresql.org/docs/current/sql-copy.html

---

### 6.2 Eliminate N+1 Queries with Batch Loading

**Impact: MEDIUM-HIGH (10-100x fewer database round trips)**

N+1 queries execute one query per item in a loop. Batch them into a single query using arrays or JOINs.

**Incorrect (N+1 queries):**

```sql
-- First query: get all users
select id from users where active = true;  -- Returns 100 IDs

-- Then N queries, one per user
select * from orders where user_id = 1;
select * from orders where user_id = 2;
select * from orders where user_id = 3;
-- ... 97 more queries!

-- Total: 101 round trips to database
```

**Correct (single batch query):**

```sql
-- Collect IDs and query once with ANY
select * from orders where user_id = any(array[1, 2, 3, ...]);

-- Or use JOIN instead of loop
select u.id, u.name, o.*
from users u
left join orders o on o.user_id = u.id
where u.active = true;

-- Total: 1 round trip
-- Instead of looping in application code:
-- for user in users: db.query("SELECT * FROM orders WHERE user_id = $1", user.id)

-- Pass array parameter:
select * from orders where user_id = any($1::bigint[]);
-- Application passes: [1, 2, 3, 4, 5, ...]
```

Application pattern:

Reference: https://supabase.com/docs/guides/database/query-optimization

---

### 6.3 Use Cursor-Based Pagination Instead of OFFSET

**Impact: MEDIUM-HIGH (Consistent O(1) performance regardless of page depth)**

OFFSET-based pagination scans all skipped rows, getting slower on deeper pages. Cursor pagination is O(1).

**Incorrect (OFFSET pagination):**

```sql
-- Page 1: scans 20 rows
select * from products order by id limit 20 offset 0;

-- Page 100: scans 2000 rows to skip 1980
select * from products order by id limit 20 offset 1980;

-- Page 10000: scans 200,000 rows!
select * from products order by id limit 20 offset 199980;
```

**Correct (cursor/keyset pagination):**

```sql
-- Page 1: get first 20
select * from products order by id limit 20;
-- Application stores last_id = 20

-- Page 2: start after last ID
select * from products where id > 20 order by id limit 20;
-- Uses index, always fast regardless of page depth

-- Page 10000: same speed as page 1
select * from products where id > 199980 order by id limit 20;
-- Cursor must include all sort columns
select * from products
where (created_at, id) > ('2024-01-15 10:00:00', 12345)
order by created_at, id
limit 20;
```

For multi-column sorting:

Reference: https://supabase.com/docs/guides/database/pagination

---

### 6.4 Use UPSERT for Insert-or-Update Operations

**Impact: MEDIUM (Atomic operation, eliminates race conditions)**

Using separate SELECT-then-INSERT/UPDATE creates race conditions. Use INSERT ... ON CONFLICT for atomic upserts.

**Incorrect (check-then-insert race condition):**

```sql
-- Race condition: two requests check simultaneously
select * from settings where user_id = 123 and key = 'theme';
-- Both find nothing

-- Both try to insert
insert into settings (user_id, key, value) values (123, 'theme', 'dark');
-- One succeeds, one fails with duplicate key error!
```

**Correct (atomic UPSERT):**

```sql
-- Single atomic operation
insert into settings (user_id, key, value)
values (123, 'theme', 'dark')
on conflict (user_id, key)
do update set value = excluded.value, updated_at = now();

-- Returns the inserted/updated row
insert into settings (user_id, key, value)
values (123, 'theme', 'dark')
on conflict (user_id, key)
do update set value = excluded.value
returning *;
-- Insert only if not exists (no update)
insert into page_views (page_id, user_id)
values (1, 123)
on conflict (page_id, user_id) do nothing;
```

Insert-or-ignore pattern:

Reference: https://www.postgresql.org/docs/current/sql-insert.html#SQL-ON-CONFLICT

---

## 7. Monitoring & Diagnostics

**Impact: LOW-MEDIUM**

Using pg_stat_statements, EXPLAIN ANALYZE, metrics collection, and performance diagnostics.

### 7.1 Enable pg_stat_statements for Query Analysis

**Impact: LOW-MEDIUM (Identify top resource-consuming queries)**

pg_stat_statements tracks execution statistics for all queries, helping identify slow and frequent queries.

**Incorrect (no visibility into query patterns):**

```sql
-- Database is slow, but which queries are the problem?
-- No way to know without pg_stat_statements
```

**Correct (enable and query pg_stat_statements):**

```sql
-- Enable the extension
create extension if not exists pg_stat_statements;

-- Find slowest queries by total time
select
  calls,
  round(total_exec_time::numeric, 2) as total_time_ms,
  round(mean_exec_time::numeric, 2) as mean_time_ms,
  query
from pg_stat_statements
order by total_exec_time desc
limit 10;

-- Find most frequent queries
select calls, query
from pg_stat_statements
order by calls desc
limit 10;

-- Reset statistics after optimization
select pg_stat_statements_reset();
-- Queries with high mean time (candidates for optimization)
select query, mean_exec_time, calls
from pg_stat_statements
where mean_exec_time > 100  -- > 100ms average
order by mean_exec_time desc;
```

Key metrics to monitor:

Reference: https://supabase.com/docs/guides/database/extensions/pg_stat_statements

---

### 7.2 Maintain Table Statistics with VACUUM and ANALYZE

**Impact: MEDIUM (2-10x better query plans with accurate statistics)**

Outdated statistics cause the query planner to make poor decisions. VACUUM reclaims space, ANALYZE updates statistics.

**Incorrect (stale statistics):**

```sql
-- Table has 1M rows but stats say 1000
-- Query planner chooses wrong strategy
explain select * from orders where status = 'pending';
-- Shows: Seq Scan (because stats show small table)
-- Actually: Index Scan would be much faster
```

**Correct (maintain fresh statistics):**

```sql
-- Manually analyze after large data changes
analyze orders;

-- Analyze specific columns used in WHERE clauses
analyze orders (status, created_at);

-- Check when tables were last analyzed
select
  relname,
  last_vacuum,
  last_autovacuum,
  last_analyze,
  last_autoanalyze
from pg_stat_user_tables
order by last_analyze nulls first;
-- Increase frequency for high-churn tables
alter table orders set (
  autovacuum_vacuum_scale_factor = 0.05,     -- Vacuum at 5% dead tuples (default 20%)
  autovacuum_analyze_scale_factor = 0.02     -- Analyze at 2% changes (default 10%)
);

-- Check autovacuum status
select * from pg_stat_progress_vacuum;
```

Autovacuum tuning for busy tables:

Reference: https://supabase.com/docs/guides/database/database-size#vacuum-operations

---

### 7.3 Use EXPLAIN ANALYZE to Diagnose Slow Queries

**Impact: LOW-MEDIUM (Identify exact bottlenecks in query execution)**

EXPLAIN ANALYZE executes the query and shows actual timings, revealing the true performance bottlenecks.

**Incorrect (guessing at performance issues):**

```sql
-- Query is slow, but why?
select * from orders where customer_id = 123 and status = 'pending';
-- "It must be missing an index" - but which one?
```

**Correct (use EXPLAIN ANALYZE):**

```sql
explain (analyze, buffers, format text)
select * from orders where customer_id = 123 and status = 'pending';

-- Output reveals the issue:
-- Seq Scan on orders (cost=0.00..25000.00 rows=50 width=100) (actual time=0.015..450.123 rows=50 loops=1)
--   Filter: ((customer_id = 123) AND (status = 'pending'::text))
--   Rows Removed by Filter: 999950
--   Buffers: shared hit=5000 read=15000
-- Planning Time: 0.150 ms
-- Execution Time: 450.500 ms
-- Seq Scan on large tables = missing index
-- Rows Removed by Filter = poor selectivity or missing index
-- Buffers: read >> hit = data not cached, needs more memory
-- Nested Loop with high loops = consider different join strategy
-- Sort Method: external merge = work_mem too low
```

Key things to look for:

Reference: https://supabase.com/docs/guides/database/inspect

---

## 8. Advanced Features

**Impact: LOW**

Full-text search, JSONB optimization, PostGIS, extensions, and advanced Postgres features.

### 8.1 Index JSONB Columns for Efficient Querying

**Impact: MEDIUM (10-100x faster JSONB queries with proper indexing)**

JSONB queries without indexes scan the entire table. Use GIN indexes for containment queries.

**Incorrect (no index on JSONB):**

```sql
create table products (
  id bigint primary key,
  attributes jsonb
);

-- Full table scan for every query
select * from products where attributes @> '{"color": "red"}';
select * from products where attributes->>'brand' = 'Nike';
```

**Correct (GIN index for JSONB):**

```sql
-- GIN index for containment operators (@>, ?, ?&, ?|)
create index products_attrs_gin on products using gin (attributes);

-- Now containment queries use the index
select * from products where attributes @> '{"color": "red"}';

-- For specific key lookups, use expression index
create index products_brand_idx on products ((attributes->>'brand'));
select * from products where attributes->>'brand' = 'Nike';
-- jsonb_ops (default): supports all operators, larger index
create index idx1 on products using gin (attributes);

-- jsonb_path_ops: only @> operator, but 2-3x smaller index
create index idx2 on products using gin (attributes jsonb_path_ops);
```

Choose the right operator class:

Reference: https://www.postgresql.org/docs/current/datatype-json.html#JSON-INDEXING

---

### 8.2 Use tsvector for Full-Text Search

**Impact: MEDIUM (100x faster than LIKE, with ranking support)**

LIKE with wildcards can't use indexes. Full-text search with tsvector is orders of magnitude faster.

**Incorrect (LIKE pattern matching):**

```sql
-- Cannot use index, scans all rows
select * from articles where content like '%postgresql%';

-- Case-insensitive makes it worse
select * from articles where lower(content) like '%postgresql%';
```

**Correct (full-text search with tsvector):**

```sql
-- Add tsvector column and index
alter table articles add column search_vector tsvector
  generated always as (to_tsvector('english', coalesce(title,'') || ' ' || coalesce(content,''))) stored;

create index articles_search_idx on articles using gin (search_vector);

-- Fast full-text search
select * from articles
where search_vector @@ to_tsquery('english', 'postgresql & performance');

-- With ranking
select *, ts_rank(search_vector, query) as rank
from articles, to_tsquery('english', 'postgresql') query
where search_vector @@ query
order by rank desc;
-- AND: both terms required
to_tsquery('postgresql & performance')

-- OR: either term
to_tsquery('postgresql | mysql')

-- Prefix matching
to_tsquery('post:*')
```

Search multiple terms:

Reference: https://supabase.com/docs/guides/database/full-text-search

---

## References

- https://www.postgresql.org/docs/current/
- https://supabase.com/docs
- https://wiki.postgresql.org/wiki/Performance_Optimization
- https://supabase.com/docs/guides/database/overview
- https://supabase.com/docs/guides/auth/row-level-security
</file>

<file path=".agents/skills/supabase-postgres-best-practices/references/advanced-full-text-search.md">
---
title: Use tsvector for Full-Text Search
impact: MEDIUM
impactDescription: 100x faster than LIKE, with ranking support
tags: full-text-search, tsvector, gin, search
---

## Use tsvector for Full-Text Search

LIKE with wildcards can't use indexes. Full-text search with tsvector is orders of magnitude faster.

**Incorrect (LIKE pattern matching):**

```sql
-- Cannot use index, scans all rows
select * from articles where content like '%postgresql%';

-- Case-insensitive makes it worse
select * from articles where lower(content) like '%postgresql%';
```

**Correct (full-text search with tsvector):**

```sql
-- Add tsvector column and index
alter table articles add column search_vector tsvector
  generated always as (to_tsvector('english', coalesce(title,'') || ' ' || coalesce(content,''))) stored;

create index articles_search_idx on articles using gin (search_vector);

-- Fast full-text search
select * from articles
where search_vector @@ to_tsquery('english', 'postgresql & performance');

-- With ranking
select *, ts_rank(search_vector, query) as rank
from articles, to_tsquery('english', 'postgresql') query
where search_vector @@ query
order by rank desc;
```

Search multiple terms:

```sql
-- AND: both terms required
to_tsquery('postgresql & performance')

-- OR: either term
to_tsquery('postgresql | mysql')

-- Prefix matching
to_tsquery('post:*')
```

Reference: [Full Text Search](https://supabase.com/docs/guides/database/full-text-search)
</file>

<file path=".agents/skills/supabase-postgres-best-practices/references/advanced-jsonb-indexing.md">
---
title: Index JSONB Columns for Efficient Querying
impact: MEDIUM
impactDescription: 10-100x faster JSONB queries with proper indexing
tags: jsonb, gin, indexes, json
---

## Index JSONB Columns for Efficient Querying

JSONB queries without indexes scan the entire table. Use GIN indexes for containment queries.

**Incorrect (no index on JSONB):**

```sql
create table products (
  id bigint primary key,
  attributes jsonb
);

-- Full table scan for every query
select * from products where attributes @> '{"color": "red"}';
select * from products where attributes->>'brand' = 'Nike';
```

**Correct (GIN index for JSONB):**

```sql
-- GIN index for containment operators (@>, ?, ?&, ?|)
create index products_attrs_gin on products using gin (attributes);

-- Now containment queries use the index
select * from products where attributes @> '{"color": "red"}';

-- For specific key lookups, use expression index
create index products_brand_idx on products ((attributes->>'brand'));
select * from products where attributes->>'brand' = 'Nike';
```

Choose the right operator class:

```sql
-- jsonb_ops (default): supports all operators, larger index
create index idx1 on products using gin (attributes);

-- jsonb_path_ops: only @> operator, but 2-3x smaller index
create index idx2 on products using gin (attributes jsonb_path_ops);
```

Reference: [JSONB Indexes](https://www.postgresql.org/docs/current/datatype-json.html#JSON-INDEXING)
</file>

<file path=".agents/skills/supabase-postgres-best-practices/references/conn-idle-timeout.md">
---
title: Configure Idle Connection Timeouts
impact: HIGH
impactDescription: Reclaim 30-50% of connection slots from idle clients
tags: connections, timeout, idle, resource-management
---

## Configure Idle Connection Timeouts

Idle connections waste resources. Configure timeouts to automatically reclaim them.

**Incorrect (connections held indefinitely):**

```sql
-- No timeout configured
show idle_in_transaction_session_timeout;  -- 0 (disabled)

-- Connections stay open forever, even when idle
select pid, state, state_change, query
from pg_stat_activity
where state = 'idle in transaction';
-- Shows transactions idle for hours, holding locks
```

**Correct (automatic cleanup of idle connections):**

```sql
-- Terminate connections idle in transaction after 30 seconds
alter system set idle_in_transaction_session_timeout = '30s';

-- Terminate completely idle connections after 10 minutes
alter system set idle_session_timeout = '10min';

-- Reload configuration
select pg_reload_conf();
```

For pooled connections, configure at the pooler level:

```ini
# pgbouncer.ini
server_idle_timeout = 60
client_idle_timeout = 300
```

Reference: [Connection Timeouts](https://www.postgresql.org/docs/current/runtime-config-client.html#GUC-IDLE-IN-TRANSACTION-SESSION-TIMEOUT)
</file>

<file path=".agents/skills/supabase-postgres-best-practices/references/conn-limits.md">
---
title: Set Appropriate Connection Limits
impact: CRITICAL
impactDescription: Prevent database crashes and memory exhaustion
tags: connections, max-connections, limits, stability
---

## Set Appropriate Connection Limits

Too many connections exhaust memory and degrade performance. Set limits based on available resources.

**Incorrect (unlimited or excessive connections):**

```sql
-- Default max_connections = 100, but often increased blindly
show max_connections;  -- 500 (way too high for 4GB RAM)

-- Each connection uses 1-3MB RAM
-- 500 connections * 2MB = 1GB just for connections!
-- Out of memory errors under load
```

**Correct (calculate based on resources):**

```sql
-- Formula: max_connections = (RAM in MB / 5MB per connection) - reserved
-- For 4GB RAM: (4096 / 5) - 10 = ~800 theoretical max
-- But practically, 100-200 is better for query performance

-- Recommended settings for 4GB RAM
alter system set max_connections = 100;

-- Also set work_mem appropriately
-- work_mem * max_connections should not exceed 25% of RAM
alter system set work_mem = '8MB';  -- 8MB * 100 = 800MB max
```

Monitor connection usage:

```sql
select count(*), state from pg_stat_activity group by state;
```

Reference: [Database Connections](https://supabase.com/docs/guides/platform/performance#connection-management)
</file>

<file path=".agents/skills/supabase-postgres-best-practices/references/conn-pooling.md">
---
title: Use Connection Pooling for All Applications
impact: CRITICAL
impactDescription: Handle 10-100x more concurrent users
tags: connection-pooling, pgbouncer, performance, scalability
---

## Use Connection Pooling for All Applications

Postgres connections are expensive (1-3MB RAM each). Without pooling, applications exhaust connections under load.

**Incorrect (new connection per request):**

```sql
-- Each request creates a new connection
-- Application code: db.connect() per request
-- Result: 500 concurrent users = 500 connections = crashed database

-- Check current connections
select count(*) from pg_stat_activity;  -- 487 connections!
```

**Correct (connection pooling):**

```sql
-- Use a pooler like PgBouncer between app and database
-- Application connects to pooler, pooler reuses a small pool to Postgres

-- Configure pool_size based on: (CPU cores * 2) + spindle_count
-- Example for 4 cores: pool_size = 10

-- Result: 500 concurrent users share 10 actual connections
select count(*) from pg_stat_activity;  -- 10 connections
```

Pool modes:

- **Transaction mode**: connection returned after each transaction (best for most apps)
- **Session mode**: connection held for entire session (needed for prepared statements, temp tables)

Reference: [Connection Pooling](https://supabase.com/docs/guides/database/connecting-to-postgres#connection-pooler)
</file>

<file path=".agents/skills/supabase-postgres-best-practices/references/conn-prepared-statements.md">
---
title: Use Prepared Statements Correctly with Pooling
impact: HIGH
impactDescription: Avoid prepared statement conflicts in pooled environments
tags: prepared-statements, connection-pooling, transaction-mode
---

## Use Prepared Statements Correctly with Pooling

Prepared statements are tied to individual database connections. In transaction-mode pooling, connections are shared, causing conflicts.

**Incorrect (named prepared statements with transaction pooling):**

```sql
-- Named prepared statement
prepare get_user as select * from users where id = $1;

-- In transaction mode pooling, next request may get different connection
execute get_user(123);
-- ERROR: prepared statement "get_user" does not exist
```

**Correct (use unnamed statements or session mode):**

```sql
-- Option 1: Use unnamed prepared statements (most ORMs do this automatically)
-- The query is prepared and executed in a single protocol message

-- Option 2: Deallocate after use in transaction mode
prepare get_user as select * from users where id = $1;
execute get_user(123);
deallocate get_user;

-- Option 3: Use session mode pooling (port 5432 vs 6543)
-- Connection is held for entire session, prepared statements persist
```

Check your driver settings:

```sql
-- Many drivers use prepared statements by default
-- Node.js pg: { prepare: false } to disable
-- JDBC: prepareThreshold=0 to disable
```

Reference: [Prepared Statements with Pooling](https://supabase.com/docs/guides/database/connecting-to-postgres#connection-pool-modes)
</file>

<file path=".agents/skills/supabase-postgres-best-practices/references/data-batch-inserts.md">
---
title: Batch INSERT Statements for Bulk Data
impact: MEDIUM
impactDescription: 10-50x faster bulk inserts
tags: batch, insert, bulk, performance, copy
---

## Batch INSERT Statements for Bulk Data

Individual INSERT statements have high overhead. Batch multiple rows in single statements or use COPY.

**Incorrect (individual inserts):**

```sql
-- Each insert is a separate transaction and round trip
insert into events (user_id, action) values (1, 'click');
insert into events (user_id, action) values (1, 'view');
insert into events (user_id, action) values (2, 'click');
-- ... 1000 more individual inserts

-- 1000 inserts = 1000 round trips = slow
```

**Correct (batch insert):**

```sql
-- Multiple rows in single statement
insert into events (user_id, action) values
  (1, 'click'),
  (1, 'view'),
  (2, 'click'),
  -- ... up to ~1000 rows per batch
  (999, 'view');

-- One round trip for 1000 rows
```

For large imports, use COPY:

```sql
-- COPY is fastest for bulk loading
copy events (user_id, action, created_at)
from '/path/to/data.csv'
with (format csv, header true);

-- Or from stdin in application
copy events (user_id, action) from stdin with (format csv);
1,click
1,view
2,click
\.
```

Reference: [COPY](https://www.postgresql.org/docs/current/sql-copy.html)
</file>

<file path=".agents/skills/supabase-postgres-best-practices/references/data-n-plus-one.md">
---
title: Eliminate N+1 Queries with Batch Loading
impact: MEDIUM-HIGH
impactDescription: 10-100x fewer database round trips
tags: n-plus-one, batch, performance, queries
---

## Eliminate N+1 Queries with Batch Loading

N+1 queries execute one query per item in a loop. Batch them into a single query using arrays or JOINs.

**Incorrect (N+1 queries):**

```sql
-- First query: get all users
select id from users where active = true;  -- Returns 100 IDs

-- Then N queries, one per user
select * from orders where user_id = 1;
select * from orders where user_id = 2;
select * from orders where user_id = 3;
-- ... 97 more queries!

-- Total: 101 round trips to database
```

**Correct (single batch query):**

```sql
-- Collect IDs and query once with ANY
select * from orders where user_id = any(array[1, 2, 3, ...]);

-- Or use JOIN instead of loop
select u.id, u.name, o.*
from users u
left join orders o on o.user_id = u.id
where u.active = true;

-- Total: 1 round trip
```

Application pattern:

```sql
-- Instead of looping in application code:
-- for user in users: db.query("SELECT * FROM orders WHERE user_id = $1", user.id)

-- Pass array parameter:
select * from orders where user_id = any($1::bigint[]);
-- Application passes: [1, 2, 3, 4, 5, ...]
```

Reference: [N+1 Query Problem](https://supabase.com/docs/guides/database/query-optimization)
</file>

<file path=".agents/skills/supabase-postgres-best-practices/references/data-pagination.md">
---
title: Use Cursor-Based Pagination Instead of OFFSET
impact: MEDIUM-HIGH
impactDescription: Consistent O(1) performance regardless of page depth
tags: pagination, cursor, keyset, offset, performance
---

## Use Cursor-Based Pagination Instead of OFFSET

OFFSET-based pagination scans all skipped rows, getting slower on deeper pages. Cursor pagination is O(1).

**Incorrect (OFFSET pagination):**

```sql
-- Page 1: scans 20 rows
select * from products order by id limit 20 offset 0;

-- Page 100: scans 2000 rows to skip 1980
select * from products order by id limit 20 offset 1980;

-- Page 10000: scans 200,000 rows!
select * from products order by id limit 20 offset 199980;
```

**Correct (cursor/keyset pagination):**

```sql
-- Page 1: get first 20
select * from products order by id limit 20;
-- Application stores last_id = 20

-- Page 2: start after last ID
select * from products where id > 20 order by id limit 20;
-- Uses index, always fast regardless of page depth

-- Page 10000: same speed as page 1
select * from products where id > 199980 order by id limit 20;
```

For multi-column sorting:

```sql
-- Cursor must include all sort columns
select * from products
where (created_at, id) > ('2024-01-15 10:00:00', 12345)
order by created_at, id
limit 20;
```

Reference: [Pagination](https://supabase.com/docs/guides/database/pagination)
</file>

<file path=".agents/skills/supabase-postgres-best-practices/references/data-upsert.md">
---
title: Use UPSERT for Insert-or-Update Operations
impact: MEDIUM
impactDescription: Atomic operation, eliminates race conditions
tags: upsert, on-conflict, insert, update
---

## Use UPSERT for Insert-or-Update Operations

Using separate SELECT-then-INSERT/UPDATE creates race conditions. Use INSERT ... ON CONFLICT for atomic upserts.

**Incorrect (check-then-insert race condition):**

```sql
-- Race condition: two requests check simultaneously
select * from settings where user_id = 123 and key = 'theme';
-- Both find nothing

-- Both try to insert
insert into settings (user_id, key, value) values (123, 'theme', 'dark');
-- One succeeds, one fails with duplicate key error!
```

**Correct (atomic UPSERT):**

```sql
-- Single atomic operation
insert into settings (user_id, key, value)
values (123, 'theme', 'dark')
on conflict (user_id, key)
do update set value = excluded.value, updated_at = now();

-- Returns the inserted/updated row
insert into settings (user_id, key, value)
values (123, 'theme', 'dark')
on conflict (user_id, key)
do update set value = excluded.value
returning *;
```

Insert-or-ignore pattern:

```sql
-- Insert only if not exists (no update)
insert into page_views (page_id, user_id)
values (1, 123)
on conflict (page_id, user_id) do nothing;
```

Reference: [INSERT ON CONFLICT](https://www.postgresql.org/docs/current/sql-insert.html#SQL-ON-CONFLICT)
</file>

<file path=".agents/skills/supabase-postgres-best-practices/references/lock-advisory.md">
---
title: Use Advisory Locks for Application-Level Locking
impact: MEDIUM
impactDescription: Efficient coordination without row-level lock overhead
tags: advisory-locks, coordination, application-locks
---

## Use Advisory Locks for Application-Level Locking

Advisory locks provide application-level coordination without requiring database rows to lock.

**Incorrect (creating rows just for locking):**

```sql
-- Creating dummy rows to lock on
create table resource_locks (
  resource_name text primary key
);

insert into resource_locks values ('report_generator');

-- Lock by selecting the row
select * from resource_locks where resource_name = 'report_generator' for update;
```

**Correct (advisory locks):**

```sql
-- Session-level advisory lock (released on disconnect or unlock)
select pg_advisory_lock(hashtext('report_generator'));
-- ... do exclusive work ...
select pg_advisory_unlock(hashtext('report_generator'));

-- Transaction-level lock (released on commit/rollback)
begin;
select pg_advisory_xact_lock(hashtext('daily_report'));
-- ... do work ...
commit;  -- Lock automatically released
```

Try-lock for non-blocking operations:

```sql
-- Returns immediately with true/false instead of waiting
select pg_try_advisory_lock(hashtext('resource_name'));

-- Use in application
if (acquired) {
  -- Do work
  select pg_advisory_unlock(hashtext('resource_name'));
} else {
  -- Skip or retry later
}
```

Reference: [Advisory Locks](https://www.postgresql.org/docs/current/explicit-locking.html#ADVISORY-LOCKS)
</file>

<file path=".agents/skills/supabase-postgres-best-practices/references/lock-deadlock-prevention.md">
---
title: Prevent Deadlocks with Consistent Lock Ordering
impact: MEDIUM-HIGH
impactDescription: Eliminate deadlock errors, improve reliability
tags: deadlocks, locking, transactions, ordering
---

## Prevent Deadlocks with Consistent Lock Ordering

Deadlocks occur when transactions lock resources in different orders. Always
acquire locks in a consistent order.

**Incorrect (inconsistent lock ordering):**

```sql
-- Transaction A                    -- Transaction B
begin;                              begin;
update accounts                     update accounts
set balance = balance - 100         set balance = balance - 50
where id = 1;                       where id = 2;  -- B locks row 2

update accounts                     update accounts
set balance = balance + 100         set balance = balance + 50
where id = 2;  -- A waits for B     where id = 1;  -- B waits for A

-- DEADLOCK! Both waiting for each other
```

**Correct (lock rows in consistent order first):**

```sql
-- Explicitly acquire locks in ID order before updating
begin;
select * from accounts where id in (1, 2) order by id for update;

-- Now perform updates in any order - locks already held
update accounts set balance = balance - 100 where id = 1;
update accounts set balance = balance + 100 where id = 2;
commit;
```

Alternative: use a single statement to update atomically:

```sql
-- Single statement acquires all locks atomically
begin;
update accounts
set balance = balance + case id
  when 1 then -100
  when 2 then 100
end
where id in (1, 2);
commit;
```

Detect deadlocks in logs:

```sql
-- Check for recent deadlocks
select * from pg_stat_database where deadlocks > 0;

-- Enable deadlock logging
set log_lock_waits = on;
set deadlock_timeout = '1s';
```

Reference:
[Deadlocks](https://www.postgresql.org/docs/current/explicit-locking.html#LOCKING-DEADLOCKS)
</file>

<file path=".agents/skills/supabase-postgres-best-practices/references/lock-short-transactions.md">
---
title: Keep Transactions Short to Reduce Lock Contention
impact: MEDIUM-HIGH
impactDescription: 3-5x throughput improvement, fewer deadlocks
tags: transactions, locking, contention, performance
---

## Keep Transactions Short to Reduce Lock Contention

Long-running transactions hold locks that block other queries. Keep transactions as short as possible.

**Incorrect (long transaction with external calls):**

```sql
begin;
select * from orders where id = 1 for update;  -- Lock acquired

-- Application makes HTTP call to payment API (2-5 seconds)
-- Other queries on this row are blocked!

update orders set status = 'paid' where id = 1;
commit;  -- Lock held for entire duration
```

**Correct (minimal transaction scope):**

```sql
-- Validate data and call APIs outside transaction
-- Application: response = await paymentAPI.charge(...)

-- Only hold lock for the actual update
begin;
update orders
set status = 'paid', payment_id = $1
where id = $2 and status = 'pending'
returning *;
commit;  -- Lock held for milliseconds
```

Use `statement_timeout` to prevent runaway transactions:

```sql
-- Abort queries running longer than 30 seconds
set statement_timeout = '30s';

-- Or per-session
set local statement_timeout = '5s';
```

Reference: [Transaction Management](https://www.postgresql.org/docs/current/tutorial-transactions.html)
</file>

<file path=".agents/skills/supabase-postgres-best-practices/references/lock-skip-locked.md">
---
title: Use SKIP LOCKED for Non-Blocking Queue Processing
impact: MEDIUM-HIGH
impactDescription: 10x throughput for worker queues
tags: skip-locked, queue, workers, concurrency
---

## Use SKIP LOCKED for Non-Blocking Queue Processing

When multiple workers process a queue, SKIP LOCKED allows workers to process different rows without waiting.

**Incorrect (workers block each other):**

```sql
-- Worker 1 and Worker 2 both try to get next job
begin;
select * from jobs where status = 'pending' order by created_at limit 1 for update;
-- Worker 2 waits for Worker 1's lock to release!
```

**Correct (SKIP LOCKED for parallel processing):**

```sql
-- Each worker skips locked rows and gets the next available
begin;
select * from jobs
where status = 'pending'
order by created_at
limit 1
for update skip locked;

-- Worker 1 gets job 1, Worker 2 gets job 2 (no waiting)

update jobs set status = 'processing' where id = $1;
commit;
```

Complete queue pattern:

```sql
-- Atomic claim-and-update in one statement
update jobs
set status = 'processing', worker_id = $1, started_at = now()
where id = (
  select id from jobs
  where status = 'pending'
  order by created_at
  limit 1
  for update skip locked
)
returning *;
```

Reference: [SELECT FOR UPDATE SKIP LOCKED](https://www.postgresql.org/docs/current/sql-select.html#SQL-FOR-UPDATE-SHARE)
</file>

<file path=".agents/skills/supabase-postgres-best-practices/references/monitor-explain-analyze.md">
---
title: Use EXPLAIN ANALYZE to Diagnose Slow Queries
impact: LOW-MEDIUM
impactDescription: Identify exact bottlenecks in query execution
tags: explain, analyze, diagnostics, query-plan
---

## Use EXPLAIN ANALYZE to Diagnose Slow Queries

EXPLAIN ANALYZE executes the query and shows actual timings, revealing the true performance bottlenecks.

**Incorrect (guessing at performance issues):**

```sql
-- Query is slow, but why?
select * from orders where customer_id = 123 and status = 'pending';
-- "It must be missing an index" - but which one?
```

**Correct (use EXPLAIN ANALYZE):**

```sql
explain (analyze, buffers, format text)
select * from orders where customer_id = 123 and status = 'pending';

-- Output reveals the issue:
-- Seq Scan on orders (cost=0.00..25000.00 rows=50 width=100) (actual time=0.015..450.123 rows=50 loops=1)
--   Filter: ((customer_id = 123) AND (status = 'pending'::text))
--   Rows Removed by Filter: 999950
--   Buffers: shared hit=5000 read=15000
-- Planning Time: 0.150 ms
-- Execution Time: 450.500 ms
```

Key things to look for:

```sql
-- Seq Scan on large tables = missing index
-- Rows Removed by Filter = poor selectivity or missing index
-- Buffers: read >> hit = data not cached, needs more memory
-- Nested Loop with high loops = consider different join strategy
-- Sort Method: external merge = work_mem too low
```

Reference: [EXPLAIN](https://supabase.com/docs/guides/database/inspect)
</file>

<file path=".agents/skills/supabase-postgres-best-practices/references/monitor-pg-stat-statements.md">
---
title: Enable pg_stat_statements for Query Analysis
impact: LOW-MEDIUM
impactDescription: Identify top resource-consuming queries
tags: pg-stat-statements, monitoring, statistics, performance
---

## Enable pg_stat_statements for Query Analysis

pg_stat_statements tracks execution statistics for all queries, helping identify slow and frequent queries.

**Incorrect (no visibility into query patterns):**

```sql
-- Database is slow, but which queries are the problem?
-- No way to know without pg_stat_statements
```

**Correct (enable and query pg_stat_statements):**

```sql
-- Enable the extension
create extension if not exists pg_stat_statements;

-- Find slowest queries by total time
select
  calls,
  round(total_exec_time::numeric, 2) as total_time_ms,
  round(mean_exec_time::numeric, 2) as mean_time_ms,
  query
from pg_stat_statements
order by total_exec_time desc
limit 10;

-- Find most frequent queries
select calls, query
from pg_stat_statements
order by calls desc
limit 10;

-- Reset statistics after optimization
select pg_stat_statements_reset();
```

Key metrics to monitor:

```sql
-- Queries with high mean time (candidates for optimization)
select query, mean_exec_time, calls
from pg_stat_statements
where mean_exec_time > 100  -- > 100ms average
order by mean_exec_time desc;
```

Reference: [pg_stat_statements](https://supabase.com/docs/guides/database/extensions/pg_stat_statements)
</file>

<file path=".agents/skills/supabase-postgres-best-practices/references/monitor-vacuum-analyze.md">
---
title: Maintain Table Statistics with VACUUM and ANALYZE
impact: MEDIUM
impactDescription: 2-10x better query plans with accurate statistics
tags: vacuum, analyze, statistics, maintenance, autovacuum
---

## Maintain Table Statistics with VACUUM and ANALYZE

Outdated statistics cause the query planner to make poor decisions. VACUUM reclaims space, ANALYZE updates statistics.

**Incorrect (stale statistics):**

```sql
-- Table has 1M rows but stats say 1000
-- Query planner chooses wrong strategy
explain select * from orders where status = 'pending';
-- Shows: Seq Scan (because stats show small table)
-- Actually: Index Scan would be much faster
```

**Correct (maintain fresh statistics):**

```sql
-- Manually analyze after large data changes
analyze orders;

-- Analyze specific columns used in WHERE clauses
analyze orders (status, created_at);

-- Check when tables were last analyzed
select
  relname,
  last_vacuum,
  last_autovacuum,
  last_analyze,
  last_autoanalyze
from pg_stat_user_tables
order by last_analyze nulls first;
```

Autovacuum tuning for busy tables:

```sql
-- Increase frequency for high-churn tables
alter table orders set (
  autovacuum_vacuum_scale_factor = 0.05,     -- Vacuum at 5% dead tuples (default 20%)
  autovacuum_analyze_scale_factor = 0.02     -- Analyze at 2% changes (default 10%)
);

-- Check autovacuum status
select * from pg_stat_progress_vacuum;
```

Reference: [VACUUM](https://supabase.com/docs/guides/database/database-size#vacuum-operations)
</file>

<file path=".agents/skills/supabase-postgres-best-practices/references/query-composite-indexes.md">
---
title: Create Composite Indexes for Multi-Column Queries
impact: HIGH
impactDescription: 5-10x faster multi-column queries
tags: indexes, composite-index, multi-column, query-optimization
---

## Create Composite Indexes for Multi-Column Queries

When queries filter on multiple columns, a composite index is more efficient than separate single-column indexes.

**Incorrect (separate indexes require bitmap scan):**

```sql
-- Two separate indexes
create index orders_status_idx on orders (status);
create index orders_created_idx on orders (created_at);

-- Query must combine both indexes (slower)
select * from orders where status = 'pending' and created_at > '2024-01-01';
```

**Correct (composite index):**

```sql
-- Single composite index (leftmost column first for equality checks)
create index orders_status_created_idx on orders (status, created_at);

-- Query uses one efficient index scan
select * from orders where status = 'pending' and created_at > '2024-01-01';
```

**Column order matters** - place equality columns first, range columns last:

```sql
-- Good: status (=) before created_at (>)
create index idx on orders (status, created_at);

-- Works for: WHERE status = 'pending'
-- Works for: WHERE status = 'pending' AND created_at > '2024-01-01'
-- Does NOT work for: WHERE created_at > '2024-01-01' (leftmost prefix rule)
```

Reference: [Multicolumn Indexes](https://www.postgresql.org/docs/current/indexes-multicolumn.html)
</file>

<file path=".agents/skills/supabase-postgres-best-practices/references/query-covering-indexes.md">
---
title: Use Covering Indexes to Avoid Table Lookups
impact: MEDIUM-HIGH
impactDescription: 2-5x faster queries by eliminating heap fetches
tags: indexes, covering-index, include, index-only-scan
---

## Use Covering Indexes to Avoid Table Lookups

Covering indexes include all columns needed by a query, enabling index-only scans that skip the table entirely.

**Incorrect (index scan + heap fetch):**

```sql
create index users_email_idx on users (email);

-- Must fetch name and created_at from table heap
select email, name, created_at from users where email = 'user@example.com';
```

**Correct (index-only scan with INCLUDE):**

```sql
-- Include non-searchable columns in the index
create index users_email_idx on users (email) include (name, created_at);

-- All columns served from index, no table access needed
select email, name, created_at from users where email = 'user@example.com';
```

Use INCLUDE for columns you SELECT but don't filter on:

```sql
-- Searching by status, but also need customer_id and total
create index orders_status_idx on orders (status) include (customer_id, total);

select status, customer_id, total from orders where status = 'shipped';
```

Reference: [Index-Only Scans](https://www.postgresql.org/docs/current/indexes-index-only-scans.html)
</file>

<file path=".agents/skills/supabase-postgres-best-practices/references/query-index-types.md">
---
title: Choose the Right Index Type for Your Data
impact: HIGH
impactDescription: 10-100x improvement with correct index type
tags: indexes, btree, gin, brin, hash, index-types
---

## Choose the Right Index Type for Your Data

Different index types excel at different query patterns. The default B-tree isn't always optimal.

**Incorrect (B-tree for JSONB containment):**

```sql
-- B-tree cannot optimize containment operators
create index products_attrs_idx on products (attributes);
select * from products where attributes @> '{"color": "red"}';
-- Full table scan - B-tree doesn't support @> operator
```

**Correct (GIN for JSONB):**

```sql
-- GIN supports @>, ?, ?&, ?| operators
create index products_attrs_idx on products using gin (attributes);
select * from products where attributes @> '{"color": "red"}';
```

Index type guide:

```sql
-- B-tree (default): =, <, >, BETWEEN, IN, IS NULL
create index users_created_idx on users (created_at);

-- GIN: arrays, JSONB, full-text search
create index posts_tags_idx on posts using gin (tags);

-- BRIN: large time-series tables (10-100x smaller)
create index events_time_idx on events using brin (created_at);

-- Hash: equality-only (slightly faster than B-tree for =)
create index sessions_token_idx on sessions using hash (token);
```

Reference: [Index Types](https://www.postgresql.org/docs/current/indexes-types.html)
</file>

<file path=".agents/skills/supabase-postgres-best-practices/references/query-missing-indexes.md">
---
title: Add Indexes on WHERE and JOIN Columns
impact: CRITICAL
impactDescription: 100-1000x faster queries on large tables
tags: indexes, performance, sequential-scan, query-optimization
---

## Add Indexes on WHERE and JOIN Columns

Queries filtering or joining on unindexed columns cause full table scans, which become exponentially slower as tables grow.

**Incorrect (sequential scan on large table):**

```sql
-- No index on customer_id causes full table scan
select * from orders where customer_id = 123;

-- EXPLAIN shows: Seq Scan on orders (cost=0.00..25000.00 rows=100 width=85)
```

**Correct (index scan):**

```sql
-- Create index on frequently filtered column
create index orders_customer_id_idx on orders (customer_id);

select * from orders where customer_id = 123;

-- EXPLAIN shows: Index Scan using orders_customer_id_idx (cost=0.42..8.44 rows=100 width=85)
```

For JOIN columns, always index the foreign key side:

```sql
-- Index the referencing column
create index orders_customer_id_idx on orders (customer_id);

select c.name, o.total
from customers c
join orders o on o.customer_id = c.id;
```

Reference: [Query Optimization](https://supabase.com/docs/guides/database/query-optimization)
</file>

<file path=".agents/skills/supabase-postgres-best-practices/references/query-partial-indexes.md">
---
title: Use Partial Indexes for Filtered Queries
impact: HIGH
impactDescription: 5-20x smaller indexes, faster writes and queries
tags: indexes, partial-index, query-optimization, storage
---

## Use Partial Indexes for Filtered Queries

Partial indexes only include rows matching a WHERE condition, making them smaller and faster when queries consistently filter on the same condition.

**Incorrect (full index includes irrelevant rows):**

```sql
-- Index includes all rows, even soft-deleted ones
create index users_email_idx on users (email);

-- Query always filters active users
select * from users where email = 'user@example.com' and deleted_at is null;
```

**Correct (partial index matches query filter):**

```sql
-- Index only includes active users
create index users_active_email_idx on users (email)
where deleted_at is null;

-- Query uses the smaller, faster index
select * from users where email = 'user@example.com' and deleted_at is null;
```

Common use cases for partial indexes:

```sql
-- Only pending orders (status rarely changes once completed)
create index orders_pending_idx on orders (created_at)
where status = 'pending';

-- Only non-null values
create index products_sku_idx on products (sku)
where sku is not null;
```

Reference: [Partial Indexes](https://www.postgresql.org/docs/current/indexes-partial.html)
</file>

<file path=".agents/skills/supabase-postgres-best-practices/references/schema-data-types.md">
---
title: Choose Appropriate Data Types
impact: HIGH
impactDescription: 50% storage reduction, faster comparisons
tags: data-types, schema, storage, performance
---

## Choose Appropriate Data Types

Using the right data types reduces storage, improves query performance, and prevents bugs.

**Incorrect (wrong data types):**

```sql
create table users (
  id int,                    -- Will overflow at 2.1 billion
  email varchar(255),        -- Unnecessary length limit
  created_at timestamp,      -- Missing timezone info
  is_active varchar(5),      -- String for boolean
  price varchar(20)          -- String for numeric
);
```

**Correct (appropriate data types):**

```sql
create table users (
  id bigint generated always as identity primary key,  -- 9 quintillion max
  email text,                     -- No artificial limit, same performance as varchar
  created_at timestamptz,         -- Always store timezone-aware timestamps
  is_active boolean default true, -- 1 byte vs variable string length
  price numeric(10,2)             -- Exact decimal arithmetic
);
```

Key guidelines:

```sql
-- IDs: use bigint, not int (future-proofing)
-- Strings: use text, not varchar(n) unless constraint needed
-- Time: use timestamptz, not timestamp
-- Money: use numeric, not float (precision matters)
-- Enums: use text with check constraint or create enum type
```

Reference: [Data Types](https://www.postgresql.org/docs/current/datatype.html)
</file>

<file path=".agents/skills/supabase-postgres-best-practices/references/schema-foreign-key-indexes.md">
---
title: Index Foreign Key Columns
impact: HIGH
impactDescription: 10-100x faster JOINs and CASCADE operations
tags: foreign-key, indexes, joins, schema
---

## Index Foreign Key Columns

Postgres does not automatically index foreign key columns. Missing indexes cause slow JOINs and CASCADE operations.

**Incorrect (unindexed foreign key):**

```sql
create table orders (
  id bigint generated always as identity primary key,
  customer_id bigint references customers(id) on delete cascade,
  total numeric(10,2)
);

-- No index on customer_id!
-- JOINs and ON DELETE CASCADE both require full table scan
select * from orders where customer_id = 123;  -- Seq Scan
delete from customers where id = 123;          -- Locks table, scans all orders
```

**Correct (indexed foreign key):**

```sql
create table orders (
  id bigint generated always as identity primary key,
  customer_id bigint references customers(id) on delete cascade,
  total numeric(10,2)
);

-- Always index the FK column
create index orders_customer_id_idx on orders (customer_id);

-- Now JOINs and cascades are fast
select * from orders where customer_id = 123;  -- Index Scan
delete from customers where id = 123;          -- Uses index, fast cascade
```

Find missing FK indexes:

```sql
select
  conrelid::regclass as table_name,
  a.attname as fk_column
from pg_constraint c
join pg_attribute a on a.attrelid = c.conrelid and a.attnum = any(c.conkey)
where c.contype = 'f'
  and not exists (
    select 1 from pg_index i
    where i.indrelid = c.conrelid and a.attnum = any(i.indkey)
  );
```

Reference: [Foreign Keys](https://www.postgresql.org/docs/current/ddl-constraints.html#DDL-CONSTRAINTS-FK)
</file>

<file path=".agents/skills/supabase-postgres-best-practices/references/schema-lowercase-identifiers.md">
---
title: Use Lowercase Identifiers for Compatibility
impact: MEDIUM
impactDescription: Avoid case-sensitivity bugs with tools, ORMs, and AI assistants
tags: naming, identifiers, case-sensitivity, schema, conventions
---

## Use Lowercase Identifiers for Compatibility

PostgreSQL folds unquoted identifiers to lowercase. Quoted mixed-case identifiers require quotes forever and cause issues with tools, ORMs, and AI assistants that may not recognize them.

**Incorrect (mixed-case identifiers):**

```sql
-- Quoted identifiers preserve case but require quotes everywhere
CREATE TABLE "Users" (
  "userId" bigint PRIMARY KEY,
  "firstName" text,
  "lastName" text
);

-- Must always quote or queries fail
SELECT "firstName" FROM "Users" WHERE "userId" = 1;

-- This fails - Users becomes users without quotes
SELECT firstName FROM Users;
-- ERROR: relation "users" does not exist
```

**Correct (lowercase snake_case):**

```sql
-- Unquoted lowercase identifiers are portable and tool-friendly
CREATE TABLE users (
  user_id bigint PRIMARY KEY,
  first_name text,
  last_name text
);

-- Works without quotes, recognized by all tools
SELECT first_name FROM users WHERE user_id = 1;
```

Common sources of mixed-case identifiers:

```sql
-- ORMs often generate quoted camelCase - configure them to use snake_case
-- Migrations from other databases may preserve original casing
-- Some GUI tools quote identifiers by default - disable this

-- If stuck with mixed-case, create views as a compatibility layer
CREATE VIEW users AS SELECT "userId" AS user_id, "firstName" AS first_name FROM "Users";
```

Reference: [Identifiers and Key Words](https://www.postgresql.org/docs/current/sql-syntax-lexical.html#SQL-SYNTAX-IDENTIFIERS)
</file>

<file path=".agents/skills/supabase-postgres-best-practices/references/schema-partitioning.md">
---
title: Partition Large Tables for Better Performance
impact: MEDIUM-HIGH
impactDescription: 5-20x faster queries and maintenance on large tables
tags: partitioning, large-tables, time-series, performance
---

## Partition Large Tables for Better Performance

Partitioning splits a large table into smaller pieces, improving query performance and maintenance operations.

**Incorrect (single large table):**

```sql
create table events (
  id bigint generated always as identity,
  created_at timestamptz,
  data jsonb
);

-- 500M rows, queries scan everything
select * from events where created_at > '2024-01-01';  -- Slow
vacuum events;  -- Takes hours, locks table
```

**Correct (partitioned by time range):**

```sql
create table events (
  id bigint generated always as identity,
  created_at timestamptz not null,
  data jsonb
) partition by range (created_at);

-- Create partitions for each month
create table events_2024_01 partition of events
  for values from ('2024-01-01') to ('2024-02-01');

create table events_2024_02 partition of events
  for values from ('2024-02-01') to ('2024-03-01');

-- Queries only scan relevant partitions
select * from events where created_at > '2024-01-15';  -- Only scans events_2024_01+

-- Drop old data instantly
drop table events_2023_01;  -- Instant vs DELETE taking hours
```

When to partition:

- Tables > 100M rows
- Time-series data with date-based queries
- Need to efficiently drop old data

Reference: [Table Partitioning](https://www.postgresql.org/docs/current/ddl-partitioning.html)
</file>

<file path=".agents/skills/supabase-postgres-best-practices/references/schema-primary-keys.md">
---
title: Select Optimal Primary Key Strategy
impact: HIGH
impactDescription: Better index locality, reduced fragmentation
tags: primary-key, identity, uuid, serial, schema
---

## Select Optimal Primary Key Strategy

Primary key choice affects insert performance, index size, and replication
efficiency.

**Incorrect (problematic PK choices):**

```sql
-- identity is the SQL-standard approach
create table users (
  id serial primary key  -- Works, but IDENTITY is recommended
);

-- Random UUIDs (v4) cause index fragmentation
create table orders (
  id uuid default gen_random_uuid() primary key  -- UUIDv4 = random = scattered inserts
);
```

**Correct (optimal PK strategies):**

```sql
-- Use IDENTITY for sequential IDs (SQL-standard, best for most cases)
create table users (
  id bigint generated always as identity primary key
);

-- For distributed systems needing UUIDs, use UUIDv7 (time-ordered)
-- Requires pg_uuidv7 extension: create extension pg_uuidv7;
create table orders (
  id uuid default uuid_generate_v7() primary key  -- Time-ordered, no fragmentation
);

-- Alternative: time-prefixed IDs for sortable, distributed IDs (no extension needed)
create table events (
  id text default concat(
    to_char(now() at time zone 'utc', 'YYYYMMDDHH24MISSMS'),
    gen_random_uuid()::text
  ) primary key
);
```

Guidelines:

- Single database: `bigint identity` (sequential, 8 bytes, SQL-standard)
- Distributed/exposed IDs: UUIDv7 (requires pg_uuidv7) or ULID (time-ordered, no
  fragmentation)
- `serial` works but `identity` is SQL-standard and preferred for new
  applications
- Avoid random UUIDs (v4) as primary keys on large tables (causes index
  fragmentation)

Reference:
[Identity Columns](https://www.postgresql.org/docs/current/sql-createtable.html#SQL-CREATETABLE-PARMS-GENERATED-IDENTITY)
</file>

<file path=".agents/skills/supabase-postgres-best-practices/references/security-privileges.md">
---
title: Apply Principle of Least Privilege
impact: MEDIUM
impactDescription: Reduced attack surface, better audit trail
tags: privileges, security, roles, permissions
---

## Apply Principle of Least Privilege

Grant only the minimum permissions required. Never use superuser for application queries.

**Incorrect (overly broad permissions):**

```sql
-- Application uses superuser connection
-- Or grants ALL to application role
grant all privileges on all tables in schema public to app_user;
grant all privileges on all sequences in schema public to app_user;

-- Any SQL injection becomes catastrophic
-- drop table users; cascades to everything
```

**Correct (minimal, specific grants):**

```sql
-- Create role with no default privileges
create role app_readonly nologin;

-- Grant only SELECT on specific tables
grant usage on schema public to app_readonly;
grant select on public.products, public.categories to app_readonly;

-- Create role for writes with limited scope
create role app_writer nologin;
grant usage on schema public to app_writer;
grant select, insert, update on public.orders to app_writer;
grant usage on sequence orders_id_seq to app_writer;
-- No DELETE permission

-- Login role inherits from these
create role app_user login password 'xxx';
grant app_writer to app_user;
```

Revoke public defaults:

```sql
-- Revoke default public access
revoke all on schema public from public;
revoke all on all tables in schema public from public;
```

Reference: [Roles and Privileges](https://supabase.com/blog/postgres-roles-and-privileges)
</file>

<file path=".agents/skills/supabase-postgres-best-practices/references/security-rls-basics.md">
---
title: Enable Row Level Security for Multi-Tenant Data
impact: CRITICAL
impactDescription: Database-enforced tenant isolation, prevent data leaks
tags: rls, row-level-security, multi-tenant, security
---

## Enable Row Level Security for Multi-Tenant Data

Row Level Security (RLS) enforces data access at the database level, ensuring users only see their own data.

**Incorrect (application-level filtering only):**

```sql
-- Relying only on application to filter
select * from orders where user_id = $current_user_id;

-- Bug or bypass means all data is exposed!
select * from orders;  -- Returns ALL orders
```

**Correct (database-enforced RLS):**

```sql
-- Enable RLS on the table
alter table orders enable row level security;

-- Create policy for users to see only their orders
create policy orders_user_policy on orders
  for all
  using (user_id = current_setting('app.current_user_id')::bigint);

-- Force RLS even for table owners
alter table orders force row level security;

-- Set user context and query
set app.current_user_id = '123';
select * from orders;  -- Only returns orders for user 123
```

Policy for authenticated role:

```sql
create policy orders_user_policy on orders
  for all
  to authenticated
  using (user_id = auth.uid());
```

Reference: [Row Level Security](https://supabase.com/docs/guides/database/postgres/row-level-security)
</file>

<file path=".agents/skills/supabase-postgres-best-practices/references/security-rls-performance.md">
---
title: Optimize RLS Policies for Performance
impact: HIGH
impactDescription: 5-10x faster RLS queries with proper patterns
tags: rls, performance, security, optimization
---

## Optimize RLS Policies for Performance

Poorly written RLS policies can cause severe performance issues. Use subqueries and indexes strategically.

**Incorrect (function called for every row):**

```sql
create policy orders_policy on orders
  using (auth.uid() = user_id);  -- auth.uid() called per row!

-- With 1M rows, auth.uid() is called 1M times
```

**Correct (wrap functions in SELECT):**

```sql
create policy orders_policy on orders
  using ((select auth.uid()) = user_id);  -- Called once, cached

-- 100x+ faster on large tables
```

Use security definer functions for complex checks:

```sql
-- Create helper function (runs as definer, bypasses RLS)
create or replace function is_team_member(team_id bigint)
returns boolean
language sql
security definer
set search_path = ''
as $$
  select exists (
    select 1 from public.team_members
    where team_id = $1 and user_id = (select auth.uid())
  );
$$;

-- Use in policy (indexed lookup, not per-row check)
create policy team_orders_policy on orders
  using ((select is_team_member(team_id)));
```

Always add indexes on columns used in RLS policies:

```sql
create index orders_user_id_idx on orders (user_id);
```

Reference: [RLS Performance](https://supabase.com/docs/guides/database/postgres/row-level-security#rls-performance-recommendations)
</file>

<file path=".agents/skills/supabase-postgres-best-practices/SKILL.md">
---
name: supabase-postgres-best-practices
description: Postgres performance optimization and best practices from Supabase. Use this skill when writing, reviewing, or optimizing Postgres queries, schema designs, or database configurations.
license: MIT
metadata:
  author: supabase
  version: "1.1.0"
  organization: Supabase
  date: January 2026
  abstract: Comprehensive Postgres performance optimization guide for developers using Supabase and Postgres. Contains performance rules across 8 categories, prioritized by impact from critical (query performance, connection management) to incremental (advanced features). Each rule includes detailed explanations, incorrect vs. correct SQL examples, query plan analysis, and specific performance metrics to guide automated optimization and code generation.
---

# Supabase Postgres Best Practices

Comprehensive performance optimization guide for Postgres, maintained by Supabase. Contains rules across 8 categories, prioritized by impact to guide automated query optimization and schema design.

## When to Apply

Reference these guidelines when:
- Writing SQL queries or designing schemas
- Implementing indexes or query optimization
- Reviewing database performance issues
- Configuring connection pooling or scaling
- Optimizing for Postgres-specific features
- Working with Row-Level Security (RLS)

## Rule Categories by Priority

| Priority | Category | Impact | Prefix |
|----------|----------|--------|--------|
| 1 | Query Performance | CRITICAL | `query-` |
| 2 | Connection Management | CRITICAL | `conn-` |
| 3 | Security & RLS | CRITICAL | `security-` |
| 4 | Schema Design | HIGH | `schema-` |
| 5 | Concurrency & Locking | MEDIUM-HIGH | `lock-` |
| 6 | Data Access Patterns | MEDIUM | `data-` |
| 7 | Monitoring & Diagnostics | LOW-MEDIUM | `monitor-` |
| 8 | Advanced Features | LOW | `advanced-` |

## How to Use

Read individual rule files for detailed explanations and SQL examples:

```
references/query-missing-indexes.md
references/schema-partial-indexes.md
references/_sections.md
```

Each rule file contains:
- Brief explanation of why it matters
- Incorrect SQL example with explanation
- Correct SQL example with explanation
- Optional EXPLAIN output or metrics
- Additional context and references
- Supabase-specific notes (when applicable)

## Full Compiled Document

For the complete guide with all rules expanded: `AGENTS.md`

## References

- https://www.postgresql.org/docs/current/
- https://supabase.com/docs
- https://wiki.postgresql.org/wiki/Performance_Optimization
- https://supabase.com/docs/guides/database/overview
- https://supabase.com/docs/guides/auth/row-level-security
</file>

<file path=".gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts
</file>

<file path="eslint.config.mjs">
import { defineConfig, globalIgnores } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";
import nextTs from "eslint-config-next/typescript";

const eslintConfig = defineConfig([
  ...nextVitals,
  ...nextTs,
  // Override default ignores of eslint-config-next.
  globalIgnores([
    // Default ignores of eslint-config-next:
    ".next/**",
    "out/**",
    "build/**",
    "next-env.d.ts",
  ]),
]);

export default eslintConfig;
</file>

<file path="migration_add_amount_received.sql">
-- Add amount_received column to orders table
ALTER TABLE orders ADD COLUMN IF NOT EXISTS amount_received numeric DEFAULT 0;

COMMENT ON COLUMN orders.amount_received IS 'Actual cash/money collected during delivery. If less than total_amount, difference is credit.';
</file>

<file path="migration_add_godown.sql">
-- Drop existing constraint
alter table cylinders drop constraint if exists cylinders_current_location_type_check;

-- Add new constraint including 'godown'
alter table cylinders add constraint cylinders_current_location_type_check 
  check (current_location_type in ('godown', 'shop', 'driver', 'customer'));
</file>

<file path="migration_add_proof_url.sql">
-- Add proof_url column to transactions table
ALTER TABLE transactions 
ADD COLUMN IF NOT EXISTS proof_url text;

-- Optional: Add comment
COMMENT ON COLUMN transactions.proof_url IS 'URL to proof of transaction (e.g. receipt image)';
</file>

<file path="migration_apply_report_fixes.sql">
-- CRITICAL FIXES FOR RAZA GAS ERP
-- Run this script in the Supabase SQL Editor to apply the "Resolution Report" fixes.

-- SECTION 1: DATABASE INTEGRITY (Stop Duplicate Users)
-- We use a DO block to safely add constraints only if they don't exist.
DO $$
BEGIN
    -- 1. Unique Email Constraint
    IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'users_email_key') THEN
        ALTER TABLE public.users ADD CONSTRAINT users_email_key UNIQUE (email);
    END IF;

    -- 2. Unique Phone Constraint (Best Practice for this ERP)
    IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'users_phone_key') THEN
        -- Only if phone column exists
        IF EXISTS (SELECT 1 FROM information_schema.columns WHERE table_schema = 'public' AND table_name = 'users' AND column_name = 'phone') THEN
            ALTER TABLE public.users ADD CONSTRAINT users_phone_key UNIQUE (phone);
        END IF;
    END IF;
END $$;

-- SECTION 2: ACCESS PERMISSIONS (Fix "Database error querying schema")
-- This explicitly configures the 'authenticated' role (logged-in users) to see the 'public' schema.

-- A. Reset Search Path
ALTER ROLE authenticated SET search_path = "$user", public, auth;
ALTER ROLE service_role SET search_path = "$user", public, auth;

-- B. Grant Broad Config Permissions
GRANT USAGE ON SCHEMA public TO authenticated;
GRANT ALL ON ALL TABLES IN SCHEMA public TO authenticated;
GRANT ALL ON ALL SEQUENCES IN SCHEMA public TO authenticated;

-- C. Specific fixes for common tables (just in case)
GRANT SELECT, INSERT, UPDATE ON public.users TO authenticated;
GRANT SELECT, UPDATE ON public.employee_wallets TO authenticated;

-- SECTION 3: RELOAD CONFIG
-- This forces the API to pick up the new Search Path immediately.
NOTIFY pgrst, 'reload config';
</file>

<file path="migration_create_cylinders.sql">
-- Create cylinders table
create table if not exists cylinders (
  id uuid default gen_random_uuid() primary key,
  serial_number text not null unique,
  type text not null check (type in ('domestic', 'commercial')),
  status text not null default 'empty' check (status in ('full', 'empty', 'missing', 'maintenance')),
  condition text default 'good',
  current_location_type text default 'shop' check (current_location_type in ('shop', 'driver', 'customer')),
  current_holder_id uuid, -- Can be User ID (Shop/Driver) or Customer ID
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  updated_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- Enable RLS
alter table cylinders enable row level security;

-- Policies
create policy "Enable read access for authenticated users" 
  on cylinders for select using (auth.role() = 'authenticated');

create policy "Enable insert access for authenticated users" 
  on cylinders for insert with check (auth.role() = 'authenticated');

create policy "Enable update access for authenticated users" 
  on cylinders for update using (auth.role() = 'authenticated');

-- Create generic Inventory/Metrics view helper (Optional, but good for queries)
-- For now, we will query directly.
</file>

<file path="migration_create_daily_rates.sql">
-- 1. Daily Rates Table banayein
CREATE TABLE IF NOT EXISTS public.daily_rates (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    product_name text UNIQUE NOT NULL,
    current_rate numeric NOT NULL,
    updated_at timestamp WITH TIME ZONE DEFAULT timezone('utc'::text, now())
);

-- 2. Initial Rate set karein (Rs. 11,000)
INSERT INTO public.daily_rates (product_name, current_rate)
VALUES ('LPG Cylinder 45.4KG', 11000)
ON CONFLICT (product_name) DO UPDATE SET current_rate = 11000;

-- 3. Ensure cylinders have 'current_location_type' column
ALTER TABLE public.cylinders ADD COLUMN IF NOT EXISTS current_location_type text DEFAULT 'godown';
</file>

<file path="migration_disable_triggers.sql">
-- EMERGENCY DEBUG: Drop Auth Triggers
-- Run this in Supabase SQL Editor

-- 1. Drop common triggers that might be breaking the Login Transaction
-- (When you login, Supabase updates 'last_sign_in_at', which fires UPDATE triggers)
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
DROP TRIGGER IF EXISTS on_auth_user_login ON auth.users; -- Some setups use this
DROP TRIGGER IF EXISTS on_auth_user_updated ON auth.users;

-- 2. Drop the functions they might call (Optional, but good for cleanup if broken)
-- DROP FUNCTION IF EXISTS public.handle_new_user(); 
-- (Commented out: simpler to just drop the trigger first)

-- 3. Double-Check Permissions (Again)
GRANT USAGE ON SCHEMA public TO postgres, anon, authenticated, service_role;
GRANT ALL ON ALL TABLES IN SCHEMA public TO postgres, service_role;

-- 4. Reload Schema Cache (Again, mandatory after Trigger changes)
NOTIFY pgrst, 'reload config';
</file>

<file path="migration_final_cleanup.sql">
-- FINAL CLEANUP: Add Shifts, Clean Names, Sync Logins
-- Run this in Supabase SQL Editor

CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- 1. Schema Migration: Add Shift Column
ALTER TABLE public.users 
ADD COLUMN IF NOT EXISTS shift text CHECK (shift IN ('Day', 'Night', 'Any')) DEFAULT 'Any';

DO $$
DECLARE
  r RECORD;
  clean_name text;
  new_email text;
  user_shift text;
  raw_name text;
BEGIN
  -- Loop through ALL users in public.users to clean/sync them
  FOR r IN SELECT * FROM public.users LOOP
    raw_name := r.name;
    user_shift := 'Any';
    
    -- 2. Logic: Extract Shift
    IF raw_name ILIKE '%(Day)%' THEN
      user_shift := 'Day';
    ELSIF raw_name ILIKE '%(Night)%' THEN
      user_shift := 'Night';
    END IF;

    -- 3. Logic: Clean Name (Remove brackets and roles)
    -- Remove content in parenthesis
    clean_name := regexp_replace(raw_name, '\s*\(.*?\)', '', 'g'); 
    -- Remove specific roles if they are part of the name string (heuristic)
    clean_name := replace(clean_name, ' Driver', '');
    clean_name := replace(clean_name, ' Recovery', '');
    clean_name := replace(clean_name, ' Bhai', ''); -- Optional based on "Jabbar Bhai"
    clean_name := trim(clean_name);

    -- Special Case: "Supervisor (You)" -> "Abrar"
    IF raw_name ILIKE '%Supervisor%' THEN
      clean_name := 'Abrar';
    END IF;
     -- Special Case: "Raza Owner" -> "Raza"
    IF raw_name ILIKE '%Raza Owner%' THEN
      clean_name := 'Raza';
    END IF;

    -- 4. Logic: Standardize Email to @razagas.com
    -- Use the first word of the clean name or existing known mapping
    -- sanitize: lowercase, remove spaces
    new_email := lower(split_part(clean_name, ' ', 1)) || '@razagas.com';

    -- UPDATE public.users
    UPDATE public.users 
    SET 
      name = clean_name,
      shift = user_shift,
      email = new_email,
      -- Set status to 'idle' if null/unknown, ensuring safe default
      status = COALESCE(status, 'idle')
    WHERE id = r.id;

    -- 5. Logic: Sync to Auth (Create or Update)
    -- Check if auth user exists by ID
    IF EXISTS (SELECT 1 FROM auth.users WHERE id = r.id) THEN
      -- UPDATE existing auth user
      UPDATE auth.users
      SET 
        email = new_email,
        encrypted_password = crypt('123456', gen_salt('bf')),
        raw_user_meta_data = jsonb_build_object('name', clean_name, 'role', r.role),
        updated_at = now()
      WHERE id = r.id;
    ELSE
      -- INSERT new auth user (using existing public ID)
      INSERT INTO auth.users (
        id, 
        instance_id, 
        aud, 
        role, 
        email, 
        encrypted_password, 
        email_confirmed_at, 
        raw_app_meta_data, 
        raw_user_meta_data, 
        created_at, 
        updated_at
      )
      VALUES (
        r.id, 
        '00000000-0000-0000-0000-000000000000', 
        'authenticated', 
        'authenticated', 
        new_email, 
        crypt('123456', gen_salt('bf')), 
        now(), 
        '{"provider":"email","providers":["email"]}', 
        jsonb_build_object('name', clean_name, 'role', r.role), 
        now(), 
        now()
      );
    END IF;

  END LOOP;
END $$;

-- Validation Query
SELECT name as "Clean Name", role as "Role", shift as "Shift", email as "Email" FROM public.users ORDER BY role, name;
</file>

<file path="migration_final_schema_fix.sql">
-- FINAL FIX: Zero-Ambiguity Schema Resolution
-- Run this in Supabase SQL Editor

-- 1. RESET SEARCH PATHS (The Core Fix)
-- Ensure 'public' is explicitly in the path, but "$user" is first (standard).
-- We remove ambiguity by ensuring the role knows exactly where to look.
ALTER ROLE authenticated SET search_path = "$user", public, auth;
ALTER ROLE service_role SET search_path = "$user", public, auth;

-- 2. GRANT PERMISSIONS (The Access Fix)
-- Ensure explicit access to the 'public' schema and key tables.
GRANT USAGE ON SCHEMA public TO postgres, anon, authenticated, service_role;

-- Grant access to 'public.users' specifically (resolves the public vs auth confusion)
GRANT SELECT ON TABLE public.users TO authenticated;
GRANT SELECT ON TABLE public.employee_wallets TO authenticated;

-- 3. ENSURE TRIGGERS ARE GONE (The Transaction Fix)
-- Double-check that no broken triggers are interrupting the login.
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
DROP TRIGGER IF EXISTS on_auth_user_login ON auth.users;
DROP TRIGGER IF EXISTS on_auth_user_updated ON auth.users;

-- 4. RELOAD CONFIGURATION (The Application Fix)
-- Force PostgREST to pick up these new search paths permissions.
NOTIFY pgrst, 'reload config';
</file>

<file path="migration_fix_auth_schema.sql">
-- CRITICAL FIX: Auth Schema & Permissions
-- Run this in Supabase SQL Editor

-- 1. Force Schema Cache Reload (Often the culprit)
NOTIFY pgrst, 'reload config';

-- 2. Grant Permissions to System Roles (Ensures Auth can access Public if needed via Triggers)
GRANT USAGE ON SCHEMA public TO postgres, anon, authenticated, service_role;
GRANT ALL ON ALL TABLES IN SCHEMA public TO postgres, service_role;
GRANT ALL ON ALL SEQUENCES IN SCHEMA public TO postgres, service_role;
GRANT ALL ON ALL ROUTINES IN SCHEMA public TO postgres, service_role;

-- 3. Fix Search Paths (Ensures 'public' is found)
ALTER ROLE authenticated SET search_path = "$user", public;
ALTER ROLE service_role SET search_path = "$user", public;

-- 4. Enable crypto (Just in case Auth relies on it and it was dropped)
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- 5. Basic RLS for Users (Ensure it exists and is open for reading self)
ALTER TABLE public.users ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Public profiles are viewable by everyone" ON public.users;
CREATE POLICY "Public profiles are viewable by everyone" 
ON public.users FOR SELECT 
USING ( true );

-- 6. Trigger Safety Check (Optional - disabling this common trouble-maker if it exists and is broken)
-- DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;

-- 7. Grant to Auth System (Sometimes needed for triggers)
GRANT ALL ON public.users TO postgres;
</file>

<file path="migration_fix_constraints.sql">
-- Drop the old constraint
ALTER TABLE orders DROP CONSTRAINT IF EXISTS orders_status_check;

-- Add new constraint with 'completed' and 'on_trip'
ALTER TABLE orders 
ADD CONSTRAINT orders_status_check 
CHECK (status IN ('pending', 'assigned', 'dispatched', 'on-the-road', 'on_trip', 'delivering', 'delivered', 'completed', 'cancelled'));

-- Add payment_method column if not exists
ALTER TABLE orders ADD COLUMN IF NOT EXISTS payment_method text;

-- Also ensure proof_url exists on transactions (from the other migration, just in case)
ALTER TABLE transactions 
ADD COLUMN IF NOT EXISTS proof_url text;

COMMENT ON COLUMN transactions.proof_url IS 'URL to proof of transaction (e.g. receipt image)';
</file>

<file path="migration_fix_cylinders_rls.sql">
-- Fix RLS Policies for Cylinders Table
-- Drop existing restricted policies (just in case)
drop policy if exists "Enable read access for authenticated users" on cylinders;
drop policy if exists "Enable insert access for authenticated users" on cylinders;
drop policy if exists "Enable update access for authenticated users" on cylinders;
drop policy if exists "Enable read access for all users" on cylinders;
drop policy if exists "Enable insert access for all users" on cylinders;
drop policy if exists "Enable update access for all users" on cylinders;

-- Create Standard Isolation Policy
-- Users can only see rows where tenant_id matches their own tenant_id
drop policy if exists "Tenant Isolation" on cylinders;
create policy "Tenant Isolation" on cylinders 
    for all 
    using (tenant_id = public.get_my_tenant_id());

-- Ensure RLS is still enabled
alter table cylinders enable row level security;
</file>

<file path="migration_fix_driver_access.sql">
-- CRITICAL FIX: Driver Access & Permissions
-- Run this in Supabase SQL Editor

-- 1. Grant Base Permissions to Authenticated Users
GRANT USAGE ON SCHEMA public TO authenticated;
GRANT ALL ON ALL TABLES IN SCHEMA public TO authenticated;
GRANT ALL ON ALL SEQUENCES IN SCHEMA public TO authenticated;

-- 2. Ensure RLS is Enabled (Safety)
ALTER TABLE public.employee_wallets ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.users ENABLE ROW LEVEL SECURITY;

-- 3. Fix Wallet RLS (Broaden for reading)
DROP POLICY IF EXISTS "Users can view own wallet" ON public.employee_wallets;
CREATE POLICY "Users can view own wallet"
ON public.employee_wallets FOR SELECT
TO authenticated
USING (
  -- User can see their own wallet OR is an Admin/Manager/Cashier
  user_id = auth.uid() 
  OR 
  EXISTS (
    SELECT 1 FROM public.users 
    WHERE id = auth.uid() 
    AND role IN ('admin', 'manager', 'owner', 'cashier')
  )
);

-- 4. Fix Users RLS (Allow reading basic profile info for joining)
-- Drivers often need to join 'users' for name display in dropdowns
DROP POLICY IF EXISTS "Authenticated can view all profiles" ON public.users;
CREATE POLICY "Authenticated can view all profiles"
ON public.users FOR SELECT
TO authenticated
USING (true); -- Allow all authenticated users to read names/roles (safe for internal ERP)

-- 5. Fix Trips/Orders RLS (Ensure Drivers can see their stuff)
-- (Assuming existing policies might be too strict)
DROP POLICY IF EXISTS "Drivers can view assigned trips" ON public.trips;
CREATE POLICY "Drivers can view assigned trips"
ON public.trips FOR SELECT
TO authenticated
USING (
  driver_id = auth.uid() 
  OR 
  EXISTS (SELECT 1 FROM public.users WHERE id = auth.uid() AND role IN ('admin', 'manager', 'owner'))
);

DROP POLICY IF EXISTS "Drivers can view assigned orders" ON public.orders;
CREATE POLICY "Drivers can view assigned orders"
ON public.orders FOR SELECT
TO authenticated
USING (
  driver_id = auth.uid() 
  OR 
  EXISTS (SELECT 1 FROM public.users WHERE id = auth.uid() AND role IN ('admin', 'manager', 'owner'))
);
</file>

<file path="migration_fix_drivers.sql">
-- 1. Standardize all driver roles (handle casing/spaces)
UPDATE users 
SET role = 'driver' 
WHERE role ILIKE 'driver%';

-- 2. Initialize statuses for drivers (fix NULLs)
UPDATE users 
SET status = 'idle' 
WHERE role = 'driver' AND status IS NULL;
</file>

<file path="migration_fix_wallets_rls.sql">
-- FIX: RLS Policies for Employee Wallets and Users
-- Run this in Supabase SQL Editor

-- 1. Enable RLS on Wallets
ALTER TABLE public.employee_wallets ENABLE ROW LEVEL SECURITY;

-- 2. Policy: Users can view their OWN wallet
DROP POLICY IF EXISTS "Users can view own wallet" ON public.employee_wallets;
CREATE POLICY "Users can view own wallet"
ON public.employee_wallets
FOR SELECT
USING (auth.uid() = user_id);

-- 3. Policy: Admin/Managers can view ALL wallets
DROP POLICY IF EXISTS "Admins can view all wallets" ON public.employee_wallets;
CREATE POLICY "Admins can view all wallets"
ON public.employee_wallets
FOR ALL
USING (
  exists (
    select 1 from public.users 
    where id = auth.uid() 
    and role in ('admin', 'manager', 'owner', 'cashier')
  )
);

-- 4. Ensure public.users columns are accessible (Usually fine, but strict RLS might block updates)
-- Allow users to update their own 'is_online' status
DROP POLICY IF EXISTS "Users can update own status" ON public.users;
CREATE POLICY "Users can update own status"
ON public.users
FOR UPDATE
USING (auth.uid() = id)
WITH CHECK (auth.uid() = id);

-- 5. Grant permissions to service roles (just in case)
GRANT ALL ON public.employee_wallets TO postgres;
GRANT ALL ON public.employee_wallets TO service_role;
GRANT ALL ON public.employee_wallets TO authenticated;
</file>

<file path="migration_init_wallets.sql">
-- MIGRATION: Init Wallets & Shift Status

CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- 1. Add Shift Tracking to Users
ALTER TABLE public.users 
ADD COLUMN IF NOT EXISTS is_online boolean DEFAULT false;

-- 2. Create/Update Employee Wallets Table
CREATE TABLE IF NOT EXISTS public.employee_wallets (
    id uuid DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id uuid NOT NULL,
    balance numeric DEFAULT 0 CHECK (balance >= 0), -- Prevent negative wallet balance? Or allow simplified math?
    -- Actually, allow negative? No, cash in hand is usually >= 0. But allow flexibility.
    last_updated timestamptz DEFAULT now(),
    CONSTRAINT fk_user FOREIGN KEY (user_id) REFERENCES public.users(id),
    CONSTRAINT uniq_user_wallet UNIQUE (user_id)
);

-- 3. Initialize Wallets for All Users (Safe Upsert)
INSERT INTO public.employee_wallets (user_id, balance)
SELECT id, 0
FROM public.users
WHERE id NOT IN (SELECT user_id FROM public.employee_wallets);

-- 4. Audit/Verify
SELECT u.name, u.role, u.shift, w.balance, u.is_online
FROM public.users u
JOIN public.employee_wallets w ON u.id = w.user_id;
</file>

<file path="migration_standardize_emails.sql">
-- DATA CLEANUP: Standardize Emails to @razagas.com and Reset Passwords
-- Run this in Supabase SQL Editor

CREATE EXTENSION IF NOT EXISTS pgcrypto;

DO $$
DECLARE
  -- Helper function to avoid repeating logic? 
  -- We'll just use direct updates for clarity and safety.
BEGIN

  -- 1. Raza Owner
  UPDATE auth.users 
  SET email = 'raza@razagas.com', encrypted_password = crypt('123456', gen_salt('bf')) 
  WHERE email = 'raza@admin.com';
  
  UPDATE public.users 
  SET email = 'raza@razagas.com' 
  WHERE email = 'raza@admin.com';

  -- 2. Supervisor
  UPDATE auth.users 
  SET email = 'supervisor@razagas.com', encrypted_password = crypt('123456', gen_salt('bf')) 
  WHERE email = 'supervisor@admin.com';
  
  UPDATE public.users 
  SET email = 'supervisor@razagas.com' 
  WHERE email = 'supervisor@admin.com';

  -- 3. Faiz (Shop 1)
  UPDATE auth.users 
  SET email = 'faiz@razagas.com', encrypted_password = crypt('123456', gen_salt('bf')) 
  WHERE email = 'faiz@shop1.com';
  
  UPDATE public.users 
  SET email = 'faiz@razagas.com' 
  WHERE email = 'faiz@shop1.com';

  -- 4. Sawab (Shop 1)
  UPDATE auth.users 
  SET email = 'sawab@razagas.com', encrypted_password = crypt('123456', gen_salt('bf')) 
  WHERE email = 'sawab@shop1.com';
  
  UPDATE public.users 
  SET email = 'sawab@razagas.com' 
  WHERE email = 'sawab@shop1.com';

  -- 5. Raaj (Shop 2)
  UPDATE auth.users 
  SET email = 'raaj@razagas.com', encrypted_password = crypt('123456', gen_salt('bf')) 
  WHERE email = 'raaj@shop2.com';
  
  UPDATE public.users 
  SET email = 'raaj@razagas.com' 
  WHERE email = 'raaj@shop2.com';

  -- 6. Kaleem (Shop 2)
  UPDATE auth.users 
  SET email = 'kaleem@razagas.com', encrypted_password = crypt('123456', gen_salt('bf')) 
  WHERE email = 'kaleem@shop2.com';
  
  UPDATE public.users 
  SET email = 'kaleem@razagas.com' 
  WHERE email = 'kaleem@shop2.com';

  -- 7. Osama (Recovery)
  UPDATE auth.users 
  SET email = 'osama@razagas.com', encrypted_password = crypt('123456', gen_salt('bf')) 
  WHERE email = 'osama@recovery.com';
  
  UPDATE public.users 
  SET email = 'osama@razagas.com' 
  WHERE email = 'osama@recovery.com';

  -- 8. Jabbar (Cashier)
  UPDATE auth.users 
  SET email = 'jabbar@razagas.com', encrypted_password = crypt('123456', gen_salt('bf')) 
  WHERE email = 'jabbar@cash.com';
  
  UPDATE public.users 
  SET email = 'jabbar@razagas.com' 
  WHERE email = 'jabbar@cash.com';

  -- 9. Ahmed (Staff)
  UPDATE auth.users 
  SET email = 'ahmed@razagas.com', encrypted_password = crypt('123456', gen_salt('bf')) 
  WHERE email = 'ahmed@staff.com';
  
  UPDATE public.users 
  SET email = 'ahmed@razagas.com' 
  WHERE email = 'ahmed@staff.com';

  -- 10. Arif (Staff)
  UPDATE auth.users 
  SET email = 'arif@razagas.com', encrypted_password = crypt('123456', gen_salt('bf')) 
  WHERE email = 'arif@staff.com';
  
  UPDATE public.users 
  SET email = 'arif@razagas.com' 
  WHERE email = 'arif@staff.com';

  -- 11. Rehmat (Staff)
  UPDATE auth.users 
  SET email = 'rehmat@razagas.com', encrypted_password = crypt('123456', gen_salt('bf')) 
  WHERE email = 'rehmat@staff.com';
  
  UPDATE public.users 
  SET email = 'rehmat@razagas.com' 
  WHERE email = 'rehmat@staff.com';

  -- 12. Habib (Driver)
  UPDATE auth.users 
  SET email = 'habib@razagas.com', encrypted_password = crypt('123456', gen_salt('bf')) 
  WHERE email = 'habib@driver.com';
  
  UPDATE public.users 
  SET email = 'habib@razagas.com' 
  WHERE email = 'habib@driver.com';

  -- 13. Ibaad (Driver)
  UPDATE auth.users 
  SET email = 'ibaad@razagas.com', encrypted_password = crypt('123456', gen_salt('bf')) 
  WHERE email = 'ibaad@driver.com';
  
  UPDATE public.users 
  SET email = 'ibaad@razagas.com' 
  WHERE email = 'ibaad@driver.com';

END $$;

-- Verify results
SELECT name, email, role FROM public.users ORDER BY name;
</file>

<file path="migration_trip_returns.sql">
-- Add column to track verification status
alter table trips add column if not exists returns_verified boolean default false;

-- Function to get metrics for trips needing return verification
create or replace function get_trip_return_metrics()
returns table (
  trip_id uuid,
  driver_name text,
  driver_id uuid,
  start_time timestamptz,
  end_time timestamptz,
  completed_orders_count bigint,
  expected_empty_returns bigint
)
language plpgsql
as $$
begin
  return query
  select 
    t.id as trip_id,
    u.name as driver_name,
    u.id as driver_id,
    t.start_time,
    t.end_time,
    count(o.id) as completed_orders_count,
    -- Assume 1 order = 1 cylinder for now (or sum quantity if available)
    -- Ideally we sum order_items.quantity for cylinder products, but simplistic start:
    coalesce(sum(
      (select sum(oi.quantity) from order_items oi where oi.order_id = o.id)
    ), 0)::bigint as expected_empty_returns
  from trips t
  join users u on t.driver_id = u.id
  left join orders o on o.driver_id = u.id 
    and (o.trip_started_at >= t.start_time)
    and (o.trip_completed_at <= coalesce(t.end_time, now()))
    and o.status = 'completed'
  where 
    -- Show active trips OR completed trips that haven't been verified
    (t.status = 'ongoing' or (t.status = 'completed' and t.returns_verified = false))
  group by t.id, u.name, u.id, t.start_time, t.end_time
  order by t.start_time desc;
end;
$$;

-- Function to process the actual return of assets
create or replace function process_trip_returns(p_trip_id uuid)
returns json
language plpgsql
as $$
declare
  v_updated_count int;
  v_order_ids uuid[];
begin
  -- 1. Get all completed orders in this trip
  -- We use the same logic as metrics: orders that happened during this trip
  select array_agg(o.id) into v_order_ids
  from orders o
  join trips t on t.id = p_trip_id
  where o.driver_id = t.driver_id
    and o.status = 'completed'
    and o.trip_started_at >= t.start_time
    and o.trip_completed_at <= coalesce(t.end_time, now());

  -- 2. Update cylinders linked to these orders
  -- Logic: If they were "delivered" in this trip, they are currently at 'customer'.
  -- We want to set them to 'godown' and 'empty'.
  
  with updated_rows as (
    update cylinders
    set 
      current_location_type = 'godown',
      status = 'empty',
      updated_at = now()
    where last_order_id = any(v_order_ids)
      -- Optional safety: only move those currently at customer? 
      -- Yes, if they were already moved, don't move again.
      and current_location_type = 'customer'
    returning id
  )
  select count(*) into v_updated_count from updated_rows;

  -- 3. Mark trip as verified
  update trips 
  set returns_verified = true 
  where id = p_trip_id;

  return json_build_object(
    'success', true,
    'trip_id', p_trip_id,
    'cylinders_returned', v_updated_count
  );
end;
$$;
</file>

<file path="migration_update_cylinder_type.sql">
-- Drop the old constraint on 'type'
alter table cylinders drop constraint if exists cylinders_type_check;

-- Add new constraint allowing '45.4KG'
-- We can also just remove the check entirely if we want flexibility, but strict is good.
alter table cylinders add constraint cylinders_type_check 
  check (type in ('45.4KG', 'domestic', 'commercial')); 
  -- Keeping old ones just in case existing rows exist, but we will migrate them.

-- Update existing rows (if any) to '45.4KG'
update cylinders set type = '45.4KG';

-- Now we can restrict strict if we want, but let's leave it flexible or just strict
alter table cylinders drop constraint cylinders_type_check;
alter table cylinders add constraint cylinders_type_check check (type = '45.4KG');
</file>

<file path="migration_wallets_handovers.sql">
-- Create Wallet Table
CREATE TABLE IF NOT EXISTS employee_wallets (
  user_id uuid PRIMARY KEY REFERENCES users(id),
  balance numeric DEFAULT 0 NOT NULL,
  updated_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- Create Handover Logs Table
CREATE TABLE IF NOT EXISTS handover_logs (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  sender_id uuid REFERENCES users(id),
  receiver_id uuid REFERENCES users(id), -- Optional, initially null until verified? or selected by driver
  amount numeric NOT NULL,
  status text NOT NULL CHECK (status IN ('pending', 'verified', 'rejected')) DEFAULT 'pending',
  proof_url text,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL,
  verified_at timestamp with time zone
);

-- Enable RLS (Standard Practice)
ALTER TABLE employee_wallets ENABLE ROW LEVEL SECURITY;
ALTER TABLE handover_logs ENABLE ROW LEVEL SECURITY;

-- Simple Policies (Adjust as needed for strictness)
CREATE POLICY "Public Read Wallets" ON employee_wallets FOR SELECT USING (true);
CREATE POLICY "Public Update Wallets" ON employee_wallets FOR UPDATE USING (true); -- Simplified for demo
CREATE POLICY "Public Insert Wallets" ON employee_wallets FOR INSERT WITH CHECK (true);

CREATE POLICY "Public Read Handovers" ON handover_logs FOR SELECT USING (true);
CREATE POLICY "Public Insert Handovers" ON handover_logs FOR INSERT WITH CHECK (true);
CREATE POLICY "Public Update Handovers" ON handover_logs FOR UPDATE USING (true);

-- Add foreign key relationship if needed for specific user queries, but references users(id) handles it.
</file>

<file path="next.config.ts">
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  /* config options here */
};

export default nextConfig;
</file>

<file path="package.json">
{
  "name": "raza-gas-erp",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "@hookform/resolvers": "^5.2.2",
    "@radix-ui/react-alert-dialog": "^1.1.15",
    "@radix-ui/react-dialog": "^1.1.15",
    "@radix-ui/react-dropdown-menu": "^2.1.16",
    "@radix-ui/react-label": "^2.1.8",
    "@radix-ui/react-popover": "^1.1.15",
    "@radix-ui/react-radio-group": "^1.3.8",
    "@radix-ui/react-select": "^2.2.6",
    "@radix-ui/react-slot": "^1.2.4",
    "@supabase/ssr": "^0.8.0",
    "@supabase/supabase-js": "^2.88.0",
    "@types/papaparse": "^5.5.2",
    "@yudiel/react-qr-scanner": "^2.5.0",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "cmdk": "^1.1.1",
    "date-fns": "^4.1.0",
    "framer-motion": "^12.27.1",
    "lucide-react": "^0.561.0",
    "next": "16.0.10",
    "papaparse": "^5.5.3",
    "react": "19.2.1",
    "react-day-picker": "^9.13.0",
    "react-dom": "19.2.1",
    "react-hook-form": "^7.71.1",
    "react-qr-code": "^2.0.18",
    "recharts": "^3.6.0",
    "sonner": "^2.0.7",
    "tailwind-merge": "^3.4.0",
    "vaul": "^1.1.2",
    "zod": "^4.3.5"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "eslint": "^9",
    "eslint-config-next": "16.0.10",
    "tailwindcss": "^4",
    "typescript": "^5"
  }
}
</file>

<file path="postcss.config.mjs">
const config = {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};

export default config;
</file>

<file path="public/file.svg">
<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>
</file>

<file path="public/globe.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><g clip-path="url(#a)"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.27 14.1a6.5 6.5 0 0 0 3.67-3.45q-1.24.21-2.7.34-.31 1.83-.97 3.1M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.48-1.52a7 7 0 0 1-.96 0H7.5a4 4 0 0 1-.84-1.32q-.38-.89-.63-2.08a40 40 0 0 0 3.92 0q-.25 1.2-.63 2.08a4 4 0 0 1-.84 1.31zm2.94-4.76q1.66-.15 2.95-.43a7 7 0 0 0 0-2.58q-1.3-.27-2.95-.43a18 18 0 0 1 0 3.44m-1.27-3.54a17 17 0 0 1 0 3.64 39 39 0 0 1-4.3 0 17 17 0 0 1 0-3.64 39 39 0 0 1 4.3 0m1.1-1.17q1.45.13 2.69.34a6.5 6.5 0 0 0-3.67-3.44q.65 1.26.98 3.1M8.48 1.5l.01.02q.41.37.84 1.31.38.89.63 2.08a40 40 0 0 0-3.92 0q.25-1.2.63-2.08a4 4 0 0 1 .85-1.32 7 7 0 0 1 .96 0m-2.75.4a6.5 6.5 0 0 0-3.67 3.44 29 29 0 0 1 2.7-.34q.31-1.83.97-3.1M4.58 6.28q-1.66.16-2.95.43a7 7 0 0 0 0 2.58q1.3.27 2.95.43a18 18 0 0 1 0-3.44m.17 4.71q-1.45-.12-2.69-.34a6.5 6.5 0 0 0 3.67 3.44q-.65-1.27-.98-3.1" fill="#666"/></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h16v16H0z"/></clipPath></defs></svg>
</file>

<file path="public/next.svg">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
</file>

<file path="public/vercel.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1155 1000"><path d="m577.3 0 577.4 1000H0z" fill="#fff"/></svg>
</file>

<file path="public/window.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 2.5h13v10a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1zM0 1h16v11.5a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 0 12.5zm3.75 4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5M7 4.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0m1.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5" fill="#666"/></svg>
</file>

<file path="README_SETUP.md">
# Raza Gas ERP - Setup Guide

## 1. Prerequisites
- Node.js (v18+)
- npm or pnpm

## 2. Installation

Clone the repository and install dependencies:

```bash
git clone <repository_url>
cd raza-gas-erp
npm install
```

## 3. Environment Configuration

Create a file named `.env.local` in the root directory.
Add your Supabase credentials (found in Supabase Dashboard -> Settings -> API):

```env
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key-here
```

## 4. Running the Project

Start the development server:

```bash
npm run dev
```

Visit `http://localhost:3000` to see the application.

## 5. Database Schema

Ensure your Supabase project has the following migrations applied:
1. `users` table linked to `auth.users`.
2. `employee_wallets` table.
3. `orders`, `customers`, `inventory`, `handover_logs` tables.
4. RLS policies enabled for security.

## Troubleshooting

- **Login Error**: If you see "Database error querying schema", ensure you have run `migration_final_schema_fix.sql` in the Supabase SQL Editor.
- **Middleware Warning**: Ignorable in dev mode if functionality works.
</file>

<file path="README.md">
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.
</file>

<file path="scripts/audit_users.js">
const fs = require('fs');
const path = require('path');
const { createClient } = require('@supabase/supabase-js');

// Parse .env.local
const envPath = path.resolve(__dirname, '../.env.local');
let env = {};
try {
    const data = fs.readFileSync(envPath, 'utf8');
    data.split('\n').forEach(line => {
        const [key, value] = line.split('=');
        if (key && value) {
            env[key.trim()] = value.trim();
        }
    });
} catch (e) {
    console.error("Could not read .env.local");
}

const supabaseUrl = env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = env.NEXT_PUBLIC_SUPABASE_ANON_KEY;
const supabase = createClient(supabaseUrl, supabaseKey);

async function deepAudit() {
    console.log("--- 1. Checking 'users' table (ALL ROWS) ---");
    const { data: users, error } = await supabase
        .from('users')
        .select('*');

    if (error) console.error("Error fetching users:", error.message);
    else {
        console.log(`Found ${users.length} users:`);
        console.table(users.map(u => ({ name: u.name, email: u.email, role: u.role, status: u.status })));
    }

    console.log("\n--- 2. Checking 'profiles' table (if exists) ---");
    const { data: profiles, error: pError } = await supabase
        .from('profiles')
        .select('*');

    if (pError) {
        console.log("Profiles check:", pError.message || pError.code); // Likely 404 or relation not found
    } else {
        console.log(`Found ${profiles.length} profiles:`);
        console.table(profiles);
    }
}

deepAudit();
</file>

<file path="src/app/(dashboard)/admin/approvals/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import { getPendingHandovers, approveHandover, rejectHandover, getPendingCylinderDetails, getPendingPayments, verifyPayment, rejectPayment } from '@/app/actions/adminActions';
import { toast } from 'sonner';
import { CheckCircle, XCircle, RefreshCw, DollarSign, Package, AlertTriangle, ArrowRight, CreditCard, Image as ImageIcon } from 'lucide-react';
import { formatDistanceToNow } from 'date-fns';
import { Dialog, DialogContent, DialogTrigger } from '@/components/ui/dialog';
import Image from 'next/image';

export default function ApprovalsPage() {
    const [requests, setRequests] = useState<any[]>([]);
    const [pendingCylinders, setPendingCylinders] = useState<any[]>([]);
    const [payments, setPayments] = useState<any[]>([]);
    const [loading, setLoading] = useState(true);
    const [processing, setProcessing] = useState<string | null>(null);
    const [confirmModal, setConfirmModal] = useState<{ id: string, type: 'approve' | 'reject' | 'verify_payment' | 'reject_payment', qty?: number, msg: string } | null>(null);

    useEffect(() => {
        loadRequests();
    }, []);

    const loadRequests = async () => {
        setLoading(true);
        const [reqs, cyls, payPending] = await Promise.all([
            getPendingHandovers(),
            getPendingCylinderDetails(),
            getPendingPayments()
        ]);
        setRequests(reqs);
        setPendingCylinders(cyls);
        setPayments(payPending);
        setLoading(false);
    };

    const handleApprove = (req: any) => {
        const cyls = pendingCylinders.filter(c => c.current_holder_id === req.user_id);
        const msg = `Confirm Handover Approval?\n\nCash: Rs ${req.amount}\nCylinders: ${cyls.length}`;
        setConfirmModal({ id: req.transaction_id || req.id, type: 'approve', msg });
    };

    const handleReject = (id: string) => {
        setConfirmModal({ id, type: 'reject', msg: "Reject this handover request? Items will remain with the driver." });
    };

    const handleVerifyPayment = (pay: any) => {
        setConfirmModal({
            id: pay.id,
            type: 'verify_payment',
            msg: `Verify Payment of Rs ${pay.amount}?\n\nCustomer: ${pay.customers?.name}\nMethod: ${pay.payment_method}`
        });
    };

    const handleRejectPayment = (id: string) => {
        setConfirmModal({
            id,
            type: 'reject_payment',
            msg: "Reject this payment? The customer balance will NOT be updated."
        });
    };

    const executeAction = async () => {
        if (!confirmModal) return;
        const { id, type } = confirmModal;

        setProcessing(id);
        let res;

        if (type === 'reject') {
            res = await rejectHandover(id);
        } else if (type === 'approve') {
            res = await approveHandover(id);
        } else if (type === 'verify_payment') {
            res = await verifyPayment(id);
        } else if (type === 'reject_payment') {
            res = await rejectPayment(id);
        }

        setConfirmModal(null);

        if (res?.error) {
            if (res.error.includes("not found") || res.error.toLowerCase().includes("processed")) {
                toast.info("Request was already processed.");
                loadRequests();
            } else {
                toast.error(res.error);
            }
        } else {
            toast.success(
                type === 'reject' ? "Request Rejected" :
                    type === 'reject_payment' ? "Payment Rejected" :
                        "Action Successful"
            );
            loadRequests();
        }
        setProcessing(null);
    };

    return (
        <div className="space-y-8 animate-in fade-in duration-500 max-w-7xl mx-auto pb-20">
            <header className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h1 className="text-3xl font-black text-slate-800 tracking-tight">Reconciliation Hub</h1>
                    <p className="text-slate-500 font-medium mt-1">Verify Driver Deposits & Banking</p>
                </div>
                <button
                    onClick={loadRequests}
                    className="p-2 bg-white border border-slate-200 rounded-full text-slate-600 hover:text-emerald-600 hover:border-emerald-200 transition-colors shadow-sm"
                >
                    <RefreshCw size={20} className={loading ? 'animate-spin' : ''} />
                </button>
            </header>

            {/* SECTION 1: PENDING PAYMENTS (High Priority) */}
            <section>
                <div className="flex items-center gap-2 mb-4">
                    <CreditCard className="text-slate-400" size={20} />
                    <h2 className="text-xl font-bold text-slate-700">Pending Bank / Cheque Payments</h2>
                    <span className="text-xs font-bold bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full">{payments.length}</span>
                </div>

                {loading && <div className="h-32 bg-slate-100 rounded-2xl animate-pulse" />}

                {!loading && payments.length === 0 && (
                    <div className="p-8 text-center border-2 border-dashed border-slate-100 rounded-2xl bg-white/50">
                        <p className="text-slate-400 font-medium">No pending bank verifications.</p>
                    </div>
                )}

                <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                    {payments.map((pay) => (
                        <div key={pay.id} className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition-shadow flex flex-col justify-between group">
                            <div>
                                <div className="flex justify-between items-start mb-3">
                                    <div>
                                        <p className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-0.5">Customer</p>
                                        <h3 className="font-bold text-slate-800 text-lg leading-tight">{pay.customers?.name}</h3>
                                    </div>
                                    <div className="text-right">
                                        <span className="text-[10px] font-bold text-amber-600 bg-amber-50 px-2 py-1 rounded-full border border-amber-100 uppercase">
                                            {pay.payment_method}
                                        </span>
                                    </div>
                                </div>

                                <div className="flex items-end justify-between mb-4 p-3 bg-slate-50 rounded-xl border border-slate-100">
                                    <div>
                                        <p className="text-xs text-slate-400 mb-1">Amount Declared</p>
                                        <p className="font-black text-2xl text-slate-800">Rs {pay.amount?.toLocaleString()}</p>
                                    </div>
                                    {pay.proof_url && (
                                        <Dialog>
                                            <DialogTrigger asChild>
                                                <button className="text-xs flex items-center gap-1 font-bold text-blue-600 hover:underline">
                                                    <ImageIcon size={14} /> View Proof
                                                </button>
                                            </DialogTrigger>
                                            <DialogContent className="max-w-3xl p-0 overflow-hidden bg-transparent border-0 shadow-none">
                                                <div className="relative w-full h-[80vh] rounded-lg overflow-hidden bg-black/80 flex items-center justify-center">
                                                    {/* Using standard img for reliability with external URLs if domain not configured in next.config */}
                                                    {/* eslint-disable-next-line @next/next/no-img-element */}
                                                    <img
                                                        src={pay.proof_url}
                                                        alt="Proof"
                                                        className="max-w-full max-h-full object-contain"
                                                    />
                                                </div>
                                            </DialogContent>
                                        </Dialog>
                                    )}
                                </div>

                                {pay.description && (
                                    <p className="text-sm text-slate-500 italic mb-4 line-clamp-2">"{pay.description}"</p>
                                )}
                            </div>

                            <div className="flex gap-2 pt-4 border-t border-slate-50 mt-2">
                                <button
                                    onClick={() => handleRejectPayment(pay.id)}
                                    disabled={!!processing}
                                    className="flex-1 py-2 bg-white border border-red-100 text-red-600 rounded-lg font-bold text-sm hover:bg-red-50 transition-colors disabled:opacity-50"
                                >
                                    Reject
                                </button>
                                <button
                                    onClick={() => handleVerifyPayment(pay)}
                                    disabled={!!processing}
                                    className="flex-[2] py-2 bg-emerald-600 text-white rounded-lg font-bold text-sm hover:bg-emerald-700 transition-colors shadow-lg shadow-emerald-600/20 disabled:opacity-50 flex items-center justify-center gap-2"
                                >
                                    {processing === pay.id ? <RefreshCw className="animate-spin" size={16} /> : 'Verify Payment'}
                                </button>
                            </div>
                        </div>
                    ))}
                </div>
            </section>

            {/* SECTION 2: DRIVER HANDOVERS */}
            <section>
                <div className="flex items-center gap-2 mb-4">
                    <Package className="text-slate-400" size={20} />
                    <h2 className="text-xl font-bold text-slate-700">Staff Handovers (Cash & Assets)</h2>
                    <span className="text-xs font-bold bg-slate-100 text-slate-600 px-2 py-0.5 rounded-full">{requests.length}</span>
                </div>

                {loading && (
                    <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3 animate-pulse">
                        {[1, 2, 3].map(i => <div key={i} className="h-48 bg-slate-100 rounded-2xl" />)}
                    </div>
                )}

                {!loading && requests.length === 0 && (
                    <div className="p-8 text-center border-2 border-dashed border-slate-100 rounded-2xl bg-white/50">
                        <p className="text-slate-400 font-medium">No pending driver handovers.</p>
                    </div>
                )}

                {!loading && requests.length > 0 && (
                    <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                        {requests.map((req, idx) => {
                            const reqId = req.transaction_id || req.id;
                            const driverName = req.driver_name || req.users?.name || 'Unknown Driver';
                            const driverCylinders = pendingCylinders.filter(c => c.current_holder_id === req.user_id);

                            return (
                                <div key={reqId || idx} className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition-shadow flex flex-col justify-between">
                                    <div>
                                        <div className="flex justify-between items-start mb-4">
                                            <div className="flex items-center gap-3">
                                                <div className="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center text-slate-600 border border-slate-200 font-bold">
                                                    {driverName[0]}
                                                </div>
                                                <div>
                                                    <p className="text-xs font-bold text-slate-400 uppercase tracking-wider">
                                                        {req.users?.role === 'recovery_agent' ? 'Recovery Agent' : 'Driver'}
                                                    </p>
                                                    <p className="font-bold text-slate-800">{driverName}</p>
                                                </div>
                                            </div>
                                            <span className="text-[10px] font-bold text-slate-400 bg-slate-50 px-2 py-1 rounded-full border border-slate-100">
                                                {formatDistanceToNow(new Date(req.created_at), { addSuffix: true })}
                                            </span>
                                        </div>

                                        {/* UNIFIED DETAILS CARD */}
                                        <div className="space-y-3 mb-6">
                                            {/* CASH */}
                                            {req.amount > 0 && (
                                                <div className="flex justify-between items-center p-3 bg-emerald-50 rounded-xl border border-emerald-100">
                                                    <div className="flex items-center gap-2 text-emerald-700 text-sm font-bold">
                                                        <DollarSign size={16} /> Cash
                                                    </div>
                                                    <span className="font-black text-lg text-emerald-800">Rs {req.amount.toLocaleString()}</span>
                                                </div>
                                            )}

                                            {/* ASSETS */}
                                            {driverCylinders.length > 0 && (
                                                <div className="p-3 bg-amber-50 rounded-xl border border-amber-100">
                                                    <div className="flex items-center justify-between mb-2">
                                                        <div className="flex items-center gap-2 text-amber-700 text-sm font-bold">
                                                            <Package size={16} /> Cylinders
                                                        </div>
                                                        <span className="text-xs font-bold bg-white px-2 py-0.5 rounded border border-amber-200 text-amber-600">
                                                            {driverCylinders.length} Returns
                                                        </span>
                                                    </div>
                                                    <div className="flex flex-wrap gap-1">
                                                        {driverCylinders.map((c: any) => (
                                                            <span key={c.id} className="text-[10px] font-bold bg-white border border-amber-200 text-slate-500 px-1 rounded">
                                                                {c.serial_number}
                                                            </span>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}

                                            {/* Fallback for Empty Request */}
                                            {req.amount === 0 && driverCylinders.length === 0 && (
                                                <div className="p-3 bg-slate-50 rounded-xl border border-slate-100 text-center">
                                                    <p className="text-xs text-slate-400 italic">No cash or assets detected.</p>
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    {/* ACTIONS */}
                                    <div className="flex gap-2 pt-4 border-t border-slate-50">
                                        <button
                                            onClick={() => handleReject(reqId)}
                                            disabled={!!processing}
                                            className="flex-1 py-2 bg-white border border-red-100 text-red-600 rounded-lg font-bold text-sm hover:bg-red-50 transition-colors disabled:opacity-50"
                                        >
                                            Reject
                                        </button>
                                        <button
                                            onClick={() => handleApprove(req)}
                                            disabled={!!processing}
                                            className="flex-[2] py-2 bg-slate-900 text-white rounded-lg font-bold text-sm hover:bg-slate-800 transition-colors shadow-lg shadow-slate-900/10 disabled:opacity-50 flex items-center justify-center gap-2"
                                        >
                                            {processing === reqId ? <RefreshCw className="animate-spin" size={16} /> : 'Approve Handover'}
                                        </button>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                )
                }
            </section >

            {/* Confirmation Modal */}
            {
                confirmModal && (
                    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm animate-in fade-in duration-200">
                        <div className="bg-white w-full max-w-md p-6 rounded-2xl shadow-xl border border-slate-100 scale-100 animate-in zoom-in-95 duration-200">
                            <div className="flex flex-col items-center text-center space-y-4">
                                <div className={`p-3 rounded-full ${['reject', 'reject_payment'].includes(confirmModal.type) ? 'bg-red-50 text-red-600' : 'bg-emerald-50 text-emerald-600'}`}>
                                    {['reject', 'reject_payment'].includes(confirmModal.type) ? <XCircle size={32} /> : <CheckCircle size={32} />}
                                </div>
                                <h3 className="text-xl font-bold text-slate-800">
                                    {confirmModal.type === 'reject' ? 'Reject Handover' :
                                        confirmModal.type === 'reject_payment' ? 'Reject Payment' :
                                            confirmModal.type === 'verify_payment' ? 'Verify Payment' :
                                                'Approve Handover'}
                                </h3>
                                <p className="text-slate-500 font-medium whitespace-pre-wrap">
                                    {confirmModal.msg}
                                </p>

                                <div className="flex gap-3 w-full pt-4">
                                    <button
                                        onClick={() => setConfirmModal(null)}
                                        disabled={!!processing}
                                        className="flex-1 py-3 bg-white border border-slate-200 text-slate-600 rounded-xl font-bold hover:bg-slate-50 transition-colors"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={executeAction}
                                        disabled={!!processing}
                                        className={`flex-1 py-3 rounded-xl font-bold text-white shadow-lg flex items-center justify-center gap-2 transition-transform active:scale-95 ${['reject', 'reject_payment'].includes(confirmModal.type)
                                            ? 'bg-red-600 hover:bg-red-700 shadow-red-200'
                                            : 'bg-emerald-600 hover:bg-emerald-700 shadow-emerald-200'
                                            }`}
                                    >
                                        {processing ? (
                                            <><RefreshCw className="animate-spin" size={20} /> Processing...</>
                                        ) : (
                                            ['reject', 'reject_payment'].includes(confirmModal.type) ? 'Reject' : 'Confirm'
                                        )}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                )
            }
        </div >
    );
}
</file>

<file path="src/app/(dashboard)/admin/customers/[id]/page.tsx">
"use client";

import { useEffect, useState } from 'react';
import { useParams, useRouter } from 'next/navigation';
import { toast } from 'sonner';
import { ArrowLeft, Wallet, Database, Phone, MapPin, Receipt, Download, AlertCircle } from 'lucide-react';
import Link from 'next/link';
import { getCustomerDetails, getCustomerTransactions, getCustomerAssets, getCustomerOrderHistory } from '@/app/actions/customerActions';

export default function CustomerDetail() {
    const params = useParams();
    const router = useRouter();
    const id = params.id as string;

    const [customer, setCustomer] = useState<any>(null);
    const [transactions, setTransactions] = useState<any[]>([]);
    const [assets, setAssets] = useState<any[]>([]);
    const [orderLogs, setOrderLogs] = useState<any[]>([]);
    const [ledger, setLedger] = useState<any[]>([]);
    const [loading, setLoading] = useState(true);
    const [activeTab, setActiveTab] = useState<'history' | 'assets'>('history');

    useEffect(() => {
        if (id) loadData();
    }, [id]);

    const loadData = async () => {
        setLoading(true);
        try {
            const [custData, txnData, assetData, orderLogsData] = await Promise.all([
                getCustomerDetails(id),
                getCustomerTransactions(id),
                getCustomerAssets(id),
                getCustomerOrderHistory(id)
            ]);

            if (!custData) {
                toast.error("Customer not found");
                router.push('/admin/customers');
                return;
            }

            setCustomer(custData);
            setTransactions(txnData || []);
            setAssets(assetData || []);
            setOrderLogs(orderLogsData || []);
            calculateLedger(txnData || []);
        } catch (error) {
            toast.error("Failed to load details");
            console.error(error);
        } finally {
            setLoading(false);
        }
    };

    // Calculate Running Balance (Bank Statement Style)
    const calculateLedger = (txns: any[]) => {
        // Sort Ascending (Oldest First)
        const sorted = [...txns].sort((a, b) => new Date(a.created_at).getTime() - new Date(b.created_at).getTime());

        let balance = 0;
        const ledgerData = sorted.map(t => {
            const amount = t.amount || 0;
            balance += amount;

            // Determine Debit vs Credit for display
            // Positive Amount = Debit (They bought something / We gave them money) -> Increases Debt
            // Negative Amount = Credit (They paid us / Security Deposit) -> Decreases Debt
            return {
                ...t,
                debit: amount > 0 ? amount : 0,
                credit: amount < 0 ? Math.abs(amount) : 0,
                running_balance: balance
            };
        });

        // Reverse back to Newest First for Display
        setLedger(ledgerData.reverse());
    };

    if (loading) return <div className="p-8 flex justify-center text-slate-400">Loading ledger...</div>;
    if (!customer) return null;

    const debtRatio = (customer.current_balance / (customer.credit_limit || 50000)) * 100;

    return (
        <div className="p-8 bg-slate-50 min-h-screen pb-32 font-sans">
            {/* Header */}
            <div className="mb-8">
                <Link href="/admin/customers" className="inline-flex items-center gap-2 text-sm font-bold text-slate-500 hover:text-slate-800 mb-4 transition-colors">
                    <ArrowLeft size={16} /> Back to Customers
                </Link>
                <div className="flex justify-between items-start">
                    <div>
                        <h1 className="text-3xl font-black text-slate-900 tracking-tight">{customer.name}</h1>
                        <div className="flex items-center gap-4 mt-2 text-slate-500 font-medium">
                            <span className="flex items-center gap-1"><Phone size={14} /> {customer.phone}</span>
                            <span className="flex items-center gap-1"><MapPin size={14} /> {customer.address || "No Address"}</span>
                        </div>
                    </div>
                </div>
            </div>

            {/* Stats Grid */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                {/* Balance Card */}
                <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <div className="text-xs font-bold text-slate-400 uppercase flex items-center gap-2 mb-2">
                        <Wallet size={14} /> Current Balance
                    </div>
                    <div className={`text-3xl font-black ${customer.current_balance > 0 ? 'text-rose-600' : 'text-emerald-600'}`}>
                        Rs {Math.abs(customer.current_balance).toLocaleString()}
                    </div>
                    <div className="text-xs text-slate-400 mt-1 font-bold">
                        {customer.current_balance > 0 ? 'RECEIVABLE' : 'ADVANCE'}
                    </div>
                </div>

                {/* Credit Limit Card */}
                <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <div className="flex justify-between items-start mb-2">
                        <div className="text-xs font-bold text-slate-400 uppercase flex items-center gap-2">
                            Credit Limit
                        </div>
                        {debtRatio > 90 && <AlertCircle size={16} className="text-red-500" />}
                    </div>
                    <div className="text-3xl font-black text-slate-900">
                        Rs {(customer.credit_limit || 50000).toLocaleString()}
                    </div>
                    <div className="w-full bg-slate-100 h-1.5 rounded-full mt-3 overflow-hidden">
                        <div
                            className={`h-full rounded-full transition-all ${debtRatio > 90 ? 'bg-red-500' : 'bg-emerald-500'}`}
                            style={{ width: `${Math.min(debtRatio, 100)}%` }}
                        />
                    </div>
                    <div className="text-xs text-slate-400 mt-1 text-right font-medium">
                        {debtRatio.toFixed(1)}% Used
                    </div>
                </div>

                {/* Asset Card */}
                <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <div className="text-xs font-bold text-slate-400 uppercase flex items-center gap-2 mb-2">
                        <Database size={14} /> Cylinders Held
                    </div>
                    <div className="text-3xl font-black text-slate-900">
                        {assets.length}
                    </div>
                    <div className="text-xs text-slate-400 mt-1 font-bold">
                        ASSETS IN POSSESSION
                    </div>
                </div>
            </div>

            {/* Tabs */}
            <div className="flex gap-1 bg-slate-200/50 p-1 rounded-xl w-fit mb-6">
                <button
                    onClick={() => setActiveTab('history')}
                    className={`px-6 py-2 rounded-lg text-sm font-bold transition-all ${activeTab === 'history' ? 'bg-white shadow-sm text-slate-900' : 'text-slate-500 hover:text-slate-700'}`}
                >
                    Financial Ledger
                </button>
                <button
                    onClick={() => setActiveTab('assets')}
                    className={`px-6 py-2 rounded-lg text-sm font-bold transition-all ${activeTab === 'assets' ? 'bg-white shadow-sm text-slate-900' : 'text-slate-500 hover:text-slate-700'}`}
                >
                    Asset Logs
                </button>
            </div>

            {/* Content Area */}
            <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden min-h-[500px]">

                {activeTab === 'history' && (
                    <div>
                        <div className="p-4 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                            <h3 className="text-xs font-bold text-slate-500 uppercase">Statement of Account</h3>
                            <button className="flex items-center gap-2 text-xs font-bold text-slate-600 hover:text-emerald-700 bg-white border border-slate-200 px-3 py-1.5 rounded-lg shadow-sm">
                                <Download size={14} /> Download PDF
                            </button>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-left border-collapse">
                                <thead className="bg-white text-xs font-bold text-slate-400 uppercase tracking-wider border-b border-slate-100">
                                    <tr>
                                        <th className="p-4 w-32">Date</th>
                                        <th className="p-4">Description</th>
                                        <th className="p-4 text-right text-emerald-600 bg-emerald-50/30 w-32 border-l border-slate-50">Debit (+)</th>
                                        <th className="p-4 text-right text-indigo-600 bg-indigo-50/30 w-32 border-l border-slate-50">Credit (-)</th>
                                        <th className="p-4 text-right w-32 border-l border-slate-50">Balance</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-50 text-sm">
                                    {ledger.length === 0 ? (
                                        <tr><td colSpan={5} className="p-8 text-center text-slate-400 font-medium">No financial history available.</td></tr>
                                    ) : (
                                        ledger.map((row: any) => (
                                            <tr key={row.id} className="hover:bg-slate-50 transition-colors group">
                                                <td className="p-4 font-bold text-slate-600 whitespace-nowrap">
                                                    {new Date(row.created_at).toLocaleDateString()}
                                                    <span className="block text-[10px] text-slate-400 font-normal">{new Date(row.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                                                </td>
                                                <td className="p-4">
                                                    <div className="font-bold text-slate-800">{row.description || 'Transaction'}</div>
                                                    <div className="flex gap-2 mt-1">
                                                        <span className={`text-[10px] uppercase font-bold px-1.5 py-0.5 rounded border ${row.type.includes('sale') ? 'text-emerald-600 border-emerald-200 bg-emerald-50' :
                                                            row.type.includes('payment') ? 'text-indigo-600 border-indigo-200 bg-indigo-50' :
                                                                'text-slate-500 border-slate-200 bg-slate-100'
                                                            }`}>{row.type}</span>
                                                        {row.proof_url && (
                                                            <a href={row.proof_url} target="_blank" className="text-[10px] font-bold text-blue-500 flex items-center gap-1 hover:underline">
                                                                <Receipt size={10} /> Receipt
                                                            </a>
                                                        )}
                                                    </div>
                                                </td>
                                                <td className="p-4 text-right font-mono font-medium text-emerald-700 bg-emerald-50/10 border-l border-slate-50">
                                                    {row.debit > 0 ? row.debit.toLocaleString() : '-'}
                                                </td>
                                                <td className="p-4 text-right font-mono font-medium text-indigo-700 bg-indigo-50/10 border-l border-slate-50">
                                                    {row.credit > 0 ? row.credit.toLocaleString() : '-'}
                                                </td>
                                                <td className="p-4 text-right font-mono font-bold text-slate-900 border-l border-slate-50 group-hover:bg-white">
                                                    Rs {row.running_balance.toLocaleString()}
                                                </td>
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                )}

                {activeTab === 'assets' && (
                    <div className="space-y-8">
                        {/* Current Holdings */}
                        <div>
                            <div className="p-4 bg-slate-50 border-b border-slate-200">
                                <h3 className="text-xs font-bold text-slate-500 uppercase">Current Asset Holdings ({assets.length})</h3>
                            </div>
                            <table className="w-full text-left">
                                <thead className="bg-slate-50 border-b border-slate-100">
                                    <tr>
                                        <th className="p-4 text-xs font-bold text-slate-500 uppercase">Serial Number</th>
                                        <th className="p-4 text-xs font-bold text-slate-500 uppercase">Assigned Date</th>
                                        <th className="p-4 text-xs font-bold text-slate-500 uppercase">Status</th>
                                        <th className="p-4 text-xs font-bold text-slate-500 uppercase">Condition</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {assets.length === 0 ? (
                                        <tr><td colSpan={4} className="p-8 text-center text-slate-400">No assets currently held.</td></tr>
                                    ) : (
                                        assets.map(a => (
                                            <tr key={a.id} className="hover:bg-slate-50">
                                                <td className="p-4 font-black text-slate-900">{a.serial_number}</td>
                                                <td className="p-4 text-sm font-bold text-slate-600">
                                                    {new Date(a.updated_at).toLocaleDateString()}
                                                </td>
                                                <td className="p-4">
                                                    <span className={`px-2 py-1 rounded-full text-xs font-black uppercase tracking-wider ${a.status === 'full' ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-600'
                                                        }`}>
                                                        {a.status}
                                                    </span>
                                                </td>
                                                <td className="p-4 text-sm font-medium text-slate-500 capitalize">{a.condition}</td>
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>

                        {/* Order History / Logs */}
                        <div>
                            <div className="p-4 bg-slate-50 border-b border-slate-200">
                                <h3 className="text-xs font-bold text-slate-500 uppercase">Asset Movement Logs</h3>
                            </div>
                            <table className="w-full text-left">
                                <thead className="bg-slate-50 border-b border-slate-100">
                                    <tr>
                                        <th className="p-4 text-xs font-bold text-slate-500 uppercase">Date</th>
                                        <th className="p-4 text-xs font-bold text-slate-500 uppercase">Driver</th>
                                        <th className="p-4 text-xs font-bold text-slate-500 uppercase">Delivered (Full)</th>
                                        <th className="p-4 text-xs font-bold text-slate-500 uppercase">Returned (Empty)</th>
                                        <th className="p-4 text-xs font-bold text-slate-500 uppercase">Status</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {orderLogs.length === 0 ? (
                                        <tr><td colSpan={5} className="p-8 text-center text-slate-400">No movement history found.</td></tr>
                                    ) : (
                                        orderLogs.map(o => (
                                            <tr key={o.id} className="hover:bg-slate-50">
                                                <td className="p-4 font-bold text-slate-600">
                                                    {new Date(o.created_at).toLocaleDateString()}
                                                </td>
                                                <td className="p-4 text-sm font-bold text-slate-900">
                                                    {o.driver?.name || 'Unknown Driver'}
                                                </td>
                                                <td className="p-4 text-emerald-600 font-bold">
                                                    +{o.cylinders_count}
                                                </td>
                                                <td className="p-4 text-indigo-600 font-bold">
                                                    {o.cylinders_returned ? `-${o.cylinders_returned}` : '-'}
                                                </td>
                                                <td className="p-4">
                                                    <span className={`px-2 py-1 rounded-full text-[10px] font-black uppercase tracking-wider ${o.status === 'completed' ? 'bg-emerald-100 text-emerald-700' : 'bg-yellow-100 text-yellow-700'
                                                        }`}>
                                                        {o.status}
                                                    </span>
                                                </td>
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
}
</file>

<file path="src/app/(dashboard)/admin/customers/page.tsx">
'use client';

import { useState, useEffect } from 'react';

import { toast } from 'sonner';
import { Users, UploadCloud, Search, Phone, MapPin, Wallet, Plus, X, ArrowRight, TrendingUp, AlertTriangle, MoreVertical, Edit2, Ban, CheckCircle } from 'lucide-react';
import CustomerImportModal from '@/components/admin/customers/CustomerImportModal';
import EditCustomerModal from '@/components/admin/customers/EditCustomerModal';
import { getCustomers, createCustomer, getCustomerStats, toggleCustomerStatus } from '@/app/actions/customerActions';
import AddCustomerModal from '@/components/admin/customers/AddCustomerModal';
import { getTenantInfo } from '@/app/actions/adminActions';
import Link from 'next/link';
// import { useDebounce } from '@/hooks/useDebounce'; 


interface Customer {
    id: string;
    name: string;
    phone: string;
    address: string;
    current_balance: number;
    tenant_id: string;
    is_active: boolean;
    credit_limit?: number;
    last_order_at?: string;
}

export default function CustomerList() {
    // Data State
    const [customers, setCustomers] = useState<Customer[]>([]);
    const [stats, setStats] = useState({ totalReceivables: 0, defaultersCount: 0 });
    const [totalCount, setTotalCount] = useState(0);
    const [loading, setLoading] = useState(true);

    // Filter State
    const [page, setPage] = useState(1);
    const [limit] = useState(10); // Standard pagination
    const [searchTerm, setSearchTerm] = useState('');
    const [statusFilter, setStatusFilter] = useState<'all' | 'active' | 'inactive'>('active');

    // UI State
    const [showImportModal, setShowImportModal] = useState(false);
    const [showAddModal, setShowAddModal] = useState(false);
    const [editingCustomer, setEditingCustomer] = useState<Customer | null>(null);
    const [tenantName, setTenantName] = useState('');
    const [actionMenuOpen, setActionMenuOpen] = useState<string | null>(null);

    // Debounce Search
    useEffect(() => {
        const timer = setTimeout(() => {
            loadData();
        }, 500);
        return () => clearTimeout(timer);
    }, [searchTerm, page, statusFilter]);

    useEffect(() => {
        loadStats();
    }, []);

    const loadData = async () => {
        setLoading(true);
        try {
            const info = await getTenantInfo();
            setTenantName(info.name || "My Organization");

            const { data, total } = await getCustomers(page, limit, searchTerm, statusFilter);
            setCustomers(data);
            setTotalCount(total);
        } catch (error) {
            toast.error('Failed to load customers');
        } finally {
            setLoading(false);
        }
    };

    const loadStats = async () => {
        const s = await getCustomerStats();
        setStats(s);
    };

    const handleToggleStatus = async (id: string, currentStatus: boolean) => {
        setActionMenuOpen(null);
        toast.promise(toggleCustomerStatus(id, !currentStatus), {
            loading: 'Updating status...',
            success: () => {
                loadData();
                return 'Status updated';
            },
            error: 'Failed to update status'
        });
    };

    const totalPages = Math.ceil(totalCount / limit);

    return (
        <div className="p-6 bg-slate-50 min-h-screen pb-32 font-sans">

            {/* Header & Stats Row */}
            <div className="flex flex-col gap-6 mb-8">
                <div className="flex justify-between items-start">
                    <div>
                        <h1 className="text-2xl font-bold text-slate-900 tracking-tight">Collections Dashboard</h1>
                        <p className="text-sm text-slate-500 font-medium">Overview for <span className="text-slate-900 font-bold">{tenantName}</span></p>
                    </div>
                    <div className="flex gap-2">
                        <button
                            onClick={() => setShowAddModal(true)}
                            className="bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 hover:bg-emerald-700 shadow-lg shadow-emerald-900/20"
                        >
                            <Plus size={16} /> New Customer
                        </button>
                        <button
                            onClick={() => setShowImportModal(true)}
                            className="bg-white text-slate-700 border border-slate-200 px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 hover:bg-slate-50"
                        >
                            <UploadCloud size={16} /> Import CSV
                        </button>
                    </div>
                </div>

                {/* KPI Cards */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex items-center gap-4">
                        <div className="w-12 h-12 rounded-full bg-emerald-50 text-emerald-600 flex items-center justify-center">
                            <Wallet size={24} />
                        </div>
                        <div>
                            <p className="text-xs font-bold text-slate-400 uppercase">Total Receivables</p>
                            <p className="text-2xl font-black text-slate-900">Rs {stats.totalReceivables.toLocaleString()}</p>
                        </div>
                    </div>

                    <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex items-center gap-4">
                        <div className="w-12 h-12 rounded-full bg-red-50 text-red-600 flex items-center justify-center">
                            <AlertTriangle size={24} />
                        </div>
                        <div>
                            <p className="text-xs font-bold text-slate-400 uppercase">At Risk (Defaulters)</p>
                            <p className="text-2xl font-black text-slate-900">{stats.defaultersCount}</p>
                        </div>
                    </div>

                    <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex items-center gap-4">
                        <div className="w-12 h-12 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center">
                            <Users size={24} />
                        </div>
                        <div>
                            <p className="text-xs font-bold text-slate-400 uppercase">Total Customers</p>
                            <p className="text-2xl font-black text-slate-900">{totalCount}</p>
                        </div>
                    </div>
                </div>
            </div>

            {/* Main Content Card */}
            <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">

                {/* Internal Toolbar */}
                <div className="p-4 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4">
                    <div className="flex items-center gap-2 w-full md:w-auto">
                        <div className="relative flex-1 md:w-64">
                            <input
                                type="text"
                                placeholder="Search Name or Phone..."
                                value={searchTerm}
                                onChange={(e) => { setSearchTerm(e.target.value); setPage(1); }}
                                className="pl-10 pr-4 py-2 rounded-lg border border-slate-200 text-sm font-semibold w-full focus:ring-2 focus:ring-emerald-500 outline-none"
                            />
                            <Search size={16} className="absolute left-3 top-3 text-slate-400" />
                        </div>

                        <div className="flex bg-slate-100 rounded-lg p-1">
                            {['active', 'all', 'inactive'].map((s) => (
                                <button
                                    key={s}
                                    onClick={() => { setStatusFilter(s as any); setPage(1); }}
                                    className={`px-3 py-1.5 text-xs font-bold rounded-md capitalize transition-all ${statusFilter === s ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-500 hover:text-slate-700'
                                        }`}
                                >
                                    {s}
                                </button>
                            ))}
                        </div>
                    </div>
                </div>

                {/* Table */}
                <div className="overflow-x-auto min-h-[400px]">
                    <table className="w-full text-left">
                        <thead className="bg-slate-50 border-b border-slate-100">
                            <tr>
                                <th className="p-4 text-xs font-bold text-slate-500 uppercase tracking-wider w-10">St</th>
                                <th className="p-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Name</th>
                                <th className="p-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Balance / Limit</th>
                                <th className="p-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Last Order</th>
                                <th className="p-4 text-xs font-bold text-slate-500 uppercase tracking-wider text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-100">
                            {loading ? (
                                <tr><td colSpan={5} className="p-12 text-center text-slate-400">Loading...</td></tr>
                            ) : customers.length === 0 ? (
                                <tr><td colSpan={5} className="p-12 text-center text-slate-400">No customers found.</td></tr>
                            ) : (
                                customers.map(c => {
                                    const limit = c.credit_limit || 50000;
                                    const usage = (c.current_balance < 0 ? 0 : c.current_balance / limit) * 100;
                                    const isDefaulter = c.current_balance > limit;

                                    return (
                                        <tr key={c.id} className={`hover:bg-slate-50 transition-colors group ${isDefaulter ? 'bg-red-50/50' : ''}`}>
                                            <td className="p-4">
                                                <div className={`w-2.5 h-2.5 rounded-full ${c.is_active ? 'bg-emerald-500' : 'bg-slate-300'}`} title={c.is_active ? "Active" : "Inactive"} />
                                            </td>
                                            <td className="p-4">
                                                <div className="font-bold text-slate-900">{c.name}</div>
                                                <div className="text-xs text-slate-500 font-medium flex items-center gap-1">
                                                    <Phone size={10} /> {c.phone}
                                                </div>
                                            </td>
                                            <td className="p-4 w-64">
                                                <div className="flex justify-between items-baseline mb-1">
                                                    <span className={`text-sm font-black ${c.current_balance > 0 ? 'text-red-600' : 'text-emerald-600'}`}>
                                                        Rs {c.current_balance.toLocaleString()}
                                                    </span>
                                                    <span className="text-[10px] font-bold text-slate-400">Limit: {limit / 1000}k</span>
                                                </div>
                                                <div className="w-full bg-slate-200 h-1.5 rounded-full overflow-hidden">
                                                    <div
                                                        className={`h-full rounded-full ${usage > 90 ? 'bg-red-500' : 'bg-blue-500'}`}
                                                        style={{ width: `${Math.min(usage, 100)}%` }}
                                                    />
                                                </div>
                                            </td>
                                            <td className="p-4 text-sm font-bold text-slate-600">
                                                {c.last_order_at ? new Date(c.last_order_at).toLocaleDateString() : '-'}
                                            </td>
                                            <td className="p-4 text-right">
                                                <div className="flex items-center justify-end gap-2 relative">
                                                    <Link href={`/admin/customers/${c.id}`} className="p-2 text-slate-400 hover:text-emerald-600 hover:bg-emerald-50 rounded-lg transition-all" title="View Ledger">
                                                        <ArrowRight size={18} />
                                                    </Link>

                                                    <button
                                                        onClick={() => setActionMenuOpen(actionMenuOpen === c.id ? null : c.id)}
                                                        className="p-2 text-slate-300 hover:text-slate-600 rounded-lg"
                                                    >
                                                        <MoreVertical size={18} />
                                                    </button>

                                                    {/* Quick Action Dropdown */}
                                                    {actionMenuOpen === c.id && (
                                                        <div className="absolute right-0 top-10 bg-white shadow-xl border border-slate-100 rounded-lg w-40 py-2 z-10 animate-in fade-in zoom-in-95 duration-100">
                                                            <button
                                                                onClick={() => { setEditingCustomer(c); setActionMenuOpen(null); }}
                                                                className="w-full text-left px-4 py-2 text-xs font-bold text-slate-600 hover:bg-slate-50 flex items-center gap-2"
                                                            >
                                                                <Edit2 size={14} /> Edit Details
                                                            </button>
                                                            <button
                                                                onClick={() => handleToggleStatus(c.id, c.is_active)}
                                                                className={`w-full text-left px-4 py-2 text-xs font-bold flex items-center gap-2 ${c.is_active ? 'text-red-600 hover:bg-red-50' : 'text-emerald-600 hover:bg-emerald-50'}`}
                                                            >
                                                                {c.is_active ? <><Ban size={14} /> Deactivate</> : <><CheckCircle size={14} /> Activate</>}
                                                            </button>
                                                        </div>
                                                    )}
                                                </div>
                                            </td>
                                        </tr>
                                    );
                                })
                            )}
                        </tbody>
                    </table>
                </div>

                {/* Pagination Footer */}
                <div className="p-4 border-t border-slate-200 bg-slate-50 flex justify-between items-center">
                    <p className="text-xs font-bold text-slate-500">
                        Showing {((page - 1) * limit) + 1} - {Math.min(page * limit, totalCount)} of {totalCount}
                    </p>
                    <div className="flex gap-2">
                        <button
                            onClick={() => setPage(p => Math.max(1, p - 1))}
                            disabled={page === 1}
                            className="px-3 py-1 bg-white border border-slate-300 rounded text-xs font-bold text-slate-600 disabled:opacity-50 hover:bg-slate-50"
                        >
                            Prev
                        </button>
                        <button
                            onClick={() => setPage(p => Math.min(totalPages, p + 1))}
                            disabled={page === totalPages || totalPages === 0}
                            className="px-3 py-1 bg-white border border-slate-300 rounded text-xs font-bold text-slate-600 disabled:opacity-50 hover:bg-slate-50"
                        >
                            Next
                        </button>
                    </div>
                </div>
            </div>

            {/* Modals */}
            {showAddModal && <AddCustomerModal onClose={() => setShowAddModal(false)} onSuccess={() => { loadData(); loadStats(); }} />}
            {editingCustomer && <EditCustomerModal customer={editingCustomer} onClose={() => setEditingCustomer(null)} onSuccess={() => { loadData(); loadStats(); }} />}
            {showImportModal && <CustomerImportModal onClose={() => setShowImportModal(false)} onSuccess={() => { loadData(); loadStats(); }} />}
        </div>
    );
}
</file>

<file path="src/app/(dashboard)/admin/cylinders/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import { createClient } from '@/utils/supabase/client';
import { toast } from 'sonner';
import {
    Plus, Filter, RefreshCw, UploadCloud, QrCode, Truck,
    MoreVertical, Edit, Trash2, Database, Box, CheckCircle
} from 'lucide-react';
import {
    DropdownMenu,
    DropdownMenuContent,
    DropdownMenuItem,
    DropdownMenuLabel,
    DropdownMenuSeparator,
    DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import {
    AlertDialog,
    AlertDialogAction,
    AlertDialogCancel,
    AlertDialogContent,
    AlertDialogDescription,
    AlertDialogFooter,
    AlertDialogHeader,
    AlertDialogTitle,
    AlertDialogTrigger,
} from "@/components/ui/alert-dialog";
import QRCodeGenerator from '@/components/admin/QRCodeGenerator';
import StockImportModal from '@/components/admin/inventory/StockImportModal';
import PlantOperationsModal from '@/components/admin/inventory/PlantOperationsModal';
import { getTenantInfo } from '@/app/actions/adminActions';
import {
    createCylinder,
    getCylinders,
    updateCylinderStatus,
    updateCylinder,
    deleteCylinder
} from '@/app/actions/cylinderActions';
import { Badge } from "@/components/ui/badge";

interface Cylinder {
    id: string;
    serial_number: string;
    type: '45.4KG';
    status: 'full' | 'empty' | 'missing' | 'maintenance' | 'at_customer';
    current_location_type: 'warehouse' | 'shop' | 'driver' | 'customer';
    condition: string;
    holder_name?: string;
    tenant_id?: string;
    updated_at: string;
}

export default function CylinderRegistry() {
    const supabase = createClient();
    const [cylinders, setCylinders] = useState<Cylinder[]>([]);
    const [loading, setLoading] = useState(true);
    const [generating, setGenerating] = useState(false);
    const [searchTerm, setSearchTerm] = useState('');
    const [showQRModal, setShowQRModal] = useState(false);
    const [showImportModal, setShowImportModal] = useState(false);
    const [showPlantModal, setShowPlantModal] = useState(false);
    const [showBulkModal, setShowBulkModal] = useState(false);
    const [tenantId, setTenantId] = useState('');
    const [tenantName, setTenantName] = useState('');

    // Bulk Form State
    const [bulkPrefix, setBulkPrefix] = useState('');
    const [bulkStart, setBulkStart] = useState('');
    const [bulkEnd, setBulkEnd] = useState('');

    // Selection State
    const [selectedIds, setSelectedIds] = useState<string[]>([]);
    const [refilling, setRefilling] = useState(false);

    // Edit State
    const [editingId, setEditingId] = useState<string | null>(null);
    const [editSerial, setEditSerial] = useState('');

    // Delete State
    const [deleteTarget, setDeleteTarget] = useState<{ id: string, serial: string } | null>(null);

    useEffect(() => {
        loadData();
    }, []);

    const loadData = async () => {
        setLoading(true);
        try {
            const info = await getTenantInfo();
            setTenantName(info.name || "My Organization");

            const generatedPrefix = (info.name || "My Organization")
                .split(' ')
                .map((word: string) => word[0])
                .join('')
                .toUpperCase() + "-";
            setBulkPrefix(generatedPrefix);

            const data = await getCylinders();
            // @ts-ignore
            setCylinders(data);

            const { data: { user } } = await supabase.auth.getUser();
            if (user?.app_metadata?.tenant_id) {
                setTenantId(user.app_metadata.tenant_id);
            }

        } catch (error) {
            toast.error('Failed to load inventory data');
            console.error(error);
        } finally {
            setLoading(false);
        }
    };

    const handleRefill = async () => {
        if (selectedIds.length === 0) return;
        setRefilling(true);
        try {
            const promises = selectedIds.map(id => updateCylinderStatus(id, 'full'));
            await Promise.all(promises);
            toast.success(`Refilled ${selectedIds.length} cylinders!`);
            setSelectedIds([]);
            await loadData();
        } catch (error: any) {
            toast.error('Refill failed: ' + error.message);
        } finally {
            setRefilling(false);
        }
    };

    // Bulk Generator Logic
    const handleBulkGenerate = async (e: React.FormEvent) => {
        e.preventDefault();
        const start = parseInt(bulkStart);
        const end = parseInt(bulkEnd);

        if (isNaN(start) || isNaN(end) || start > end) {
            toast.error('Invalid number range');
            return;
        }

        if (end - start > 500) {
            toast.error('Please limit bulk to 500 at a time');
            return;
        }

        setGenerating(true);
        let successCount = 0;
        let errors = 0;

        try {
            // Loop creation (reusing existing logic from previous page)
            for (let i = start; i <= end; i++) {
                const numStr = i.toString().padStart(3, '0');
                const serial = `${bulkPrefix}${numStr}`;

                const formData = new FormData();
                formData.append('serial_number', serial);
                formData.append('type', '45.4KG');
                formData.append('status', 'full');

                const result = await createCylinder(null, formData);
                if (result?.error) errors++;
                else successCount++;
            }

            if (errors > 0) toast.warning(`Generated ${successCount}. ${errors} failed.`);
            else toast.success(`Generated ${successCount} cylinders!`);

            setBulkStart('');
            setBulkEnd('');
            setShowBulkModal(false);
            await loadData();

        } catch (error: any) {
            toast.error(error.message);
        } finally {
            setGenerating(false);
        }
    };

    const handleEdit = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!editingId || !editSerial) return;

        try {
            const result = await updateCylinder(editingId, editSerial);
            if (result.error) throw new Error(result.error);
            toast.success("Updated successfully");
            setEditingId(null);
            loadData();
        } catch (error: any) {
            toast.error(error.message);
        }
    };

    const confirmDelete = async () => {
        if (!deleteTarget) return;
        try {
            const result = await deleteCylinder(deleteTarget.id);
            if (result.error) throw new Error(result.error);
            toast.success("Deleted successfully");
            setDeleteTarget(null);
            loadData();
        } catch (error: any) {
            toast.error(error.message);
        }
    };

    const filteredCylinders = cylinders.filter(c =>
        c.serial_number.toLowerCase().includes(searchTerm.toLowerCase())
    );

    const toggleSelect = (id: string) => {
        if (selectedIds.includes(id)) setSelectedIds(selectedIds.filter(i => i !== id));
        else setSelectedIds([...selectedIds, id]);
    };

    const toggleSelectAll = () => {
        if (selectedIds.length === filteredCylinders.length) setSelectedIds([]);
        else setSelectedIds(filteredCylinders.map(c => c.id));
    };

    // Stats
    const totalCount = cylinders.length;
    const fullCount = cylinders.filter(c => c.status === 'full').length;
    const emptyCount = cylinders.filter(c => c.status === 'empty').length;
    const atPlantCount = cylinders.filter(c => c.status === 'maintenance').length;


    // Helper for Status Badge
    const getStatusBadge = (status: string) => {
        switch (status) {
            case 'full': return <Badge className="bg-emerald-100 text-emerald-700 hover:bg-emerald-200 border-emerald-200 shadow-none">Full</Badge>;
            case 'empty': return <Badge className="bg-slate-100 text-slate-700 hover:bg-slate-200 border-slate-200 shadow-none">Empty</Badge>;
            case 'maintenance': return <Badge className="bg-orange-100 text-orange-700 hover:bg-orange-200 border-orange-200 shadow-none">Maintenance</Badge>;
            case 'at_customer': return <Badge className="bg-blue-100 text-blue-700 hover:bg-blue-200 border-blue-200 shadow-none">At Customer</Badge>;
            case 'missing': return <Badge className="bg-rose-100 text-rose-700 hover:bg-rose-200 border-rose-200 shadow-none">Missing</Badge>;
            default: return <Badge variant="outline">{status}</Badge>;
        }
    };

    return (
        <div className="p-8 space-y-8 bg-slate-50/50 min-h-screen pb-32">

            {/* Header */}
            <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h1 className="text-3xl font-bold tracking-tight text-slate-900">Inventory Registry</h1>
                    <p className="text-slate-500 mt-1 font-medium">Manage gas cylinders and meaningful assets for {tenantName}</p>
                </div>
                <div className="flex gap-2">
                    <button onClick={() => setShowPlantModal(true)} className="flex items-center gap-2 px-4 py-2 text-sm font-semibold text-orange-700 bg-orange-50 hover:bg-orange-100 border border-orange-200 rounded-lg transition-colors">
                        <Truck size={16} /> Plant Operations
                    </button>
                    <button onClick={() => setShowBulkModal(true)} className="flex items-center gap-2 px-4 py-2 text-sm font-semibold text-white bg-emerald-600 hover:bg-emerald-700 rounded-lg shadow-sm shadow-emerald-200 transition-all active:scale-95">
                        <Plus size={18} /> Add Stock
                    </button>
                </div>
            </div>

            {/* Stats Cards */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <StatCard title="Total Assets" value={totalCount} icon={<Database className="text-blue-600" />} />
                <StatCard title="Filled Cylinders" value={fullCount} icon={<CheckCircle className="text-emerald-600" />} />
                <StatCard title="Empty Cylinders" value={emptyCount} icon={<Box className="text-slate-600" />} />
                <StatCard title="At Plant" value={atPlantCount} icon={<Truck className="text-orange-600" />} />
            </div>

            {/* Main Content */}
            <div className="bg-white border boundary-slate-200 rounded-xl shadow-sm overflow-hidden">
                {/* Search Bar */}
                <div className="p-4 border-b border-slate-100 flex items-center justify-between gap-4">
                    <div className="relative flex-1 max-w-sm">
                        <Filter className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={16} />
                        <input
                            type="text"
                            placeholder="Search by serial number..."
                            className="w-full pl-9 pr-4 py-2 text-sm border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all"
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                        />
                    </div>
                    <div className="flex items-center gap-2">
                        <button onClick={() => setShowImportModal(true)} className="text-sm font-medium text-slate-600 hover:text-slate-900 flex items-center gap-2 px-3 py-2 hover:bg-slate-50 rounded-lg transition-colors">
                            <UploadCloud size={16} /> Legacy Import
                        </button>
                    </div>
                </div>

                {/* Table */}
                <div className="overflow-x-auto">
                    <table className="w-full text-left text-sm">
                        <thead className="bg-slate-50 border-b border-slate-100 text-slate-500 font-semibold uppercase tracking-wider">
                            <tr>
                                <th className="p-4 w-[40px]">
                                    <input type="checkbox" className="rounded border-slate-300 text-emerald-600 focus:ring-emerald-500"
                                        checked={filteredCylinders.length > 0 && selectedIds.length === filteredCylinders.length}
                                        onChange={toggleSelectAll}
                                    />
                                </th>
                                <th className="p-4">Serial #</th>
                                <th className="p-4">Status</th>
                                <th className="p-4">Location</th>
                                <th className="p-4">Last Update</th>
                                <th className="p-4 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-50">
                            {filteredCylinders.length === 0 ? (
                                <tr>
                                    <td colSpan={6} className="p-12 text-center text-slate-400">
                                        No assets found matching your search.
                                    </td>
                                </tr>
                            ) : (
                                filteredCylinders.map((cyl) => (
                                    <tr key={cyl.id} className="hover:bg-slate-50/80 transition-colors group">
                                        <td className="p-4">
                                            <input type="checkbox" className="rounded border-slate-300 text-emerald-600 focus:ring-emerald-500"
                                                checked={selectedIds.includes(cyl.id)}
                                                onChange={() => toggleSelect(cyl.id)}
                                            />
                                        </td>
                                        <td className="p-4 font-bold text-slate-900">{cyl.serial_number}</td>
                                        <td className="p-4">{getStatusBadge(cyl.status)}</td>
                                        <td className="p-4">
                                            <div className="flex flex-col">
                                                <span className="font-medium text-slate-700 capitalize">{cyl.current_location_type}</span>
                                                {cyl.holder_name && cyl.current_location_type !== 'warehouse' && (
                                                    <span className="text-xs text-slate-500">{cyl.holder_name}</span>
                                                )}
                                            </div>
                                        </td>
                                        <td className="p-4 text-slate-500">
                                            {new Date(cyl.updated_at).toLocaleDateString()}
                                        </td>
                                        <td className="p-4 text-right">
                                            <DropdownMenu>
                                                <DropdownMenuTrigger className="p-2 hover:bg-slate-100 rounded-full transition-colors outline-none text-slate-400 hover:text-slate-600">
                                                    <MoreVertical size={16} />
                                                </DropdownMenuTrigger>
                                                <DropdownMenuContent align="end">
                                                    <DropdownMenuLabel>Actions</DropdownMenuLabel>
                                                    <DropdownMenuItem onClick={() => {
                                                        setEditingId(cyl.id);
                                                        setEditSerial(cyl.serial_number);
                                                    }}>
                                                        <Edit className="mr-2 h-4 w-4" /> Edit Serial
                                                    </DropdownMenuItem>
                                                    <DropdownMenuSeparator />
                                                    <DropdownMenuItem className="text-rose-600 focus:text-rose-600" onClick={() => setDeleteTarget({ id: cyl.id, serial: cyl.serial_number })}>
                                                        <Trash2 className="mr-2 h-4 w-4" /> Delete Asset
                                                    </DropdownMenuItem>
                                                </DropdownMenuContent>
                                            </DropdownMenu>
                                        </td>
                                    </tr>
                                ))
                            )}
                        </tbody>
                    </table>
                </div>
            </div>

            {/* Bulk Action Bar - Preserved Functionality */}
            {selectedIds.length > 0 && (
                <div className="fixed bottom-8 left-1/2 -translate-x-1/2 z-50 w-[90%] max-w-lg animate-in slide-in-from-bottom-4 fade-in duration-200">
                    <div className="bg-slate-900/95 backdrop-blur-md text-white p-3 px-6 rounded-2xl shadow-xl border border-slate-800 flex items-center justify-between">
                        <span className="font-bold text-sm tracking-wide">{selectedIds.length} Selected</span>
                        <div className="flex items-center gap-3">
                            {/* Contextual Actions */}
                            {selectedIds.length > 0 && (
                                <button
                                    onClick={() => setShowQRModal(true)}
                                    className="p-2 hover:bg-white/10 rounded-lg transition-colors text-slate-300 hover:text-white" title="Print QR"
                                >
                                    <QrCode size={18} />
                                </button>
                            )}

                            {/* Refill Action (Only for Empty) */}
                            {filteredCylinders.filter(c => selectedIds.includes(c.id)).every(c => c.status === 'empty') && (
                                <button
                                    onClick={handleRefill}
                                    disabled={refilling}
                                    className="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-1.5 rounded-lg text-sm font-semibold transition-colors flex items-center gap-2"
                                >
                                    {refilling ? 'Processing...' : <><RefreshCw size={14} /> Refill</>}
                                </button>
                            )}

                            {/* Clear Selection */}
                            <button onClick={() => setSelectedIds([])} className="ml-2 text-xs font-bold text-slate-500 hover:text-slate-300 uppercase tracking-wider">
                                Clear
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Modals */}
            {showQRModal && (
                <QRCodeGenerator
                    serialNumbers={filteredCylinders.filter(c => selectedIds.includes(c.id)).map(c => c.serial_number)}
                    tenantId={tenantId}
                    onClose={() => setShowQRModal(false)}
                />
            )}

            {showImportModal && (
                <StockImportModal
                    onClose={() => setShowImportModal(false)}
                    onSuccess={() => loadData()}
                />
            )}

            {showPlantModal && (
                <PlantOperationsModal
                    onClose={() => setShowPlantModal(false)}
                    onSuccess={() => loadData()}
                    emptyCount={emptyCount}
                    maintenanceCount={atPlantCount}
                />
            )}

            {/* Bulk Generate Modal (Simple Version) */}
            {showBulkModal && (
                <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-in fade-in zoom-in-95 duration-200">
                    <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden">
                        <div className="p-6 border-b border-slate-100">
                            <h3 className="text-xl font-bold text-slate-900">Add New Assets</h3>
                            <p className="text-sm text-slate-500">Generate serial numbers in bulk.</p>
                        </div>
                        <form onSubmit={handleBulkGenerate} className="p-6 space-y-4">
                            <div>
                                <label className="text-xs font-bold text-slate-500 uppercase">Prefix</label>
                                <input type="text" value={bulkPrefix} readOnly className="w-full mt-1 p-3 bg-slate-50 border border-slate-200 rounded-xl text-slate-500 font-mono text-sm" />
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="text-xs font-bold text-slate-500 uppercase">Start #</label>
                                    <input type="number" required value={bulkStart} onChange={(e) => setBulkStart(e.target.value)} className="w-full mt-1 p-3 border border-slate-200 rounded-xl font-mono focus:ring-2 focus:ring-emerald-500/20 outline-none transition-all" placeholder="001" />
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-slate-500 uppercase">End #</label>
                                    <input type="number" required value={bulkEnd} onChange={(e) => setBulkEnd(e.target.value)} className="w-full mt-1 p-3 border border-slate-200 rounded-xl font-mono focus:ring-2 focus:ring-emerald-500/20 outline-none transition-all" placeholder="100" />
                                </div>
                            </div>
                            <div className="pt-4 flex gap-3">
                                <button type="button" onClick={() => setShowBulkModal(false)} className="flex-1 py-3 text-slate-600 font-bold hover:bg-slate-50 rounded-xl transition-colors">Cancel</button>
                                <button type="submit" disabled={generating} className="flex-1 py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-xl shadow-lg shadow-emerald-200 transition-all active:scale-95 disabled:opacity-50 disabled:pointer-events-none">
                                    {generating ? 'Generating...' : 'Generate Assets'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            )}

            {/* Edit Serial Modal */}
            {editingId && (
                <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6">
                        <h3 className="text-lg font-bold text-slate-900 mb-4">Edit Serial Number</h3>
                        <form onSubmit={handleEdit} className="space-y-4">
                            <input
                                type="text"
                                value={editSerial}
                                onChange={(e) => setEditSerial(e.target.value)}
                                className="w-full p-3 border border-slate-200 rounded-xl font-mono uppercase focus:ring-2 focus:ring-emerald-500/20 outline-none"
                                autoFocus
                            />
                            <div className="flex gap-3">
                                <button type="button" onClick={() => setEditingId(null)} className="flex-1 py-2 text-slate-600 font-bold hover:bg-slate-50 rounded-xl">Cancel</button>
                                <button type="submit" className="flex-1 py-2 bg-slate-900 text-white font-bold rounded-xl hover:bg-slate-800">Update</button>
                            </div>
                        </form>
                    </div>
                </div>
            )}
            {/* DELETE ALERT DIALOG */}
            <AlertDialog open={!!deleteTarget} onOpenChange={(open) => !open && setDeleteTarget(null)}>
                <AlertDialogContent>
                    <AlertDialogHeader>
                        <AlertDialogTitle>Are you absolutely sure?</AlertDialogTitle>
                        <AlertDialogDescription>
                            This action cannot be undone. This will permanently delete cylinder
                            <span className="font-bold text-slate-900"> {deleteTarget?.serial} </span>
                            from the database.
                        </AlertDialogDescription>
                    </AlertDialogHeader>
                    <AlertDialogFooter>
                        <AlertDialogCancel>Cancel</AlertDialogCancel>
                        <AlertDialogAction onClick={confirmDelete} className="bg-red-600 hover:bg-red-700 text-white border-0">
                            Delete
                        </AlertDialogAction>
                    </AlertDialogFooter>
                </AlertDialogContent>
            </AlertDialog>
        </div>
    )
}



function StatCard({ title, value, icon }: { title: string, value: number, icon: React.ReactNode }) {
    return (
        <div className="bg-white p-6 rounded-xl border border-slate-100 shadow-sm flex items-center justify-between hover:shadow-md transition-shadow">
            <div>
                <p className="text-sm font-medium text-slate-500 mb-1">{title}</p>
                <div className="text-2xl font-bold text-slate-900">{value}</div>
            </div>
            <div className="h-10 w-10 bg-slate-50 rounded-full flex items-center justify-center border border-slate-100">
                {icon}
            </div>
        </div>
    )
}
</file>

<file path="src/app/(dashboard)/admin/expenses/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import { getExpenses, getExpenseStats, approveExpense, rejectExpense } from '@/app/actions/adminExpenseActions';
import { toast } from 'sonner';
import { Check, X, Eye, BanknoteIcon, Clock, ChartBar, DownloadCloud, AlertCircle } from 'lucide-react';
import { User, FileText } from 'lucide-react';

type Expense = {
    id: string;
    created_at: string;
    amount: number;
    category: string;
    description?: string;
    proof_url: string;
    status: 'pending' | 'approved' | 'rejected';
    profiles: { full_name: string };
};

type Stats = {
    monthSpend: number;
    pendingLiability: number;
    topCategory: { name: string; amount: number; percentage: number };
    weeklyTrend: { date: string; amount: number }[];
};

export default function AdminExpensesPage() {
    const [activeTab, setActiveTab] = useState<'pending' | 'approved' | 'rejected'>('pending');
    const [expenses, setExpenses] = useState<Expense[]>([]);
    const [stats, setStats] = useState<Stats | null>(null);
    const [loading, setLoading] = useState(true);
    const [loadingStats, setLoadingStats] = useState(true);

    // Modal State
    const [showProofModal, setShowProofModal] = useState(false);
    const [selectedProofUrl, setSelectedProofUrl] = useState<string | null>(null);
    const [confirmAction, setConfirmAction] = useState<{ type: 'approve' | 'reject'; id: string; amount: number; name: string } | null>(null);
    const [processingId, setProcessingId] = useState<string | null>(null);

    useEffect(() => {
        loadData();
    }, [activeTab]);

    const loadData = async () => {
        setLoading(true);
        // Load Lists
        const data = await getExpenses(activeTab);
        setExpenses(data as Expense[]);
        setLoading(false);

        // Load Stats only once or on specific triggers if needed.
        if (!stats) {
            setLoadingStats(true);
            const statsData = await getExpenseStats();
            setStats(statsData);
            setLoadingStats(false);
        }
    };

    const handleActionClick = (type: 'approve' | 'reject', expense: Expense) => {
        setConfirmAction({
            type,
            id: expense.id,
            amount: expense.amount,
            name: expense.profiles?.full_name || 'Unknown Driver'
        });
    };

    const confirmActionHandler = async () => {
        if (!confirmAction) return;
        setProcessingId(confirmAction.id);

        let res;
        if (confirmAction.type === 'approve') {
            res = await approveExpense(confirmAction.id);
        } else {
            res = await rejectExpense(confirmAction.id);
        }

        setProcessingId(null);
        setConfirmAction(null);

        if (res.success) {
            toast.success(`Expense ${confirmAction.type === 'approve' ? 'Approved' : 'Rejected'}!`);
            loadData(); // Reload both list and stats as amounts changed
        } else {
            toast.error(res.error || "Action Failed");
        }
    };

    const exportCSV = () => {
        if (expenses.length === 0) {
            toast.error("No data to export");
            return;
        }

        const headers = ["ID", "Date", "Driver", "Category", "Amount", "Status", "Description"];
        const rows = expenses.map(e => [
            e.id,
            new Date(e.created_at).toLocaleDateString(),
            e.profiles?.full_name || 'Unknown',
            e.category,
            e.amount,
            e.status,
            e.description || ''
        ]);

        const csvContent = [
            headers.join(','),
            ...rows.map(r => r.map(c => `"${c}"`).join(','))
        ].join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `expenses-${activeTab}-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
    };

    const openProof = (url: string) => {
        setSelectedProofUrl(url);
        setShowProofModal(true);
    };

    const formatCurrency = (amount: number) => {
        return `Rs. ${amount.toLocaleString()}`;
    };

    // Calculate chart total for empty state check
    const chartTotal = stats?.weeklyTrend.reduce((acc, curr) => acc + curr.amount, 0) || 0;

    return (
        <div className="min-h-screen bg-slate-50 p-8 space-y-8 font-sans">
            <div className="max-w-7xl mx-auto space-y-8">

                {/* 1. Header */}
                <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div>
                        <h1 className="text-3xl font-bold text-slate-800 tracking-tight">Financial Dashboard</h1>
                        <p className="text-slate-500">Manage expenses and approve requests.</p>
                    </div>
                    <button
                        onClick={exportCSV}
                        className="flex items-center gap-2 px-4 py-2 bg-white border border-slate-200 text-slate-700 font-semibold rounded-lg shadow-sm hover:bg-slate-50 transition-colors"
                    >
                        <DownloadCloud size={18} /> Export CSV
                    </button>
                </div>

                {/* 2. Stats Grid */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                    {/* Card 1: Month Spend */}
                    <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex items-start justify-between">
                        <div>
                            <p className="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-1">Month's Spend</p>
                            <h2 className="text-3xl font-black text-slate-800">
                                {loadingStats ? '...' : formatCurrency(stats?.monthSpend || 0)}
                            </h2>
                            <p className="text-emerald-600 text-xs font-bold mt-2 flex items-center gap-1">
                                <Check size={12} /> Approved Limit
                            </p>
                        </div>
                        <div className="p-3 bg-emerald-50 text-emerald-600 rounded-xl">
                            <BanknoteIcon size={24} />
                        </div>
                    </div>

                    {/* Card 2: Pending Liability */}
                    <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex items-start justify-between">
                        <div>
                            <p className="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-1">Pending Liability</p>
                            <h2 className="text-3xl font-black text-slate-800">
                                {loadingStats ? '...' : formatCurrency(stats?.pendingLiability || 0)}
                            </h2>
                            <p className="text-orange-500 text-xs font-bold mt-2 flex items-center gap-1">
                                <Clock size={12} /> Needs Approval
                            </p>
                        </div>
                        <div className="p-3 bg-orange-50 text-orange-500 rounded-xl">
                            <AlertCircle size={24} />
                        </div>
                    </div>

                    {/* Card 3: Top Category */}
                    <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex items-start justify-between">
                        <div>
                            <p className="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-1">Top Category</p>
                            <h2 className="text-3xl font-black text-slate-800">
                                {loadingStats ? '...' : stats?.topCategory.name}
                            </h2>
                            <div className="mt-2 w-full bg-slate-100 rounded-full h-1.5 overflow-hidden max-w-[100px]">
                                <div className="h-full bg-blue-500" style={{ width: `${stats?.topCategory.percentage || 0}%` }}></div>
                            </div>
                            <p className="text-slate-400 text-xs mt-1 font-medium">{stats?.topCategory.percentage || 0}% of spend</p>
                        </div>
                        <div className="p-3 bg-blue-50 text-blue-600 rounded-xl">
                            <ChartBar size={24} />
                        </div>
                    </div>
                </div>

                {/* 3. Tabs */}
                <div className="flex items-center gap-2 border-b border-slate-200">
                    {(['pending', 'approved', 'rejected'] as const).map((tab) => (
                        <button
                            key={tab}
                            onClick={() => setActiveTab(tab)}
                            className={`px-6 py-3 text-sm font-bold capitalize transition-all border-b-2 ${activeTab === tab
                                ? 'border-slate-800 text-slate-800'
                                : 'border-transparent text-slate-400 hover:text-slate-600'
                                }`}
                        >
                            {tab}
                        </button>
                    ))}
                </div>

                {/* 4. Chart & List Content */}
                <div className="space-y-6">

                    {/* Chart - Only for Approved Tab */}
                    {activeTab === 'approved' && (
                        <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                            <h3 className="text-lg font-bold text-slate-800 mb-6">Last 7 Days Spending</h3>

                            {loadingStats ? (
                                <div className="h-40 flex items-center justify-center text-slate-300">Loading Trends...</div>
                            ) : chartTotal === 0 ? (
                                <div className="h-40 flex items-center justify-center text-slate-400 font-medium bg-slate-50/50 rounded-lg">
                                    No spending activity this week.
                                </div>
                            ) : (
                                <div className="h-40 flex items-end justify-between gap-4 px-4">
                                    {stats?.weeklyTrend.map((day, idx) => {
                                        const maxVal = Math.max(...(stats?.weeklyTrend.map(d => d.amount) || [1]));
                                        // Ensure at least a sliver if > 0, else 0 height if 0.
                                        const height = day.amount === 0 ? 0 : Math.max(2, (day.amount / maxVal) * 100);

                                        return (
                                            <div key={idx} className="flex-1 flex flex-col items-center gap-2 group h-full justify-end">
                                                <div className="relative w-full max-w-[60px] rounded-t-lg bg-emerald-100/30 hover:bg-emerald-100 transition-colors h-full flex items-end overflow-visible">
                                                    {/* Bar */}
                                                    <div
                                                        className="w-full bg-emerald-500 rounded-t-lg transition-all duration-500 hover:bg-emerald-600"
                                                        style={{ height: `${height}%` }}
                                                    ></div>

                                                    {/* Tooltip */}
                                                    <div className="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-xs font-bold py-1.5 px-3 rounded shadow-xl opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-10 pointer-events-none">
                                                        Rs. {day.amount.toLocaleString()}
                                                    </div>
                                                </div>
                                                <span className="text-xs font-bold text-slate-400 uppercase">{day.date}</span>
                                            </div>
                                        )
                                    })}
                                </div>
                            )}
                        </div>
                    )}

                    {/* List */}
                    {loading ? (
                        <div className="text-center py-20 text-slate-400 animate-pulse">Loading records...</div>
                    ) : expenses.length === 0 ? (
                        <div className="flex flex-col items-center justify-center py-20 bg-white rounded-xl border border-slate-200 shadow-sm border-dashed">
                            <div className="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mb-4">
                                <FileText size={32} className="text-slate-300" />
                            </div>
                            <h3 className="text-lg font-bold text-slate-800">No {activeTab} expenses</h3>
                            <p className="text-slate-500 text-sm">Everything looks clear here.</p>
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 gap-3">
                            {expenses.map((expense) => (
                                <div key={expense.id} className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-shadow flex flex-col md:flex-row items-start md:items-center justify-between gap-4">

                                    <div className="flex items-start gap-4">
                                        <div className={`w-12 h-12 rounded-xl flex items-center justify-center text-xl font-bold ${expense.category === 'Fuel' ? 'bg-blue-50 text-blue-600' :
                                            expense.category === 'Food' ? 'bg-orange-50 text-orange-600' :
                                                'bg-slate-100 text-slate-600'
                                            }`}>
                                            {expense.category[0]}
                                        </div>
                                        <div>
                                            <h3 className="font-bold text-slate-800 text-lg">{expense.category}</h3>
                                            <div className="flex items-center gap-2 text-sm text-slate-500 mt-1">
                                                <span className="flex items-center gap-1 font-medium text-slate-600">
                                                    <User size={14} /> {expense.profiles?.full_name || 'Unknown'}
                                                </span>
                                                <span className="w-1 h-1 rounded-full bg-slate-300"></span>
                                                <span>{new Date(expense.created_at).toLocaleDateString()}</span>
                                            </div>
                                            {expense.description && (
                                                <p className="text-sm text-slate-400 mt-1 max-w-md">{expense.description}</p>
                                            )}
                                        </div>
                                    </div>

                                    <div className="flex items-center gap-6 w-full md:w-auto justify-between md:justify-end">
                                        <div className="text-right">
                                            <p className="text-2xl font-black text-slate-900">
                                                {formatCurrency(expense.amount)}
                                            </p>
                                            <p className={`text-xs font-bold uppercase tracking-wider ${expense.status === 'approved' ? 'text-emerald-500' :
                                                expense.status === 'rejected' ? 'text-rose-500' : 'text-orange-500'
                                                }`}>
                                                {expense.status}
                                            </p>
                                        </div>

                                        <div className="flex items-center gap-2">
                                            <button
                                                onClick={() => openProof(expense.proof_url)}
                                                className="p-3 rounded-lg border border-slate-200 text-slate-500 hover:bg-slate-50 transition-colors"
                                                title="View Receipt"
                                            >
                                                <Eye size={20} />
                                            </button>

                                            {activeTab === 'pending' && (
                                                <>
                                                    <button
                                                        onClick={() => handleActionClick('reject', expense)}
                                                        disabled={!!processingId}
                                                        className="p-3 rounded-lg bg-rose-50 text-rose-600 border border-rose-100 hover:bg-rose-100 transition-colors disabled:opacity-50"
                                                        title="Reject"
                                                    >
                                                        <X size={20} />
                                                    </button>
                                                    <button
                                                        onClick={() => handleActionClick('approve', expense)}
                                                        disabled={!!processingId}
                                                        className="p-3 rounded-lg bg-emerald-50 text-emerald-600 border border-emerald-100 hover:bg-emerald-100 transition-colors disabled:opacity-50"
                                                        title="Approve"
                                                    >
                                                        <Check size={20} />
                                                    </button>
                                                </>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>

                {/* Proof Modal (unchanged styles) */}
                {showProofModal && (
                    <div className="fixed inset-0 z-50 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in duration-200" onClick={() => setShowProofModal(false)}>
                        <div className="relative bg-white rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden shadow-2xl scale-100 transition-all" onClick={e => e.stopPropagation()}>
                            <div className="absolute top-4 right-4 z-10">
                                <button onClick={() => setShowProofModal(false)} className="bg-white/10 hover:bg-white/20 text-white rounded-full p-2 backdrop-blur-md transition-colors">
                                    <X size={24} />
                                </button>
                            </div>
                            {selectedProofUrl ? (
                                <div className="w-full h-[80vh] bg-black flex items-center justify-center">
                                    <img
                                        src={selectedProofUrl}
                                        alt="Expense Proof"
                                        className="max-w-full max-h-full object-contain"
                                    />
                                </div>
                            ) : (
                                <div className="p-20 text-center text-slate-400">
                                    <p>No proof image available.</p>
                                </div>
                            )}
                        </div>
                    </div>
                )}

                {/* Confirm Action Modal (unchanged styles) */}
                {confirmAction && (
                    <div className="fixed inset-0 z-50 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in zoom-in duration-200">
                        <div className="bg-white rounded-2xl max-w-md w-full p-6 shadow-2xl relative overflow-hidden">
                            <h3 className="text-xl font-bold text-slate-800 mb-2">
                                {confirmAction.type === 'approve' ? 'Confirm Approval?' : 'Reject Request?'}
                            </h3>
                            <p className="text-slate-600 mb-6">
                                {confirmAction.type === 'approve'
                                    ? <span>Approve this expense for <span className="font-bold text-slate-900">{confirmAction.name}</span>?</span>
                                    : <span>Are you sure you want to reject this request from <span className="font-bold text-slate-900">{confirmAction.name}</span>?</span>
                                }
                            </p>

                            <div className="flex gap-3 justify-end">
                                <button
                                    onClick={() => setConfirmAction(null)}
                                    className="px-5 py-2.5 rounded-xl font-bold text-slate-500 hover:bg-slate-100 transition-colors"
                                >
                                    Cancel
                                </button>
                                <button
                                    onClick={confirmActionHandler}
                                    disabled={!!processingId}
                                    className={`px-6 py-2.5 rounded-xl font-bold text-white shadow-lg transition-transform active:scale-95 flex items-center gap-2 ${confirmAction.type === 'approve'
                                        ? 'bg-emerald-600 hover:bg-emerald-700 shadow-emerald-200'
                                        : 'bg-rose-600 hover:bg-rose-700 shadow-rose-200'
                                        }`}
                                >
                                    {processingId ? 'Processing...' : (confirmAction.type === 'approve' ? 'Confirm Approval' : 'Reject Expense')}
                                </button>
                            </div>
                        </div>
                    </div>
                )}

            </div>
        </div>
    );
}
</file>

<file path="src/app/(dashboard)/admin/finance/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import { getCompanyStats, getLedgerHistory } from '@/app/actions/financeActions';
import { RefreshCw, TrendingUp, TrendingDown, DollarSign, Calendar, User } from 'lucide-react';
import { format } from 'date-fns';

import { TransactionModal } from '@/components/admin/TransactionModal';

export default function FinanceDashboard() {
    const [stats, setStats] = useState({ totalBalance: 0 });
    const [history, setHistory] = useState<any[]>([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        loadData();
    }, []);

    const loadData = async () => {
        setLoading(true);
        const [statsData, historyData] = await Promise.all([
            getCompanyStats(),
            getLedgerHistory()
        ]);
        setStats(statsData);
        setHistory(historyData);
        setLoading(false);
    };

    return (
        <div className="space-y-8 animate-in fade-in duration-500 max-w-7xl mx-auto">
            <header className="flex justify-between items-center">
                <div>
                    <h1 className="text-3xl font-black text-slate-800 tracking-tight">Company Treasury</h1>
                    <p className="text-slate-500 font-medium mt-1">Live Cash Flow & Ledger</p>
                </div>
                <div className="flex items-center gap-3">
                    <button
                        onClick={loadData}
                        className="p-3 bg-white border border-slate-200 rounded-xl text-slate-600 hover:text-emerald-600 hover:border-emerald-200 transition-colors shadow-sm"
                        title="Refresh Data"
                    >
                        <RefreshCw size={20} className={loading ? 'animate-spin' : ''} />
                    </button>
                    <TransactionModal />
                </div>
            </header>

            {/* 1. STATS CARD */}
            <div className="grid gap-4 md:grid-cols-3">
                <div className="bg-white p-8 rounded-3xl shadow-sm border border-slate-100 flex flex-col justify-between h-48">
                    <div>
                        <p className="text-slate-500 font-bold uppercase tracking-wider text-xs mb-2">Total Cash in Safe</p>
                        <h2 className="text-4xl font-black tracking-tight text-emerald-600">
                            Rs {stats.totalBalance.toLocaleString()}
                        </h2>
                    </div>
                </div>

                {/* Placeholders for Future Stats (Bank, Receivables etc) */}
                <div className="bg-white p-8 rounded-3xl border border-slate-100 flex flex-col justify-center opacity-50 h-48">
                    <p className="text-slate-400 font-bold uppercase tracking-wider text-xs mb-2">Bank Balance</p>
                    <h2 className="text-3xl font-bold text-slate-300">Coming Soon</h2>
                </div>
            </div>

            {/* 2. LEDGER HISTORY */}
            <div className="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
                <div className="p-6 border-b border-slate-50 flex justify-between items-center">
                    <h3 className="font-bold text-lg text-slate-800">Recent Transactions</h3>
                    <span className="text-xs font-bold text-slate-400 uppercase tracking-wider">{history.length} Records</span>
                </div>

                <div className="overflow-x-auto">
                    <table className="w-full text-left text-sm">
                        <thead className="bg-slate-50 text-slate-500 font-bold border-b border-slate-100">
                            <tr>
                                <th className="px-6 py-4">Date</th>
                                <th className="px-6 py-4">Description</th>
                                <th className="px-6 py-4">Admin</th>
                                <th className="px-6 py-4 text-right">Amount</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-50">
                            {loading ? (
                                [1, 2, 3].map(i => (
                                    <tr key={i} className="animate-pulse">
                                        <td colSpan={4} className="px-6 py-6">
                                            <div className="h-4 bg-slate-100 rounded w-full"></div>
                                        </td>
                                    </tr>
                                ))
                            ) : history.length === 0 ? (
                                <tr>
                                    <td colSpan={4} className="px-6 py-12 text-center text-slate-400 italic">
                                        No transactions recorded yet.
                                    </td>
                                </tr>
                            ) : (
                                history.map((tx) => (
                                    <tr key={tx.id} className="hover:bg-slate-50/50 transition-colors">
                                        <td className="px-6 py-4 text-slate-500 font-medium">
                                            <div className="flex items-center gap-2">
                                                <Calendar size={14} className="text-slate-300" />
                                                {format(new Date(tx.created_at), 'MMM d, yyyy h:mm a')}
                                            </div>
                                        </td>
                                        <td className="px-6 py-4">
                                            <span className="font-bold text-slate-700 block">{tx.transaction_type.replace('_', ' ').toUpperCase()}</span>
                                            <span className="text-xs text-slate-400">{tx.description}</span>
                                        </td>
                                        <td className="px-6 py-4 text-slate-600">
                                            <div className="flex items-center gap-2">
                                                <div className="w-6 h-6 rounded-full bg-slate-100 flex items-center justify-center text-xs font-bold">
                                                    {tx.users?.name?.[0] || 'A'}
                                                </div>
                                                {tx.users?.name || 'Unknown'}
                                            </div>
                                        </td>
                                        <td className={`px-6 py-4 text-right font-black ${tx.amount >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                                            {tx.amount >= 0 ? '+' : ''}{tx.amount.toLocaleString()}
                                        </td>
                                    </tr>
                                ))
                            )}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="src/app/(dashboard)/admin/orders/new/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import { createClient } from '@/utils/supabase/client';
import { toast } from 'sonner';
import { ArrowLeft, Truck, Package, User, ScanBarcode, Check, ShoppingCart, List, X, Info } from 'lucide-react';
import Link from 'next/link';
import { useRouter } from 'next/navigation';
import { createOrder } from '@/app/actions/orderActions';
import { getCustomers } from '@/app/actions/customerActions';
import { getDrivers } from '@/app/actions/adminActions';
import { getAvailableStock } from '@/app/actions/cylinderActions';
import { getSettings } from '@/app/actions/settingsActions';

export default function NewOrderPage() {
    const supabase = createClient();
    const router = useRouter();

    // Data State
    const [customers, setCustomers] = useState<any[]>([]);
    const [drivers, setDrivers] = useState<any[]>([]);
    const [availableCylinders, setAvailableCylinders] = useState<any[]>([]);

    // Form State
    const [selectedCustomerId, setSelectedCustomerId] = useState('');
    const [selectedDriverId, setSelectedDriverId] = useState('');
    const [quantity, setQuantity] = useState(1);
    const [selectedSerials, setSelectedSerials] = useState<string[]>([]);

    // UI State
    const [isSerialModalOpen, setIsSerialModalOpen] = useState(false);
    const [submitting, setSubmitting] = useState(false);
    const [loadingStock, setLoadingStock] = useState(true);

    // Pricing State
    const [price, setPrice] = useState(0);
    const [productName, setProductName] = useState('LPG Cylinder 45.4KG');

    useEffect(() => {
        fetchData();
        fetchAvailableCylinders();
        fetchPrice();
    }, []);

    const fetchData = async () => {
        const [customersData, safeDrivers] = await Promise.all([
            getCustomers(1, 1000, '', 'active'),
            getDrivers()
        ]);
        // @ts-ignore
        setCustomers(customersData.data || []);
        setDrivers(safeDrivers as any[]);
    };

    const fetchPrice = async () => {
        const { settings } = await getSettings();
        if (settings?.default_gas_rate) {
            setPrice(settings.default_gas_rate);
        } else {
            // Fallback (or keep existing daily_rates logic if you prefer, but usually settings overrides)
            const { data } = await supabase.from('daily_rates').select('current_rate').eq('product_name', productName).single();
            setPrice(data?.current_rate || 11000);
        }
    };

    const fetchAvailableCylinders = async () => {
        setLoadingStock(true);
        const stock = await getAvailableStock();
        setAvailableCylinders(stock as any[]);
        setLoadingStock(false);
    };

    const calculateTotal = () => quantity * price;

    const toggleSerial = (serial: string) => {
        const isSelected = selectedSerials.includes(serial);
        if (isSelected) {
            setSelectedSerials(selectedSerials.filter(s => s !== serial));
        } else {
            if (selectedSerials.length >= quantity) {
                toast.error(`Quantity limit reached (${quantity}). Unselect one first.`);
                return;
            }
            setSelectedSerials([...selectedSerials, serial]);
        }
    };

    const autoSelectSerials = () => {
        if (availableCylinders.length < quantity) {
            toast.error("Not enough cylinders in stock!");
            return;
        }
        // Basic FIFO auto-select
        const toSelect = availableCylinders.slice(0, quantity).map(c => c.serial_number);
        setSelectedSerials(toSelect);
        toast.success(`Auto-selected ${quantity} cylinders`);
    };

    const handleDispatch = async () => {
        if (!selectedCustomerId || !selectedDriverId) {
            toast.error('Customer and Driver are required');
            return;
        }
        if (selectedSerials.length !== quantity) {
            toast.error(`Please select exactly ${quantity} serial numbers.`);
            setIsSerialModalOpen(true);
            return;
        }

        setSubmitting(true);
        try {
            const formData = new FormData();
            formData.append('customer_id', selectedCustomerId);
            formData.append('driver_id', selectedDriverId);
            formData.append('cylinders_count', quantity.toString());
            formData.append('total_amount', calculateTotal().toString());
            formData.append('product_name', productName);
            formData.append('price', price.toString());
            formData.append('serials', JSON.stringify(selectedSerials));

            const result = await createOrder(null, formData);

            if (result?.error) throw new Error(result.error);

            toast.success("Order Dispatch Successful!", {
                description: result.assignedSerials && result.assignedSerials.length > 0
                    ? `Assigned: ${result.assignedSerials.join(', ')}`
                    : "Drivers notified."
            });

            if (result.orderId) router.push(`/invoice/${result.orderId}`);
            else router.push('/admin/orders');

        } catch (error: any) {
            toast.error(error.message || "Dispatch failed");
        } finally {
            setSubmitting(false);
        }
    };

    // Derived State
    const currentCustomer = customers.find(c => c.id === selectedCustomerId);
    const isSatisfied = selectedSerials.length === quantity;

    return (
        <div className="min-h-screen bg-slate-50 p-6 pb-32">
            <div className="max-w-6xl mx-auto space-y-6">

                {/* Header */}
                <div className="flex items-center justify-between">
                    <div>
                        <Link href="/admin/orders" className="flex items-center gap-2 text-slate-500 hover:text-emerald-700 font-bold text-sm mb-1 transition-colors">
                            <ArrowLeft size={16} /> Back to Orders
                        </Link>
                        <h1 className="text-3xl font-black text-slate-900 tracking-tight">New Order Dispatch</h1>
                    </div>
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">

                    {/* LEFT COLUMN: Logistics */}
                    <div className="lg:col-span-1 space-y-6">
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                            <h2 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4 border-b pb-2">Logistics Details</h2>

                            <div className="space-y-6">
                                {/* Customer */}
                                <div>
                                    <label className="block text-sm font-bold text-slate-700 mb-1">Select Customer</label>
                                    <div className="relative">
                                        <select
                                            value={selectedCustomerId}
                                            onChange={(e) => setSelectedCustomerId(e.target.value)}
                                            className="w-full h-10 pl-3 pr-8 rounded-lg border border-slate-300 focus:ring-2 focus:ring-emerald-500 outline-none text-sm font-medium appearance-none"
                                        >
                                            <option value="">-- Choose Customer --</option>
                                            {customers.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                        </select>
                                        <User size={16} className="absolute right-3 top-3 text-slate-400 pointer-events-none" />
                                    </div>
                                    {currentCustomer && (
                                        <div className={`mt-2 text-xs font-medium px-3 py-2 rounded-lg flex justify-between items-center ${currentCustomer.current_balance < 0 ? 'bg-emerald-50 text-emerald-700' : 'bg-red-50 text-red-700'}`}>
                                            <span>Current Balance:</span>
                                            <span className="font-bold">Rs {currentCustomer.current_balance?.toLocaleString()}</span>
                                        </div>
                                    )}
                                </div>

                                {/* Driver */}
                                <div>
                                    <label className="block text-sm font-bold text-slate-700 mb-1">Assign Driver</label>
                                    <div className="relative">
                                        <select
                                            value={selectedDriverId}
                                            onChange={(e) => setSelectedDriverId(e.target.value)}
                                            className="w-full h-10 pl-10 pr-4 rounded-lg border border-slate-300 focus:ring-2 focus:ring-emerald-500 outline-none text-sm font-medium appearance-none"
                                        >
                                            <option value="">-- Choose Driver --</option>
                                            {drivers.map(d => <option key={d.id} value={d.id}>{d.name}</option>)}
                                        </select>
                                        <Truck size={16} className="absolute left-3 top-3 text-emerald-600 pointer-events-none" />
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Stock Summary Card */}
                        <div className="bg-slate-900 p-6 rounded-xl shadow-lg text-white">
                            <h3 className="text-xs font-bold text-slate-400 uppercase mb-2">My Warehouse Stock</h3>
                            <div className="flex items-baseline gap-2">
                                <span className="text-4xl font-black text-emerald-400">{loadingStock ? '...' : availableCylinders.length}</span>
                                <span className="text-sm font-medium text-slate-300">Cylinders Available</span>
                            </div>
                            <p className="text-xs text-slate-500 mt-2">Only 'Full' cylinders shown.</p>
                        </div>
                    </div>

                    {/* RIGHT COLUMN: Cart & Actions */}
                    <div className="lg:col-span-2 space-y-6">

                        {/* Order Items */}
                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                            <div className="p-4 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                                <h2 className="text-sm font-bold text-slate-700 uppercase tracking-wider flex items-center gap-2">
                                    <ShoppingCart size={16} /> Order Items
                                </h2>
                            </div>

                            <table className="w-full text-left">
                                <thead className="bg-white text-xs text-slate-400 border-b border-slate-100">
                                    <tr>
                                        <th className="p-4 font-bold uppercase">Product</th>
                                        <th className="p-4 font-bold uppercase w-32">Rate (Rs)</th>
                                        <th className="p-4 font-bold uppercase w-32 text-center">Qty</th>
                                        <th className="p-4 font-bold uppercase w-32 text-right">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr className="hover:bg-slate-50 transition-colors">
                                        <td className="p-4">
                                            <div className="font-bold text-slate-900">{productName}</div>
                                            <div className="text-xs text-emerald-600 font-medium flex items-center gap-1 mt-1">
                                                <Check size={12} /> In Stock
                                            </div>
                                        </td>
                                        <td className="p-4">
                                            <input
                                                type="number"
                                                value={price}
                                                onChange={(e) => setPrice(parseFloat(e.target.value) || 0)}
                                                className="w-full bg-transparent border-b border-dashed border-slate-300 focus:border-emerald-500 outline-none py-1 font-mono text-sm"
                                            />
                                        </td>
                                        <td className="p-4">
                                            <div className="flex items-center justify-center gap-2 bg-slate-100 rounded-lg p-1">
                                                <button
                                                    onClick={() => {
                                                        const n = Math.max(1, quantity - 1);
                                                        setQuantity(n);
                                                        if (selectedSerials.length > n) setSelectedSerials(selectedSerials.slice(0, n));
                                                    }}
                                                    className="w-6 h-6 flex items-center justify-center bg-white rounded shadow-sm text-slate-600 hover:text-emerald-600 font-bold"
                                                >-</button>
                                                <input
                                                    type="number"
                                                    value={quantity}
                                                    onChange={(e) => {
                                                        const n = Math.max(1, parseInt(e.target.value) || 1);
                                                        setQuantity(n);
                                                        if (selectedSerials.length > n) setSelectedSerials(selectedSerials.slice(0, n));
                                                    }}
                                                    className="w-10 text-center bg-transparent outline-none font-bold text-slate-900"
                                                />
                                                <button
                                                    onClick={() => setQuantity(quantity + 1)}
                                                    className="w-6 h-6 flex items-center justify-center bg-white rounded shadow-sm text-slate-600 hover:text-emerald-600 font-bold"
                                                >+</button>
                                            </div>
                                        </td>
                                        <td className="p-4 text-right font-black text-slate-900">
                                            {(quantity * price).toLocaleString()}
                                        </td>
                                    </tr>
                                </tbody>
                            </table>

                            {/* Asset Selection Bar */}
                            <div className="p-4 bg-slate-50 border-t border-slate-200 flex justify-between items-center">
                                <div className="flex items-center gap-3">
                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center ${isSatisfied ? 'bg-emerald-100 text-emerald-600' : 'bg-amber-100 text-amber-600'}`}>
                                        <ScanBarcode size={16} />
                                    </div>
                                    <div>
                                        <p className="text-sm font-bold text-slate-900">
                                            {selectedSerials.length} of {quantity} Assets Selected
                                        </p>
                                        <p className="text-xs text-slate-500">
                                            {isSatisfied ? 'Ready for dispatch' : 'Please select specific cylinders'}
                                        </p>
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <button
                                        onClick={autoSelectSerials}
                                        className="px-3 py-1.5 text-xs font-bold text-slate-600 hover:bg-slate-200 rounded-lg transition-colors border border-slate-200"
                                    >
                                        Auto-Select
                                    </button>
                                    <button
                                        onClick={() => setIsSerialModalOpen(true)}
                                        className={`px-4 py-2 text-sm font-bold rounded-lg transition-all shadow-sm flex items-center gap-2 ${isSatisfied ? 'bg-white text-emerald-700 border border-emerald-200' : 'bg-emerald-600 text-white hover:bg-emerald-700'}`}
                                    >
                                        <List size={16} /> {isSatisfied ? 'View / Edit Serials' : 'Select Serials'}
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                {/* FOOTER ACTION BAR */}
                <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 p-4 shadow-2xl z-40">
                    <div className="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                        <div className="text-left">
                            <p className="text-xs font-bold text-slate-400 uppercase">Grand Total</p>
                            <p className="text-3xl font-black text-emerald-600 tracking-tight">
                                <span className="text-lg text-emerald-400 font-bold mr-1">Rs.</span>
                                {calculateTotal().toLocaleString()}
                            </p>
                        </div>
                        <div className="flex gap-4 w-full md:w-auto">
                            <Link href="/admin/orders" className="flex-1 md:flex-none px-6 py-3 text-center text-sm font-bold text-slate-500 hover:bg-slate-100 rounded-xl transition-colors">
                                Cancel
                            </Link>
                            <button
                                onClick={handleDispatch}
                                disabled={submitting}
                                className="flex-1 md:flex-none px-8 py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl font-bold shadow-lg shadow-emerald-200 transition-all active:scale-95 disabled:opacity-50 disabled:active:scale-100 flex items-center justify-center gap-2"
                            >
                                {submitting ? 'Creating Invoice...' : <><Check size={18} /> Confirm Order</>}
                            </button>
                        </div>
                    </div>
                </div>

                {/* SERIAL SELECTION MODAL */}
                {isSerialModalOpen && (
                    <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4 animate-in fade-in duration-200">
                        <div className="bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[85vh]">
                            <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                                <div>
                                    <h2 className="text-lg font-bold text-slate-900">Select Cylinders</h2>
                                    <p className="text-xs text-slate-500 font-medium">Please select exactly {quantity} serial numbers.</p>
                                </div>
                                <div className="text-right">
                                    <span className={`text-2xl font-black ${isSatisfied ? 'text-emerald-600' : 'text-amber-500'}`}>
                                        {selectedSerials.length}
                                    </span>
                                    <span className="text-slate-400 font-bold text-sm">/{quantity}</span>
                                </div>
                            </div>

                            <div className="flex-1 overflow-y-auto p-6 bg-white min-h-[300px]">
                                {availableCylinders.length === 0 ? (
                                    <div className="h-full flex flex-col items-center justify-center text-slate-400">
                                        <Info size={48} className="mb-4 opacity-20" />
                                        <p className="font-bold">No Warehouse Stock Available</p>
                                    </div>
                                ) : (
                                    <div className="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3">
                                        {availableCylinders.map(c => {
                                            const active = selectedSerials.includes(c.serial_number);
                                            return (
                                                <button
                                                    key={c.id}
                                                    onClick={() => toggleSerial(c.serial_number)}
                                                    className={`px-2 py-2 text-xs font-mono font-bold rounded border transition-all ${active
                                                        ? 'bg-slate-800 text-white border-slate-800 shadow-md scale-105 ring-2 ring-emerald-400'
                                                        : 'bg-white text-slate-600 border-slate-200 hover:border-emerald-400 hover:text-emerald-600'
                                                        }`}
                                                >
                                                    {c.serial_number}
                                                </button>
                                            )
                                        })}
                                    </div>
                                )}
                            </div>

                            <div className="p-4 border-t border-slate-100 bg-slate-50 flex justify-end">
                                <button
                                    onClick={() => setIsSerialModalOpen(false)}
                                    className="px-6 py-2 bg-slate-900 text-white rounded-lg font-bold text-sm hover:bg-slate-800 transition-colors"
                                >
                                    Done
                                </button>
                            </div>
                        </div>
                    </div>
                )}

            </div>
        </div>
    );
}
</file>

<file path="src/app/(dashboard)/admin/orders/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import { getOrders } from '@/app/actions/orderActions';
import { format } from 'date-fns';
import Link from 'next/link';
import { Printer, Eye, ShoppingCart, Calendar } from 'lucide-react';
import { toast } from 'sonner';
import { Database } from '@/types/database.types';

type Order = Database['public']['Tables']['orders']['Row'] & {
    customers: { name: string; address: string | null } | null;
    driver: { name: string } | null;
};

export default function OrderListPage() {
    const [orders, setOrders] = useState<Order[]>([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        loadData();
    }, []);

    const loadData = async () => {
        setLoading(true);
        const data = await getOrders();
        setOrders(data);
        setLoading(false);
    };

    return (
        <div className="p-8 bg-slate-50 min-h-screen pb-32 font-sans">
            <div className="flex justify-between items-center mb-8">
                <div>
                    <h1 className="text-2xl font-bold text-slate-900 tracking-tight">Order History</h1>
                    <p className="text-sm text-slate-500 font-medium">Track all dispatch and sales records</p>
                </div>
                <Link href="/admin/orders/new" className="bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 hover:bg-emerald-700 transition-colors shadow-lg shadow-emerald-900/20">
                    <ShoppingCart size={16} /> New Order
                </Link>
            </div>

            <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                <div className="overflow-x-auto">
                    <table className="w-full text-left">
                        <thead className="bg-slate-50 border-b border-slate-100">
                            <tr>
                                <th className="p-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Order ID</th>
                                <th className="p-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Customer</th>
                                <th className="p-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Driver</th>
                                <th className="p-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Date</th>
                                <th className="p-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Status</th>
                                <th className="p-4 text-xs font-bold text-slate-500 uppercase tracking-wider text-right">Amount</th>
                                <th className="p-4 text-xs font-bold text-slate-500 uppercase tracking-wider text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-100">
                            {loading ? (
                                <tr><td colSpan={7} className="p-8 text-center text-slate-400">Loading orders...</td></tr>
                            ) : orders.length === 0 ? (
                                <tr><td colSpan={7} className="p-8 text-center text-slate-400">No orders found.</td></tr>
                            ) : (
                                orders.map((order) => (
                                    <tr key={order.id} className="hover:bg-slate-50 transition-colors">
                                        <td className="p-4 font-mono font-bold text-slate-600 text-xs">
                                            #{order.friendly_id || order.id.slice(0, 8).toUpperCase()}
                                        </td>
                                        <td className="p-4">
                                            <div className="font-bold text-slate-900 text-sm">{order.customers?.name || 'Guest'}</div>
                                            <div className="text-xs text-slate-400">{order.customers?.address || '-'}</div>
                                        </td>
                                        <td className="p-4 text-sm text-slate-600">
                                            {order.driver?.name || 'Unassigned'}
                                        </td>
                                        <td className="p-4 text-sm text-slate-500 flex items-center gap-2">
                                            <Calendar size={14} />
                                            {format(new Date(order.created_at), 'MMM dd, yyyy')}
                                        </td>
                                        <td className="p-4">
                                            <span className={`px-2 py-1 rounded-full text-xs font-black uppercase tracking-wider ${order.status === 'delivered' ? 'bg-emerald-100 text-emerald-700' :
                                                order.status === 'on_trip' ? 'bg-purple-100 text-purple-700' :
                                                    order.status === 'assigned' ? 'bg-blue-100 text-blue-700' :
                                                        'bg-amber-100 text-amber-700'
                                                }`}>
                                                {order.status === 'on_trip' ? 'ON WAY' : order.status}
                                            </span>
                                        </td>
                                        <td className="p-4 text-right font-bold text-slate-900">
                                            Rs {order.total_amount?.toLocaleString()}
                                        </td>
                                        <td className="p-4 text-right">
                                            <div className="flex justify-end gap-2">
                                                <Link
                                                    href={`/invoice/${order.id}`}
                                                    className="p-2 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-lg transition-colors"
                                                    title="View Invoice"
                                                >
                                                    <Printer size={16} />
                                                </Link>
                                            </div>
                                        </td>
                                    </tr>
                                ))
                            )}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="src/app/(dashboard)/admin/page.tsx">
import { getDashboardStats } from "@/app/actions/adminActions";
import { getSettings } from "@/app/actions/settingsActions";
import { DashboardChart } from "@/components/admin/DashboardChart";
import { Badge } from "@/components/ui/badge";
import {
    Users,
    Truck,
    Database,
    DollarSign,
    Plus,
    ArrowUpRight,
    Briefcase
} from "lucide-react";
import Link from "next/link";
import { format } from "date-fns";

export default async function AdminDashboardPage() {
    const stats = await getDashboardStats();

    // Safety check for stats (in case of error return)
    const {
        totalCash = 0,
        activeDrivers = 0,
        totalAssets = 0,
        emptyCylinders = 0,
        chartData = [],
        recentActivity = []
    } = stats;

    const currentDate = format(new Date(), "EEEE, MMMM d, yyyy");

    return (
        <div className="space-y-8 p-8 min-h-screen bg-slate-50/50 pb-20">
            {/* Header */}
            <header className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div>
                    <h1 className="text-3xl font-bold tracking-tight text-slate-900">Dashboard</h1>
                    <p className="text-slate-500 font-medium mt-1">{currentDate}</p>
                </div>
            </header>

            {/* Stats Row */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                {/* Total Cash */}
                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between">
                    <div>
                        <p className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Total Cash</p>
                        <div className="text-2xl font-black text-emerald-600">
                            Rs {totalCash.toLocaleString()}
                        </div>
                    </div>
                    <div className="h-10 w-10 bg-emerald-50 rounded-full flex items-center justify-center border border-emerald-100">
                        <DollarSign className="text-emerald-600 h-5 w-5" />
                    </div>
                </div>

                {/* Active Drivers */}
                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between">
                    <div>
                        <p className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Active Drivers</p>
                        <div className="text-2xl font-bold text-slate-900">
                            {activeDrivers}
                        </div>
                    </div>
                    <div className="h-10 w-10 bg-blue-50 rounded-full flex items-center justify-center border border-blue-100">
                        <Truck className="text-blue-600 h-5 w-5" />
                    </div>
                </div>

                {/* Stock Alert (Empty) */}
                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between">
                    <div>
                        <p className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Empty Cylinders</p>
                        <div className={`text-2xl font-bold ${emptyCylinders > 5 ? 'text-rose-600' : 'text-slate-900'}`}>
                            {emptyCylinders}
                        </div>
                        {emptyCylinders > 5 && <span className="text-[10px] font-bold text-rose-500 bg-rose-50 px-2 py-0.5 rounded-full">Refill Needed</span>}
                    </div>
                    <div className={`h-10 w-10 rounded-full flex items-center justify-center border ${emptyCylinders > 5 ? 'bg-rose-50 border-rose-100' : 'bg-slate-50 border-slate-100'}`}>
                        <Database className={`${emptyCylinders > 5 ? 'text-rose-600' : 'text-slate-400'} h-5 w-5`} />
                    </div>
                </div>

                {/* Total Assets */}
                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between">
                    <div>
                        <p className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Total Assets</p>
                        <div className="text-2xl font-bold text-slate-900">
                            {totalAssets}
                        </div>
                    </div>
                    <div className="h-10 w-10 bg-slate-50 rounded-full flex items-center justify-center border border-slate-100">
                        <Briefcase className="text-slate-600 h-5 w-5" />
                    </div>
                </div>
            </div>

            {/* Middle Section: Chart and Actions */}
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                {/* Chart Section */}
                <div className="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <div className="flex items-center justify-between mb-6">
                        <div>
                            <h3 className="text-lg font-bold text-slate-900">Weekly Orders</h3>
                            <p className="text-sm text-slate-500">Order volume over the last 7 days</p>
                        </div>
                    </div>
                    <DashboardChart data={chartData} />
                </div>

                {/* Quick Actions */}
                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col">
                    <h3 className="text-lg font-bold text-slate-900 mb-6">Quick Actions</h3>
                    <div className="space-y-3 flex-1">
                        <Link href="/admin/finance" className="flex items-center justify-between w-full p-4 bg-emerald-50 hover:bg-emerald-100 border border-emerald-100 rounded-xl transition-colors group">
                            <span className="font-semibold text-emerald-800">New Finance Entry</span>
                            <ArrowUpRight className="h-5 w-5 text-emerald-600 group-hover:translate-x-1 transition-transform" />
                        </Link>

                        <Link href="/admin/inventory" className="flex items-center justify-between w-full p-4 bg-slate-50 hover:bg-slate-100 border border-slate-100 rounded-xl transition-colors group">
                            <span className="font-semibold text-slate-700">Add Stock</span>
                            <Plus className="h-5 w-5 text-slate-400 group-hover:text-slate-600 transition-colors" />
                        </Link>

                        <Link href="/admin/users" className="flex items-center justify-between w-full p-4 bg-slate-50 hover:bg-slate-100 border border-slate-100 rounded-xl transition-colors group">
                            <span className="font-semibold text-slate-700">Add Staff</span>
                            <Users className="h-5 w-5 text-slate-400 group-hover:text-slate-600 transition-colors" />
                        </Link>
                    </div>
                </div>
            </div>

            {/* Recent Activity Table */}
            <div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <div className="p-6 border-b border-slate-50 flex justify-between items-center">
                    <div>
                        <h3 className="text-lg font-bold text-slate-900">Recent Activity</h3>
                        <p className="text-sm text-slate-500">Latest orders and transactions</p>
                    </div>
                    <Link href="/admin/history" className="text-sm font-bold text-emerald-600 hover:text-emerald-700 hover:underline">
                        View All
                    </Link>
                </div>
                <div className="overflow-x-auto">
                    <table className="w-full text-left text-sm">
                        <thead className="bg-slate-50 border-b border-slate-100 text-slate-500 font-semibold">
                            <tr>
                                <th className="px-6 py-4">Customer</th>
                                <th className="px-6 py-4">Order ID</th>
                                <th className="px-6 py-4">Status</th>
                                <th className="px-6 py-4">Date</th>
                                <th className="px-6 py-4 text-right">Amount</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-50">
                            {recentActivity.length === 0 ? (
                                <tr>
                                    <td colSpan={5} className="px-6 py-8 text-center text-slate-400 italic">
                                        No recent activity found.
                                    </td>
                                </tr>
                            ) : (
                                recentActivity.map((activity: any) => (
                                    <tr key={activity.id} className="hover:bg-slate-50/50 transition-colors">
                                        <td className="px-6 py-4 font-medium text-slate-900">
                                            {activity.customers?.name || 'Guest'}
                                        </td>
                                        <td className="px-6 py-4 text-slate-500 font-mono text-xs">
                                            #{activity.friendly_id || activity.id.slice(0, 8)}
                                        </td>
                                        <td className="px-6 py-4">
                                            <Badge variant="outline" className={`
                                                ${activity.status === 'completed' || activity.status === 'delivered' ? 'bg-emerald-100 text-emerald-700 border-emerald-200' :
                                                    activity.status === 'pending' || activity.status === 'on_trip' ? 'bg-amber-100 text-amber-700 border-amber-200' :
                                                        'bg-slate-100 text-slate-600 border-slate-200'} shadow-none
                                            `}>
                                                {activity.status === 'on_trip' ? 'On Way' : activity.status}
                                            </Badge>
                                        </td>
                                        <td className="px-6 py-4 text-slate-500">
                                            {new Date(activity.created_at).toLocaleDateString()}
                                        </td>
                                        <td className="px-6 py-4 text-right font-bold text-slate-900">
                                            Rs {activity.total_amount?.toLocaleString() || 0}
                                        </td>
                                    </tr>
                                ))
                            )}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="src/app/(dashboard)/admin/settings/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import { getSettings, updateSettings, changePassword, type OrgSettings } from '@/app/actions/settingsActions';
import { toast } from 'sonner';
import { Loader2, Save, Lock, Building, DollarSign } from 'lucide-react';
// import { updateProfile } from '@/app/actions/manageUser';

export default function SettingsPage() {
    const [activeTab, setActiveTab] = useState<'profile' | 'config' | 'security'>('profile');
    const [settings, setSettings] = useState<OrgSettings | null>(null);
    const [loading, setLoading] = useState(true);
    const [submitting, setSubmitting] = useState(false);

    // Profile Form
    const [form, setForm] = useState({
        company_name: '',
        company_phone: '',
        company_address: '',
        invoice_footer: '',
        default_gas_rate: '',
        low_stock_threshold: ''
    });

    // Password Form
    const [passForm, setPassForm] = useState({
        new_password: '',
        confirm_password: ''
    });

    useEffect(() => {
        loadSettings();
    }, []);

    async function loadSettings() {
        setLoading(true);
        const { settings, error } = await getSettings();
        if (settings) {
            setSettings(settings);
            setForm({
                company_name: settings.company_name || '',
                company_phone: settings.company_phone || '',
                company_address: settings.company_address || '',
                invoice_footer: settings.invoice_footer || '',
                default_gas_rate: settings.default_gas_rate?.toString() || '',
                low_stock_threshold: settings.low_stock_threshold?.toString() || ''
            });
        }
        setLoading(false);
    }

    async function handleSaveSettings(e: React.FormEvent) {
        e.preventDefault();
        setSubmitting(true);
        const payload = new FormData();
        Object.entries(form).forEach(([k, v]) => payload.append(k, v));

        const res = await updateSettings(null, payload);
        if (res.error) toast.error(res.error);
        else toast.success("Settings saved!");
        setSubmitting(false);
    }

    async function handleChangePassword(e: React.FormEvent) {
        e.preventDefault();
        setSubmitting(true);
        const payload = new FormData();
        payload.append('new_password', passForm.new_password);
        payload.append('confirm_password', passForm.confirm_password);

        const res = await changePassword(null, payload);
        if (res.error) toast.error(res.error);
        else {
            toast.success("Password changed!");
            setPassForm({ new_password: '', confirm_password: '' });
        }
        setSubmitting(false);
    }

    if (loading) return <div className="p-10 flex justify-center"><Loader2 className="animate-spin" /></div>;

    return (
        <div className="p-6 max-w-4xl mx-auto min-h-screen pb-32">
            <h1 className="text-3xl font-black text-slate-800 tracking-tight mb-2">System Settings</h1>
            <p className="text-slate-500 font-medium mb-8">Manage branding, configurations, and security.</p>

            {/* TABS */}
            <div className="flex gap-2 bg-white p-1 rounded-xl border border-slate-200 shadow-sm mb-6 inline-flex">
                <TabButton active={activeTab === 'profile'} onClick={() => setActiveTab('profile')} icon={<Building size={16} />} label="Company Profile" />
                <TabButton active={activeTab === 'config'} onClick={() => setActiveTab('config')} icon={<DollarSign size={16} />} label="Configurations" />
                <TabButton active={activeTab === 'security'} onClick={() => setActiveTab('security')} icon={<Lock size={16} />} label="Security" />
            </div>

            {/* TAB CONTENT */}
            <div className="bg-white rounded-2xl shadow-xl shadow-slate-200/50 border border-slate-100 overflow-hidden animate-in fade-in slide-in-from-bottom-4 duration-300">

                {activeTab === 'profile' && (
                    <form onSubmit={handleSaveSettings} className="p-8 space-y-6">
                        <h2 className="text-xl font-bold text-slate-900 border-b border-slate-100 pb-4">Branding & Invoice Details</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <Input label="Company Name" value={form.company_name} onChange={(e: any) => setForm({ ...form, company_name: e.target.value })} required />
                            <Input label="Phone Number" value={form.company_phone} onChange={(e: any) => setForm({ ...form, company_phone: e.target.value })} />
                            <div className="md:col-span-2">
                                <Input label="Address" value={form.company_address} onChange={(e: any) => setForm({ ...form, company_address: e.target.value })} />
                            </div>
                            <div className="md:col-span-2">
                                <Input label="Invoice Footer Message" value={form.invoice_footer} onChange={(e: any) => setForm({ ...form, invoice_footer: e.target.value })} />
                            </div>
                        </div>
                        <div className="pt-4 flex justify-end">
                            <SaveButton loading={submitting} />
                        </div>
                    </form>
                )}

                {activeTab === 'config' && (
                    <form onSubmit={handleSaveSettings} className="p-8 space-y-6">
                        <h2 className="text-xl font-bold text-slate-900 border-b border-slate-100 pb-4">System Configurations</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div className="bg-emerald-50 p-6 rounded-xl border border-emerald-100">
                                <label className="block text-sm font-bold text-emerald-800 uppercase mb-2">Today's Gas Rate (Rs)</label>
                                <input
                                    type="number"
                                    value={form.default_gas_rate}
                                    onChange={(e) => setForm({ ...form, default_gas_rate: e.target.value })}
                                    className="w-full text-3xl font-black text-emerald-600 bg-transparent outline-none placeholder:text-emerald-200"
                                    placeholder="0"
                                />
                                <p className="text-xs text-emerald-600 mt-2">Auto-filled in new orders.</p>
                            </div>

                            <div className="bg-rose-50 p-6 rounded-xl border border-rose-100">
                                <label className="block text-sm font-bold text-rose-800 uppercase mb-2">Low Stock Alert Limit</label>
                                <input
                                    type="number"
                                    value={form.low_stock_threshold}
                                    onChange={(e) => setForm({ ...form, low_stock_threshold: e.target.value })}
                                    className="w-full text-3xl font-black text-rose-600 bg-transparent outline-none placeholder:text-rose-200"
                                    placeholder="15"
                                />
                                <p className="text-xs text-rose-600 mt-2">Trigger for dashboard warnings.</p>
                            </div>
                        </div>
                        <div className="pt-4 flex justify-end">
                            <SaveButton loading={submitting} />
                        </div>
                    </form>
                )}

                {activeTab === 'security' && (
                    <form onSubmit={handleChangePassword} className="p-8 space-y-6">
                        <h2 className="text-xl font-bold text-slate-900 border-b border-slate-100 pb-4">Change Password</h2>
                        <div className="max-w-md space-y-4">
                            <Input
                                label="New Password"
                                type="password"
                                value={passForm.new_password}
                                onChange={(e: any) => setPassForm({ ...passForm, new_password: e.target.value })}
                                required
                            />
                            <Input
                                label="Confirm Password"
                                type="password"
                                value={passForm.confirm_password}
                                onChange={(e: any) => setPassForm({ ...passForm, confirm_password: e.target.value })}
                                required
                            />
                        </div>
                        <div className="pt-4">
                            <button
                                type="submit"
                                disabled={submitting}
                                className="bg-slate-900 hover:bg-slate-800 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg shadow-slate-900/10 transition-all active:scale-95 disabled:opacity-50"
                            >
                                {submitting ? <Loader2 size={18} className="animate-spin" /> : <Lock size={18} />} Update Password
                            </button>
                        </div>
                    </form>
                )}

            </div>
        </div>
    );
}

// --- COMPONENTS ---
function TabButton({ active, onClick, icon, label }: any) {
    return (
        <button
            onClick={onClick}
            className={`px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2 transition-all ${active ? 'bg-slate-900 text-white shadow-md' : 'text-slate-500 hover:bg-slate-50 hover:text-slate-900'
                }`}
        >
            {icon} {label}
        </button>
    );
}

function Input({ label, ...props }: any) {
    return (
        <div>
            <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">{label}</label>
            <input
                {...props}
                className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-900 focus:ring-2 focus:ring-emerald-500 outline-none"
            />
        </div>
    );
}

function SaveButton({ loading }: { loading: boolean }) {
    return (
        <button
            type="submit"
            disabled={loading}
            className="bg-emerald-500 hover:bg-emerald-600 text-white px-8 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg shadow-emerald-500/20 transition-all active:scale-95 disabled:opacity-50"
        >
            {loading ? <Loader2 size={18} className="animate-spin" /> : <Save size={18} />} Save Changes
        </button>
    );
}
</file>

<file path="src/app/(dashboard)/admin/users/page.tsx">
'use client';

import { useRouter } from 'next/navigation';
import { useState, useEffect } from 'react';
import { createEmployee } from '@/app/actions/createEmployee';
import { updateUser, resetPassword, toggleUserStatus } from '@/app/actions/manageUser';
import { getTenantUsers } from '@/app/actions/adminActions';
import {
    Users, UserPlus, Search, Phone, Shield, Loader2, X,
    Briefcase, Truck, MoreVertical, Edit, Lock, Ban, MailIcon
} from 'lucide-react';
import { toast } from 'sonner';
import { createClient } from '@/utils/supabase/client';

// --- Types ---
interface Employee {
    id: string;
    name?: string;
    role: string;
    phone?: string;
    email?: string;
    shift?: string;
    created_at: string;
    phone_number?: string;
    // New Props from Join
    profiles?: {
        vehicle_number?: string;
        phone_number?: string;
    } | null;
    raw_user_meta_data?: any;
}

export default function UsersPage() {
    const supabase = createClient();
    const router = useRouter();
    const [employees, setEmployees] = useState<Employee[]>([]);
    const [loading, setLoading] = useState(true);
    const [search, setSearch] = useState('');
    const [currentUserId, setCurrentUserId] = useState<string>('');

    // Modals
    const [modalMode, setModalMode] = useState<'create' | 'edit'>('create');
    const [isUserModalOpen, setIsUserModalOpen] = useState(false);

    // Action Modals
    const [resettingUser, setResettingUser] = useState<Employee | null>(null);
    const [deactivatingUser, setDeactivatingUser] = useState<Employee | null>(null);

    const [isSubmitting, setIsSubmitting] = useState(false);

    // Form State (Unified for Create & Edit)
    const [formData, setFormData] = useState({
        id: '', // For Edit
        name: '',
        email: '',
        phone_number: '',
        role: 'driver',
        shift: 'Day',
        vehicle_number: '',
        password: '' // Only for Create
    });

    // Reset Password State
    const [newPassword, setNewPassword] = useState('');

    useEffect(() => {
        fetchEmployees();
    }, []);

    async function fetchEmployees() {
        setLoading(true);
        try {
            const { data: { user } } = await supabase.auth.getUser();
            if (user) setCurrentUserId(user.id);
            const rawData = await getTenantUsers();
            setEmployees(rawData);
        } catch (err) {
            toast.error("Failed to load staff.");
        } finally {
            setLoading(false);
        }
    }

    // --- Actions ---

    const openCreateModal = () => {
        setModalMode('create');
        setFormData({
            id: '',
            name: '',
            email: '',
            phone_number: '',
            role: 'driver',
            shift: 'Day',
            vehicle_number: '',
            password: ''
        });
        setIsUserModalOpen(true);
    };

    const openEditModal = (emp: Employee) => {
        setModalMode('edit');
        setFormData({
            id: emp.id,
            name: emp.name || '',
            email: emp.email || '', // Email usually mostly read-only/display but we keep it
            phone_number: emp.profiles?.phone_number || emp.phone_number || emp.phone || '',
            role: emp.role || 'driver',
            shift: emp.shift || emp.raw_user_meta_data?.shift || 'Day',
            vehicle_number: emp.profiles?.vehicle_number || '', // Fetch from Profile
            password: '' // Not needed for edit
        });
        setIsUserModalOpen(true);
    };

    const handleUserSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setIsSubmitting(true);
        const payload = new FormData();

        // Common Fields
        payload.append('name', formData.name);
        payload.append('role', formData.role);
        payload.append('shift', formData.shift);
        payload.append('phone_number', formData.phone_number);
        // Conditional Vehicle
        if (formData.role === 'driver') {
            payload.append('vehicle_number', formData.vehicle_number);
        }

        try {
            let result;
            if (modalMode === 'create') {
                payload.append('email', formData.email);
                payload.append('password', formData.password);
                result = await createEmployee(null, payload);
            } else {
                payload.append('id', formData.id);
                // updateUser handles the rest
                result = await updateUser(null, payload);
            }

            if (result.error) toast.error(result.error);
            else {
                toast.success(result.message);
                setIsUserModalOpen(false);
                fetchEmployees();
                if (modalMode === 'edit') router.refresh();
            }
        } catch { toast.error('Operation failed'); }
        finally { setIsSubmitting(false); }
    };

    const handleResetPassword = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!resettingUser) return;
        setIsSubmitting(true);

        const payload = new FormData();
        payload.append('id', resettingUser.id);
        payload.append('password', newPassword);

        try {
            const result = await resetPassword(null, payload);
            if (result.error) toast.error(result.error);
            else {
                toast.success(result.message);
                setResettingUser(null);
                setNewPassword('');
            }
        } catch { toast.error('Error resetting password'); }
        finally { setIsSubmitting(false); }
    };

    const handleToggleStatus = async () => {
        if (!deactivatingUser) return;
        setIsSubmitting(true);
        const payload = new FormData();
        payload.append('id', deactivatingUser.id);
        payload.append('action', 'deactivate');

        try {
            const result = await toggleUserStatus(null, payload);
            if (result.error) toast.error(result.error);
            else {
                toast.success(result.message);
                setDeactivatingUser(null);
                fetchEmployees();
            }
        } catch { toast.error('Error updating status'); }
        finally { setIsSubmitting(false); }
    };

    // --- UI Helpers ---
    const getRoleBadge = (role: string) => {
        switch (role.toLowerCase()) {
            case 'admin': return { style: 'bg-blue-100 text-blue-700', icon: Shield, label: 'Admin' };
            case 'driver': return { style: 'bg-emerald-100 text-emerald-700', icon: Truck, label: 'Driver' };
            case 'manager': return { style: 'bg-purple-100 text-purple-700', icon: Briefcase, label: 'Manager' };
            default: return { style: 'bg-slate-100 text-slate-600', icon: Users, label: role };
        }
    };

    const filteredEmployees = employees.filter(e =>
        (e.name || '').toLowerCase().includes(search.toLowerCase()) ||
        (e.role || '').toLowerCase().includes(search.toLowerCase())
    );

    return (
        <div className="space-y-8 animate-in fade-in duration-500 max-w-7xl mx-auto">
            <header className="flex justify-between items-center">
                <div>
                    <h1 className="text-3xl font-black text-slate-800 tracking-tight">Staff Management</h1>
                    <p className="text-slate-500 font-medium mt-1">Manage users, roles, and profiles.</p>
                </div>
                <button
                    onClick={openCreateModal}
                    className="bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2.5 rounded-xl font-bold flex items-center gap-2 shadow-lg shadow-emerald-900/10 transition-all active:scale-95"
                >
                    <UserPlus size={18} /> Add New Staff
                </button>
            </header>

            {/* Main Content */}
            <div className="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
                <div className="p-4 border-b border-slate-50 flex items-center gap-4">
                    <div className="relative flex-1 max-w-md">
                        <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={20} />
                        <input
                            type="text"
                            value={search}
                            onChange={(e) => setSearch(e.target.value)}
                            className="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-100 rounded-xl font-medium text-slate-700 focus:outline-none focus:ring-2 focus:ring-emerald-500/20"
                            placeholder="Search staff..."
                        />
                    </div>
                </div>

                <div className="overflow-x-auto">
                    <table className="w-full text-left text-sm">
                        <thead className="bg-slate-50 text-slate-500 font-bold border-b border-slate-100">
                            <tr>
                                <th className="px-6 py-4">Name</th>
                                <th className="px-6 py-4">Role</th>
                                <th className="px-6 py-4">Shift</th>
                                <th className="px-6 py-4">Phone</th>
                                <th className="px-6 py-4">Vehicle</th>
                                <th className="px-6 py-4 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-50">
                            {loading ? (
                                [1, 2, 3].map(i => (
                                    <tr key={i} className="animate-pulse">
                                        <td colSpan={6} className="px-6 py-6"><div className="h-4 bg-slate-100 rounded w-full"></div></td>
                                    </tr>
                                ))
                            ) : filteredEmployees.length === 0 ? (
                                <tr><td colSpan={6} className="px-6 py-12 text-center text-slate-400 italic">No staff found.</td></tr>
                            ) : (
                                filteredEmployees.map((emp) => {
                                    const badge = getRoleBadge(emp.role);
                                    const phone = emp.profiles?.phone_number || emp.phone_number || emp.phone || '-';
                                    const vehicle = emp.profiles?.vehicle_number || '-';

                                    return (
                                        <tr key={emp.id} className="hover:bg-slate-50/50 transition-colors">
                                            <td className="px-6 py-4 font-bold text-slate-700">
                                                <div className="flex items-center gap-3">
                                                    <div className="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-xs font-black text-slate-500">
                                                        {(emp.name || 'U')[0]}
                                                    </div>
                                                    {emp.name || 'Unknown'}
                                                </div>
                                            </td>
                                            <td className="px-6 py-4">
                                                <span className={`inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-bold uppercase tracking-wide ${badge.style}`}>
                                                    <badge.icon size={12} /> {badge.label}
                                                </span>
                                            </td>
                                            <td className="px-6 py-4 text-slate-600 font-medium">
                                                {emp.shift || 'Day'}
                                            </td>
                                            <td className="px-6 py-4 text-slate-500 font-mono text-xs">
                                                {phone}
                                            </td>
                                            <td className="px-6 py-4 text-slate-500">
                                                {emp.role === 'driver' && vehicle !== '-' ? (
                                                    <div className="flex items-center gap-1.5 text-xs font-bold bg-amber-50 text-amber-700 px-2 py-1 rounded border border-amber-100 w-fit">
                                                        <Truck size={12} /> {vehicle}
                                                    </div>
                                                ) : (
                                                    <span className="text-slate-300">-</span>
                                                )}
                                            </td>
                                            <td className="px-6 py-4 text-right">
                                                <div className="flex items-center justify-end gap-2">
                                                    <button onClick={() => openEditModal(emp)} className="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="Edit">
                                                        <Edit size={16} />
                                                    </button>
                                                    <button onClick={() => setResettingUser(emp)} className="p-2 text-slate-400 hover:text-orange-600 hover:bg-orange-50 rounded-lg transition-colors" title="Reset Password">
                                                        <Lock size={16} />
                                                    </button>
                                                    <button onClick={() => setDeactivatingUser(emp)} className="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Deactivate">
                                                        <Ban size={16} />
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    );
                                })
                            )}
                        </tbody>
                    </table>
                </div>
            </div>

            {/* --- MODALS --- */}

            {/* CREATE / EDIT USER MODAL */}
            {isUserModalOpen && (
                <Modal
                    title={modalMode === 'create' ? "Add New Staff" : "Edit Details"}
                    icon={modalMode === 'create' ? <UserPlus size={20} className="text-emerald-600" /> : <Edit size={20} className="text-blue-600" />}
                    onClose={() => setIsUserModalOpen(false)}
                >
                    <form onSubmit={handleUserSubmit} className="space-y-4">
                        <Input
                            label="Full Name"
                            value={formData.name}
                            onChange={(e: any) => setFormData({ ...formData, name: e.target.value })}
                            required
                        />

                        {/* Email only adjustable on Create for now (Supabase Auth complexity) */}
                        {modalMode === 'create' && (
                            <Input
                                label="Email Address"
                                type="email"
                                value={formData.email}
                                onChange={(e: any) => setFormData({ ...formData, email: e.target.value })}
                                required
                                icon={<MailIcon size={16} />}
                            />
                        )}

                        <div className="grid grid-cols-2 gap-4">
                            <Select
                                label="Role"
                                value={formData.role}
                                onChange={(e: any) => setFormData({ ...formData, role: e.target.value })}
                                disabled={modalMode === 'edit' && formData.id === currentUserId} // Prevent self-lockout
                            >
                                <option value="driver">Driver</option>
                                <option value="salesman">Salesman</option>
                                <option value="cashier">Cashier</option>
                                <option value="manager">Manager</option>
                                <option value="recovery">Recovery</option>
                                <option value="admin">Admin</option>
                            </Select>
                            <Select label="Shift" value={formData.shift} onChange={(e: any) => setFormData({ ...formData, shift: e.target.value })}>
                                <option value="Day">Day Shift</option>
                                <option value="Night">Night Shift</option>
                            </Select>
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <Input
                                label="Phone Number"
                                value={formData.phone_number}
                                onChange={(e: any) => setFormData({ ...formData, phone_number: e.target.value })}
                                icon={<Phone size={16} />}
                            />

                            {/* CONDITIONAL VEHICLE INPUT */}
                            {formData.role === 'driver' && (
                                <div className="animate-in slide-in-from-left-2 duration-300">
                                    <Input
                                        label="Vehicle Number"
                                        placeholder="KHI-2026"
                                        value={formData.vehicle_number}
                                        onChange={(e: any) => setFormData({ ...formData, vehicle_number: e.target.value })}
                                        icon={<Truck size={16} />}
                                        required={formData.role === 'driver'}
                                    />
                                </div>
                            )}
                        </div>

                        {modalMode === 'create' && (
                            <Input label="Initial Password" value={formData.password} onChange={(e: any) => setFormData({ ...formData, password: e.target.value })} required />
                        )}

                        <div className="pt-4">
                            <Button loading={isSubmitting}>
                                {modalMode === 'create' ? 'Create Account' : 'Save Changes'}
                            </Button>
                        </div>
                    </form>
                </Modal>
            )}

            {/* RESET PASSWORD MODAL */}
            {resettingUser && (
                <Modal title="Reset Password" icon={<Lock size={20} className="text-orange-600" />} onClose={() => setResettingUser(null)}>
                    <form onSubmit={handleResetPassword} className="space-y-4">
                        <div className="p-3 bg-orange-50 text-orange-800 text-sm rounded-lg mb-4">
                            Resetting password for <strong>{resettingUser.name}</strong>.
                        </div>
                        <Input label="New Password" placeholder="Enter new password" value={newPassword} onChange={(e: any) => setNewPassword(e.target.value)} required />
                        <div className="pt-4">
                            <Button loading={isSubmitting}>Update Password</Button>
                        </div>
                    </form>
                </Modal>
            )}

            {/* DEACTIVATE MODAL */}
            {deactivatingUser && (
                <Modal title="Deactivate User" icon={<Ban size={20} className="text-red-600" />} onClose={() => setDeactivatingUser(null)}>
                    <div className="space-y-4">
                        <div className="p-4 bg-red-50 text-red-900 rounded-xl border border-red-100">
                            <p className="font-bold text-lg mb-1">Are you sure?</p>
                            <p className="text-sm">
                                This will immediately block access for <strong>{deactivatingUser.name}</strong>.
                            </p>
                        </div>
                        <div className="flex gap-3 pt-4">
                            <button onClick={() => setDeactivatingUser(null)} className="flex-1 py-3 font-bold text-slate-600 hover:bg-slate-100 rounded-xl">Cancel</button>
                            <button onClick={handleToggleStatus} disabled={isSubmitting} className="flex-1 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-xl shadow-lg shadow-red-600/20">
                                {isSubmitting ? <Loader2 className="animate-spin mx-auto" /> : 'Confirm Deactivate'}
                            </button>
                        </div>
                    </div>
                </Modal>
            )}
        </div>
    );
}

// --- Components ---

function Modal({ children, title, icon, onClose }: any) {
    return (
        <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div className="bg-white p-6 rounded-2xl w-full max-w-md shadow-2xl relative animate-in fade-in zoom-in duration-200 text-left">
                <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-900"><X size={24} /></button>
                <h2 className="text-xl font-bold text-slate-900 mb-6 flex items-center gap-2">{icon} {title}</h2>
                {children}
            </div>
        </div>
    );
}

function Input({ label, icon, ...props }: any) {
    return (
        <div>
            <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">{label}</label>
            <div className="relative">
                {icon && <div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">{icon}</div>}
                <input
                    {...props}
                    className={`w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-900 focus:ring-2 focus:ring-emerald-500 outline-none placeholder:font-normal placeholder:text-slate-400 ${icon ? 'pl-10' : ''}`}
                    style={{ color: '#0f172a' }}
                />
            </div>
        </div>
    );
}

function Select({ label, children, ...props }: any) {
    return (
        <div>
            <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">{label}</label>
            <select
                {...props}
                className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-900 focus:ring-2 focus:ring-emerald-500 outline-none appearance-none"
                style={{ color: '#0f172a' }}
            >
                {children}
            </select>
        </div>
    );
}

function Button({ children, loading }: any) {
    return (
        <button
            type="submit"
            disabled={loading}
            className="w-full bg-slate-900 hover:bg-emerald-600 text-white font-bold py-4 rounded-xl shadow-lg transition-all active:scale-95 disabled:opacity-50 flex items-center justify-center gap-2"
        >
            {loading ? <Loader2 className="animate-spin" /> : children}
        </button>
    );
}
</file>

<file path="src/app/(dashboard)/driver/expenses/page.tsx">
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { ArrowLeft, Camera, Check, UploadCloud, Receipt } from 'lucide-react';
import { toast } from 'sonner';
import { submitExpense } from '@/app/actions/driverExpenseActions';
import Link from 'next/link';
import Image from 'next/image';

const CATEGORIES = ['Fuel', 'Food', 'Challan', 'Maintenance', 'Other'];

export default function AddExpensePage() {
    const router = useRouter();
    const [submitting, setSubmitting] = useState(false);

    // Form State
    const [amount, setAmount] = useState('');
    const [category, setCategory] = useState('');
    const [description, setDescription] = useState('');
    const [proofFile, setProofFile] = useState<File | null>(null);
    const [previewUrl, setPreviewUrl] = useState<string | null>(null);

    const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        const file = e.target.files?.[0];
        if (file) {
            setProofFile(file);
            const url = URL.createObjectURL(file);
            setPreviewUrl(url);
        }
    };

    const handleSubmit = async () => {
        // Validation
        if (!amount || parseFloat(amount) <= 0) {
            toast.error("Please enter a valid amount");
            return;
        }
        if (!category) {
            toast.error("Please select a category");
            return;
        }
        if (!proofFile) {
            toast.error("Please upload a proof photo");
            return;
        }

        setSubmitting(true);
        const formData = new FormData();
        formData.append('amount', amount);
        formData.append('category', category);
        formData.append('description', description);
        formData.append('proof_file', proofFile);

        const res = await submitExpense(formData);

        if (res.error) {
            toast.error(res.error);
            setSubmitting(false);
        } else {
            toast.success("Expense Added Successfully!");
            router.push('/driver');
        }
    };

    return (
        <div className="min-h-screen bg-slate-50 font-sans pb-10">
            {/* Header */}
            <header className="bg-white p-4 shadow-sm border-b border-slate-100 flex items-center gap-4 sticky top-0 z-20">
                <Link href="/driver" className="p-2 -ml-2 rounded-full hover:bg-slate-100 text-slate-600">
                    <ArrowLeft size={24} />
                </Link>
                <h1 className="text-xl font-black text-slate-800 tracking-tight">Add New Expense</h1>
            </header>

            <main className="p-6 max-w-md mx-auto space-y-8">

                {/* 1. Category Selector */}
                <div className="space-y-3">
                    <label className="text-xs font-bold text-slate-400 uppercase tracking-wider">Select Category</label>
                    <div className="flex flex-wrap gap-3">
                        {CATEGORIES.map(cat => (
                            <button
                                key={cat}
                                onClick={() => setCategory(cat)}
                                className={`px-5 py-3 rounded-xl font-bold text-sm transition-all shadow-sm ${category === cat ? 'bg-emerald-600 text-white shadow-emerald-200 scale-105 ring-2 ring-emerald-600 ring-offset-2' : 'bg-white text-slate-600 border border-slate-200 hover:border-slate-300'}`}
                            >
                                {cat}
                            </button>
                        ))}
                    </div>
                </div>

                {/* 2. Amount Input */}
                <div className="space-y-3">
                    <label className="text-xs font-bold text-slate-400 uppercase tracking-wider">Total Amount</label>
                    <div className="relative">
                        <span className="absolute left-6 top-1/2 -translate-y-1/2 text-2xl font-bold text-slate-300">Rs.</span>
                        <input
                            type="number"
                            placeholder="0"
                            value={amount}
                            onChange={(e) => setAmount(e.target.value)}
                            className="w-full h-24 pl-16 bg-white rounded-3xl border border-slate-200 shadow-sm text-5xl font-black text-slate-900 placeholder:text-slate-200 outline-none focus:ring-4 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all"
                        />
                    </div>
                </div>

                {/* 3. Description (Optional) */}
                <div className="space-y-3">
                    <label className="text-xs font-bold text-slate-400 uppercase tracking-wider">Details (Optional)</label>
                    <textarea
                        rows={2}
                        placeholder="e.g. Pump Name, Workshop Details..."
                        value={description}
                        onChange={(e) => setDescription(e.target.value)}
                        className="w-full p-4 bg-white rounded-2xl border border-slate-200 font-medium text-slate-700 outline-none focus:ring-2 focus:ring-slate-200 transition-all resize-none"
                    />
                </div>

                {/* 4. Proof Upload */}
                <div className="space-y-3">
                    <label className="text-xs font-bold text-slate-400 uppercase tracking-wider">Proof of Payment</label>
                    <label className={`block w-full aspect-video rounded-3xl border-3 border-dashed transition-all cursor-pointer relative overflow-hidden group ${proofFile ? 'border-emerald-500 bg-emerald-50' : 'border-slate-300 bg-slate-100 hover:bg-white hover:border-slate-400'}`}>
                        <input
                            type="file"
                            accept="image/*"
                            capture="environment" // Opens camera on mobile
                            className="hidden"
                            onChange={handleFileChange}
                        />

                        {previewUrl ? (
                            <div className="absolute inset-0 z-10">
                                <Image src={previewUrl} alt="Preview" fill className="object-cover" />
                                <div className="absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                    <div className="bg-white/90 backdrop-blur text-slate-900 px-4 py-2 rounded-full font-bold text-sm shadow-xl flex items-center gap-2">
                                        <Camera size={16} /> Retake
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="absolute inset-0 flex flex-col items-center justify-center text-slate-400 gap-3">
                                <div className="w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-sm">
                                    <Camera size={32} className="text-slate-400" />
                                </div>
                                <span className="font-bold text-sm">Tap to Take Photo</span>
                            </div>
                        )}
                    </label>
                </div>

                {/* Submit Button */}
                <div className="pt-4">
                    <button
                        onClick={handleSubmit}
                        disabled={submitting}
                        className="w-full py-5 bg-emerald-600 text-white rounded-2xl font-black text-lg shadow-xl shadow-emerald-200 active:scale-[98%] transition-transform disabled:opacity-50 flex items-center justify-center gap-3 hover:bg-emerald-700"
                    >
                        {submitting ? (
                            <>
                                <UploadCloud size={24} className="animate-bounce" /> Uploading...
                            </>
                        ) : (
                            <>
                                <Receipt size={24} /> Submit Expense
                            </>
                        )}
                    </button>
                </div>

            </main>
        </div>
    );
}
</file>

<file path="src/app/(dashboard)/driver/history/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import { getCompletedOrders } from '@/app/actions/driverActions';
import { format, addDays, subDays } from 'date-fns';
import { Share2, ArrowLeft, RefreshCw, Calendar as CalendarIcon, ChevronLeft, ChevronRight, CheckCircle2 } from 'lucide-react';
import Link from 'next/link';
import { toast } from 'sonner';

export default function HistoryPage() {
    const [loading, setLoading] = useState(true);
    const [completed, setCompleted] = useState<any[]>([]);
    const [selectedDate, setSelectedDate] = useState(new Date());

    useEffect(() => {
        loadHistory();
    }, [selectedDate]); // Re-run when date changes

    const loadHistory = async () => {
        setLoading(true);
        try {
            // Pass ISO string to backend
            const data = await getCompletedOrders(selectedDate.toISOString());
            setCompleted(data);
        } catch (error) {
            console.error(error);
            toast.error("Failed to load history");
        } finally {
            setLoading(false);
        }
    };

    const handlePrevDay = () => setSelectedDate(prev => subDays(prev, 1));
    const handleNextDay = () => setSelectedDate(prev => addDays(prev, 1));

    const getFriendlyId = (order: any) => {
        if (order.friendly_id) return `#${order.friendly_id}`;
        return `#${order.id.slice(0, 5).toUpperCase()}`;
    };

    return (
        <div className="min-h-screen bg-slate-50 pb-24 font-sans">
            {/* 1. MAIN HEADER (Sticky) */}
            <header className="bg-white shadow-sm border-b border-slate-100 z-20 sticky top-0">
                <div className="px-6 py-4 flex items-center justify-between">
                    <div className="flex items-center gap-4">
                        <Link href="/driver" className="p-2 -ml-2 rounded-full hover:bg-slate-100 text-slate-500">
                            <ArrowLeft size={24} />
                        </Link>
                        <h1 className="text-xl font-black text-slate-800 tracking-tight">Daily History</h1>
                    </div>
                    <button
                        onClick={loadHistory}
                        className="p-2 text-slate-400 hover:text-emerald-600 transition-colors"
                    >
                        <RefreshCw size={20} className={loading ? 'animate-spin' : ''} />
                    </button>
                </div>

                {/* 2. DATE NAVIGATION BAR (Sticky Sub-header) */}
                <div className="bg-slate-50 border-b border-slate-200 px-4 py-2 flex items-center justify-between">
                    <button
                        onClick={handlePrevDay}
                        className="p-2 rounded-lg bg-white border border-slate-200 shadow-sm text-slate-500 active:scale-95 transition-transform"
                    >
                        <ChevronLeft size={20} />
                    </button>

                    <div className="flex items-center gap-2 bg-white px-4 py-2 rounded-lg border border-slate-200 shadow-sm relative">
                        <CalendarIcon size={16} className="text-emerald-500" />
                        <span className="text-sm font-bold text-slate-700 w-32 text-center">
                            {format(selectedDate, 'EEE, MMM do')}
                        </span>
                        {/* Hidden Date Input Overlay */}
                        <input
                            type="date"
                            className="absolute inset-0 opacity-0 cursor-pointer"
                            value={format(selectedDate, 'yyyy-MM-dd')}
                            onChange={(e) => {
                                if (e.target.value) setSelectedDate(new Date(e.target.value));
                            }}
                        />
                    </div>

                    <button
                        onClick={handleNextDay}
                        disabled={format(selectedDate, 'yyyy-MM-dd') === format(new Date(), 'yyyy-MM-dd')}
                        className="p-2 rounded-lg bg-white border border-slate-200 shadow-sm text-slate-500 active:scale-95 transition-transform disabled:opacity-50"
                    >
                        <ChevronRight size={20} />
                    </button>
                </div>
            </header>


            <main className="p-4 max-w-md mx-auto space-y-4">

                {/* LOADING SHIMMER */}
                {loading && completed.length === 0 && (
                    <div className="space-y-3 mt-4">
                        {[1, 2, 3].map(i => (
                            <div key={i} className="h-24 bg-white rounded-xl shadow-sm animate-pulse border border-slate-100"></div>
                        ))}
                    </div>
                )}

                {/* EMPTY STATE */}
                {!loading && completed.length === 0 && (
                    <div className="flex flex-col items-center justify-center py-20 text-center animate-in fade-in zoom-in duration-300">
                        <div className="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mb-4 text-slate-300">
                            <CheckCircle2 size={32} />
                        </div>
                        <h3 className="text-lg font-black text-slate-600">No Records Found</h3>
                        <p className="text-slate-400 text-sm font-medium mt-1">
                            No deliveries on {format(selectedDate, 'MMM do')}.
                        </p>
                    </div>
                )}

                {/* ORDER LIST */}
                {!loading && completed.map(order => (
                    <div key={order.id} className="bg-white p-5 rounded-xl shadow-sm border border-slate-100 relative overflow-hidden group hover:border-emerald-100 transition-colors">
                        <div className="flex justify-between items-start mb-3">
                            <div>
                                <div className="flex items-center gap-2 mb-1">
                                    <span className="bg-slate-100 text-slate-500 text-[10px] font-bold px-1.5 py-0.5 rounded tracking-wide">{getFriendlyId(order)}</span>
                                    <span className="text-[10px] uppercase font-bold text-slate-300">
                                        {format(new Date(order.created_at), 'h:mm a')}
                                    </span>
                                </div>
                                <h3 className="font-black text-slate-800 text-base leading-tight">{order.customers?.name || 'Unknown User'}</h3>
                            </div>

                            {/* Status Badge */}
                            <div className="text-right">
                                <span className="bg-emerald-50 text-emerald-600 text-[10px] font-black uppercase px-2 py-1 rounded-full border border-emerald-100">
                                    Delivered
                                </span>
                            </div>
                        </div>

                        <div className="flex items-center justify-between border-t border-slate-50 pt-3">
                            <div className="flex flex-col">
                                <span className="text-[10px] font-bold text-slate-400 uppercase">Paid / Total</span>
                                <div className="flex items-baseline gap-1">
                                    <span className="font-bold text-slate-900">Rs {order.amount_received?.toLocaleString() || '0'}</span>
                                    <span className="text-xs text-slate-400 font-medium">/ {order.total_amount?.toLocaleString()}</span>
                                </div>
                            </div>

                            <div className="flex flex-col items-end">
                                <span className="text-[10px] font-bold text-slate-400 uppercase mb-0.5">Payment</span>
                                <span className={`text-xs font-bold px-2 py-0.5 rounded capitalize ${order.payment_method === 'cash' ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'}`}>
                                    {order.payment_method || 'Pending'}
                                </span>
                            </div>
                        </div>

                        {/* Share Invoice Action */}
                        <div className="absolute bottom-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity">
                            <a
                                href={`https://wa.me/?text=Invoice for Order ${getFriendlyId(order)}: Rs ${order.total_amount} - Paid: Rs ${order.amount_received}`}
                                target="_blank"
                                className="p-2 bg-slate-900 text-white rounded-full shadow-lg hover:scale-110 transition-transform flex"
                            >
                                <Share2 size={14} />
                            </a>
                        </div>
                    </div>
                ))}

            </main>
        </div>
    );
}
</file>

<file path="src/app/(dashboard)/driver/layout.tsx">
export default function DriverLayout({
    children,
}: {
    children: React.ReactNode;
}) {
    return (
        <main className="pb-32 md:pb-36">
            {children}
        </main>
    );
}
</file>

<file path="src/app/(dashboard)/driver/orders/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { Truck, MapPin, Phone, Package, AlertCircle, Camera, Check, X, RefreshCw, ChevronLeft } from 'lucide-react';
import { toast } from 'sonner';
import Link from 'next/link';
import { getDriverOrders, startTrip, completeDelivery } from '@/app/actions/driverActions';
import { getCustomerAssets } from '@/app/actions/customerActions';

export default function OrdersPage() {
  const router = useRouter();
  const [loading, setLoading] = useState(true);
  const [orders, setOrders] = useState<any[]>([]);
  
  // -- DELIVERY MODAL STATE --
  const [activeOrder, setActiveOrder] = useState<any>(null);
  const [submitting, setSubmitting] = useState(false);
  const [receivedAmount, setReceivedAmount] = useState('');
  const [paymentMethod, setPaymentMethod] = useState('cash'); // 'cash' | 'credit'
  const [proofFile, setProofFile] = useState<File | null>(null);
  
  // Inventory Return State
  const [customerAssets, setCustomerAssets] = useState<any[]>([]);
  const [selectedReturns, setSelectedReturns] = useState<string[]>([]);
  const [loadingAssets, setLoadingAssets] = useState(false);
  const [returnsCount, setReturnsCount] = useState('0'); // Fallback manual count

  useEffect(() => {
    loadOrders();
  }, []);

  const loadOrders = async () => {
    setLoading(true);
    try {
      const data = await getDriverOrders();
      setOrders(data);
    } catch (error) {
      console.error("Failed to load orders", error);
      toast.error("Failed to load orders");
    } finally {
      setLoading(false);
    }
  };

  // -- HANDLERS --

  const handleStartTrip = async (orderId: string) => {
    const res = await startTrip([orderId]);
    if (res?.error) {
      toast.error(res.error);
    } else {
      toast.success("Trip Started! Drive Safe ");
      loadOrders(); // Refresh status
    }
  };

  const openDeliveryModal = async (order: any) => {
    setActiveOrder(order);
    // Reset Form
    setReceivedAmount(order.total_amount.toString());
    setPaymentMethod('cash');
    setProofFile(null);
    setReturnsCount('0');
    setSelectedReturns([]);
    setCustomerAssets([]);

    // Fetch Assets if customer exists
    if (order.customer_id) {
      setLoadingAssets(true);
      try {
        const assets = await getCustomerAssets(order.customer_id);
        setCustomerAssets(assets);
      } catch (err) {
        console.error("Failed to fetch customer assets", err);
      } finally {
        setLoadingAssets(false);
      }
    }
  };

  const toggleReturnAsset = (serial: string) => {
    setSelectedReturns(prev => 
      prev.includes(serial) ? prev.filter(s => s !== serial) : [...prev, serial]
    );
  };

  const handlePaymentMethodChange = (method: string) => {
    setPaymentMethod(method);
    if (activeOrder) {
      if (method === 'credit') {
        setReceivedAmount('0');
      } else {
        setReceivedAmount(activeOrder.total_amount.toString());
      }
    }
  };

  const handleSubmitDelivery = async () => {
    if (!activeOrder) return;

    // Validation
    const amt = parseFloat(receivedAmount);
    if (isNaN(amt) || amt < 0) {
      toast.error("Invalid Amount");
      return;
    }

    if (paymentMethod === 'cash' && amt > 0 && !proofFile) {
        toast.error("Please upload a photo of the cash/receipt!");
        return;
    }

    setSubmitting(true);
    
    // Prepare FormData
    const formData = new FormData();
    formData.append('order_id', activeOrder.id);
    formData.append('received_amount', amt.toString());
    formData.append('payment_method', paymentMethod);
    formData.append('returned_empty_count', returnsCount);
    formData.append('returned_serials', JSON.stringify(selectedReturns));
    if (proofFile) formData.append('proof_file', proofFile);
    
    // Append notes if needed, skipping for now as per backup

    const res = await completeDelivery(formData);

    if (res?.error) {
      toast.error(res.error);
    } else {
      toast.success("Delivery Completed!");
      setActiveOrder(null);
      loadOrders(); // Refresh list
    }
    setSubmitting(false);
  };

  // Helper
  const getFriendlyId = (order: any) => {
    if (order.friendly_id) return `#${order.friendly_id}`;
    return `#${order.id.slice(0, 5).toUpperCase()}`;
  };

  return (
    <div className="min-h-screen bg-slate-50 pb-24">
      {/* HEADER */}
      <header className="bg-white px-6 py-4 shadow-sm border-b border-slate-100 flex items-center gap-4 sticky top-0 z-10">
        <Link href="/driver" className="p-2 -ml-2 rounded-full hover:bg-slate-100 text-slate-500">
            <ChevronLeft size={24} />
        </Link>
        <h1 className="text-xl font-black text-slate-800 tracking-tight">Active Orders</h1>
        {loading && <RefreshCw size={16} className="animate-spin text-slate-400 ml-auto" />}
      </header>

      <main className="p-4 space-y-4 max-w-md mx-auto">
        {!loading && orders.length === 0 ? (
          <div className="flex flex-col items-center justify-center py-16 text-center animate-in fade-in zoom-in duration-300">
            <div className="w-24 h-24 bg-slate-100 rounded-full flex items-center justify-center mb-6 text-slate-300">
              <Truck size={40} />
            </div>
            <h3 className="text-xl font-black text-slate-700">All Caught Up!</h3>
            <p className="text-slate-500 text-sm mt-2 font-medium max-w-[200px]">No pending deliveries assigned to you.</p>
            <button onClick={loadOrders} className="mt-6 px-6 py-3 bg-white border border-slate-200 shadow-sm rounded-full font-bold text-slate-600 active:scale-95 transition-transform text-sm">
              Refresh
            </button>
          </div>
        ) : (
          orders.map(order => (
            <div key={order.id} className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden transform transition-all active:scale-[99%]">
               {/* Card Header */}
               <div className="p-5 border-b border-slate-50 relative overflow-hidden">
                    <div className="absolute top-0 right-0 p-2 opacity-5">
                      <Truck size={64} />
                    </div>
                    <div className="relative z-10">
                      <div className="flex justify-between items-start mb-2">
                        <div>
                          <span className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">{getFriendlyId(order)}</span>
                          <h3 className="text-lg font-black text-slate-800 leading-tight">{order.customers?.name}</h3>
                        </div>
                        {order.status === 'on_trip' ? (
                          <span className="animate-pulse bg-emerald-100 text-emerald-700 text-[10px] font-black uppercase px-2 py-1 rounded-full">Live</span>
                        ) : (
                          <span className="bg-blue-50 text-blue-600 text-[10px] font-black uppercase px-2 py-1 rounded-full">Assigned</span>
                        )}
                      </div>
                      <p className="text-sm text-slate-500 font-medium flex items-start gap-1.5 leading-snug">
                        <MapPin size={14} className="shrink-0 mt-0.5 text-slate-400" />
                        {order.customers?.address || 'Address not provided'}
                      </p>
                    </div>
                  </div>

                  {/* Card Body */}
                  <div className="p-5 pt-4">
                     {/* Asset List */}
                     <div className="bg-slate-50 rounded-lg p-3 mb-4 border border-slate-100">
                      <p className="text-[10px] uppercase font-bold text-slate-400 mb-2 flex items-center gap-1">
                        <Package size={12} /> Assigned Assets
                      </p>
                      <div className="flex flex-wrap gap-2">
                        {order.cylinders && order.cylinders.length > 0 ? (
                          order.cylinders.map((cyl: any, i: number) => (
                            <span key={i} className="bg-white border border-slate-200 text-slate-700 text-xs font-bold px-2 py-1 rounded shadow-sm">
                               {cyl.serial_number}
                            </span>
                          ))
                        ) : (
                          <span className="text-xs text-slate-400 italic">No specific assets linked</span>
                        )}
                      </div>
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                      <div className="bg-slate-50 rounded-lg p-3">
                        <p className="text-[10px] uppercase font-bold text-slate-400 mb-1">Qty</p>
                        <p className="font-black text-xl text-slate-800">{order.order_items?.[0]?.quantity || 0}</p>
                      </div>
                      <div className="bg-emerald-50 rounded-lg p-3 text-right">
                        <p className="text-[10px] uppercase font-bold text-emerald-600/60 mb-1">To Collect</p>
                        <p className="font-black text-xl text-emerald-700">Rs {order.total_amount?.toLocaleString()}</p>
                      </div>
                    </div>
                  </div>

                   {/* Card Footer */}
                   <div className="p-2 pb-3 px-3 flex gap-2">
                    <a href={`tel:${order.customers?.phone}`} className="flex-1 py-3 bg-white border border-slate-200 text-slate-600 rounded-lg font-bold text-sm flex items-center justify-center gap-2 active:bg-slate-50">
                      <Phone size={16} /> Call
                    </a>

                    {order.status === 'assigned' ? (
                      <button
                        onClick={() => handleStartTrip(order.id)}
                        className="flex-[2] py-3 rounded-lg font-bold text-sm shadow-md flex items-center justify-center gap-2 text-white transition-all bg-slate-800 active:bg-slate-900"
                      >
                        <Truck size={16} /> Start Trip
                      </button>
                    ) : (
                      <button
                        onClick={() => openDeliveryModal(order)}
                        className="flex-[2] py-3 rounded-lg font-bold text-sm shadow-md flex items-center justify-center gap-2 text-white transition-all bg-emerald-600 active:bg-emerald-700"
                      >
                        DELIVER & PAY
                      </button>
                    )}
                  </div>
            </div>
          ))
        )}
      </main>

      {/* -- DELIVERY MODAL -- */}
      {activeOrder && (
        <div className="fixed inset-0 z-50 bg-slate-900/90 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in zoom-in duration-200">
             <div className="bg-white w-full max-w-sm rounded-3xl overflow-hidden shadow-2xl relative max-h-[90vh] overflow-y-auto">
                <button onClick={() => setActiveOrder(null)} className="absolute top-4 right-4 bg-slate-100 p-2 rounded-full text-slate-500 hover:bg-slate-200 z-10">
                    <X size={20} />
                </button>

                <div className="p-6 pb-2">
                    <h3 className="text-2xl font-black text-slate-900 tracking-tight">Collect Payment</h3>
                    <p className="text-slate-500 text-sm font-medium">{getFriendlyId(activeOrder)}  {activeOrder.customers?.name}</p>
                </div>

                <div className="p-6 space-y-6">
                    {/* Payment Section */}
                    <div>
                        <div className="flex bg-slate-100 p-1 rounded-xl mb-4">
                            <button
                                onClick={() => handlePaymentMethodChange('cash')}
                                className={`flex-1 py-3 font-bold text-sm rounded-lg transition-all shadow-sm ${paymentMethod === 'cash' ? 'bg-white text-emerald-700 ring-1 ring-slate-200' : 'text-slate-400 shadow-none'}`}
                            >
                                CASH
                            </button>
                            <button
                                onClick={() => handlePaymentMethodChange('credit')}
                                className={`flex-1 py-3 font-bold text-sm rounded-lg transition-all shadow-sm ${paymentMethod === 'credit' ? 'bg-white text-amber-600 ring-1 ring-slate-200' : 'text-slate-400 shadow-none'}`}
                            >
                                CREDIT
                            </button>
                        </div>
                        
                        <label className="block text-xs font-bold text-slate-400 uppercase mb-2">Amount Received</label>
                        <div className="relative">
                            <div className="absolute left-4 top-4 text-slate-400 font-bold">Rs</div>
                            <input
                                type="number"
                                value={receivedAmount}
                                onChange={(e) => setReceivedAmount(e.target.value)}
                                className="w-full h-14 pl-10 bg-slate-50 rounded-xl border border-slate-200 font-black text-2xl text-slate-900 outline-none focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/20 transition-all placeholder:text-slate-300"
                                placeholder="0"
                            />
                        </div>
                        
                        {/* Debt Warning */}
                         {parseFloat(receivedAmount || '0') < activeOrder.total_amount && (
                            <div className="mt-3 bg-amber-50 p-3 rounded-lg border border-amber-100 flex items-start gap-2">
                                <AlertCircle size={16} className="text-amber-500 shrink-0 mt-0.5" />
                                <p className="text-xs text-amber-700 font-bold leading-tight">
                                    Rs {(activeOrder.total_amount - (parseFloat(receivedAmount) || 0)).toLocaleString()} added to Ledger.
                                </p>
                            </div>
                        )}
                    </div>

                    {/* Proof Upload (Only if Cash > 0) */}
                    {parseFloat(receivedAmount || '0') > 0 && paymentMethod === 'cash' && (
                        <div>
                             <label className="block text-xs font-bold text-slate-400 uppercase mb-2">Proof of Payment</label>
                             <label className={`flex flex-col items-center justify-center h-28 border-2 border-dashed rounded-xl cursor-pointer transition-all ${proofFile ? 'border-emerald-500 bg-emerald-50' : 'border-slate-300 bg-white hover:bg-slate-50'}`}>
                                {proofFile ? (
                                    <div className="text-emerald-600 font-bold text-sm flex flex-col items-center gap-1 animate-in zoom-in">
                                        <Check size={24} className="bg-emerald-100 p-1 rounded-full" />
                                        <span>Image Attached</span>
                                    </div>
                                ) : (
                                    <>
                                        <Camera size={28} className="text-slate-400 mb-2" />
                                        <span className="text-xs text-slate-500 font-bold">Tap to Take Photo</span>
                                    </>
                                )}
                                <input
                                    type="file"
                                    accept="image/*"
                                    capture="environment"
                                    className="hidden"
                                    onChange={(e) => setProofFile(e.target.files?.[0] || null)}
                                />
                             </label>
                        </div>
                    )}

                    {/* Inventory Returns */}
                    <div className="bg-slate-50 p-4 rounded-xl border border-slate-200">
                        <label className="block text-xs font-bold text-slate-400 uppercase mb-3 flex justify-between items-center">
                            <span>Select Returning Assets</span>
                            {loadingAssets && <RefreshCw size={12} className="animate-spin text-emerald-500" />}
                        </label>

                        <div className="space-y-2 max-h-40 overflow-y-auto pr-1">
                            {customerAssets.length > 0 ? (
                                customerAssets.map((asset) => (
                                    <label key={asset.id} className={`flex items-center gap-3 p-3 rounded-lg border cursor-pointer transition-all ${selectedReturns.includes(asset.serial_number) ? 'bg-white border-emerald-500 shadow-sm' : 'border-transparent hover:bg-white/50'}`}>
                                        <div className={`w-5 h-5 rounded flex items-center justify-center border ${selectedReturns.includes(asset.serial_number) ? 'bg-emerald-500 border-emerald-500 text-white' : 'border-slate-300 bg-white'}`}>
                                            {selectedReturns.includes(asset.serial_number) && <Check size={14} strokeWidth={3} />}
                                        </div>
                                        <input
                                            type="checkbox"
                                            className="hidden"
                                            checked={selectedReturns.includes(asset.serial_number)}
                                            onChange={() => toggleReturnAsset(asset.serial_number)}
                                        />
                                        <div>
                                            <p className="font-bold text-slate-700 text-sm"> {asset.serial_number}</p>
                                            <p className="text-[10px] uppercase font-bold text-slate-400">{asset.status === 'at_customer' ? 'At Customer' : asset.status}</p>
                                        </div>
                                    </label>
                                ))
                            ) : (
                                <div className="text-center py-4">
                                    <p className="text-sm text-slate-400 font-medium">No assets found for this customer.</p>
                                </div>
                            )}
                        </div>
                        
                        {/* Fallback Manual Entry */}
                         {customerAssets.length === 0 && (
                             <div className="mt-3 pt-3 border-t border-slate-200">
                                <p className="text-[10px] uppercase font-bold text-slate-400 mb-2">Manual Count (Fallback)</p>
                                <div className="flex items-center bg-white rounded-lg p-1 border border-slate-200">
                                    <button onClick={() => setReturnsCount(Math.max(0, parseInt(returnsCount) - 1).toString())} className="w-10 h-10 rounded shadow-sm font-bold text-slate-500 active:bg-slate-50">-</button>
                                    <input 
                                        type="number" 
                                        value={returnsCount}
                                        onChange={(e) => setReturnsCount(e.target.value)}
                                        className="flex-1 h-10 bg-transparent text-center font-bold text-slate-900 outline-none"
                                    />
                                    <button onClick={() => setReturnsCount((parseInt(returnsCount) + 1).toString())} className="w-10 h-10 rounded shadow-sm font-bold text-slate-500 active:bg-slate-50">+</button>
                                </div>
                             </div>
                         )}
                    </div>
                </div>

                {/* Footer */}
                <div className="p-4 bg-white border-t border-slate-100">
                    <button
                        onClick={handleSubmitDelivery}
                        disabled={submitting}
                        className="w-full py-4 bg-slate-900 text-white rounded-xl font-black uppercase text-lg shadow-xl active:scale-95 disabled:opacity-50 transition-all flex items-center justify-center gap-2"
                    >
                        {submitting ? <RefreshCw className="animate-spin" /> : 'Confirm Delivery'}
                    </button>
                </div>

             </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/app/(dashboard)/driver/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import {
  User, Bell, Wallet, Truck, Package, Receipt, LogOut,
  RefreshCw, ChevronRight, MapPin, Check, X, Info, Home, ArrowRightLeft
} from 'lucide-react';
import { toast } from 'sonner';
import { createClient } from '@/utils/supabase/client';
import { getDriverStats, getDriverAllAssets, getReceivers } from '@/app/actions/driverActions';

export default function DriverDashboard() {
  const supabase = createClient();
  const router = useRouter();

  // -- STATE --
  const [loading, setLoading] = useState(true);
  const [driverName, setDriverName] = useState('Driver');
  const [isOnline, setIsOnline] = useState(false);

  // Stats
  const [stats, setStats] = useState({ cashLiability: 0, emptiesOnHand: 0, fullOnHand: 0 });

  // Modals
  const [showStockModal, setShowStockModal] = useState(false);
  const [showHandoverModal, setShowHandoverModal] = useState(false);

  // Handover Form
  const [receivers, setReceivers] = useState<any[]>([]);
  const [selectedReceiver, setSelectedReceiver] = useState('');
  const [driverAssets, setDriverAssets] = useState<any[]>([]);
  const [selectedHandoverAssets, setSelectedHandoverAssets] = useState<string[]>([]);
  const [depositAmount, setDepositAmount] = useState('');
  const [submittingHandover, setSubmittingHandover] = useState(false);

  // -- LOAD DATA --
  useEffect(() => {
    loadDashboardData();
  }, []);

  const loadDashboardData = async () => {
    setLoading(true);
    // 1. User Info
    const { data: { user } } = await supabase.auth.getUser();
    if (user) {
      setDriverName(user.user_metadata?.name || 'Driver');

      // Fetch Real Name & Status
      const { data: profile } = await supabase
        .from('users')
        .select('name, status') // Assuming 'name' column exists in 'users' table (which is our profiles)
        .eq('id', user.id)
        .single();

      if (profile?.name) setDriverName(profile.name);
      setIsOnline(profile?.status === 'active' || profile?.status === 'online');
    }

    // 2. Stats
    const hudStats = await getDriverStats();
    // getDriverStats currently returns { cashLiability, emptiesOnHand }. 
    // We might need to fetch 'fullOnHand' separately or update getDriverStats.
    // For now, let's assume we can fetch inventory count 
    const { data: inventory } = await supabase
      .from('cylinders')
      .select('status')
      .eq('current_holder_id', user?.id)
      .eq('current_location_type', 'driver');

    const fullCount = inventory?.filter(c => c.status === 'full').length || 0;
    const emptyCount = inventory?.filter(c => c.status === 'empty').length || 0;

    setStats({
      cashLiability: hudStats.cashLiability,
      emptiesOnHand: emptyCount,
      fullOnHand: fullCount
    });

    setLoading(false);
  };

  // -- HANDLERS --

  const toggleStatus = async () => {
    const newStatus = !isOnline;
    setIsOnline(newStatus);
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return;

    // Update DB
    await supabase.from('users').update({
      status: newStatus ? 'active' : 'inactive'
    }).eq('id', user.id);

    toast.success(newStatus ? "You are now ONLINE" : "You are now OFFLINE");
  };

  const openHandover = async () => {
    setShowHandoverModal(true);
    // Load Handover Data
    const [assets, recs] = await Promise.all([
      getDriverAllAssets(),
      getReceivers()
    ]);
    setDriverAssets(assets);
    setReceivers(recs);
    if (recs.length > 0) setSelectedReceiver(recs[0].id);
    setDepositAmount(stats.cashLiability.toString()); // Default Max
  };

  const submitHandover = async () => {
    if (!selectedReceiver) {
      toast.error("Please select a receiver (Admin/Manager).");
      return;
    }

    const deposit = parseFloat(depositAmount);
    if (deposit > stats.cashLiability) {
      toast.error(`Insufficient Wallet Balance. Max: ${stats.cashLiability}`);
      return;
    }

    setSubmittingHandover(true);

    try {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) throw new Error("Unauthorized");

      // RPC CALL
      const { data, error } = await supabase.rpc('submit_driver_handover', {
        p_driver_id: user.id,
        p_receiver_id: selectedReceiver,
        p_cash_amount: deposit,
        p_cylinder_ids: selectedHandoverAssets // Array of UUIDs
      });

      if (error) throw error;
      if (data && !data.success) throw new Error(data.message || "Handover failed");

      toast.success("Handover Request Sent!", {
        description: "Admin approval required."
      });
      setShowHandoverModal(false);
      loadDashboardData(); // Refresh Stats

    } catch (err: any) {
      console.error("RPC Error:", err);
      toast.error(err.message || "Failed to submit handover.");
    } finally {
      setSubmittingHandover(false);
    }
  };

  // Helper to toggle assets in modal
  const toggleAsset = (id: string) => {
    if (selectedHandoverAssets.includes(id)) {
      setSelectedHandoverAssets(selectedHandoverAssets.filter(s => s !== id));
    } else {
      setSelectedHandoverAssets([...selectedHandoverAssets, id]);
    }
  };

  // -- RENDER --

  return (
    <div className="min-h-screen bg-slate-50 font-sans pb-24 text-slate-900">

      {/* A. HEADER */}
      <header className="bg-white sticky top-0 z-30 px-6 py-4 shadow-sm border-b border-slate-100 flex justify-between items-center">
        <div>
          <p className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-0.5">Salam,</p>
          <h1 className="text-xl font-black text-slate-800 tracking-tight">{driverName}!</h1>
        </div>
        <div className="flex items-center gap-4">
          {/* Status Toggle */}
          <button
            onClick={toggleStatus}
            className={`flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-bold transition-all ${isOnline ? 'bg-emerald-100 text-emerald-700 ring-1 ring-emerald-500' : 'bg-slate-100 text-slate-500'}`}
          >
            <div className={`w-2 h-2 rounded-full ${isOnline ? 'bg-emerald-500 animate-pulse' : 'bg-slate-400'}`} />
            {isOnline ? 'ONLINE' : 'OFFLINE'}
          </button>
          {/* Notification Bell */}
          <div className="relative">
            <Bell size={24} className="text-slate-600" />
            <span className="absolute -top-1 -right-1 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white"></span>
          </div>
        </div>
      </header>

      <main className="p-6 space-y-6">

        {/* B. HERO CARD (WALLET) */}
        {/* B. HERO CARD (WALLET) */}
        <div className="relative overflow-hidden rounded-2xl p-6 shadow-md bg-white border border-slate-100">
          <div className="relative z-10">
            <div className="flex justify-between items-start mb-2">
              <p className="text-sm font-bold text-slate-400 uppercase tracking-wider">Cash in Hand</p>
              {stats.cashLiability >= 10000 ? (
                <div className="px-3 py-1 bg-rose-50 text-rose-600 rounded-full text-[10px] font-black uppercase tracking-wide border border-rose-100">
                  Deposit Needed
                </div>
              ) : (
                <div className="px-3 py-1 bg-emerald-50 text-emerald-600 rounded-full text-[10px] font-black uppercase tracking-wide border border-emerald-100">
                  Limit Safe
                </div>
              )}
            </div>

            <h2 className={`text-4xl font-black mb-4 tracking-tight ${stats.cashLiability >= 10000 ? 'text-rose-600' : 'text-emerald-600'}`}>
              <span className="text-2xl font-bold opacity-60 mr-1 text-slate-400">Rs.</span>
              {stats.cashLiability.toLocaleString()}
            </h2>

            <div className="flex items-center justify-end">
              <Link href="/driver/history" className="flex items-center gap-1 text-sm font-bold text-slate-400 hover:text-slate-600 transition-colors">
                View History <ChevronRight size={16} />
              </Link>
            </div>
          </div>
        </div>

        {/* C. ACTION GRID */}
        <div className="grid grid-cols-2 gap-4">

          {/* 1. My Stock */}
          <button
            onClick={() => setShowStockModal(true)}
            className="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 flex flex-col items-start gap-3 active:scale-[98%] transition-transform"
          >
            <div className="w-10 h-10 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center">
              <Package size={22} />
            </div>
            <div className="text-left">
              <h3 className="font-bold text-slate-800">My Stock</h3>
              <p className="text-xs text-slate-500 font-medium mt-0.5">{stats.fullOnHand + stats.emptiesOnHand} Cylinders</p>
            </div>
          </button>

          {/* 2. New Orders */}
          <Link
            href="/driver/orders"
            className="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 flex flex-col items-start gap-3 active:scale-[98%] transition-transform"
          >
            <div className="w-10 h-10 bg-emerald-50 text-emerald-600 rounded-xl flex items-center justify-center">
              <Truck size={22} />
            </div>
            <div className="text-left">
              <h3 className="font-bold text-slate-800">New Orders</h3>
              <p className="text-xs text-slate-500 font-medium mt-0.5">Start Delivery</p>
            </div>
          </Link>

          {/* 3. Add Expense */}
          <Link
            href="/driver/expenses"
            className="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 flex flex-col items-start gap-3 active:scale-[98%] transition-transform"
          >
            <div className="w-10 h-10 bg-amber-50 text-amber-600 rounded-xl flex items-center justify-center">
              <Receipt size={22} />
            </div>
            <div className="text-left">
              <h3 className="font-bold text-slate-800">Add Expense</h3>
              <p className="text-xs text-slate-500 font-medium mt-0.5">Fuel, Food...</p>
            </div>
          </Link>

          {/* 4. End Shift */}
          {/* 4. End Shift */}
          <button
            onClick={openHandover}
            className="bg-white p-5 rounded-2xl shadow-sm border-2 border-indigo-100 flex flex-col items-start gap-3 active:scale-[98%] transition-transform"
          >
            <div className="w-10 h-10 bg-indigo-50 text-indigo-600 rounded-xl flex items-center justify-center">
              <ArrowRightLeft size={22} />
            </div>
            <div className="text-left">
              <h3 className="font-bold text-slate-800">Deposit Assets</h3>
              <p className="text-xs text-slate-500 font-medium mt-0.5">Handover Cash/Stock</p>
            </div>
          </button>
        </div>

        {/* Promo/Status Card (Optional) */}


      </main>

      {/* D. BOTTOM NAVIGATION (Sticky) */}
      <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 flex justify-around items-center p-2 pb-5 z-40 shadow-[0_-4px_20px_rgba(0,0,0,0.05)]">
        <Link href="/driver" className="flex flex-col items-center gap-1 p-2 text-emerald-600">
          <div className="bg-emerald-50 px-5 py-1.5 rounded-full">
            <Home size={24} fill="currentColor" />
          </div>
          <span className="text-[10px] font-bold">Home</span>
        </Link>
        <Link href="/driver/history" className="flex flex-col items-center gap-1 p-2 text-slate-400 hover:text-slate-600 transition-colors">
          <Receipt size={24} />
          <span className="text-[10px] font-medium">History</span>
        </Link>
        <Link href="/driver/profile" className="flex flex-col items-center gap-1 p-2 text-slate-400 hover:text-slate-600 transition-colors">
          <User size={24} />
          <span className="text-[10px] font-medium">Profile</span>
        </Link>
      </div>


      {/* -- MODALS -- */}

      {/* 1. STOCK MODAL */}
      {showStockModal && (
        <div className="fixed inset-0 z-50 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in zoom-in duration-200">
          <div className="bg-white w-full max-w-sm rounded-3xl p-6 relative shadow-2xl">
            <button onClick={() => setShowStockModal(false)} className="absolute top-4 right-4 p-2 bg-slate-100 rounded-full text-slate-500 hover:bg-slate-200">
              <X size={20} />
            </button>

            <h3 className="text-xl font-black text-slate-900 mb-6">Current Inventory</h3>

            <div className="space-y-4">
              <div className="bg-emerald-50 p-4 rounded-2xl border border-emerald-100 flex justify-between items-center">
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 bg-emerald-100 text-emerald-600 rounded-xl flex items-center justify-center font-bold">F</div>
                  <div>
                    <h4 className="font-bold text-slate-800">Full Cylinders</h4>
                    <p className="text-xs text-emerald-600 font-bold uppercase">Ready to Sell</p>
                  </div>
                </div>
                <span className="text-3xl font-black text-slate-900">{stats.fullOnHand}</span>
              </div>

              <div className="bg-amber-50 p-4 rounded-2xl border border-amber-100 flex justify-between items-center">
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 bg-amber-100 text-amber-600 rounded-xl flex items-center justify-center font-bold">E</div>
                  <div>
                    <h4 className="font-bold text-slate-800">Empty Cylinders</h4>
                    <p className="text-xs text-amber-600 font-bold uppercase">To Return</p>
                  </div>
                </div>
                <span className="text-3xl font-black text-slate-900">{stats.emptiesOnHand}</span>
              </div>
            </div>

            <button onClick={() => setShowStockModal(false)} className="w-full mt-6 py-3 bg-slate-900 text-white font-bold rounded-xl">
              Close
            </button>
          </div>
        </div>
      )}

      {/* 2. HANDOVER MODAL */}
      {showHandoverModal && (
        <div className="fixed inset-0 z-50 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in zoom-in duration-200">
          <div className="bg-white w-full max-w-md rounded-3xl relative shadow-2xl flex flex-col max-h-[90vh]">

            {/* Header */}
            <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-3xl">
              <div>
                <h3 className="text-xl font-black text-slate-900">Deposit Assets to Warehouse</h3>
                <p className="text-xs text-slate-500 font-medium">Select Cash & Cylinders to return.</p>
              </div>
              <button onClick={() => setShowHandoverModal(false)} className="p-2 bg-white border border-slate-200 rounded-full text-slate-500 hover:bg-slate-50">
                <X size={20} />
              </button>
            </div>

            {/* Scrollable Body */}
            <div className="flex-1 overflow-y-auto p-6 space-y-6">

              {/* Recevier */}
              <div>
                <label className="block text-xs font-bold text-slate-400 uppercase mb-2">Handover To</label>
                <select
                  value={selectedReceiver}
                  onChange={(e) => setSelectedReceiver(e.target.value)}
                  className="w-full h-12 bg-white border border-slate-200 rounded-xl px-4 font-bold text-slate-800 outline-none focus:ring-2 focus:ring-emerald-500"
                >
                  {receivers.map(r => <option key={r.id} value={r.id}>{r.name} ({r.role})</option>)}
                </select>
              </div>

              {/* Cash */}
              <div>
                <label className="block text-xs font-bold text-slate-400 uppercase mb-2">Cash Deposit</label>
                <div className="relative">
                  <span className="absolute left-4 top-3.5 font-bold text-slate-400">Rs.</span>
                  <input
                    type="number"
                    value={depositAmount}
                    onChange={(e) => setDepositAmount(e.target.value)}
                    className="w-full h-12 pl-12 bg-white border border-slate-200 rounded-xl font-black text-xl text-slate-900 outline-none focus:ring-2 focus:ring-emerald-500"
                  />
                </div>
                <div className="flex justify-between mt-2 text-xs">
                  <span className="text-slate-500">Wallet Balance:</span>
                  <span className="font-bold text-slate-900">Rs {stats.cashLiability.toLocaleString()}</span>
                </div>
              </div>

              {/* Assets */}
              <div className="bg-slate-50 p-4 rounded-xl border border-slate-100">
                <label className="block text-xs font-bold text-slate-400 uppercase mb-3">Select Assets to Return</label>
                <div className="space-y-2 max-h-40 overflow-y-auto">
                  {driverAssets.length === 0 ? (
                    <p className="text-center text-sm text-slate-400 py-4 italic">No assets on truck.</p>
                  ) : (
                    driverAssets.map(asset => (
                      <button
                        key={asset.id}
                        onClick={() => toggleAsset(asset.id)} // Use ID
                        className={`w-full flex items-center justify-between p-3 rounded-xl border transition-all ${selectedHandoverAssets.includes(asset.id) ? 'bg-white border-emerald-500 shadow-sm ring-1 ring-emerald-500' : 'bg-white border-slate-200 opacity-80'}`}
                      >
                        <div className="flex items-center gap-3">
                          <div className={`w-5 h-5 rounded flex items-center justify-center border ${selectedHandoverAssets.includes(asset.id) ? 'bg-emerald-500 border-emerald-500 text-white' : 'border-slate-300'}`}>
                            {selectedHandoverAssets.includes(asset.id) && <Check size={14} />}
                          </div>
                          <div className="text-left">
                            <span className="block text-sm font-bold text-slate-800">{asset.serial_number}</span>
                            <span className="block text-[10px] uppercase font-bold text-slate-400">{asset.status}</span>
                          </div>
                        </div>
                      </button>
                    ))
                  )}
                </div>
              </div>

            </div>

            {/* Footer */}
            <div className="p-6 bg-white border-t border-slate-100 rounded-b-3xl">
              <button
                onClick={submitHandover}
                disabled={submittingHandover}
                className="w-full py-4 bg-slate-900 text-white rounded-xl font-bold hover:bg-slate-800 active:scale-95 transition-all disabled:opacity-50 flex items-center justify-center gap-2"
              >
                {submittingHandover ? <RefreshCw className="animate-spin" /> : 'Confirm Handover'}
              </button>
            </div>
          </div>
        </div>
      )}

    </div>
  );
}
</file>

<file path="src/app/(dashboard)/driver/profile/page.tsx">
'use client';

import { useEffect, useState } from 'react';
import { getDriverProfile } from '@/app/actions/driverActions';
import { User, Truck, Phone, LogOut, CheckCircle, ChevronRight, AlertCircle } from 'lucide-react';
import LogoutBtn from '@/components/LogoutBtn';

export default function DriverProfilePage() {
    const [profile, setProfile] = useState<any>(null);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        async function load() {
            setLoading(true);
            const data = await getDriverProfile();
            setProfile(data);
            setLoading(false);
        }
        load();
    }, []);

    if (loading) {
        return (
            <div className="min-h-screen bg-white p-6 flex flex-col items-center justify-center space-y-4">
                <div className="w-24 h-24 bg-slate-100 rounded-full animate-pulse" />
                <div className="h-4 w-32 bg-slate-100 rounded animate-pulse" />
            </div>
        );
    }

    if (!profile) {
        return (
            <div className="p-6 text-center pt-24">
                <div className="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                    <AlertCircle size={32} />
                </div>
                <p className="text-slate-500 font-medium">Profile data unavailable.</p>
                <div className="mt-8">
                    <LogoutBtn className="w-full justify-center border border-red-200" />
                </div>
            </div>
        );
    }

    return (
        <div className="min-h-screen bg-slate-50 pb-safe">
            {/* 1. Header (Clean White) */}
            <div className="bg-white px-6 pt-12 pb-8 flex flex-col items-center shadow-sm border-b border-slate-100 relative z-10">
                <div className="w-24 h-24 bg-slate-900 text-white rounded-full flex items-center justify-center text-3xl font-bold shadow-xl mb-4 relative">
                    {profile.full_name?.[0] || 'D'}
                    <div className="absolute -bottom-1 -right-1 bg-emerald-500 text-white p-1.5 rounded-full border-4 border-white">
                        <CheckCircle size={16} fill="currentColor" className="text-white" />
                    </div>
                </div>

                <h1 className="text-2xl font-black text-slate-900 tracking-tight text-center">
                    {profile.full_name || 'Unknown Driver'}
                </h1>

                <div className="mt-2 flex items-center gap-1.5 bg-slate-100 px-3 py-1 rounded-full">
                    <span className="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse" />
                    <span className="text-slate-500 text-xs font-bold uppercase tracking-wide">
                        {profile.role || 'Active Driver'}
                    </span>
                </div>
            </div>

            {/* 2. Info Content (Settings Rows) */}
            <main className="p-4 space-y-6 max-w-lg mx-auto mt-4">
                <div className="space-y-2">
                    <p className="px-2 text-xs font-bold text-slate-400 uppercase tracking-wider">Vehicle & Contact</p>
                    <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden divide-y divide-slate-100">
                        {/* Vehicle Row */}
                        <div className="flex items-center p-4 gap-4">
                            <div className="w-10 h-10 bg-amber-50 text-amber-600 rounded-lg flex items-center justify-center shrink-0">
                                <Truck size={20} />
                            </div>
                            <div className="flex-1 min-w-0">
                                <p className="text-xs text-slate-500 font-medium">Vehicle Number</p>
                                <p className="text-base font-bold text-slate-800 truncate">
                                    {profile.vehicle_number || 'No Vehicle'}
                                </p>
                            </div>
                            <button disabled className="text-slate-300">
                                <ChevronRight size={20} />
                            </button>
                        </div>

                        {/* Phone Row */}
                        <div className="flex items-center p-4 gap-4">
                            <div className="w-10 h-10 bg-blue-50 text-blue-600 rounded-lg flex items-center justify-center shrink-0">
                                <Phone size={20} />
                            </div>
                            <div className="flex-1 min-w-0">
                                <p className="text-xs text-slate-500 font-medium">Phone Number</p>
                                <p className="text-base font-bold text-slate-800 truncate">
                                    {profile.phone_number || 'No Phone'}
                                </p>
                            </div>
                            <button disabled className="text-slate-300">
                                <ChevronRight size={20} />
                            </button>
                        </div>
                    </div>
                    <p className="px-2 text-[10px] text-slate-400">
                        Contact Admin to update these details.
                    </p>
                </div>

                {/* 3. Actions Footer */}
                <div className="pt-8 space-y-3">
                    <a
                        href="tel:+923000000000"
                        className="flex items-center justify-center w-full py-3.5 bg-white border border-slate-200 text-slate-600 font-bold rounded-xl hover:bg-slate-50 transition-colors shadow-sm"
                    >
                        Call Support
                    </a>

                    <LogoutBtn
                        className="w-full justify-center py-3.5 border border-red-200 bg-white text-red-600 hover:bg-red-50 rounded-xl font-bold shadow-sm"
                        iconOnly={false}
                    />
                </div>
            </main>
        </div>
    );
}
</file>

<file path="src/app/(dashboard)/recovery/history/page.tsx">
import { createClient } from "@/utils/supabase/server";
import { redirect } from "next/navigation";
import { getAgentHistory } from "@/app/actions/recoveryActions";
import { Card, CardContent } from "@/components/ui/card";
import { ArrowLeft, Clock, CheckCircle, XCircle, FileText, Image as ImageIcon } from "lucide-react";
import Link from "next/link";
import { formatDistanceToNow } from "date-fns";
import { Dialog, DialogContent, DialogTrigger } from "@/components/ui/dialog";

export default async function HistoryPage() {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();

    if (!user) return redirect("/login");

    const history = await getAgentHistory();

    return (
        <div className="min-h-screen bg-slate-50 pb-20 font-sans">
            {/* Header */}
            <div className="bg-emerald-900 pt-8 pb-16 px-6 rounded-b-[2.5rem] shadow-xl relative overflow-hidden">
                <div className="relative z-10 flex items-center gap-4 mb-2">
                    <Link href="/recovery" className="p-2 bg-white/10 rounded-full text-white hover:bg-white/20 transition-colors">
                        <ArrowLeft size={20} />
                    </Link>
                    <h1 className="text-2xl font-bold text-white tracking-tight">Transaction History</h1>
                </div>
                <p className="text-emerald-200/80 text-sm ml-14">Your evidence log of all collections and handovers.</p>
            </div>

            {/* List */}
            <div className="px-6 -mt-8 relative z-20 space-y-4">
                {history.length === 0 ? (
                    <Card className="border-0 shadow-sm">
                        <CardContent className="p-8 text-center text-slate-400">
                            <p>No history found.</p>
                        </CardContent>
                    </Card>
                ) : (
                    history.map((txn: any) => (
                        <Card key={txn.id} className="border-0 shadow-sm ring-1 ring-slate-100 overflow-hidden">
                            <CardContent className="p-4">
                                <div className="flex justify-between items-start mb-2">
                                    <div className="flex items-center gap-2">
                                        <span className={`text-[10px] font-bold px-2 py-0.5 rounded-full uppercase tracking-wide border ${txn.type === 'collection'
                                                ? 'bg-blue-50 text-blue-600 border-blue-100'
                                                : 'bg-amber-50 text-amber-600 border-amber-100'
                                            }`}>
                                            {txn.type === 'collection' ? 'Customer Collection' : 'Admin Handover'}
                                        </span>
                                        <span className="text-xs text-slate-400">
                                            {formatDistanceToNow(new Date(txn.created_at), { addSuffix: true })}
                                        </span>
                                    </div>
                                    {getStatusIcon(txn.status)}
                                </div>

                                <div className="flex justify-between items-end">
                                    <div>
                                        <p className="font-bold text-slate-800 text-lg">
                                            {txn.customers?.name || (txn.type === 'handover_request' ? 'Handover to Admin' : 'Unknown')}
                                        </p>
                                        <p className="text-xs text-slate-500 italic mt-0.5 line-clamp-1">
                                            {txn.description}
                                        </p>
                                    </div>
                                    <div className="text-right">
                                        <div className={`font-mono font-bold text-xl ${txn.amount < 0 ? 'text-blue-600' : 'text-slate-800'}`}>
                                            Rs {Math.abs(txn.amount).toLocaleString()}
                                        </div>
                                    </div>
                                </div>

                                {/* Proof View */}
                                {txn.proof_url && (
                                    <div className="mt-3 pt-3 border-t border-slate-50 flex justify-end">
                                        <Dialog>
                                            <DialogTrigger asChild>
                                                <button className="flex items-center gap-1.5 text-xs font-bold text-emerald-600 bg-emerald-50 px-3 py-1.5 rounded-lg hover:bg-emerald-100 transition-colors">
                                                    <ImageIcon size={14} />
                                                    View Proof
                                                </button>
                                            </DialogTrigger>
                                            <DialogContent className="max-w-md p-0 overflow-hidden bg-transparent border-0 shadow-none">
                                                <div className="relative w-full h-[60vh] rounded-xl overflow-hidden bg-black flex items-center justify-center">
                                                    {/* eslint-disable-next-line @next/next/no-img-element */}
                                                    <img
                                                        src={txn.proof_url}
                                                        alt="Proof"
                                                        className="max-w-full max-h-full object-contain"
                                                    />
                                                </div>
                                            </DialogContent>
                                        </Dialog>
                                    </div>
                                )}
                            </CardContent>
                        </Card>
                    ))
                )}
            </div>
        </div>
    );
}

function getStatusIcon(status: string) {
    switch (status) {
        case 'collected_cash':
        case 'verified':
        case 'approved':
            return <span className="flex items-center gap-1 text-[10px] font-bold text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded-full border border-emerald-100"><CheckCircle size={12} /> Success</span>;
        case 'pending':
        case 'pending_verification':
            return <span className="flex items-center gap-1 text-[10px] font-bold text-amber-600 bg-amber-50 px-2 py-0.5 rounded-full border border-amber-100"><Clock size={12} /> Pending</span>;
        case 'rejected':
            return <span className="flex items-center gap-1 text-[10px] font-bold text-red-600 bg-red-50 px-2 py-0.5 rounded-full border border-red-100"><XCircle size={12} /> Rejected</span>;
        default:
            return <span className="text-[10px] font-bold text-slate-400 capitalize">{status.replace('_', ' ')}</span>;
    }
}
</file>

<file path="src/app/(dashboard)/recovery/loading.tsx">
import { RecoverySkeleton } from "@/components/recovery/RecoverySkeleton";

export default function Loading() {
    return (
        <div className="flex flex-col min-h-screen bg-slate-50 pb-20 font-sans">
            <div className="bg-gradient-to-br from-emerald-900 via-emerald-800 to-teal-900 pt-8 pb-32 px-6 rounded-b-[2.5rem] relative overflow-hidden">
                <div className="flex justify-between items-start mb-6">
                    <div className="space-y-2">
                        <div className="h-4 w-24 bg-white/20 rounded animate-pulse"></div>
                        <div className="h-8 w-40 bg-white/20 rounded animate-pulse"></div>
                    </div>
                    <div className="h-10 w-10 bg-white/20 rounded-full animate-pulse"></div>
                </div>
            </div>

            <div className="px-6 -mt-24 relative z-20 space-y-5">
                <div className="h-48 w-full bg-white rounded-2xl shadow-lg animate-pulse"></div>
                <RecoverySkeleton />
            </div>
        </div>
    );
}
</file>

<file path="src/app/(dashboard)/recovery/page.tsx">
import { createClient } from "@/utils/supabase/server";
import { redirect } from "next/navigation";
import { getRecoveryStats, getDueCustomers, getRecoveryReceivers } from "@/app/actions/recoveryActions";
import { Card, CardContent } from "@/components/ui/card";
import { HandoverDialog } from "@/components/recovery/HandoverDialog";
import { LogoutButton } from "@/components/recovery/LogoutButton";
import { RecoveryStats } from "@/components/recovery/RecoveryStats";
import { RecoveryList } from "@/components/recovery/RecoveryList";

export const dynamic = "force-dynamic";

export default async function RecoveryDashboard() {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();

    if (!user) return redirect("/login");

    const stats = await getRecoveryStats();
    const dueCustomers = await getDueCustomers();
    const receivers = await getRecoveryReceivers();

    // Get User Name
    const agentName = user.user_metadata?.full_name || user.user_metadata?.name || "Agent";

    // Calculate total due
    const totalDue = dueCustomers.reduce((acc, curr) => acc + Math.abs(curr.current_balance), 0);

    return (
        <div className="flex flex-col min-h-screen bg-slate-50 pb-20 font-sans">
            {/* 1. HERO SECTION & HEADER */}
            <div className="bg-gradient-to-br from-emerald-900 via-emerald-800 to-teal-900 pt-8 pb-20 px-6 rounded-b-[2.5rem] shadow-2xl relative overflow-hidden">
                {/* Decorative Elements */}
                <div className="absolute top-0 right-0 w-64 h-64 bg-white/5 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>
                <div className="absolute bottom-0 left-0 w-48 h-48 bg-emerald-500/10 rounded-full blur-2xl -ml-10 pointer-events-none"></div>

                <div className="relative z-10 flex justify-between items-start mb-6">
                    <div>
                        <p className="text-emerald-100/80 text-sm font-medium tracking-wide mb-1 uppercase">Welcome Back</p>
                        <h1 className="text-2xl font-bold text-white tracking-tight">{agentName}</h1>
                        <p className="text-emerald-200/70 text-xs mt-1">{new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}</p>
                    </div>
                    <div className="flex gap-2">
                        <a href="/recovery/history" className="p-2 bg-white/10 rounded-full text-emerald-100 hover:bg-white/20 transition-colors">
                            <span className="sr-only">History</span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v5h5" /><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8" /></svg>
                        </a>
                        <LogoutButton />
                    </div>
                </div>
            </div>

            {/* 2. FLOATING WALLET CARD */}
            <div className="px-6 -mt-16 relative z-20 space-y-5">
                <Card className="shadow-[0_10px_40px_-10px_rgba(0,0,0,0.1)] border-0 bg-white/95 backdrop-blur-xl ring-1 ring-slate-100 rounded-2xl overflow-hidden">
                    <CardContent className="p-6">
                        <div className="flex flex-col items-center justify-center space-y-4">
                            <div className="text-center">
                                <span className="text-xs font-bold text-slate-400 uppercase tracking-widest">Available to Handover</span>
                                <div className="text-4xl font-extrabold text-slate-900 mt-2 tracking-tight">
                                    <span className="text-2xl align-top text-slate-400 font-medium mr-1">Rs</span>
                                    {(stats.cashOnHand - (stats.pendingAmount || 0)).toLocaleString()}
                                </div>
                                {(stats.pendingAmount || 0) > 0 && (
                                    <p className="text-xs text-amber-600 font-bold mt-2 bg-amber-50 inline-block px-2 py-1 rounded-full border border-amber-100">
                                        Rs {(stats.pendingAmount || 0).toLocaleString()} Pending Approval
                                    </p>
                                )}
                            </div>

                            <div className="w-full flex justify-center">
                                <HandoverDialog
                                    currentBalance={stats.cashOnHand - (stats.pendingAmount || 0)}
                                    receivers={receivers}
                                />
                            </div>
                        </div>
                    </CardContent>
                    {/* Subtle bottom stripe */}
                    <div className="h-1 w-full bg-gradient-to-r from-emerald-500 via-teal-500 to-emerald-500 opacity-80"></div>
                </Card>

                {/* 3. NEW STATS WIDGET */}
                <RecoveryStats totalDue={totalDue} count={dueCustomers.length} />
            </div>

            {/* 4. DUE LIST SECTION */}
            <div className="flex-1 px-6 mt-8">
                <div className="flex justify-between items-end mb-4 px-1">
                    <div>
                        <h2 className="text-lg font-bold text-slate-800">Due Payments</h2>
                        <p className="text-xs text-slate-500 mt-0.5">Focus on highest debt first</p>
                    </div>
                </div>

                <RecoveryList customers={dueCustomers} />
            </div>
        </div>
    );
}
</file>

<file path="src/app/actions/adminExpenseActions.ts">
'use server';

import { createClient } from "@/utils/supabase/server";
import { revalidatePath } from "next/cache";

export async function getExpenses(statusFilter: 'pending' | 'approved' | 'rejected' = 'pending') {
    const supabase = await createClient();

    const { data, error } = await supabase
        .from('expenses')
        .select('*, profiles!expenses_user_id_fkey(full_name)')
        .eq('status', statusFilter)
        .order('created_at', { ascending: false });

    if (error) {
        console.error("Error fetching expenses:", error);
        return [];
    }

    return data;
}

export async function getExpenseStats() {
    const supabase = await createClient();

    // Dates
    const now = new Date();
    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();

    // Last 7 Days logic:
    // We want today + 6 previous days.
    const dates = [];
    for (let i = 6; i >= 0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        dates.push(d);
    }
    // Set start date to beginning of "Day 1"
    const startOf7Days = new Date(dates[0]);
    startOf7Days.setHours(0, 0, 0, 0);

    // A. Month's Spend
    const { data: monthData } = await supabase
        .from('expenses')
        .select('amount')
        .eq('status', 'approved')
        .gte('created_at', startOfMonth);

    const monthSpend = monthData?.reduce((sum, item) => sum + item.amount, 0) || 0;

    // B. Pending Liability
    const { data: pendingData } = await supabase
        .from('expenses')
        .select('amount')
        .eq('status', 'pending');

    const pendingLiability = pendingData?.reduce((sum, item) => sum + item.amount, 0) || 0;

    // C. Top Category
    const { data: catData } = await supabase
        .from('expenses')
        .select('category, amount')
        .eq('status', 'approved');

    const catMap: Record<string, number> = {};
    let totalApproved = 0;
    catData?.forEach(item => {
        catMap[item.category] = (catMap[item.category] || 0) + item.amount;
        totalApproved += item.amount;
    });

    let topCategory = { name: 'N/A', amount: 0, percentage: 0 };
    Object.entries(catMap).forEach(([name, amount]) => {
        if (amount > topCategory.amount) {
            topCategory = { name, amount, percentage: 0 };
        }
    });
    if (totalApproved > 0) {
        topCategory.percentage = Math.round((topCategory.amount / totalApproved) * 100);
    }

    // D. Last 7 Days Trend
    const { data: trendData } = await supabase
        .from('expenses')
        .select('created_at, amount')
        .eq('status', 'approved')
        .gte('created_at', startOf7Days.toISOString());

    // Initialize buckets
    const daysMap = new Map<string, number>();
    dates.forEach(d => {
        // Use YYYY-MM-DD for grouping
        const key = d.toISOString().split('T')[0];
        daysMap.set(key, 0);
    });

    trendData?.forEach(item => {
        // Convert DB time (ISO String) to YYYY-MM-DD key.
        const dateObj = new Date(item.created_at);
        const key = dateObj.toISOString().split('T')[0];

        if (daysMap.has(key)) {
            daysMap.set(key, (daysMap.get(key) || 0) + item.amount);
        }
    });

    const weeklyTrend = Array.from(daysMap.entries()).map(([dateStr, amount]) => {
        const d = new Date(dateStr);
        return {
            date: d.toLocaleDateString('en-US', { weekday: 'short' }), // Mon
            amount: Number(amount) // Ensure number
        };
    });

    return {
        monthSpend,
        pendingLiability,
        topCategory,
        weeklyTrend
    };
}

export async function approveExpense(expenseId: string) {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();

    if (!user) return { error: "Unauthorized" };

    const { data, error } = await supabase.rpc('approve_expense', {
        p_expense_id: expenseId,
        p_admin_id: user.id
    });

    if (error) {
        console.error("Error approving expense:", error);
        return { error: error.message };
    }

    if (data && !data.success) {
        return { error: data.message || "Approval failed" };
    }

    revalidatePath('/admin/expenses');
    return { success: true };
}

export async function rejectExpense(expenseId: string) {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();

    if (!user) return { error: "Unauthorized" };

    const { data, error } = await supabase.rpc('reject_expense', {
        p_expense_id: expenseId,
        p_admin_id: user.id
    });

    if (error) {
        console.error("Error rejecting expense:", error);
        return { error: error.message };
    }

    if (data && !data.success) {
        return { error: data.message || "Rejection failed" };
    }

    revalidatePath('/admin/expenses');
    return { success: true };
}
</file>

<file path="src/app/actions/authActions.ts">
"use server";

import { createClient } from "@/utils/supabase/server";

export async function checkSystemAlreadySetup() {
    const supabase = await createClient();
    const OWNER_TENANT_ID = process.env.NEXT_PUBLIC_OWNER_TENANT_ID;

    if (!OWNER_TENANT_ID) return false;

    // Check if any user exists with this tenant ID and super_admin role
    const { count, error } = await supabase
        .from('users')
        .select('*', { count: 'exact', head: true })
        .eq('tenant_id', OWNER_TENANT_ID)
        .eq('role', 'super_admin');

    if (error) {
        console.error("Error checking system setup:", error);
        // Fail safe: assume setup to prevent override if DB error
        return true;
    }

    return (count || 0) > 0;
}

export async function signupSuperAdmin(formData: FormData) {
    const email = formData.get("email") as string;
    const password = formData.get("password") as string;

    if (!email || !password) {
        return { error: "Email and password are required" };
    }

    const supabase = await createClient();

    // CRITICAL: Hardcoded Owner Tenant ID for the first Super Admin
    const OWNER_TENANT_ID = process.env.NEXT_PUBLIC_OWNER_TENANT_ID!;

    if (!OWNER_TENANT_ID) {
        return { error: "System Configuration Error: Missing Owner Tenant ID" };
    }

    const { data, error } = await supabase.auth.signUp({
        email,
        password,
        options: {
            data: {
                tenant_id: OWNER_TENANT_ID,
                role: 'super_admin',
                name: 'System Owner'
            }
        }
    });

    if (error) {
        return { error: error.message };
    }

    // Check if session exists (Auto-confirm enabled) or user needs to verify email
    if (data.session) {
        return { success: true, redirect: "/super-admin" };
    } else if (data.user) {
        return { success: true, message: "Please check your email to confirm account." };
    }

    return { error: "Unknown error occurred" };
}
</file>

<file path="src/app/actions/createEmployee.ts">
'use server';

import { createClient } from '@/utils/supabase/server';
import { createClient as createSupabaseClient } from '@supabase/supabase-js';

// Admin client for bypassing RLS during user creation
const supabaseAdmin = createSupabaseClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!,
    {
        auth: {
            autoRefreshToken: false,
            persistSession: false,
        },
    }
);

export async function createEmployee(prevState: any, formData: FormData) {
    const name = formData.get('name') as string;
    const email = formData.get('email') as string;
    const password = formData.get('password') as string;
    const role = formData.get('role') as string;
    const shift = formData.get('shift') as string;
    const phone = formData.get('phone') as string;
    const vehicleNumber = formData.get('vehicle_number') as string;
    const phoneNumber = formData.get('phone_number') as string;

    const finalPhone = phoneNumber || phone || '';

    if (!name || !email || !password || !role || !shift) {
        return { error: 'Please fill in all required fields (Name, Email, Password, Role, Shift)' };
    }

    try {
        // 1. Get current Authenticated Admin
        const supabase = await createClient();
        const { data: { user: adminAuth }, error: adminAuthError } = await supabase.auth.getUser();

        if (adminAuthError || !adminAuth) {
            return { error: 'Unauthorized: You must be logged in to create employees.' };
        }

        // 2. Resolve Tenant ID (Robustly)
        let tenantId = adminAuth.app_metadata?.tenant_id || adminAuth.user_metadata?.tenant_id;

        if (!tenantId) {
            // Fallback: Check DB via auth_id
            const { data: dbAdmin } = await supabaseAdmin
                .from('users')
                .select('tenant_id')
                .eq('auth_id', adminAuth.id)
                .single();
            if (dbAdmin) tenantId = dbAdmin.tenant_id;
        }

        if (!tenantId) {
            // Fallback 2: Check DB via ID (Legacy)
            const { data: dbAdminLegacy } = await supabaseAdmin
                .from('users')
                .select('tenant_id')
                .eq('id', adminAuth.id)
                .single();
            if (dbAdminLegacy) tenantId = dbAdminLegacy.tenant_id;
        }

        if (!tenantId) {
            return { error: 'Critical Security Error: Tenant Context Missing. Cannot proceed.' };
        }

        // 3. Create User in Supabase Auth
        const { data: authData, error: authError } = await supabaseAdmin.auth.admin.createUser({
            email,
            password,
            email_confirm: true,
            user_metadata: {
                name: name,
                role: role,
                shift: shift,
                phone_number: finalPhone,
                vehicle_number: vehicleNumber || '',
                tenant_id: tenantId
            },
        });

        if (authError) throw authError;
        if (!authData.user) throw new Error('User creation failed');

        const authUserId = authData.user.id;

        // 4. Manual DB Creation Removed
        // public.handle_new_user check (Trigger automatically creates: User, Profile, Wallet)

        // Wait briefly for trigger to fire (optional but helps UI consistency immediately after)
        // In a real production app, we might poll or just assume success.

        return { success: true, message: `Employee ${name} created successfully!` };

    } catch (error: any) {
        console.error('Create Employee Error:', error);
        return { error: error.message };
    }
}
</file>

<file path="src/app/actions/customerActions.ts">
"use server";

import { createClient } from "@/utils/supabase/server";
import { revalidatePath } from "next/cache";

/**
 * CUSTOMER ACTIONS - DOUBLE-LOCK SECURITY
 */

export async function getCustomers(
    page: number = 1,
    limit: number = 20,
    search: string = '',
    status: 'all' | 'active' | 'inactive' = 'all'
) {
    const supabase = await createClient();

    // 1. Session & Metadata
    const { data: { user }, error: authError } = await supabase.auth.getUser();
    if (authError || !user) return { data: [], total: 0 };

    const tenantId = user.app_metadata?.tenant_id;
    if (!tenantId) {
        console.error("CRITICAL: Tenant ID missing in getCustomers");
        return { data: [], total: 0 };
    }

    // 2. Build Query
    let query = supabase
        .from("customers")
        .select("*", { count: 'exact' })
        .eq("tenant_id", tenantId);

    // 3. Filters
    if (search) {
        // Search by name or phone
        query = query.or(`name.ilike.%${search}%,phone.ilike.%${search}%`);
    }

    if (status !== 'all') {
        const isActive = status === 'active';
        query = query.eq('is_active', isActive);
    }

    // 4. Pagination
    const from = (page - 1) * limit;
    const to = from + limit - 1;

    const { data, error, count } = await query
        .order("created_at", { ascending: false })
        .range(from, to);

    if (error) {
        console.error("Error fetching customers:", error);
        return { data: [], total: 0 };
    }

    return { data: data || [], total: count || 0 };
}

// NEW: Dashboard Stats
export async function getCustomerStats() {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();
    const tenantId = user?.app_metadata?.tenant_id;
    if (!tenantId) return { totalReceivables: 0, defaultersCount: 0 };

    // 1. Total Receivables & At Risk (Positive Debt Model)
    // "Receivables" = Money people owe us (Positive Balance > 0)

    const { data: debtors } = await supabase
        .from('customers')
        .select('current_balance')
        .eq('tenant_id', tenantId)
        .gt('current_balance', 0);

    let totalReceivables = 0;
    let defaultersCount = 0;

    if (debtors) {
        debtors.forEach(c => {
            totalReceivables += c.current_balance;
            defaultersCount++;
        });
    }

    return { totalReceivables, defaultersCount };
}

// NEW: Toggle Status
export async function toggleCustomerStatus(id: string, newStatus: boolean) {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();
    const tenantId = user?.app_metadata?.tenant_id;

    if (!tenantId) return { error: "Unauthorized" };

    const { error } = await supabase
        .from('customers')
        .update({ is_active: newStatus })
        .eq('id', id)
        .eq('tenant_id', tenantId);

    if (error) return { error: error.message };

    revalidatePath('/admin/customers');
    return { success: true };
}



export async function createCustomer(prevState: any, formData: FormData) {
    const supabase = await createClient();

    // 1. Session & Metadata
    const { data: { user } } = await supabase.auth.getUser();
    const tenantId = user?.app_metadata?.tenant_id;

    if (!user || !tenantId) {
        return { error: "Unauthorized: Tenant Context Missing" };
    }

    // Extract Data
    const name = formData.get("name")?.toString();
    const phone = formData.get("phone")?.toString();
    const city = formData.get("city")?.toString() || "";
    let address = formData.get("address")?.toString() || "";

    // Financials
    // Opening Balance: Positive = Debt (Asset), Negative = Advance (Liability)
    const openingBalance = parseFloat(formData.get("opening_balance")?.toString() || "0");
    // Security Deposit: Always Positive from input, but represents Liability (Negative balance)
    const securityDeposit = parseFloat(formData.get("security_deposit")?.toString() || "0");
    // Credit Limit
    const creditLimit = parseInt(formData.get("credit_limit")?.toString() || "50000");

    if (!name || !phone) {
        return { error: "Name and Phone are required" };
    }

    // Combine City with Address if provided
    if (city) {
        address = address ? `${address}, ${city}` : city;
    }

    // Net Initial Balance Calculation
    // Logic: (Opening Debt) - (Security Deposit)
    // Example: Debt 1000, Deposit 5000 -> Balance -4000 (Advance)
    const netBalance = openingBalance - securityDeposit;

    // 2. Force Tenant ID on Write
    const { data: newCustomer, error } = await supabase.from("customers").insert({
        tenant_id: tenantId, // <--- FORCE OVERRIDE
        name,
        phone,
        address,
        current_balance: netBalance,
        credit_limit: creditLimit
    }).select().single();

    if (error) {
        console.error("Create Customer Error:", error);
        return { error: error.message };
    }

    // 3. Create Ledger Entries (If applicable)
    // We do this silently. If it fails, the customer is still created (Non-atomic for now, but acceptable)
    try {
        if (openingBalance !== 0) {
            await supabase.from("transactions").insert({
                tenant_id: tenantId,
                customer_id: newCustomer.id,
                amount: openingBalance, // Preserves sign
                type: 'opening_balance', // Ensure this enum exists or use 'adjustment'
                description: 'Opening Balance Brought Forward'
            });
        }

        if (securityDeposit > 0) {
            await supabase.from("transactions").insert({
                tenant_id: tenantId,
                customer_id: newCustomer.id,
                amount: -securityDeposit, // Credit (Negative)
                type: 'security_deposit', // Ensure this enum exists or use 'adjustment'
                description: 'Security Deposit (Cylinders)'
            });
        }
    } catch (txError) {
        console.error("Failed to create initial transactions:", txError);
    }

    revalidatePath("/admin/customers");
    revalidatePath("/admin/customers");
    return { success: true };
}

export async function updateCustomer(prevState: any, formData: FormData) {
    const supabase = await createClient();

    const { data: { user } } = await supabase.auth.getUser();
    const tenantId = user?.app_metadata?.tenant_id;

    if (!user || !tenantId) return { error: "Unauthorized" };

    const id = formData.get("id")?.toString();
    const name = formData.get("name")?.toString();
    const phone = formData.get("phone")?.toString();
    const city = formData.get("city")?.toString();
    let address = formData.get("address")?.toString();
    const creditLimit = parseInt(formData.get("credit_limit")?.toString() || "0");

    if (!id || !name || !phone) {
        return { error: "Name and Phone are required" };
    }

    if (city && address) {
        // If address doesn't already contain city, append it (simple heuristic)
        if (!address.toLowerCase().includes(city.toLowerCase())) {
            address = `${address}, ${city}`;
        }
    } else if (city) {
        address = city;
    }

    const { error } = await supabase
        .from("customers")
        .update({
            name,
            phone,
            address,
            credit_limit: creditLimit
        })
        .eq("id", id)
        .eq("tenant_id", tenantId);

    if (error) return { error: error.message };

    revalidatePath("/admin/customers");
    revalidatePath(`/admin/customers/${id}`);
    return { success: true };
}

export async function bulkCreateCustomers(prevState: any, formData: FormData) {
    const supabase = await createClient();

    // 1. Session & Metadata Check
    const { data: { user }, error: authError } = await supabase.auth.getUser();
    const tenantId = user?.app_metadata?.tenant_id;

    if (authError || !user || !tenantId) {
        return { error: "Unauthorized: Tenant Context Missing" };
    }

    // 2. Parse Payload
    const rawPayload = formData.get("payload")?.toString();
    if (!rawPayload) return { error: "No data provided" };

    let items: any[] = [];
    try {
        items = JSON.parse(rawPayload);
    } catch (e) {
        return { error: "Invalid JSON data" };
    }

    if (!Array.isArray(items) || items.length === 0) {
        return { error: "Empty or invalid list" };
    }

    // 3. Prepare Data with Forced Tenant ID
    const validItems = items.map(item => ({
        tenant_id: tenantId, // <--- FORCE OVERRIDE
        name: item.name,
        phone: item.phone,
        address: item.address || '',
        current_balance: item.current_balance || 0
    }));

    // 4. Bulk Insert
    const { error } = await supabase.from("customers").insert(validItems);

    if (error) {
        console.error("Bulk Customer Create Error:", error);
        return { error: error.message };
    }

    revalidatePath("/admin/customers");
    return { success: true, count: validItems.length };
}

// CRM HELPER ACTIONS

export async function getCustomerDetails(id: string) {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();
    const tenantId = user?.app_metadata?.tenant_id;
    if (!tenantId) return null;

    const { data, error } = await supabase
        .from("customers")
        .select("*")
        .eq("id", id)
        .eq("tenant_id", tenantId)
        .single();

    if (error) return null;
    return data;
}

export async function getCustomerTransactions(id: string) {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();
    const tenantId = user?.app_metadata?.tenant_id;
    if (!tenantId) return [];

    const { data, error } = await supabase
        .from("transactions")
        .select("*")
        .eq("customer_id", id)
        .eq("tenant_id", tenantId)
        .order("created_at", { ascending: false });

    return data || [];
}

export async function getCustomerAssets(id: string) {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();
    const tenantId = user?.app_metadata?.tenant_id;
    if (!tenantId) return [];

    const { data, error } = await supabase
        .from("cylinders")
        .select("*")
        .eq("current_holder_id", id)
        .eq("current_location_type", "customer") // Explicit check
        .eq("tenant_id", tenantId)
        .order("updated_at", { ascending: false });

    return data || [];
}

export async function getCustomerOrderHistory(id: string) {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();
    const tenantId = user?.app_metadata?.tenant_id;
    if (!tenantId) return [];

    const { data, error } = await supabase
        .from("orders")
        .select(`
            *,
            driver:users (name)
        `)
        .eq("customer_id", id)
        .eq("tenant_id", tenantId)
        .order("created_at", { ascending: false });

    return data || [];
}
</file>

<file path="src/app/actions/cylinderActions.ts">
"use server";

import { createClient } from "@/utils/supabase/server";
import { revalidatePath } from "next/cache";

/**
 * DOUBLE-LOCK SECURITY PATTERN
 * 1. Metadata Extration: tenant_id from user.app_metadata
 * 2. Explicit Filtering: .eq('tenant_id', tenantId) on ALL reads
 * 3. Write Override: Force tenant_id on ALL writes
 */

export async function getAvailableStock() {
    const supabase = await createClient();

    const { data: { user } } = await supabase.auth.getUser();
    const tenantId = user?.app_metadata?.tenant_id;

    if (!tenantId) return [];

    const { data, error } = await supabase
        .from('cylinders')
        .select('id, serial_number, type')
        // Strict Filters
        .eq('type', '45.4KG')
        .eq('status', 'full')
        .eq('current_location_type', 'warehouse')
        .eq('tenant_id', tenantId)
        .order('serial_number');

    if (error) {
        console.error("Error fetching stock:", error);
        return [];
    }

    return data || [];
}

export async function getCylinders() {
    const supabase = await createClient();

    // 1. Session & Metadata Check
    const { data: { user }, error: authError } = await supabase.auth.getUser();
    if (authError || !user) return [];

    const tenantId = user.app_metadata?.tenant_id;
    if (!tenantId) {
        console.error("CRITICAL: Tenant ID missing in getCylinders");
        return [];
    }

    // 2. Fetch All Cylinders (Double-Lock)
    const { data: cylinders, error } = await supabase
        .from("cylinders")
        .select("*")
        .eq("tenant_id", tenantId)
        .order("created_at", { ascending: false });

    if (error) {
        console.error("Error fetching cylinders:", error);
        return [];
    }

    if (!cylinders || cylinders.length === 0) return [];

    // 3. Extract IDs for polymorphic join
    const driverIds = new Set<string>();
    const customerIds = new Set<string>();

    cylinders.forEach((cyl: any) => {
        if (cyl.current_location_type === 'driver' && cyl.current_holder_id) {
            driverIds.add(cyl.current_holder_id);
        } else if (cyl.current_location_type === 'customer' && cyl.current_holder_id) {
            customerIds.add(cyl.current_holder_id);
        }
    });

    // 4. Fetch Names in Parallel
    const [driversResult, customersResult] = await Promise.all([
        driverIds.size > 0 ? supabase.from("users").select("id, name").in("id", Array.from(driverIds)) : Promise.resolve({ data: [] }),
        customerIds.size > 0 ? supabase.from("customers").select("id, name").in("id", Array.from(customerIds)) : Promise.resolve({ data: [] })
    ]);

    const driverMap = new Map<string, string>();
    driversResult.data?.forEach((d: any) => driverMap.set(d.id, d.name));

    const customerMap = new Map<string, string>();
    customersResult.data?.forEach((c: any) => customerMap.set(c.id, c.name));

    // 5. Map Names to Cylinders
    const enhancedCylinders = cylinders.map((cyl: any) => {
        let holderName = "Unknown";
        if (cyl.current_location_type === 'warehouse') {
            holderName = "Warehouse";
        } else if (cyl.current_location_type === 'driver') {
            holderName = driverMap.get(cyl.current_holder_id) || `Unknown Driver (${cyl.current_holder_id?.slice(0, 4) || '?'})`;
        } else if (cyl.current_location_type === 'customer') {
            holderName = customerMap.get(cyl.current_holder_id) || `Unknown Customer (${cyl.current_holder_id?.slice(0, 4) || '?'})`;
        }

        return {
            ...cyl,
            holder_name: holderName
        };
    });

    return enhancedCylinders;
}

export async function createCylinder(prevState: any, formData: FormData) {
    const supabase = await createClient();

    // 1. Session & Metadata Check
    const { data: { user }, error: authError } = await supabase.auth.getUser();
    const tenantId = user?.app_metadata?.tenant_id;

    if (authError || !user || !tenantId) {
        return { error: "Unauthorized: Tenant Context Missing" };
    }

    // Extract Data
    const serialNumber = formData.get("serial_number")?.toString();
    const type = formData.get("type")?.toString();
    const status = formData.get("status")?.toString() || "empty";

    if (!serialNumber || !type) {
        return { error: "Missing required fields" };
    }

    // 2. Force Tenant ID on Write
    const { error } = await supabase.from("cylinders").insert({
        tenant_id: tenantId, // <--- FORCE OVERRIDE
        serial_number: serialNumber,
        type: type,
        status: status,
        current_location_type: 'warehouse', // Default new cylinders to Warehouse
        current_holder_id: null
    });

    if (error) {
        console.error("Create Cylinder Error:", error);
        return { error: error.message };
    }

    revalidatePath("/admin/inventory");
    revalidatePath("/admin/cylinders");
    return { success: true };
}

export async function updateCylinderStatus(id: string, newStatus: string) {
    const supabase = await createClient();

    const { data: { user } } = await supabase.auth.getUser();
    const tenantId = user?.app_metadata?.tenant_id;

    if (!tenantId) throw new Error("Unauthorized");

    // Double-Lock Update
    const { error } = await supabase
        .from("cylinders")
        .update({ status: newStatus })
        .eq("id", id)
        .eq("tenant_id", tenantId); // <--- FORCE FILTER

    if (error) {
        console.error("Update Status Error:", error);
        throw new Error(error.message);
    }

    revalidatePath("/admin/inventory");
    revalidatePath("/admin/cylinders");
}

export async function bulkCreateCylinders(prevState: any, formData: FormData) {
    const supabase = await createClient();

    // 1. Session & Metadata Check
    const { data: { user }, error: authError } = await supabase.auth.getUser();
    const tenantId = user?.app_metadata?.tenant_id;

    if (authError || !user || !tenantId) {
        return { error: "Unauthorized: Tenant Context Missing" };
    }

    // 2. Parse Payload
    const rawPayload = formData.get("payload")?.toString();
    if (!rawPayload) return { error: "No data provided" };

    let items: any[] = [];
    try {
        items = JSON.parse(rawPayload);
    } catch (e) {
        return { error: "Invalid JSON data" };
    }

    if (!Array.isArray(items) || items.length === 0) {
        return { error: "Empty or invalid list" };
    }

    // 3. Prepare Data with Forced Tenant ID
    const validItems = items.map(item => ({
        tenant_id: tenantId, // <--- FORCE OVERRIDE
        serial_number: item.serial_number,
        type: item.type || '45.4KG',
        status: item.status || 'full',
        current_location_type: 'warehouse',
        current_holder_id: null,
        condition: 'good'
    }));

    // 4. Bulk Insert
    const { error } = await supabase.from("cylinders").insert(validItems);

    if (error) {
        console.error("Bulk Create Error:", error);
        // User friendly overlap error
        if (error.code === '23505') return { error: "Some serial numbers already exist. Please check your file." };
        return { error: error.message };
    }

    revalidatePath("/admin/inventory");
    revalidatePath("/admin/cylinders");
    return { success: true, count: validItems.length };
}

export async function sendToPlant(quantity: number) {
    const supabase = await createClient();

    // 1. Session & Metadata Check
    const { data: { user }, error: authError } = await supabase.auth.getUser();
    const tenantId = user?.app_metadata?.tenant_id;

    if (authError || !user || !tenantId) return { error: "Unauthorized" };

    // 2. Fetch oldest 'empty' cylinders (Double-Lock + Warehouse Check)
    const { data: cylinders, error: fetchError } = await supabase
        .from("cylinders")
        .select("id")
        .eq("tenant_id", tenantId)
        .eq("status", "empty")
        .eq("current_location_type", "warehouse") // <--- STRICT SECURITY
        .order("created_at", { ascending: true }) // Oldest first
        .limit(quantity);

    if (fetchError) return { error: fetchError.message };
    if (!cylinders || cylinders.length === 0) return { error: "No empty cylinders found in Warehouse to send." };

    const ids2Update = cylinders.map(c => c.id);

    // 3. Update Status (Double-Lock)
    const { error: updateError } = await supabase
        .from("cylinders")
        .update({ status: "maintenance" }) // Using 'maintenance' to represent 'at plant/refilling'
        .in("id", ids2Update)
        .eq("tenant_id", tenantId);

    if (updateError) return { error: updateError.message };

    revalidatePath("/admin/inventory");
    revalidatePath("/admin/cylinders");
    return { success: true, count: ids2Update.length };
}

export async function receiveFromPlant(quantity: number) {
    const supabase = await createClient();

    // 1. Session & Metadata Check
    const { data: { user }, error: authError } = await supabase.auth.getUser();
    const tenantId = user?.app_metadata?.tenant_id;

    if (authError || !user || !tenantId) return { error: "Unauthorized" };

    // 2. Fetch 'maintenance' cylinders
    const { data: cylinders, error: fetchError } = await supabase
        .from("cylinders")
        .select("id")
        .eq("tenant_id", tenantId)
        .eq("status", "maintenance")
        .limit(quantity);

    if (fetchError) return { error: fetchError.message };
    if (!cylinders || cylinders.length === 0) return { error: "No cylinders at plant found." };

    const ids2Update = cylinders.map(c => c.id);

    // 3. Update Status (Reset Location to Warehouse)
    const { error: updateError } = await supabase
        .from("cylinders")
        .update({
            status: "full",
            current_location_type: 'warehouse', // <--- STRICT RESET
            current_holder_id: null
        })
        .in("id", ids2Update)
        .eq("tenant_id", tenantId);

    if (updateError) return { error: updateError.message };

    revalidatePath("/admin/inventory");
    revalidatePath("/admin/cylinders");
    return { success: true, count: ids2Update.length };
}


// 6. UPDATE CYLINDER (Rename / Edit)
export async function updateCylinder(id: string, newSerial: string) {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();
    const tenantId = user?.app_metadata?.tenant_id;

    if (!tenantId) return { error: "Unauthorized" };

    const { error } = await supabase
        .from('cylinders')
        .update({ serial_number: newSerial })
        .eq('id', id)
        .eq('tenant_id', tenantId);

    if (error) {
        console.error("Update Serial Error:", error);
        return { error: error.message };
    }

    revalidatePath("/admin/cylinders");
    return { success: true };
}

// 7. DELETE CYLINDER
export async function deleteCylinder(id: string) {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();
    const tenantId = user?.app_metadata?.tenant_id;

    if (!tenantId) return { error: "Unauthorized" };

    const { error } = await supabase
        .from('cylinders')
        .delete()
        .eq('id', id)
        .eq('tenant_id', tenantId);

    if (error) {
        console.error("Delete Cylinder Error:", error);
        return { error: error.message };
    }

    revalidatePath("/admin/cylinders");
    return { success: true };
}
</file>

<file path="src/app/actions/driverExpenseActions.ts">
'use server';

import { createClient } from "@/utils/supabase/server";
import { revalidatePath } from "next/cache";

export async function submitExpense(formData: FormData) {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();

    // Auth Check
    if (!user) return { error: "Unauthorized" };
    const tenantId = user.app_metadata?.tenant_id;
    if (!tenantId) return { error: "Tenant ID missing" };

    // Parse Data
    const amount = parseFloat(formData.get('amount')?.toString() || '0');
    const category = formData.get('category')?.toString();
    const description = formData.get('description')?.toString() || '';
    const proofFile = formData.get('proof_file') as File;

    // Validation
    if (!amount || amount <= 0) return { error: "Invalid Amount" };
    if (!category) return { error: "Category is required" };
    if (!proofFile || proofFile.size === 0) return { error: "Proof of expense is required" };

    try {
        // 1. Upload Proof Image
        const fileExt = proofFile.name.split('.').pop();
        const fileName = `${user.id}/${Date.now()}.${fileExt}`;
        const { error: uploadError } = await supabase.storage
            .from('expense-proofs')
            .upload(fileName, proofFile);

        if (uploadError) throw new Error(`Upload Failed: ${uploadError.message}`);

        // Get Public URL
        const { data: { publicUrl } } = supabase.storage
            .from('expense-proofs')
            .getPublicUrl(fileName);

        // 2. Insert into DB
        const { error: insertError } = await supabase
            .from('expenses')
            .insert({
                tenant_id: tenantId,
                user_id: user.id,
                amount: amount,
                category: category,
                description: description,
                proof_url: publicUrl,
                status: 'pending'
            });

        if (insertError) throw new Error(`DB Insert Failed: ${insertError.message}`);

        revalidatePath('/driver');
        return { success: true };

    } catch (err: any) {
        console.error("Submit Expense Error:", err);
        return { error: err.message || "Failed to submit expense" };
    }
}
</file>

<file path="src/app/actions/financeActions.ts">
'use server';

import { createClient } from "@/utils/supabase/server";
import { revalidatePath } from "next/cache";

// 1. Get Totals (Live Calculation)
export async function getCompanyStats() {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return { totalBalance: 0 };
    const tenantId = user.app_metadata?.tenant_id;

    // Sum of all amounts
    const { data, error } = await supabase
        .from('company_ledger')
        .select('amount')
        .eq('tenant_id', tenantId);

    if (error) {
        console.error("Finance Stats Error:", error);
        return { totalBalance: 0 };
    }

    const total = data.reduce((acc, curr) => acc + (curr.amount || 0), 0);
    return { totalBalance: total };
}

// 2. Get Ledger History
export async function getLedgerHistory() {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return [];
    const tenantId = user.app_metadata?.tenant_id;

    const { data, error } = await supabase
        .from('company_ledger')
        .select(`
            id,
            amount,
            transaction_type,
            description,
            created_at,
            admin_id,
            users (name)
        `)
        .eq('tenant_id', tenantId)
        .order('created_at', { ascending: false });

    if (error) {
        console.error("Finance History Error:", error);
        return [];
    }

    return data || [];
}

// 3. GET ALL CUSTOMERS (Lite Version for Dropdown)
export async function getAllCustomersClient() {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return { data: [] };
    const tenantId = user.app_metadata?.tenant_id;

    const { data, error } = await supabase
        .from('customers')
        .select('id, name')
        .eq('tenant_id', tenantId)
        .eq('is_active', true)
        .order('name', { ascending: true })
        .limit(100); // Reasonable limit for dropdown

    return { data: data || [] };
}

// 4. CREATE TRANSACTION (Smart Action)
export async function createTransaction(formData: FormData) {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return { error: "Unauthorized" };
    const tenantId = user.app_metadata?.tenant_id;
    if (!tenantId) return { error: "Tenant context missing" };

    // Parse Data
    const type = formData.get('type')?.toString(); // 'income' | 'expense'
    const category = formData.get('category')?.toString();
    const amountStr = formData.get('amount')?.toString();
    const description = formData.get('description')?.toString();
    const dateStr = formData.get('date')?.toString();
    const customerId = formData.get('customer_id')?.toString();

    let amount = parseFloat(amountStr || '0');
    if (isNaN(amount) || amount <= 0) return { error: "Invalid amount" };

    // If Expense, make negative
    if (type === 'expense') {
        amount = -amount;
    }

    // Map to DB Allowed Types (credit/debit)
    const dbTransactionType = type === 'income' ? 'credit' : 'debit';

    try {
        // A. Create Company Ledger Entry (The visible cash change)
        const { error: ledgerError } = await supabase.from('company_ledger').insert({
            tenant_id: tenantId,
            amount: amount,
            transaction_type: dbTransactionType, // 'credit' or 'debit'
            category: category,                  // Specific category (e.g. 'Customer Payment')
            description: description,
            admin_id: user.id,
            created_at: dateStr || new Date().toISOString()
        });

        if (ledgerError) throw new Error(`Ledger Error: ${ledgerError.message}`);

        // B. Handle Customer Linkage (If Payment)
        if (category === 'customer_payment' && customerId) {

            // 1. Credit the Customer (Decrease Debt)
            // Fetch current balance first to be safe (or use RPC increment if available, but simple update is fine for low concurrency)
            const { data: customer } = await supabase.from('customers').select('current_balance').eq('id', customerId).single();
            const currentBalance = customer?.current_balance || 0;

            // Payment reduces the balance (Debt - Payment)
            // Amount here is POSITIVE because we parsed it as such, but wait...
            // In the "Type" check above, income remains Positive.
            // So if Customer Pays 5000:
            // Ledger: +5000 (Income)
            // Customer Balance: Old - 5000

            // We need the absolute value for the customer calculation
            const absAmount = Math.abs(amount);
            const newBalance = currentBalance - absAmount;

            await supabase.from('customers')
                .update({ current_balance: newBalance })
                .eq('id', customerId)
                .eq('tenant_id', tenantId);

            // 2. Add to Customer History (Transactions Table)
            // This is crucial for the customer to see "Payment Received"
            await supabase.from('transactions').insert({
                tenant_id: tenantId,
                customer_id: customerId,
                amount: -absAmount, // Credit is Negative in Transactions table usually (reduces debt)
                type: 'payment',
                payment_method: 'cash', // Assumed cash since it's "Manual Finance Entry"
                description: description || 'Direct Payment at Office',
                created_at: dateStr || new Date().toISOString()
            });
        }

        revalidatePath('/admin/finance');
        if (customerId) revalidatePath('/admin/customers');
        return { success: true };

    } catch (err: any) {
        console.error("Transaction Error:", err);
        return { error: err.message };
    }
}
</file>

<file path="src/app/actions/manageUser.ts">
'use server';

import { createClient } from '@supabase/supabase-js';
import { revalidatePath } from 'next/cache';

const supabaseAdmin = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!,
    {
        auth: {
            autoRefreshToken: false,
            persistSession: false,
        },
    }
);

import { Database } from '@/types/database.types';

export async function updateUser(prevState: any, formData: FormData) {
    const id = formData.get('id') as string;
    const name = formData.get('name') as string;
    const role = formData.get('role') as string;
    const shift = formData.get('shift') as string;
    const phone = formData.get('phone') as string;
    const vehicleNumber = formData.get('vehicle_number') as string;

    if (!id || !name || !role) {
        return { error: 'Missing required fields' };
    }

    try {
        // 0. Fetch User to get Tenant ID (Critical for Profile Upsert)
        const { data: existingUser, error: fetchError } = await supabaseAdmin.auth.admin.getUserById(id);
        if (fetchError || !existingUser?.user) throw new Error("User not found for update");

        const tenantId = existingUser.user.user_metadata?.tenant_id || existingUser.user.app_metadata?.tenant_id;

        // 1. Update Auth Metadata
        const { error: authError } = await supabaseAdmin.auth.admin.updateUserById(id, {
            user_metadata: {
                name: name,
                role: role,
                shift: shift,
                phone_number: phone,
                vehicle_number: vehicleNumber,
                tenant_id: tenantId // Ensure persistence
            }
        });
        if (authError) throw authError;

        // 2. Update Public Table (Manual Sync to be safe)
        const { error: dbError } = await supabaseAdmin
            .from('users')
            .update({
                name: name,
                role: role,
                shift: shift,
                phone_number: phone
            })
            .eq('id', id);

        if (dbError) {
            throw new Error(`Auth updated but DB sync failed: ${dbError.message}`);
        }

        // 3. Update Profiles Table (Vehicle & Phone) WITH Tenant ID
        const profileData: Database['public']['Tables']['profiles']['Insert'] = {
            id: id,
            full_name: name,
            role: role as Database['public']['Enums']['user_role'], // Cast if role is enum
            phone_number: phone,
            vehicle_number: vehicleNumber,
            updated_at: new Date().toISOString()
        };

        // Only add tenant_id if found, otherwise rely on existing or default
        if (tenantId) profileData.tenant_id = tenantId;

        const { error: profileError } = await supabaseAdmin
            .from('profiles')
            .upsert(profileData);

        if (profileError) {
            console.error("Profile Update Error:", profileError);
            throw new Error(`Profile update failed: ${profileError.message}`);
        }

        revalidatePath('/admin/users');
        revalidatePath('/driver/profile'); // Ensure driver sees it too
        return { success: true, message: 'User updated successfully' };
    } catch (error: any) {
        return { error: error.message };
    }
}

export async function resetPassword(prevState: any, formData: FormData) {
    const id = formData.get('id') as string;
    const password = formData.get('password') as string;

    if (!id || !password) return { error: 'Password required' };

    try {
        const { error } = await supabaseAdmin.auth.admin.updateUserById(id, {
            password: password
        });
        if (error) throw error;
        return { success: true, message: 'Password reset successfully' };
    } catch (error: any) {
        return { error: error.message };
    }
}

export async function toggleUserStatus(prevState: any, formData: FormData) {
    const id = formData.get('id') as string;
    const action = formData.get('action') as string; // 'activate' | 'deactivate'

    try {
        const banDuration = action === 'deactivate' ? '876000h' : 'none'; // 100 years or none
        const { error } = await supabaseAdmin.auth.admin.updateUserById(id, {
            ban_duration: banDuration
        });
        if (error) throw error;
        return { success: true, message: `User ${action}d successfully` };
    } catch (error: any) {
        return { error: error.message };
    }
}
</file>

<file path="src/app/actions/orderActions.ts">
"use server";

import { createClient } from "@/utils/supabase/server";
import { revalidatePath } from "next/cache";

/**
 * ORDER ACTIONS - DOUBLE-LOCK SECURITY
 */

export async function getOrders() {
    const supabase = await createClient();

    // 1. Session & Metadata
    const { data: { user }, error: authError } = await supabase.auth.getUser();
    if (authError || !user) return [];

    const tenantId = user.app_metadata?.tenant_id;
    if (!tenantId) {
        console.error("CRITICAL: Tenant ID missing in getOrders");
        return [];
    }

    // 2. Double-Lock Query
    // Joins 'customers' and 'users' (driver) - ensuring tenant isolation on main table is key
    const { data, error } = await supabase
        .from("orders")
        .select(`
            *,
            customers (name, address),
            driver:users (name)
        `)
        .eq("tenant_id", tenantId) // Double Lock
        .order("created_at", { ascending: false });

    if (error) {
        console.error("Error fetching orders:", error);
        return [];
    }

    return data || [];
}

// 3. SECURE CREATE ORDER (Full Transaction)
export async function createOrder(prevState: any, formData: FormData) {
    const supabase = await createClient();

    // 1. Session & Metadata
    const { data: { user } } = await supabase.auth.getUser();
    const tenantId = user?.app_metadata?.tenant_id;

    if (!user || !tenantId) {
        return { error: "Unauthorized: Tenant Context Missing" };
    }

    // Extract Data
    const customerId = formData.get("customer_id")?.toString();
    const driverId = formData.get("driver_id")?.toString();
    const cylindersCount = parseInt(formData.get("cylinders_count")?.toString() || "0");
    const totalAmount = parseFloat(formData.get("total_amount")?.toString() || "0");
    const productName = formData.get("product_name")?.toString() || "LPG Cylinder";
    const price = parseFloat(formData.get("price")?.toString() || "0");

    // Serials (Passed as JSON string)
    const serialsJson = formData.get("serials")?.toString();
    const explicitSerials: string[] = serialsJson ? JSON.parse(serialsJson) : [];

    // Validation
    if (!customerId || !driverId) return { error: "Customer and Driver are required" };
    if (cylindersCount < 1) return { error: "Invalid Quantity" };

    // STOCK CHECK & SELECTION
    // We need to identify WHICH cylinders to move.
    // Case A: Manual Selection (Explicit Serials)
    // Case B: Auto Dispatch (FIFO from Warehouse)

    let targetCylinderIds: string[] = [];
    let assignedSerials: string[] = [];

    if (explicitSerials.length > 0) {
        // Validate explicit serials match quantity
        if (explicitSerials.length !== cylindersCount) {
            return { error: `Serial mismatch: Expected ${cylindersCount}, got ${explicitSerials.length}` };
        }

        // Fetch these specific cylinders to ensure they are in godown
        const { data: explicitStock, error: stockError } = await supabase
            .from('cylinders')
            .select('id, serial_number, current_location_type')
            .in('serial_number', explicitSerials)
            .eq('tenant_id', tenantId);

        if (stockError || !explicitStock) return { error: "Error verifying selected cylinders" };

        // Verify all are in godown
        const invalid = explicitStock.filter(c => c.current_location_type !== 'warehouse');
        if (invalid.length > 0) {
            return { error: `Some selected cylinders are not in Warehouse: ${invalid.map(c => c.serial_number).join(', ')}` };
        }

        targetCylinderIds = explicitStock.map(c => c.id);
        assignedSerials = explicitStock.map(c => c.serial_number);

    } else {
        // Auto-Selection (FIFO)
        // 1. Check Total Available
        const { count, error: countError } = await supabase
            .from('cylinders')
            .select('*', { count: 'exact', head: true })
            .eq('current_location_type', 'warehouse')
            .eq('status', 'full')
            .eq('tenant_id', tenantId);

        if (countError) return { error: "Failed to check stock levels" };

        const available = count || 0;
        if (available < cylindersCount) {
            return { error: `Cannot Dispatch ${cylindersCount}. Only ${available} Available in Warehouse.` };
        }

        // 2. Lock/Select N Cylinders
        // We select ID to lock them for update
        const { data: autoStock, error: autoError } = await supabase
            .from('cylinders')
            .select('id, serial_number')
            .eq('current_location_type', 'warehouse')
            .eq('status', 'full')
            .eq('tenant_id', tenantId)
            .limit(cylindersCount);

        if (autoError || !autoStock || autoStock.length < cylindersCount) {
            return { error: "Race Condition: Stock changed during checkout. Please try again." };
        }

        targetCylinderIds = autoStock.map(c => c.id);
        assignedSerials = autoStock.map(c => c.serial_number);
    }


    // 2. Perform Updates (Pseudo-Transaction via Server Action)

    // A. Create Order
    const { data: order, error: orderError } = await supabase
        .from('orders')
        .insert({
            tenant_id: tenantId, // <--- FORCE OVERRIDE
            customer_id: customerId,
            driver_id: driverId, // Assign to driver
            cylinders_count: cylindersCount,
            total_amount: totalAmount,
            status: 'assigned', // Visible to driver immediately
            payment_method: 'pending',
            created_by: user.id
        })
        .select()
        .single();

    if (orderError) {
        console.error("Create Order Error:", orderError);
        return {
            error: `Failed to create order: ${orderError.message}`,
            details: orderError.details,
            hint: orderError.hint
        };
    }

    // B. Create Order Items
    const { error: itemError } = await supabase.from('order_items').insert({
        order_id: order.id,
        product_name: productName,
        quantity: cylindersCount,
        price: price
    });

    if (itemError) {
        console.error("Create Item Error:", itemError);
        // Note: In a real DB transaction, we would rollback here. 
    }

    // C. Update Cylinders (Assign to Driver)
    // CRITICAL: We move the PRE-VALIDATED ids
    const { error: cylinderError } = await supabase
        .from('cylinders')
        .update({
            // status: 'full', // Already full
            current_location_type: 'driver',
            current_holder_id: driverId,
            last_order_id: order.id,
            updated_at: new Date().toISOString()
        })
        .in('id', targetCylinderIds)
        .eq('tenant_id', tenantId); // Double Lock

    if (cylinderError) {
        console.error("Cylinder Update Error:", cylinderError);
        return { error: "Order created but asset assignment failed. Please check system logs." };
    }

    revalidatePath("/admin/orders");
    return { success: true, orderId: order.id, assignedSerials };
}
</file>

<file path="src/app/actions/recoveryActions.ts">
"use server";

import { createClient } from "@/utils/supabase/server";
import { revalidatePath } from "next/cache";

/**
 * RECOVERY AGENT ACTIONS
 * Dedicated logic for debt collection and field operations.
 */

// 1. GET AGENT STATS (Wallet Balance)
export async function getRecoveryStats() {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();

    if (!user) return { cashOnHand: 0 };

    // Safety check: Ensure user is recovery agent or admin
    // In a real app we might check roles here, but RLS usually handles data access.

    // 1. Get Wallet Balance
    const { data: wallet } = await supabase
        .from('employee_wallets')
        .select('balance')
        .eq('user_id', user.id)
        .single();

    // 2. Get Pending Handovers (Money in transit)
    const { data: pendingTxns } = await supabase
        .from('transactions')
        .select('id, amount, created_at, status')
        .eq('user_id', user.id)
        .eq('type', 'handover_request')
        .eq('status', 'pending');

    const pendingAmount = pendingTxns?.reduce((acc, curr) => acc + (curr.amount || 0), 0) || 0;

    return {
        cashOnHand: wallet?.balance || 0,
        pendingAmount,
        pendingHandovers: pendingTxns || []
    };
}

// 2. GET DUE CUSTOMERS
export async function getDueCustomers() {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return [];

    const tenantId = user.app_metadata?.tenant_id || user.user_metadata?.tenant_id;

    if (!tenantId) {
        console.error("getDueCustomers: No tenant_id found for user", user.id);
        return [];
    }

    // DEBUG: console.log("Fetching due customers for tenant:", tenantId);

    const { data, error } = await supabase
        .from('customers')
        .select('id, name, address, phone, current_balance')
        .eq('tenant_id', tenantId)
        .gt('current_balance', 0) // Debt is positive
        .order('current_balance', { ascending: false }); // Largest debt first

    if (error) {
        console.error("Fetch Due Customers Error:", error);
        return [];
    }

    return data || [];
}

// 3. COLLECT PAYMENT (The main workhorse)
export async function collectPayment(formData: FormData) {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return { error: "Unauthorized" };

    const tenantId = user.app_metadata?.tenant_id;

    // Parse Input
    const customerId = formData.get('customer_id')?.toString();
    const amount = parseFloat(formData.get('amount')?.toString() || '0');
    const paymentMode = formData.get('payment_mode')?.toString() || 'cash';
    const description = formData.get('description')?.toString();
    const proofImage = formData.get('proof_image') as File | null;

    if (!customerId) return { error: "Customer required" };
    if (isNaN(amount) || amount <= 0) return { error: "Invalid amount" };

    try {
        let proofUrl = null;

        // A. Handle Proof Upload
        if (proofImage && proofImage.size > 0) {
            const fileExt = proofImage.name.split('.').pop();
            const fileName = `${tenantId}/${Math.random()}.${fileExt}`;
            const { error: uploadError } = await supabase.storage
                .from('payment-proofs')
                .upload(fileName, proofImage);

            if (uploadError) {
                console.error("Proof Upload Failed:", uploadError);
                return { error: "Failed to upload proof image" };
            }

            const { data: { publicUrl } } = supabase.storage
                .from('payment-proofs')
                .getPublicUrl(fileName);

            proofUrl = publicUrl;
        }

        // B. SPLIT LOGIC
        // SCENARIO 1: CASH (Immediate Settlement)
        if (paymentMode === 'cash') {
            // 1. Credit Customer (Reduce Debt)
            const { data: cust } = await supabase
                .from('customers')
                .select('current_balance, name')
                .eq('id', customerId)
                .single();

            if (!cust) return { error: "Customer not found" };

            const newBalance = (cust.current_balance || 0) - amount;

            await supabase
                .from('customers')
                .update({ current_balance: newBalance })
                .eq('id', customerId);

            // 2. Increase Agent Liability (Wallet)
            const { data: w } = await supabase.from('employee_wallets').select('balance').eq('user_id', user.id).single();
            const currentWallet = w?.balance || 0;

            await supabase.from('employee_wallets').upsert({
                user_id: user.id,
                balance: currentWallet + amount,
                updated_at: new Date().toISOString(),
                tenant_id: tenantId
            }, { onConflict: 'user_id' });

            // 3. Log Transaction (Completed)
            const { error: txnError } = await supabase.from('transactions').insert({
                tenant_id: tenantId,
                user_id: user.id,
                customer_id: customerId,
                type: 'collection',
                status: 'collected_cash',
                amount: -amount, // Debt reduction is negative
                payment_method: paymentMode,
                description: description || `Cash Collection from ${cust.name}`,
                proof_url: proofUrl,
                created_at: new Date().toISOString()
            });

            if (txnError) throw new Error(`Txn Error: ${txnError.message}`);

        } else {
            // SCENARIO 2: BANK / ONLINE (Pending Verification)
            // NO Customer Update, NO Wallet Update. Just Transaction Log.

            const { error: txnError } = await supabase.from('transactions').insert({
                tenant_id: tenantId,
                user_id: user.id,
                customer_id: customerId,
                type: 'collection',
                status: 'pending_verification', // CRITICAL: Needs Admin Approval
                amount: -amount,
                payment_method: paymentMode,
                description: description || `Online Payment Claim`,
                proof_url: proofUrl,
                created_at: new Date().toISOString()
            });

            if (txnError) throw new Error(`Txn Error: ${txnError.message}`);
        }

        revalidatePath('/recovery');
        return { success: true };

    } catch (err: any) {
        console.error("Collection Failed:", err);
        return { error: err.message };
    }
}

// 4. PROCESS HANDOVER (Agent -> Admin)
export async function processRecoveryHandover(formData: FormData) {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return { error: "Unauthorized" };

    const tenantId = user.app_metadata?.tenant_id;

    // Parse
    const receiverId = formData.get('receiver_id')?.toString();
    const amount = parseFloat(formData.get('amount')?.toString() || '0');

    if (!receiverId) return { error: "Select receiver" };
    if (amount <= 0) return { error: "Invalid amount" };

    // Validate Wallet
    const { data: wallet } = await supabase.from('employee_wallets')
        .select('balance')
        .eq('user_id', user.id)
        .single();

    if (!wallet || wallet.balance < amount) {
        return { error: `Insufficient funds. You only have ${wallet?.balance || 0}` };
    }

    // Create Handover Request
    // This puts it in 'pending' state. Valid Money is still in Agent Wallet until Admin Approves.
    const { error } = await supabase.from('transactions').insert({
        tenant_id: tenantId,
        user_id: user.id,
        receiver_id: receiverId,
        type: 'handover_request',
        status: 'pending',
        amount: amount,
        payment_method: 'cash',
        description: `Recovery Handover: Rs ${amount}`,
        created_at: new Date().toISOString()
    });

    if (error) return { error: error.message };

    revalidatePath('/recovery');
    return { success: true };
}

// 5. GET RECEIVERS (Admins)
export async function getRecoveryReceivers() {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return [];

    const tenantId = user.app_metadata?.tenant_id;

    const { data } = await supabase
        .from('users')
        .select('id, name, role')
        .in('role', ['admin', 'manager'])
        .eq('tenant_id', tenantId);

    return data || [];
}

// 6. GET AGENT HISTORY
export async function getAgentHistory() {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return [];

    const tenantId = user.app_metadata?.tenant_id;

    const { data } = await supabase
        .from('transactions')
        .select('id, type, amount, status, created_at, description, proof_url, customers(name), receiver_id')
        .eq('user_id', user.id)
        .eq('tenant_id', tenantId)
        .in('type', ['collection', 'handover_request'])
        .order('created_at', { ascending: false })
        .limit(50);

    return data || [];
}
</file>

<file path="src/app/actions/settingsActions.ts">
'use server';

import { createClient } from '@/utils/supabase/server';
import { revalidatePath } from 'next/cache';

// --- TYPES ---
export interface OrgSettings {
    id: string;
    company_name: string;
    company_address: string;
    company_phone: string;
    invoice_footer: string;
    default_gas_rate: number;
    low_stock_threshold: number;
}

// --- 1. FETCH SETTINGS ---
export async function getSettings() {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return { error: "Unauthorized" };

    const { data, error } = await supabase
        .from('organization_settings')
        .select('*')
        .eq('tenant_id', user.app_metadata.tenant_id)
        .single();

    if (error) {
        console.error("Fetch Settings Error:", error);
        return { error: 'Failed to load settings' };
    }

    return { settings: data as OrgSettings };
}

// --- 2. UPDATE BRANDING & CONFIG ---
export async function updateSettings(prevState: any, formData: FormData) {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return { error: "Unauthorized" };

    const tenant_id = user.app_metadata.tenant_id;

    // Extract Data
    const updates = {
        company_name: formData.get('company_name'),
        company_address: formData.get('company_address'),
        company_phone: formData.get('company_phone'),
        invoice_footer: formData.get('invoice_footer'),
        default_gas_rate: parseFloat(formData.get('default_gas_rate') as string || '0'),
        low_stock_threshold: parseInt(formData.get('low_stock_threshold') as string || '15'),
        updated_at: new Date().toISOString()
    };

    const { error } = await supabase
        .from('organization_settings')
        .update(updates)
        .eq('tenant_id', tenant_id);

    if (error) {
        console.error("Update Settings Error:", error);
        return { error: 'Failed to update settings' };
    }

    revalidatePath('/admin/settings');
    revalidatePath('/invoice/[id]', 'page'); // Revalidate invoices
    return { success: true, message: 'Settings saved successfully' };
}

// --- 3. SECURITY: CHANGE PASSWORD ---
export async function changePassword(prevState: any, formData: FormData) {
    const supabase = await createClient();

    const password = formData.get('new_password') as string;
    const confirm = formData.get('confirm_password') as string;

    if (!password || password.length < 6) {
        return { error: 'Password must be at least 6 characters' };
    }
    if (password !== confirm) {
        return { error: 'Passwords do not match' };
    }

    const { error } = await supabase.auth.updateUser({
        password: password
    });

    if (error) {
        return { error: error.message };
    }

    return { success: true, message: 'Password updated successfully' };
}
</file>

<file path="src/app/actions/superAdminActions.ts">
"use server";

import { createClient } from "@/utils/supabase/server";
import { createAdminClient } from "@/utils/supabase/admin";

// Master Key: The UUID of the SaaS Owner Tenant
const OWNER_TENANT_ID = process.env.NEXT_PUBLIC_OWNER_TENANT_ID!;

export async function checkSuperAdmin() {
    const supabase = await createClient();

    // 1. Get Auth User
    const { data: { user }, error: authError } = await supabase.auth.getUser();
    if (authError || !user) {
        throw new Error("Unauthorized: Please log in.");
    }

    // 2. Fetch Profile to verify Role & Tenant
    const { data: profile, error: profileError } = await supabase
        .from("users")
        .select("tenant_id, role")
        .eq("id", user.id)
        .single();

    if (profileError || !profile) {
        throw new Error("Unauthorized: Profile not found.");
    }

    // 3. VALIDATION RULE (Master Key or Role)
    const isOwner = profile.tenant_id === OWNER_TENANT_ID;
    const isSuperAdmin = profile.role === 'super_admin';

    if (!isOwner && !isSuperAdmin) {
        throw new Error("Unauthorized: You are not the System Owner");
    }

    return user;
}

export async function getTenants() {
    await checkSuperAdmin();
    const supabase = await createClient();

    const { data: tenants, error } = await supabase
        .from("tenants")
        .select("*")
        .order("created_at", { ascending: false });

    if (error) throw new Error(error.message);
    return tenants;
}

interface CreateTenantParams {
    name: string;
    plan: 'basic' | 'standard' | 'premium';
    owner_email: string;
    owner_password: string;
}

export async function createTenant(params: CreateTenantParams) {
    await checkSuperAdmin();
    const supabase = await createClient();
    const adminClient = createAdminClient();

    // 1. Create Tenant in DB
    const { data: tenant, error: tenantError } = await supabase
        .from("tenants")
        .insert({
            name: params.name,
            subscription_status: 'active',
            // Defaulting plan might need a column update or metadata field, assuming 'subscription_status' suffices for now or 'plan' if column exists. 
            // Checking schema from context: 'subscription_plan' implies logic, but let's stick to status 'active' and maybe store plan in a future column if not present.
            // For now, we will assume standard 'subscription_status' is enough to activate them.
        })
        .select()
        .single();

    if (tenantError) throw new Error("Failed to create tenant: " + tenantError.message);

    // 2. Create Admin User for this Tenant
    // Metadata is critical for the trigger to pick it up and assign correct Tenant ID + Role
    const { data: user, error: userError } = await adminClient.auth.admin.createUser({
        email: params.owner_email,
        password: params.owner_password,
        email_confirm: true,
        user_metadata: {
            tenant_id: tenant.id,
            role: 'admin',
            name: 'Tenant Owner',
        }
    });

    if (userError) {
        // Rollback Tenant? (Ideal world yes, simplified here: just error out)
        // Ideally we delete the tenant if user creation fails to avoid orphans.
        await supabase.from("tenants").delete().eq("id", tenant.id);
        throw new Error("Failed to create owner account: " + userError.message);
    }

    return { tenant, user };
}
</file>

<file path="src/app/auth/callback/route.ts">
import { NextResponse } from 'next/server'
import { createClient } from '@/utils/supabase/server'

export async function GET(request: Request) {
    const { searchParams, origin } = new URL(request.url)
    const code = searchParams.get('code')
    // if "next" is in param, use it as the redirect URL
    const next = searchParams.get('next') ?? '/'

    if (code) {
        const supabase = await createClient()
        const { error } = await supabase.auth.exchangeCodeForSession(code)
        if (!error) {
            const forwardedHost = request.headers.get('x-forwarded-host') // original origin before load balancer
            const isLocalEnv = process.env.NODE_ENV === 'development'
            if (isLocalEnv) {
                // we can be sure that there is no load balancer in between, so no need to watch for X-Forwarded-Host
                return NextResponse.redirect(`${origin}${next}`)
            } else if (forwardedHost) {
                return NextResponse.redirect(`https://${forwardedHost}${next}`)
            } else {
                return NextResponse.redirect(`${origin}${next}`)
            }
        }
    }

    // return the user to an error page with instructions
    return NextResponse.redirect(`${origin}/auth/auth-code-error`)
}
</file>

<file path="src/app/globals.css">
@import "tailwindcss";

:root {
  /* BACKGROUNDS */
  --background: #ffffff;
  /* White  */
  --foreground: #020617;
  /* Slate 950 */

  /* BRANDING (Emerald 600) - HARDCODED FOR VISIBILITY */
  --primary: #059669;
  --primary-foreground: #ffffff;

  /* SECONDARY (Slate 100) */
  --secondary: #f1f5f9;
  --secondary-foreground: #0f172a;

  /* DESTRUCTIVE (Red 600) */
  --destructive: #dc2626;
  --destructive-foreground: #fef2f2;

  /* MUTED / ACCENTS */
  --muted: #f1f5f9;
  --muted-foreground: #64748b;
  --accent: #f1f5f9;
  --accent-foreground: #0f172a;

  /* BORDERS */
  --border: #e2e8f0;
  --input: #e2e8f0;
  --ring: #059669;
  /* Match Primary */

  /* RADIUS */
  --radius: 0.5rem;
}

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);

  --color-primary: var(--primary);
  --color-primary-foreground: var(--primary-foreground);

  --color-secondary: var(--secondary);
  --color-secondary-foreground: var(--secondary-foreground);

  --color-destructive: var(--destructive);
  --color-destructive-foreground: var(--destructive-foreground);

  --color-muted: var(--muted);
  --color-muted-foreground: var(--muted-foreground);

  --color-accent: var(--accent);
  --color-accent-foreground: var(--accent-foreground);

  --color-border: var(--border);
  --color-input: var(--input);
  --color-ring: var(--ring);

  --radius-sm: calc(var(--radius) - 2px);
  --radius-md: calc(var(--radius) - 2px);
  --radius-lg: var(--radius);
}

/* BASE STYLES */
@layer base {
  body {
    @apply bg-background text-foreground font-sans antialiased;
  }
}

/* UTILITIES */
@layer utilities {
  .container {
    @apply mx-auto px-4 max-w-7xl;
  }
}
</file>

<file path="src/app/health/page.tsx">
export default function HealthPage() {
    return <div>OK</div>;
}
</file>

<file path="src/app/invoice/[id]/page.tsx">
'use client';

import { useEffect, useState } from 'react';
import { createClient } from '@/utils/supabase/client';
import { useParams } from 'next/navigation';
import { format } from 'date-fns';
import { Printer, Share2, MapPin, Phone, Mail, Package, ArrowLeft } from 'lucide-react';
import Link from 'next/link';
import { getTenantInfo } from '@/app/actions/adminActions';
import { getSettings } from '@/app/actions/settingsActions';

export default function InvoicePage() {
    const supabase = createClient();
    const { id } = useParams();
    const [order, setOrder] = useState<any>(null);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState('');

    const [tenantName, setTenantName] = useState('My Organization');
    const [tenantSettings, setTenantSettings] = useState<any>(null);

    useEffect(() => {
        async function fetchOrder() {
            // Fetch Tenant Info & Settings
            const info = await getTenantInfo();
            const { settings } = await getSettings();
            setTenantName(settings?.company_name || info.name || "My Organization");
            // We can store other settings in state if needed, or just use them directly if strict state is not required for printing (setState is better)
            if (settings) {
                setTenantSettings(settings);
            }

            if (!id) return;
            try {
                setLoading(true);
                // Try searching by ID first (UUID)
                let { data, error } = await supabase
                    .from('orders')
                    .select('*, customers(*), order_items(*)')
                    .eq('id', id)
                    .single();

                if (error || !data) {
                    // Fallback: Try searching by readable_id if the ID param looks short/custom
                    // Note: This depends on if readable_id is unique enough or if we want to support it in URL
                    // For now, let's assume the URL param IS the UUID for simplicity, 
                    // but if the user passed a readable_id, we might want to query that.
                    // Let's stick to UUID for the route param for safety, or check if valid UUID.
                }

                if (error) throw error;
                setOrder(data);
            } catch (err: any) {
                console.error(err);
                setError('Order not found or invalid ID.');
            } finally {
                setLoading(false);
            }
        }

        fetchOrder();
    }, [id]);

    if (loading) {
        return (
            <div className="min-h-screen bg-slate-50 flex items-center justify-center">
                <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-600"></div>
            </div>
        );
    }

    if (error || !order) {
        return (
            <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center gap-4 p-4">
                <div className="bg-white p-8 rounded-2xl shadow-xl text-center max-w-md w-full">
                    <div className="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <Package size={32} />
                    </div>
                    <h1 className="text-xl font-bold text-slate-900 mb-2">Invoice Not Found</h1>
                    <p className="text-slate-500 mb-6">{error || "We couldn't locate the order details."}</p>
                    <Link href="/" className="inline-flex items-center gap-2 text-emerald-600 font-bold hover:underline">
                        <ArrowLeft size={16} /> Return to Home
                    </Link>
                </div>
            </div>
        );
    }

    const handlePrint = () => {
        window.print();
    };

    const handleShare = () => {
        if (navigator.share) {
            navigator.share({
                title: `Raza Gas Invoice #${order.readable_id || order.id.slice(0, 6)}`,
                text: `Invoice for order #${order.readable_id || order.id.slice(0, 6)} from Raza Gas.`,
                url: window.location.href,
            }).catch(console.error);
        } else {
            // Fallback to WhatsApp
            const text = `Here is your invoice link: ${window.location.href}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        }
    };

    return (
        <div className="min-h-screen bg-slate-100 p-4 md:p-8 font-sans print:p-0 print:bg-white">
            <div className="max-w-3xl mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden print:shadow-none print:rounded-none">

                {/* Header */}
                <div className="bg-slate-900 text-white p-8 print:bg-white print:text-black print:border-b-2 print:border-slate-200">
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
                        <div>
                            <h1 className="text-3xl font-black tracking-tight text-emerald-400 print:text-emerald-600 uppercase">{tenantName}</h1>
                            <p className="text-sm text-slate-400 font-bold uppercase tracking-widest mt-1 print:text-slate-500">Management System</p>
                            <div className="flex items-center gap-4 mt-4 text-sm text-slate-300 print:text-slate-600">
                                <span className="flex items-center gap-1"><MapPin size={14} /> {tenantSettings?.company_address || 'Main Highway, City'}</span>
                                <span className="flex items-center gap-1"><Phone size={14} /> {tenantSettings?.company_phone || '+92 300 1234567'}</span>
                            </div>
                        </div>
                        <div className="text-right">
                            <div className="inline-block bg-white/10 p-4 rounded-xl backdrop-blur-sm print:bg-slate-100 print:text-black">
                                <p className="text-xs font-bold text-slate-400 uppercase mb-1">Invoice Number</p>
                                <p className="text-2xl font-mono font-bold tracking-wider">
                                    #INV-{order.friendly_id || order.id.slice(0, 5).toUpperCase()}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                {/* content */}
                <div className="p-8">

                    {/* Info Grid */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
                        <div>
                            <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">Billed To</h3>
                            <div className="space-y-1">
                                <h2 className="text-xl font-bold text-slate-900">{order.customers?.name || 'Guest Customer'}</h2>
                                <div className="flex items-center gap-2 text-slate-600">
                                    <MapPin size={16} className="text-emerald-600" />
                                    <span>{order.customers?.address || 'No Address Provided'}</span>
                                </div>
                                {order.customers?.phone && (
                                    <div className="flex items-center gap-2 text-slate-600">
                                        <Phone size={16} className="text-emerald-600" />
                                        <span>{order.customers?.phone}</span>
                                    </div>
                                )}
                            </div>
                        </div>

                        <div className="md:text-right">
                            <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">Order Details</h3>
                            <div className="space-y-2">
                                <div className="flex justify-between md:justify-end gap-4">
                                    <span className="text-slate-500">Date Issued:</span>
                                    <span className="font-bold text-slate-900">
                                        {order.created_at ? format(new Date(order.created_at), 'MMM dd, yyyy') : 'N/A'}
                                    </span>
                                </div>
                                <div className="flex justify-between md:justify-end gap-4">
                                    <span className="text-slate-500">Status:</span>
                                    <span className={`font-bold px-2 py-0.5 rounded text-xs uppercase ${order.status === 'delivered' ? 'bg-green-100 text-green-700' :
                                        order.status === 'pending' ? 'bg-yellow-100 text-yellow-700' :
                                            'bg-slate-100 text-slate-600'
                                        }`}>
                                        {order.status}
                                    </span>
                                </div>
                                <div className="flex justify-between md:justify-end gap-4">
                                    <span className="text-slate-500">Payment:</span>
                                    <span className="font-bold text-slate-900 uppercase">{order.payment_method || 'Unpaid'}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Items Table */}
                    <div className="border border-slate-200 rounded-2xl overflow-hidden mb-8">
                        <table className="w-full text-left">
                            <thead className="bg-slate-50 text-slate-500 text-xs font-bold uppercase tracking-wider">
                                <tr>
                                    <th className="p-4 border-b border-slate-200">Item Description</th>
                                    <th className="p-4 border-b border-slate-200 text-center">Quantity</th>
                                    <th className="p-4 border-b border-slate-200 text-right">Price</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {order.order_items?.map((item: any, i: number) => (
                                    <tr key={i}>
                                        <td className="p-4">
                                            <span className="font-bold text-slate-900 block">{item.product_name}</span>
                                            {/* <span className="text-xs text-slate-400">Standard Cylinder</span> */}
                                        </td>
                                        <td className="p-4 text-center font-mono font-bold text-slate-700">x{item.quantity}</td>
                                        <td className="p-4 text-right font-bold text-slate-900">
                                            {/* Assuming we don't store unit price on item, just guessing or fetching. 
                             If not available, we can just show total for now or calculate if possible.
                             But simplest is to just show total amount at bottom since schema is unclear.
                             Let's leave price column empty per item if we don't have it, or show "---"
                             Actually, let's just show total amount. 
                                            ---
                         */}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                            <tfoot className="bg-slate-50">
                                <tr>
                                    <td colSpan={2} className="p-4 text-right font-bold text-slate-500 uppercase text-xs">Total Amount</td>
                                    <td className="p-4 text-right text-xl font-black text-emerald-600">Rs {order.total_amount?.toLocaleString()}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    {/* Footer Note */}
                    <div className="text-center text-slate-400 text-xs mb-8 border-t border-slate-100 pt-6">
                        <p className="font-bold text-slate-500">{tenantSettings?.invoice_footer || 'Thank you for your business!'} </p>
                        <p className="mt-1">Generated by {tenantName}</p>
                    </div>

                    {/* Actions */}
                    <div className="flex gap-4 justify-center print:hidden">
                        <button
                            onClick={handlePrint}
                            className="flex items-center gap-2 px-6 py-3 bg-slate-900 text-white rounded-xl font-bold hover:bg-slate-800 transition-all active:scale-95"
                        >
                            <Printer size={20} /> Print Invoice
                        </button>
                        <button
                            onClick={handleShare}
                            className="flex items-center gap-2 px-6 py-3 bg-emerald-600 text-white rounded-xl font-bold hover:bg-emerald-700 transition-all active:scale-95"
                        >
                            <Share2 size={20} /> Share
                        </button>
                    </div>

                </div>
            </div>
        </div>
    );
}
</file>

<file path="src/app/layout.tsx">
import type { Metadata } from 'next';
import { Inter } from 'next/font/google';
import './globals.css';
import { Toaster } from 'sonner';

const inter = Inter({ subsets: ['latin'] });

export const metadata: Metadata = {
  title: "LPG Management System",
  description: "Advanced LPG ERP",
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en">
      <body className={inter.className}>
        {children}
        <Toaster position="bottom-center" richColors />
      </body>
    </html>
  );
}
</file>

<file path="src/app/login/page.tsx">
'use client';

import { useState } from 'react';
import { createClient } from '@/utils/supabase/client';
import { useRouter } from 'next/navigation';
import { Shield, Loader2, AlertCircle } from 'lucide-react';
import { toast } from 'sonner';

export default function LoginPage() {
    const supabase = createClient();
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [loading, setLoading] = useState(false);
    const [errorMsg, setErrorMsg] = useState<string | null>(null);
    const router = useRouter();

    const handleLogin = async (e: React.FormEvent) => {
        e.preventDefault();
        setLoading(true);
        setErrorMsg(null);

        try {
            // 1. Authenticate
            const { data: { user }, error: authError } = await supabase.auth.signInWithPassword({
                email,
                password,
            });

            if (authError) {
                if (authError.message.includes('Invalid login credentials')) {
                    throw new Error('Incorrect Email or Password.');
                }
                throw authError;
            }

            if (!user) throw new Error('Authentication failed. Please try again.');

            // 2. Fetch Profile
            const { data: profile, error: profileError } = await supabase
                .from('users')
                .select('*')
                .eq('auth_id', user.id)
                .maybeSingle();

            if (profileError) {
                console.error('Profile Fetch Error:', profileError);
                throw new Error('System Error: Unable to retrieve user profile.');
            }

            // 3. Verify Identity
            if (!profile) {
                throw new Error('Account Setup Incomplete: Identity Missing. Please contact Admin.');
            }

            // 4. Check Role
            const role = profile.role;
            if (!role) {
                throw new Error('Access Denied: No role assigned.');
            }

            // Success
            toast.success(`Welcome back, ${profile.name || 'User'}`);

            // Redirect
            // Redirect
            if (role === 'super_admin') router.push('/super-admin');
            else if (role === 'admin') router.push('/admin');
            else if (role === 'driver') router.push('/driver');
            else if (role === 'recovery_agent') router.push('/recovery');
            else router.push('/');

        } catch (error: any) {
            console.error('Login Error:', error);
            setErrorMsg(error.message || 'An unexpected error occurred.');
            toast.error(error.message || 'Login failed');
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="min-h-screen bg-slate-50 flex flex-col justify-center py-12 sm:px-6 lg:px-8 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-emerald-50/50 to-slate-50">
            <div className="sm:mx-auto sm:w-full sm:max-w-md">
                <div className="mx-auto h-12 w-12 text-emerald-600 flex items-center justify-center">
                    <Shield size={48} />
                </div>
                <h2 className="mt-6 text-center text-3xl font-bold tracking-tight text-slate-900">
                    Sign in to your account
                </h2>
                <div className="mt-2 text-center">
                    <p className="text-sm text-slate-600">Enter your credentials to access the workspace</p>
                </div>
            </div>

            <div className="mt-8 sm:mx-auto sm:w-full sm:max-w-[480px]">
                <div className="bg-white py-10 px-10 shadow-2xl rounded-2xl border border-slate-100 border-t-4 border-t-emerald-500">
                    {errorMsg && (
                        <div className="mb-6 p-4 bg-red-50 border border-red-100 rounded-lg flex items-start gap-3 text-destructive animate-in fade-in slide-in-from-top-2">
                            <AlertCircle size={20} className="shrink-0 mt-0.5" />
                            <p className="text-sm font-semibold">{errorMsg}</p>
                        </div>
                    )}

                    <form className="space-y-6" onSubmit={handleLogin}>
                        <div>
                            <label htmlFor="email" className="block text-sm font-medium text-slate-700">
                                Email Address
                            </label>
                            <div className="mt-1">
                                <input
                                    id="email"
                                    name="email"
                                    type="email"
                                    autoComplete="email"
                                    required
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className="block w-full h-12 rounded-lg bg-slate-50 border-slate-200 shadow-sm focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/20 transition-all sm:text-sm outline-none px-4"
                                    placeholder="name@company.com"
                                />
                            </div>
                        </div>

                        <div>
                            <label htmlFor="password" className="block text-sm font-medium text-slate-700">
                                Password
                            </label>
                            <div className="mt-1">
                                <input
                                    id="password"
                                    name="password"
                                    type="password"
                                    autoComplete="current-password"
                                    required
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="block w-full h-12 rounded-lg bg-slate-50 border-slate-200 shadow-sm focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/20 transition-all sm:text-sm outline-none px-4"
                                    placeholder=""
                                />
                            </div>
                        </div>

                        <div>
                            <button
                                type="submit"
                                disabled={loading}
                                className="flex w-full justify-center rounded-lg bg-emerald-600 px-4 py-3 text-sm font-semibold text-white shadow-sm hover:bg-emerald-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-600 transition-colors disabled:opacity-70 disabled:cursor-not-allowed"
                            >
                                {loading && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                                {loading ? 'Signing in...' : 'Sign In'}
                            </button>
                        </div>
                    </form>
                </div>

                <div className="mt-8 text-center text-xs text-slate-400">
                    <p> 2026 LPG Management System. All rights reserved.</p>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="src/app/page.tsx">
import { redirect } from "next/navigation";
import { createClient } from "@/utils/supabase/server";

export default async function RootPage() {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    return redirect("/login");
  }

  // Role-Based Redirection
  const role = user.user_metadata?.role;

  switch (role) {
    case 'super_admin':
      return redirect("/super-admin");
    case 'driver':
      return redirect("/driver");
    case 'recovery_agent':
      return redirect("/recovery");
    case 'finance': // Future proofing
      return redirect("/admin/finance");
    default:
      // Default to Admin Dashboard for 'admin', 'shop_manager', or undefined
      return redirect("/admin");
  }
}
</file>

<file path="src/app/signup/page.tsx">
"use client";

import { useState } from "react";
import { signupSuperAdmin, checkSystemAlreadySetup } from "@/app/actions/authActions";
import { useRouter } from "next/navigation";
import { toast } from "sonner";
import { ShieldAlert, Loader2, ArrowRight } from "lucide-react";

export default function SignupPage() {
    const router = useRouter();
    const [loading, setLoading] = useState(false);

    const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
        e.preventDefault();
        setLoading(true);

        const formData = new FormData(e.currentTarget);
        const password = formData.get("password") as string;
        const confirmPassword = formData.get("confirmPassword") as string;

        if (password !== confirmPassword) {
            toast.error("Passwords do not match");
            setLoading(false);
            return;
        }

        // Security Check: Prevent overwriting existing system
        try {
            const isSetup = await checkSystemAlreadySetup();
            if (isSetup) {
                toast.error("System Setup Complete. Cannot create new owner.");
                setLoading(false);
                return;
            }
        } catch (error) {
            console.error("Setup check failed", error);
            toast.error("Security check failed. Please contact support.");
            setLoading(false);
            return;
        }

        try {
            const result = await signupSuperAdmin(formData);

            if (result.error) {
                toast.error(result.error);
            } else if (result.success) {
                toast.success(result.message || "Account created! Redirecting...");
                if (result.redirect) {
                    router.push(result.redirect);
                } else {
                    // If email confirmation is needed
                    router.push("/login?message=Check your email to confirm account");
                }
            }
        } catch (err: any) {
            toast.error("Something went wrong: " + err.message);
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
            <div className="w-full max-w-md bg-white rounded-2xl shadow-2xl overflow-hidden">
                <div className="p-8 pb-6">
                    <div className="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mb-4 text-red-600">
                        <ShieldAlert size={24} />
                    </div>
                    <h1 className="text-2xl font-black text-slate-900">Emergency Access</h1>
                    <p className="text-slate-500 mt-2">Create the <strong className="text-slate-900">Super Admin (Owner)</strong> account to restore system access.</p>
                </div>

                <form onSubmit={handleSubmit} className="p-8 pt-0 space-y-4">
                    <div>
                        <label className="text-xs font-bold text-slate-400 uppercase mb-1 block">System Email</label>
                        <input
                            name="email"
                            type="email"
                            required
                            placeholder="superadmin@example.com"
                            className="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-900 focus:ring-2 focus:ring-red-500 outline-none transition-all"
                        />
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="text-xs font-bold text-slate-400 uppercase mb-1 block">Password</label>
                            <input
                                name="password"
                                type="password"
                                required
                                placeholder=""
                                className="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-900 focus:ring-2 focus:ring-red-500 outline-none transition-all"
                            />
                        </div>
                        <div>
                            <label className="text-xs font-bold text-slate-400 uppercase mb-1 block">Confirm</label>
                            <input
                                name="confirmPassword"
                                type="password"
                                required
                                placeholder=""
                                className="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-900 focus:ring-2 focus:ring-red-500 outline-none transition-all"
                            />
                        </div>
                    </div>

                    <button
                        type="submit"
                        disabled={loading}
                        className="w-full bg-red-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-red-700 active:scale-95 transition-all flex items-center justify-center gap-2 shadow-lg shadow-red-500/20"
                    >
                        {loading ? <Loader2 className="animate-spin" /> : <>Restore Access <ArrowRight size={20} /></>}
                    </button>
                </form>

                <div className="bg-slate-50 p-4 text-center border-t border-slate-100">
                    <p className="text-xs text-slate-400 font-medium">This is a restricted administrative action.</p>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="src/app/super-admin/page.tsx">
"use client";

import { useState, useEffect } from "react";
import { getTenants, createTenant } from "@/app/actions/superAdminActions";
import { Plus, Building, Users, Activity, ShieldCheck } from "lucide-react";
import { toast } from "sonner";
import { useRouter } from "next/navigation";
import LogoutBtn from "@/components/LogoutBtn";
import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Label } from "@/components/ui/label";
import { Badge } from "@/components/ui/badge";

export default function SuperAdminPage() {
    const [tenants, setTenants] = useState<any[]>([]);
    const [loading, setLoading] = useState(true);
    const [newTenantName, setNewTenantName] = useState("");
    const [isCreating, setIsCreating] = useState(false);
    const router = useRouter();

    useEffect(() => {
        loadTenants();
    }, []);

    const loadTenants = async () => {
        try {
            const data = await getTenants();
            setTenants(data);
        } catch (error: any) {
            toast.error("Access Denied: " + error.message);
            if (error.message.includes("Unauthorized")) {
                router.push("/");
            }
        } finally {
            setLoading(false);
        }
    };

    const handleCreateTenant = async (e: React.FormEvent<HTMLFormElement>) => {
        e.preventDefault();

        const formData = new FormData(e.currentTarget);
        const name = newTenantName;
        const plan = formData.get('plan') as any;
        const owner_email = formData.get('owner_email') as string;
        const owner_password = formData.get('owner_password') as string;

        if (!name.trim() || !owner_email || !owner_password) return;

        setIsCreating(true);
        try {
            await createTenant({
                name,
                plan,
                owner_email,
                owner_password
            });
            toast.success("Tenant & Owner Account Created!");
            setNewTenantName("");
            (e.target as HTMLFormElement).reset(); // Reset form
            loadTenants();
        } catch (error: any) {
            toast.error(error.message);
        } finally {
            setIsCreating(false);
        }
    };

    if (loading) {
        return <div className="min-h-screen flex items-center justify-center bg-slate-50 text-muted-foreground animate-pulse">Loading Dashboard...</div>;
    }

    return (
        <div className="min-h-screen bg-slate-50 p-8">
            <div className="max-w-6xl mx-auto">
                <header className="flex justify-between items-center mb-10">
                    <div>
                        <h1 className="text-3xl font-black text-slate-900 flex items-center gap-3">
                            <ShieldCheck className="text-primary" size={32} />
                            Super Admin
                        </h1>
                        <p className="text-muted-foreground font-medium">SaaS Tenant Management</p>
                    </div>
                    <div className="flex items-center gap-3">
                        <div className="bg-white px-4 py-2 rounded-full border shadow-sm flex items-center gap-2">
                            <div className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse" />
                            <span className="text-xs font-bold text-muted-foreground">System Healthy</span>
                        </div>
                        <LogoutBtn />
                    </div>
                </header>

                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    {/* Create Tenant Card */}
                    <Card className="h-fit">
                        <CardHeader>
                            <CardTitle className="flex items-center gap-2 text-lg">
                                <Plus size={20} className="text-primary" />
                                Onboard New Tenant
                            </CardTitle>
                        </CardHeader>
                        <CardContent>
                            <form onSubmit={handleCreateTenant} className="space-y-4">
                                <div className="space-y-2">
                                    <Label htmlFor="orgName" className="text-xs font-bold text-muted-foreground uppercase">Organization Name</Label>
                                    <Input
                                        id="orgName"
                                        type="text"
                                        value={newTenantName}
                                        onChange={(e) => setNewTenantName(e.target.value)}
                                        placeholder="e.g. City Gas Distributors"
                                        className="bg-slate-50"
                                        required
                                    />
                                </div>

                                <div className="space-y-2">
                                    <Label className="text-xs font-bold text-muted-foreground uppercase">Subscription Plan</Label>
                                    <select
                                        className="w-full h-10 rounded-md border border-input bg-slate-50 px-3 py-2 text-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring"
                                        name="plan"
                                    >
                                        <option value="basic">Basic (Free)</option>
                                        <option value="standard">Standard (Paid)</option>
                                        <option value="premium">Premium (Enterprise)</option>
                                    </select>
                                </div>

                                <div className="space-y-2">
                                    <Label className="text-xs font-bold text-muted-foreground uppercase">Owner Email</Label>
                                    <Input
                                        name="owner_email"
                                        type="email"
                                        placeholder="admin@company.com"
                                        className="bg-slate-50"
                                        required
                                    />
                                </div>

                                <div className="space-y-2">
                                    <Label className="text-xs font-bold text-muted-foreground uppercase">Initial Password</Label>
                                    <Input
                                        name="owner_password"
                                        type="password"
                                        placeholder="*******"
                                        className="bg-slate-50"
                                        required
                                    />
                                </div>

                                <Button
                                    type="submit"
                                    className="w-full"
                                    disabled={isCreating}
                                    isLoading={isCreating}
                                >
                                    Create Organization & User
                                </Button>
                            </form>
                        </CardContent>
                    </Card>

                    {/* Tenant List */}
                    <div className="lg:col-span-2">
                        <Card className="overflow-hidden border-0 shadow-sm ring-1 ring-slate-200">
                            <div className="p-6 border-b bg-white flex justify-between items-center">
                                <h2 className="text-lg font-bold text-slate-900 flex items-center gap-2">
                                    <Building size={20} className="text-muted-foreground" />
                                    Active Tenants
                                </h2>
                                <Badge variant="secondary" className="px-3 py-1 text-xs">
                                    {tenants.length} Organizations
                                </Badge>
                            </div>

                            {tenants.length === 0 ? (
                                <div className="p-12 text-center text-muted-foreground">
                                    No tenants found. Create one to get started.
                                </div>
                            ) : (
                                <div className="divide-y divide-slate-100 bg-white">
                                    {tenants.map(tenant => (
                                        <div key={tenant.id} className="p-6 hover:bg-slate-50 transition-colors group">
                                            <div className="flex justify-between items-start mb-2">
                                                <div>
                                                    <h3 className="text-lg font-bold text-slate-900">{tenant.name}</h3>
                                                    <p className="text-xs text-muted-foreground font-mono mt-1">{tenant.id}</p>
                                                </div>
                                                <Badge variant={tenant.subscription_status === 'active' ? 'success' : 'secondary'}>
                                                    {tenant.subscription_status}
                                                </Badge>
                                            </div>
                                            <div className="flex items-center gap-6 mt-4">
                                                <div className="flex items-center gap-2 text-muted-foreground text-sm">
                                                    <Activity size={16} />
                                                    <span>Created {new Date(tenant.created_at).toLocaleDateString()}</span>
                                                </div>
                                                {/* Placeholder for future stats */}
                                                <div className="flex items-center gap-2 text-muted-foreground text-sm">
                                                    <Users size={16} />
                                                    <span>-- Users</span>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </Card>
                    </div>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="src/components/admin/AdminSidebar.tsx">
"use client";

import Link from "next/link";
import { usePathname } from "next/navigation";
import { LayoutDashboard, Cylinder, Users, Settings, LogOut, Briefcase, ShoppingCart, Database, CheckSquare, ClipboardList, Landmark } from "lucide-react";
import { cn } from "@/lib/utils";
import LogoutBtn from "@/components/LogoutBtn";

// ...

const navItems = [
    { href: "/admin", label: "Dashboard", icon: LayoutDashboard },
    { href: "/admin/orders", label: "Orders", icon: ShoppingCart },
    { href: '/admin/cylinders', label: 'Inventory', icon: Database },
    { href: "/admin/approvals", label: "Approvals", icon: CheckSquare },
    { href: "/admin/finance", label: "Finance", icon: Landmark },
    { href: "/admin/expenses", label: "Expenses", icon: ClipboardList }, // Added Expenses
    { href: "/admin/customers", label: "Customer CRM", icon: Users },
    { href: "/admin/users", label: "Staff", icon: Briefcase },
    { href: "/admin/settings", label: "Settings", icon: Settings },
];

import { useState, useEffect } from "react";
import { getTenantInfo } from "@/app/actions/adminActions";

export function AdminSidebar() {
    const pathname = usePathname();
    const [tenantName, setTenantName] = useState<string>("");
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        getTenantInfo().then(info => {
            setTenantName(info.name || "LPG Manager");
            setLoading(false);
        });
    }, []);

    return (
        <aside className="hidden md:flex flex-col w-64 border-r border-border bg-white h-screen sticky top-0">
            <div className="p-6 border-b border-border">
                <h1 className="text-xl font-bold tracking-tight text-primary flex items-center gap-2">
                    <span className="bg-primary/10 p-1.5 rounded-lg">
                        <Cylinder className="w-5 h-5 text-primary" />
                    </span>
                    {loading ? (
                        <span className="h-6 w-24 bg-slate-100 animate-pulse rounded block" />
                    ) : (
                        tenantName
                    )}
                </h1>
            </div>

            <nav className="flex-1 p-4 space-y-1">
                {navItems.map((item) => {
                    const isActive = pathname === item.href;
                    return (
                        <Link
                            key={item.href}
                            href={item.href}
                            className={cn(
                                "flex items-center gap-3 px-3 py-2.5 rounded-md text-sm font-medium transition-colors",
                                isActive
                                    ? "bg-primary/10 text-primary"
                                    : "text-muted-foreground hover:bg-secondary hover:text-foreground"
                            )}
                        >
                            <item.icon className="h-4 w-4" />
                            {item.label}
                        </Link>
                    );
                })}
            </nav>

            <div className="p-4 border-t border-border">
                {/* We are reusing the LogoutBtn but we might need to style it to fit the sidebar look if needed. 
              Currently LogoutBtn renders a button. We can wrap it or just place it. */}
                <div className="flex items-center gap-3 px-3 py-2.5 text-sm font-medium text-muted-foreground">
                    <LogoutBtn />
                </div>
            </div>
        </aside>
    );
}
</file>

<file path="src/components/admin/customers/AddCustomerModal.tsx">
'use client';

import { useState } from 'react';
import { X, Save, AlertCircle } from 'lucide-react';
import { createCustomer } from '@/app/actions/customerActions';
import { toast } from 'sonner';

interface AddCustomerModalProps {
    onClose: () => void;
    onSuccess: () => void;
}

export default function AddCustomerModal({ onClose, onSuccess }: AddCustomerModalProps) {
    const [isSubmitting, setIsSubmitting] = useState(false);

    const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
        e.preventDefault();
        setIsSubmitting(true);
        const formData = new FormData(e.currentTarget);

        try {
            const result = await createCustomer(null, formData);
            if (result?.error) {
                toast.error(result.error);
            } else {
                toast.success("Customer account created successfully!");
                onSuccess();
                onClose();
            }
        } catch (err) {
            toast.error("Failed to create customer");
            console.error(err);
        } finally {
            setIsSubmitting(false);
        }
    };

    return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/40 backdrop-blur-sm p-4 animate-in fade-in duration-200">
            <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden animate-in zoom-in-95 duration-200 border border-slate-100">
                {/* Header */}
                <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                    <div>
                        <h2 className="text-xl font-bold text-slate-900">Add New Customer</h2>
                        <p className="text-sm text-slate-500 font-medium">Create a new client account and ledger</p>
                    </div>
                    <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full text-slate-400 hover:text-slate-600 transition-colors">
                        <X size={20} />
                    </button>
                </div>

                <form onSubmit={handleSubmit} className="p-8">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 content-start">
                        {/* Column 1: Identity */}
                        <div className="space-y-6">
                            <h3 className="text-xs font-black text-slate-400 uppercase tracking-wider border-b border-slate-100 pb-2">Identity</h3>

                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">
                                    Full Name <span className="text-red-500">*</span>
                                </label>
                                <input
                                    name="name"
                                    required
                                    type="text"
                                    className="w-full rounded-md border-slate-300 p-2.5 text-sm focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none border transition-all"
                                    placeholder="e.g. Karachi Broast"
                                    autoFocus
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">
                                    Phone Number <span className="text-red-500">*</span>
                                </label>
                                <input
                                    name="phone"
                                    required
                                    type="tel"
                                    pattern="^03[0-9]{9}$"
                                    title="Format: 03001234567"
                                    className="w-full rounded-md border-slate-300 p-2.5 text-sm focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none border transition-all"
                                    placeholder="03001234567"
                                />
                                <p className="text-xs text-slate-400 mt-1">Format: 03001234567 (11 digits)</p>
                            </div>
                        </div>

                        {/* Column 2: Location */}
                        <div className="space-y-6">
                            <h3 className="text-xs font-black text-slate-400 uppercase tracking-wider border-b border-slate-100 pb-2">Location</h3>

                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">
                                    Area / City
                                </label>
                                <input
                                    name="city"
                                    type="text"
                                    className="w-full rounded-md border-slate-300 p-2.5 text-sm focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none border transition-all"
                                    placeholder="e.g. Gulshan-e-Iqbal, Karachi"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">
                                    Full Address
                                </label>
                                <textarea
                                    name="address"
                                    rows={3}
                                    className="w-full rounded-md border-slate-300 p-2.5 text-sm focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none border transition-all resize-none"
                                    placeholder="Street, Plot No, Landmark..."
                                />
                            </div>
                        </div>

                        {/* Full Width: Financials */}
                        <div className="md:col-span-2 space-y-6 pt-2">
                            <h3 className="text-xs font-black text-slate-400 uppercase tracking-wider border-b border-slate-100 pb-2 flex items-center gap-2">
                                Financial Overview <span className="bg-slate-100 text-slate-500 text-[10px] px-2 py-0.5 rounded-full">Ledger Init</span>
                            </h3>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1 flex items-center gap-2">
                                        Opening Balance (Rs)
                                        <div className="group relative">
                                            <AlertCircle size={14} className="text-slate-400 cursor-help" />
                                            <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-48 bg-slate-900 text-white text-xs p-2 rounded shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                                Amount they owe us from the past. Enter negative for Advance.
                                            </div>
                                        </div>
                                    </label>
                                    <div className="relative">
                                        <span className="absolute left-3 top-2.5 text-slate-400 font-bold text-sm">Rs</span>
                                        <input
                                            name="opening_balance"
                                            type="number"
                                            step="0.01"
                                            className="w-full rounded-md border-slate-300 pl-10 p-2.5 text-sm focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none border transition-all font-mono font-bold text-slate-700"
                                            placeholder="0.00"
                                        />
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">
                                        Security Deposit (Rs) <span className="text-xs font-normal text-slate-400">(Optional)</span>
                                    </label>
                                    <div className="relative">
                                        <span className="absolute left-3 top-2.5 text-slate-400 font-bold text-sm">Rs</span>
                                        <input
                                            name="security_deposit"
                                            type="number"
                                            step="0.01"
                                            className="w-full rounded-md border-slate-300 pl-10 p-2.5 text-sm focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none border transition-all font-mono font-bold text-slate-700"
                                            placeholder="0.00"
                                        />
                                    </div>
                                    <p className="text-xs text-slate-400 mt-1">Held against cylinders (Liability)</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Footer */}
                    <div className="flex justify-end gap-3 mt-8 pt-4 border-t border-slate-100">
                        <button
                            type="button"
                            onClick={onClose}
                            className="px-4 py-2 text-sm font-bold text-slate-600 hover:bg-slate-50 hover:text-slate-800 rounded-lg transition-colors border border-transparent hover:border-slate-200"
                        >
                            Cancel
                        </button>
                        <button
                            type="submit"
                            disabled={isSubmitting}
                            className="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-lg text-sm font-bold shadow-lg shadow-emerald-900/10 flex items-center gap-2 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            {isSubmitting ? 'Creating Account...' : <><Save size={16} /> Create Account</>}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
}
</file>

<file path="src/components/admin/customers/CustomerImportModal.tsx">
"use client";

import { useState, useRef } from 'react';
import { UploadCloud, X, Check, FileSpreadsheet, AlertCircle } from 'lucide-react';
import Papa from 'papaparse';
import { toast } from 'sonner';
import { bulkCreateCustomers } from '@/app/actions/customerActions';

interface CustomerImportModalProps {
    onClose: () => void;
    onSuccess: () => void;
}

export default function CustomerImportModal({ onClose, onSuccess }: CustomerImportModalProps) {
    const [file, setFile] = useState<File | null>(null);
    const [previewData, setPreviewData] = useState<any[]>([]);
    const [loading, setLoading] = useState(false);
    const fileInputRef = useRef<HTMLInputElement>(null);

    const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        const selectedFile = e.target.files?.[0];
        if (selectedFile) {
            setFile(selectedFile);
            parseCSV(selectedFile);
        }
    };

    const parseCSV = (file: File) => {
        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: (results) => {
                if (results.data && results.data.length > 0) {
                    setPreviewData(results.data.slice(0, 5)); // Preview first 5
                }
            },
            error: (error) => {
                toast.error('Failed to parse CSV');
            }
        });
    };

    const handleImport = async () => {
        if (!file) return;

        setLoading(true);
        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: async (results) => {
                const rows = results.data;

                // Construct Payload
                const payload = rows.map((row: any) => ({
                    name: row['Name'] || row['name'],
                    phone: row['Phone'] || row['phone'],
                    address: row['Address'] || row['address'] || '',
                    current_balance: parseFloat(row['Balance'] || row['balance'] || '0')
                })).filter((item: any) => item.name && item.phone);

                if (payload.length === 0) {
                    toast.error("No valid customers found (Name & Phone required).");
                    setLoading(false);
                    return;
                }

                // Send to Server Action
                const formData = new FormData();
                formData.append('payload', JSON.stringify(payload));

                const response = await bulkCreateCustomers(null, formData);

                if (response?.error) {
                    toast.error(response.error);
                } else {
                    toast.success(`Successfully imported ${response?.count || 0} customers!`);
                    onSuccess();
                    onClose();
                }
                setLoading(false);
            }
        });
    };

    const downloadTemplate = () => {
        const csvContent = "data:text/csv;charset=utf-8,Name,Phone,Address,Balance\nJohn Doe,03001234567,House 123,0";
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "customer_template.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

    return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4 animate-in fade-in duration-200">
            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden animate-in zoom-in-95 duration-200">
                {/* Header */}
                <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                    <div>
                        <h2 className="text-xl font-bold text-slate-900">Import Customers</h2>
                        <p className="text-sm text-slate-500 font-medium">Upload CSV to bulk add customers</p>
                    </div>
                    <button onClick={onClose} className="p-2 hover:bg-slate-100 rounded-full transition-colors text-slate-400 hover:text-slate-600">
                        <X size={20} />
                    </button>
                </div>

                <div className="p-8">
                    {/* Step 1: Download Template */}
                    <div className="mb-8 p-4 bg-blue-50/50 rounded-xl border border-blue-100 flex justify-between items-center">
                        <div className="flex items-center gap-3">
                            <div className="bg-blue-100 p-2 rounded-lg text-blue-600">
                                <FileSpreadsheet size={20} />
                            </div>
                            <div>
                                <h3 className="font-bold text-slate-800 text-sm">Step 1: Get Template</h3>
                                <p className="text-xs text-slate-500">Ensure your CSV matches the required format.</p>
                            </div>
                        </div>
                        <button onClick={downloadTemplate} className="text-sm font-bold text-blue-600 hover:underline">
                            Download CSV
                        </button>
                    </div>

                    {/* Step 2: Upload */}
                    {!file ? (
                        <div
                            onClick={() => fileInputRef.current?.click()}
                            className="border-2 border-dashed border-slate-200 rounded-2xl p-12 flex flex-col items-center justify-center cursor-pointer hover:border-emerald-500 hover:bg-emerald-50/30 transition-all group"
                        >
                            <input
                                type="file"
                                accept=".csv"
                                className="hidden"
                                ref={fileInputRef}
                                onChange={handleFileChange}
                            />
                            <div className="bg-slate-100 p-4 rounded-full mb-4 group-hover:bg-emerald-100 transition-colors">
                                <UploadCloud size={32} className="text-slate-400 group-hover:text-emerald-600 transition-colors" />
                            </div>
                            <h3 className="font-bold text-slate-900 mb-1">Click to Upload</h3>
                            <p className="text-sm text-slate-500 text-center max-w-xs">Supported format: .csv (Max 5MB)</p>
                        </div>
                    ) : (
                        <div className="space-y-6">
                            {/* File Info */}
                            <div className="flex justify-between items-center p-4 bg-slate-50 rounded-xl border border-slate-200">
                                <div className="flex items-center gap-3">
                                    <div className="bg-emerald-100 p-2 rounded-lg text-emerald-600">
                                        <Check size={20} />
                                    </div>
                                    <div>
                                        <p className="font-bold text-slate-900 text-sm truncate max-w-[200px]">{file.name}</p>
                                        <p className="text-xs text-slate-500">Ready to processing</p>
                                    </div>
                                </div>
                                <button onClick={() => { setFile(null); setPreviewData([]); }} className="text-xs font-bold text-rose-500 hover:text-rose-600">
                                    Remove
                                </button>
                            </div>

                            {/* Preview Table */}
                            {previewData.length > 0 && (
                                <div className="border border-slate-200 rounded-xl overflow-hidden">
                                    <div className="bg-slate-50 px-4 py-2 border-b border-slate-200">
                                        <h4 className="text-xs font-bold text-slate-500 uppercase tracking-wider">Preview (First 5 Rows)</h4>
                                    </div>
                                    <table className="w-full text-sm text-left">
                                        <thead className="bg-white border-b border-slate-100">
                                            <tr>
                                                <th className="px-4 py-2 font-bold text-slate-700">Name</th>
                                                <th className="px-4 py-2 font-bold text-slate-700">Phone</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-50">
                                            {previewData.map((row, i) => (
                                                <tr key={i} className="bg-white">
                                                    <td className="px-4 py-2 text-slate-600">
                                                        {row['Name'] || row['name'] || '-'}
                                                    </td>
                                                    <td className="px-4 py-2 text-slate-600 font-mono">
                                                        {row['Phone'] || row['phone'] || '-'}
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </div>
                    )}
                </div>

                {/* Footer */}
                <div className="px-6 py-4 bg-slate-50 border-t border-slate-100 flex justify-end gap-3">
                    <button onClick={onClose} className="px-4 py-2 text-sm font-bold text-slate-600 hover:bg-slate-200/50 rounded-lg transition-colors">
                        Cancel
                    </button>
                    <button
                        onClick={handleImport}
                        disabled={!file || loading}
                        className="btn-primary px-6 py-2 text-sm flex items-center gap-2"
                    >
                        {loading ? 'Importing...' : 'Confirm Import'}
                    </button>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="src/components/admin/customers/EditCustomerModal.tsx">
'use client';

import { useState } from 'react';
import { X, Save, AlertCircle } from 'lucide-react';
import { updateCustomer } from '@/app/actions/customerActions';
import { toast } from 'sonner';

interface EditCustomerModalProps {
    customer: {
        id: string;
        name: string;
        phone: string;
        address: string;
        credit_limit?: number;
    };
    onClose: () => void;
    onSuccess: () => void;
}

export default function EditCustomerModal({ customer, onClose, onSuccess }: EditCustomerModalProps) {
    const [isSubmitting, setIsSubmitting] = useState(false);

    const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
        e.preventDefault();
        setIsSubmitting(true);
        const formData = new FormData(e.currentTarget);
        // Ensure ID is included
        formData.append('id', customer.id);

        try {
            const result = await updateCustomer(null, formData);
            if (result?.error) {
                toast.error(result.error);
            } else {
                toast.success("Customer updated successfully!");
                onSuccess();
                onClose();
            }
        } catch (err) {
            toast.error("Failed to update customer");
            console.error(err);
        } finally {
            setIsSubmitting(false);
        }
    };

    return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/40 backdrop-blur-sm p-4 animate-in fade-in duration-200">
            <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden animate-in zoom-in-95 duration-200 border border-slate-100">
                {/* Header */}
                <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                    <div>
                        <h2 className="text-xl font-bold text-slate-900">Edit Customer</h2>
                        <p className="text-sm text-slate-500 font-medium">Update account details and limits</p>
                    </div>
                    <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full text-slate-400 hover:text-slate-600 transition-colors">
                        <X size={20} />
                    </button>
                </div>

                <form onSubmit={handleSubmit} className="p-8">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 content-start">
                        {/* Column 1: Identity */}
                        <div className="space-y-6">
                            <h3 className="text-xs font-black text-slate-400 uppercase tracking-wider border-b border-slate-100 pb-2">Identity</h3>

                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">
                                    Full Name <span className="text-red-500">*</span>
                                </label>
                                <input
                                    name="name"
                                    defaultValue={customer.name}
                                    required
                                    type="text"
                                    className="w-full rounded-md border-slate-300 p-2.5 text-sm focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none border transition-all"
                                    placeholder="e.g. Karachi Broast"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">
                                    Phone Number <span className="text-red-500">*</span>
                                </label>
                                <input
                                    name="phone"
                                    defaultValue={customer.phone}
                                    required
                                    type="tel"
                                    pattern="^03[0-9]{9}$"
                                    title="Format: 03001234567"
                                    className="w-full rounded-md border-slate-300 p-2.5 text-sm focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none border transition-all"
                                    placeholder="03001234567"
                                />
                                <p className="text-xs text-slate-400 mt-1">Format: 03001234567 (11 digits)</p>
                            </div>
                        </div>

                        {/* Column 2: Location */}
                        <div className="space-y-6">
                            <h3 className="text-xs font-black text-slate-400 uppercase tracking-wider border-b border-slate-100 pb-2">Location</h3>

                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">
                                    Full Address
                                </label>
                                <textarea
                                    name="address"
                                    defaultValue={customer.address}
                                    rows={3}
                                    className="w-full rounded-md border-slate-300 p-2.5 text-sm focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none border transition-all resize-none"
                                    placeholder="Street, Plot No, Landmark..."
                                />
                            </div>
                        </div>

                        {/* Full Width: Financial Limits */}
                        <div className="md:col-span-2 space-y-6 pt-2">
                            <h3 className="text-xs font-black text-slate-400 uppercase tracking-wider border-b border-slate-100 pb-2 flex items-center gap-2">
                                Limits & Controls
                            </h3>

                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1 flex items-center gap-2">
                                    Credit Limit (Rs)
                                    <div className="group relative">
                                        <AlertCircle size={14} className="text-slate-400 cursor-help" />
                                        <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-48 bg-slate-900 text-white text-xs p-2 rounded shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                            Max debt allowed before system warns/blocks.
                                        </div>
                                    </div>
                                </label>
                                <div className="relative">
                                    <span className="absolute left-3 top-2.5 text-slate-400 font-bold text-sm">Rs</span>
                                    <input
                                        name="credit_limit"
                                        defaultValue={customer.credit_limit || 50000}
                                        type="number"
                                        step="1"
                                        className="w-full rounded-md border-slate-300 pl-10 p-2.5 text-sm focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none border transition-all font-mono font-bold text-slate-700"
                                        placeholder="50000"
                                    />
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Footer */}
                    <div className="flex justify-end gap-3 mt-8 pt-4 border-t border-slate-100">
                        <button
                            type="button"
                            onClick={onClose}
                            className="px-4 py-2 text-sm font-bold text-slate-600 hover:bg-slate-50 hover:text-slate-800 rounded-lg transition-colors border border-transparent hover:border-slate-200"
                        >
                            Cancel
                        </button>
                        <button
                            type="submit"
                            disabled={isSubmitting}
                            className="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-lg text-sm font-bold shadow-lg shadow-emerald-900/10 flex items-center gap-2 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            {isSubmitting ? 'Saving Changes...' : <><Save size={16} /> Save Changes</>}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
}
</file>

<file path="src/components/admin/DashboardChart.tsx">
"use client"

import { Bar, BarChart, ResponsiveContainer, XAxis, YAxis, Tooltip } from "recharts"

interface DashboardChartProps {
    data: { name: string, value: number }[]
}

export function DashboardChart({ data }: DashboardChartProps) {
    if (!data || data.every(d => d.value === 0)) {
        return (
            <div className="h-[300px] flex items-center justify-center text-slate-400 text-sm font-medium border border-dashed border-slate-200 rounded-xl bg-slate-50/50">
                No orders in the last 7 days
            </div>
        )
    }

    return (
        <ResponsiveContainer width="100%" height={300}>
            <BarChart data={data}>
                <XAxis
                    dataKey="name"
                    stroke="#888888"
                    fontSize={12}
                    tickLine={false}
                    axisLine={false}
                />
                <YAxis
                    stroke="#888888"
                    fontSize={12}
                    tickLine={false}
                    axisLine={false}
                    tickFormatter={(value) => `${value}`}
                />
                <Tooltip
                    cursor={{ fill: 'rgba(0,0,0,0.05)' }}
                    contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }}
                />
                <Bar
                    dataKey="value"
                    fill="#10b981"
                    radius={[4, 4, 0, 0]}
                    maxBarSize={50}
                />
            </BarChart>
        </ResponsiveContainer>
    )
}
</file>

<file path="src/components/admin/inventory/PlantOperationsModal.tsx">
"use client";

import { useState } from 'react';
import { X, Truck, ArrowRight, ArrowLeft, CheckCircle } from 'lucide-react';
import { toast } from 'sonner';
import { sendToPlant, receiveFromPlant } from '@/app/actions/cylinderActions';

interface PlantOperationsModalProps {
    onClose: () => void;
    onSuccess: () => void;
    emptyCount: number;
    maintenanceCount: number;
}

export default function PlantOperationsModal({ onClose, onSuccess, emptyCount, maintenanceCount }: PlantOperationsModalProps) {
    const [mode, setMode] = useState<'send' | 'receive'>('send');
    const [quantity, setQuantity] = useState<string>('');
    const [loading, setLoading] = useState(false);

    const handleSubmit = async () => {
        const qty = parseInt(quantity);
        if (!qty || qty <= 0) {
            toast.error("Please enter a valid quantity");
            return;
        }

        if (mode === 'send' && qty > emptyCount) {
            toast.error(`Only ${emptyCount} empty cylinders available`);
            return;
        }

        if (mode === 'receive' && qty > maintenanceCount) {
            toast.error(`Only ${maintenanceCount} cylinders at plant`);
            return;
        }

        setLoading(true);
        try {
            const result = mode === 'send'
                ? await sendToPlant(qty)
                : await receiveFromPlant(qty);

            if (result.error) {
                toast.error(result.error);
            } else {
                toast.success(mode === 'send'
                    ? `Sent ${result.count} cylinders to plant`
                    : `Received ${result.count} filled cylinders`
                );
                onSuccess();
                onClose();
            }
        } catch (error) {
            toast.error("Operation failed");
            console.error(error);
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4 animate-in fade-in duration-200">
            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden animate-in zoom-in-95 duration-200">
                {/* Header */}
                <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                    <div className="flex items-center gap-3">
                        <div className="bg-orange-100 p-2 rounded-lg text-orange-600">
                            <Truck size={24} />
                        </div>
                        <div>
                            <h2 className="text-xl font-bold text-slate-900">Plant Operations</h2>
                            <p className="text-sm text-slate-500 font-medium">Bulk Send / Receive Workflow</p>
                        </div>
                    </div>
                    <button onClick={onClose} className="p-2 hover:bg-slate-100 rounded-full transition-colors text-slate-400 hover:text-slate-600">
                        <X size={20} />
                    </button>
                </div>

                <div className="p-6">
                    {/* Tabs */}
                    <div className="flex bg-slate-100 rounded-lg p-1 mb-6">
                        <button
                            onClick={() => setMode('send')}
                            className={`flex-1 flex items-center justify-center gap-2 py-2 text-sm font-bold rounded-md transition-all ${mode === 'send'
                                    ? 'bg-white text-slate-900 shadow-sm'
                                    : 'text-slate-500 hover:text-slate-700'
                                }`}
                        >
                            <ArrowRight size={16} /> Send to Plant
                        </button>
                        <button
                            onClick={() => setMode('receive')}
                            className={`flex-1 flex items-center justify-center gap-2 py-2 text-sm font-bold rounded-md transition-all ${mode === 'receive'
                                    ? 'bg-white text-slate-900 shadow-sm'
                                    : 'text-slate-500 hover:text-slate-700'
                                }`}
                        >
                            <ArrowLeft size={16} /> Receive Full
                        </button>
                    </div>

                    {/* Stats & Input */}
                    <div className="space-y-6">
                        <div className="text-center">
                            <p className="text-sm font-medium text-slate-500 mb-1">
                                {mode === 'send' ? 'Available Empty Cylinders' : 'Cylinders Currently at Plant'}
                            </p>
                            <div className="text-3xl font-black text-slate-900">
                                {mode === 'send' ? emptyCount : maintenanceCount}
                            </div>
                        </div>

                        <div className="bg-slate-50 p-6 rounded-xl border border-slate-200">
                            <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">
                                Quantity to {mode === 'send' ? 'Send' : 'Receive'}
                            </label>
                            <input
                                type="number"
                                value={quantity}
                                onChange={(e) => setQuantity(e.target.value)}
                                placeholder="e.g. 50"
                                className="w-full text-center text-2xl font-bold py-3 bg-white border border-slate-200 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none"
                                autoFocus
                            />
                            <p className="text-xs text-center text-slate-400 mt-2">
                                {mode === 'send'
                                    ? `Will update oldest ${quantity || 0} empty cylinders to 'Maintenance'`
                                    : `Will update ${quantity || 0} cylinders to 'Full'`}
                            </p>
                        </div>
                    </div>
                </div>

                {/* Footer */}
                <div className="px-6 py-4 bg-slate-50 border-t border-slate-100 flex justify-end gap-3">
                    <button onClick={onClose} className="px-4 py-2 text-sm font-bold text-slate-600 hover:bg-slate-200/50 rounded-lg transition-colors">
                        Cancel
                    </button>
                    <button
                        onClick={handleSubmit}
                        disabled={loading}
                        className={`px-6 py-2 text-sm font-bold text-white rounded-lg shadow-lg flex items-center gap-2 transition-transform active:scale-95 ${mode === 'send'
                                ? 'bg-orange-600 hover:bg-orange-700 shadow-orange-600/20'
                                : 'bg-emerald-600 hover:bg-emerald-700 shadow-emerald-600/20'
                            }`}
                    >
                        {loading ? 'Processing...' : (
                            <>
                                <CheckCircle size={16} /> Confirm {mode === 'send' ? 'Dispatch' : 'Receipt'}
                            </>
                        )}
                    </button>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="src/components/admin/inventory/StockImportModal.tsx">
"use client";

import { useState, useRef } from 'react';
import { UploadCloud, X, Check, FileSpreadsheet, AlertCircle } from 'lucide-react';
import Papa from 'papaparse';
import { toast } from 'sonner';
import { bulkCreateCylinders } from '@/app/actions/cylinderActions';

interface StockImportModalProps {
    onClose: () => void;
    onSuccess: () => void;
}

export default function StockImportModal({ onClose, onSuccess }: StockImportModalProps) {
    const [file, setFile] = useState<File | null>(null);
    const [previewData, setPreviewData] = useState<any[]>([]);
    const [loading, setLoading] = useState(false);
    const fileInputRef = useRef<HTMLInputElement>(null);

    const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        const selectedFile = e.target.files?.[0];
        if (selectedFile) {
            setFile(selectedFile);
            parseCSV(selectedFile);
        }
    };

    const parseCSV = (file: File) => {
        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: (results) => {
                if (results.data && results.data.length > 0) {
                    setPreviewData(results.data.slice(0, 5)); // Preview first 5
                }
            },
            error: (error) => {
                toast.error('Failed to parse CSV');
            }
        });
    };

    const handleImport = async () => {
        if (!file) return;

        setLoading(true);
        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: async (results) => {
                const rows = results.data;

                // Construct Payload
                const payload = rows.map((row: any) => ({
                    serial_number: row['Serial Number'] || row['serial_number'] || row['Serial'],
                    type: '45.4KG', // Enforce type
                    status: 'full', // Default to full
                })).filter((item: any) => item.serial_number);

                if (payload.length === 0) {
                    toast.error("No valid serial numbers found. Check CSV headers.");
                    setLoading(false);
                    return;
                }

                // Send to Server Action
                const formData = new FormData();
                formData.append('payload', JSON.stringify(payload));

                const response = await bulkCreateCylinders(null, formData);

                if (response?.error) {
                    toast.error(response.error);
                } else {
                    toast.success(`Successfully imported ${response?.count || 0} cylinders!`);
                    onSuccess();
                    onClose();
                }
                setLoading(false);
            }
        });
    };

    const downloadTemplate = () => {
        const csvContent = "data:text/csv;charset=utf-8,Serial Number\nAG-001\nAG-002";
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "stock_template.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

    return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4 animate-in fade-in duration-200">
            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden animate-in zoom-in-95 duration-200">
                {/* Header */}
                <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                    <div>
                        <h2 className="text-xl font-bold text-slate-900">Import Stock</h2>
                        <p className="text-sm text-slate-500 font-medium">Upload CSV to bulk register assets</p>
                    </div>
                    <button onClick={onClose} className="p-2 hover:bg-slate-100 rounded-full transition-colors text-slate-400 hover:text-slate-600">
                        <X size={20} />
                    </button>
                </div>

                <div className="p-8">
                    {/* Step 1: Download Template */}
                    <div className="mb-8 p-4 bg-blue-50/50 rounded-xl border border-blue-100 flex justify-between items-center">
                        <div className="flex items-center gap-3">
                            <div className="bg-blue-100 p-2 rounded-lg text-blue-600">
                                <FileSpreadsheet size={20} />
                            </div>
                            <div>
                                <h3 className="font-bold text-slate-800 text-sm">Step 1: Get Template</h3>
                                <p className="text-xs text-slate-500">Ensure your CSV matches the required format.</p>
                            </div>
                        </div>
                        <button onClick={downloadTemplate} className="text-sm font-bold text-blue-600 hover:underline">
                            Download CSV
                        </button>
                    </div>

                    {/* Step 2: Upload */}
                    {!file ? (
                        <div
                            onClick={() => fileInputRef.current?.click()}
                            className="border-2 border-dashed border-slate-200 rounded-2xl p-12 flex flex-col items-center justify-center cursor-pointer hover:border-emerald-500 hover:bg-emerald-50/30 transition-all group"
                        >
                            <input
                                type="file"
                                accept=".csv"
                                className="hidden"
                                ref={fileInputRef}
                                onChange={handleFileChange}
                            />
                            <div className="bg-slate-100 p-4 rounded-full mb-4 group-hover:bg-emerald-100 transition-colors">
                                <UploadCloud size={32} className="text-slate-400 group-hover:text-emerald-600 transition-colors" />
                            </div>
                            <h3 className="font-bold text-slate-900 mb-1">Click to Upload</h3>
                            <p className="text-sm text-slate-500 text-center max-w-xs">Supported format: .csv (Max 5MB)</p>
                        </div>
                    ) : (
                        <div className="space-y-6">
                            {/* File Info */}
                            <div className="flex justify-between items-center p-4 bg-slate-50 rounded-xl border border-slate-200">
                                <div className="flex items-center gap-3">
                                    <div className="bg-emerald-100 p-2 rounded-lg text-emerald-600">
                                        <Check size={20} />
                                    </div>
                                    <div>
                                        <p className="font-bold text-slate-900 text-sm truncate max-w-[200px]">{file.name}</p>
                                        <p className="text-xs text-slate-500">Ready to processing</p>
                                    </div>
                                </div>
                                <button onClick={() => { setFile(null); setPreviewData([]); }} className="text-xs font-bold text-rose-500 hover:text-rose-600">
                                    Remove
                                </button>
                            </div>

                            {/* Preview Table */}
                            {previewData.length > 0 && (
                                <div className="border border-slate-200 rounded-xl overflow-hidden">
                                    <div className="bg-slate-50 px-4 py-2 border-b border-slate-200">
                                        <h4 className="text-xs font-bold text-slate-500 uppercase tracking-wider">Preview (First 5 Rows)</h4>
                                    </div>
                                    <table className="w-full text-sm text-left">
                                        <thead className="bg-white border-b border-slate-100">
                                            <tr>
                                                <th className="px-4 py-2 font-bold text-slate-700">Serial Number</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-50">
                                            {previewData.map((row, i) => (
                                                <tr key={i} className="bg-white">
                                                    <td className="px-4 py-2 text-slate-600 font-mono">
                                                        {row['Serial Number'] || row['serial_number'] || row['Serial'] || '-'}
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            )}

                            <div className="flex items-start gap-2 p-3 bg-amber-50 text-amber-700 rounded-lg text-xs">
                                <AlertCircle size={14} className="shrink-0 mt-0.5" />
                                <p>This specific import will register assets as <strong>45.4KG Full Cylinders</strong> in the <strong>Warehouse</strong>.</p>
                            </div>
                        </div>
                    )}
                </div>

                {/* Footer */}
                <div className="px-6 py-4 bg-slate-50 border-t border-slate-100 flex justify-end gap-3">
                    <button onClick={onClose} className="px-4 py-2 text-sm font-bold text-slate-600 hover:bg-slate-200/50 rounded-lg transition-colors">
                        Cancel
                    </button>
                    <button
                        onClick={handleImport}
                        disabled={!file || loading}
                        className="btn-primary px-6 py-2 text-sm flex items-center gap-2"
                    >
                        {loading ? 'Importing...' : 'Confirm Import'}
                    </button>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="src/components/admin/TransactionModal.tsx">
"use client"

import { useState, useEffect } from "react"
import { useForm } from "react-hook-form"
import { zodResolver } from "@hookform/resolvers/zod"
import * as z from "zod"
import { CalendarIcon, Loader2, Plus, ArrowRight } from "lucide-react"
import { format } from "date-fns"
import { cn } from "@/lib/utils"

import { Button } from "@/components/ui/button"
import {
    Dialog,
    DialogContent,
    DialogDescription,
    DialogHeader,
    DialogTitle,
    DialogTrigger,
} from "@/components/ui/dialog"
import {
    Form,
    FormControl,
    FormField,
    FormItem,
    FormLabel,
    FormMessage,
} from "@/components/ui/form"
import { Input } from "@/components/ui/input"
import {
    Select,
    SelectContent,
    SelectItem,
    SelectTrigger,
    SelectValue,
} from "@/components/ui/select"
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover"
import { Calendar } from "@/components/ui/calendar"
import { toast } from "sonner"
import { createTransaction, getAllCustomersClient } from "@/app/actions/financeActions"

// Schema
const formSchema = z.object({
    type: z.enum(["income", "expense"]),
    category: z.string().min(1, "Please select a category"),
    amount: z.coerce.number().min(1, "Amount must be greater than 0"),
    customerId: z.string().optional(),
    description: z.string().min(3, "Description is required"),
    date: z.date()
}).refine(data => {
    if (data.category === 'customer_payment' && !data.customerId) {
        return false;
    }
    return true;
}, {
    message: "Customer is required for payments",
    path: ["customerId"]
});

type TransactionFormValues = z.infer<typeof formSchema>;

export function TransactionModal() {
    const [open, setOpen] = useState(false)
    const [customers, setCustomers] = useState<{ id: string, name: string }[]>([])
    const [loadingCustomers, setLoadingCustomers] = useState(false)

    const form = useForm<TransactionFormValues>({
        resolver: zodResolver(formSchema) as any,
        defaultValues: {
            type: "expense",
            category: "operational_expense",
            amount: 0,
            description: "",
            date: new Date(),
        },
    })

    const type = form.watch("type")
    const category = form.watch("category")

    // Fetch Customers if needed
    useEffect(() => {
        if (category === 'customer_payment') {
            setLoadingCustomers(true);
            getAllCustomersClient().then(res => {
                if (res.data) setCustomers(res.data);
                setLoadingCustomers(false);
            });
        }
    }, [category]);

    // Auto-switch type based on category
    useEffect(() => {
        if (category === 'customer_payment' || category === 'deposit' || category === 'owner_equity') {
            form.setValue('type', 'income');
        } else if (category === 'operational_expense' || category === 'owner_withdrawal' || category === 'maintenance') {
            form.setValue('type', 'expense');
        }
    }, [category, form]);

    async function onSubmit(values: TransactionFormValues) {
        try {
            const formData = new FormData();
            formData.append('type', values.type);
            formData.append('category', values.category);
            formData.append('amount', values.amount.toString());
            formData.append('description', values.description);
            formData.append('date', values.date.toISOString());
            if (values.customerId) formData.append('customer_id', values.customerId);

            const result = await createTransaction(formData);

            if (result.error) {
                toast.error(result.error);
            } else {
                toast.success("Transaction recorded successfully");
                setOpen(false);
                form.reset();
            }
        } catch (error) {
            toast.error("An unexpected error occurred");
        }
    }

    return (
        <Dialog open={open} onOpenChange={setOpen}>
            <DialogTrigger asChild>
                <Button className="bg-emerald-600 hover:bg-emerald-700 text-white gap-2">
                    <Plus size={16} /> New Entry
                </Button>
            </DialogTrigger>
            <DialogContent className="sm:max-w-[500px]">
                <DialogHeader>
                    <DialogTitle>Manual Transaction</DialogTitle>
                    <DialogDescription>
                        Record a manual expense, deposit, or customer payment directly to the ledger.
                    </DialogDescription>
                </DialogHeader>

                <Form {...form}>
                    <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4 pt-4">

                        {/* Type Toggle */}
                        <div className="flex gap-4 p-1 bg-slate-100 rounded-lg">
                            <button
                                type="button"
                                onClick={() => form.setValue("type", "income")}
                                className={cn(
                                    "flex-1 py-1.5 text-sm font-bold rounded-md transition-all",
                                    type === "income" ? "bg-white text-emerald-600 shadow-sm border border-slate-200" : "text-slate-500 hover:text-slate-700"
                                )}
                            >
                                Income (+)
                            </button>
                            <button
                                type="button"
                                onClick={() => form.setValue("type", "expense")}
                                className={cn(
                                    "flex-1 py-1.5 text-sm font-bold rounded-md transition-all",
                                    type === "expense" ? "bg-white text-rose-600 shadow-sm border border-slate-200" : "text-slate-500 hover:text-slate-700"
                                )}
                            >
                                Expense (-)
                            </button>
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <FormField
                                control={form.control}
                                name="category"
                                render={({ field }) => (
                                    <FormItem>
                                        <FormLabel>Category</FormLabel>
                                        <Select onValueChange={field.onChange} defaultValue={field.value}>
                                            <FormControl>
                                                <SelectTrigger>
                                                    <SelectValue placeholder="Select Category" />
                                                </SelectTrigger>
                                            </FormControl>
                                            <SelectContent>
                                                <SelectItem value="customer_payment">Customer Payment</SelectItem>
                                                <SelectItem value="deposit">General Deposit</SelectItem>
                                                <SelectItem value="owner_equity">Owner Investment</SelectItem>
                                                <SelectItem value="operational_expense">Operational Expense</SelectItem>
                                                <SelectItem value="maintenance">Maintenance</SelectItem>
                                                <SelectItem value="salary">Salary Advance</SelectItem>
                                                <SelectItem value="owner_withdrawal">Owner Withdrawal</SelectItem>
                                            </SelectContent>
                                        </Select>
                                        <FormMessage />
                                    </FormItem>
                                )}
                            />

                            <FormField
                                control={form.control}
                                name="amount"
                                render={({ field }) => (
                                    <FormItem>
                                        <FormLabel>Amount (Rs)</FormLabel>
                                        <FormControl>
                                            <Input type="number" {...field} className={cn("font-mono text-right font-bold", type === 'income' ? 'text-emerald-600' : 'text-rose-600')} />
                                        </FormControl>
                                        <FormMessage />
                                    </FormItem>
                                )}
                            />
                        </div>

                        {/* Conditional Customer Select */}
                        {category === 'customer_payment' && (
                            <FormField
                                control={form.control}
                                name="customerId"
                                render={({ field }) => (
                                    <FormItem className="animate-in fade-in slide-in-from-top-2">
                                        <FormLabel>Select Customer</FormLabel>
                                        <Select onValueChange={field.onChange} value={field.value}>
                                            <FormControl>
                                                <SelectTrigger disabled={loadingCustomers}>
                                                    <SelectValue placeholder={loadingCustomers ? "Loading..." : "Select Customer"} />
                                                </SelectTrigger>
                                            </FormControl>
                                            <SelectContent>
                                                {customers.map(c => (
                                                    <SelectItem key={c.id} value={c.id}>
                                                        {c.name}
                                                    </SelectItem>
                                                ))}
                                            </SelectContent>
                                        </Select>
                                        <FormMessage />
                                    </FormItem>
                                )}
                            />
                        )}

                        <FormField
                            control={form.control}
                            name="description"
                            render={({ field }) => (
                                <FormItem>
                                    <FormLabel>Description / Note</FormLabel>
                                    <FormControl>
                                        <Input placeholder="e.g. Tea for Staff, Bill #123" {...field} />
                                    </FormControl>
                                    <FormMessage />
                                </FormItem>
                            )}
                        />

                        <FormField
                            control={form.control}
                            name="date"
                            render={({ field }) => (
                                <FormItem className="flex flex-col">
                                    <FormLabel>Date</FormLabel>
                                    <Popover>
                                        <PopoverTrigger asChild>
                                            <FormControl>
                                                <Button
                                                    variant={"outline"}
                                                    className={cn(
                                                        "w-full pl-3 text-left font-normal",
                                                        !field.value && "text-muted-foreground"
                                                    )}
                                                >
                                                    {field.value ? (
                                                        format(field.value, "PPP")
                                                    ) : (
                                                        <span>Pick a date</span>
                                                    )}
                                                    <CalendarIcon className="ml-auto h-4 w-4 opacity-50" />
                                                </Button>
                                            </FormControl>
                                        </PopoverTrigger>
                                        <PopoverContent className="w-auto p-0" align="start">
                                            <Calendar
                                                mode="single"
                                                selected={field.value}
                                                onSelect={field.onChange}
                                                disabled={(date) =>
                                                    date > new Date() || date < new Date("1900-01-01")
                                                }
                                                initialFocus
                                            />
                                        </PopoverContent>
                                    </Popover>
                                    <FormMessage />
                                </FormItem>
                            )}
                        />

                        <div className="pt-4 flex gap-3">
                            <Button type="button" variant="ghost" onClick={() => setOpen(false)} className="flex-1">Cancel</Button>
                            <Button type="submit" className={cn("flex-1 font-bold", type === 'income' ? 'bg-emerald-600 hover:bg-emerald-700' : 'bg-rose-600 hover:bg-rose-700')} disabled={form.formState.isSubmitting}>
                                {form.formState.isSubmitting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                                {type === 'income' ? 'Record Income' : 'Record Expense'}
                            </Button>
                        </div>
                    </form>
                </Form>
            </DialogContent>
        </Dialog>
    )
}
</file>

<file path="src/components/LogoutBtn.tsx">
"use client";

import { LogOut } from "lucide-react";
import { createClient } from '@/utils/supabase/client'
import { useRouter } from "next/navigation";
import { toast } from "sonner";
import { useState } from "react";

interface LogoutBtnProps {
    className?: string;
    iconOnly?: boolean;
}

export default function LogoutBtn({ className, iconOnly = false }: LogoutBtnProps) {
    const router = useRouter();
    const [loading, setLoading] = useState(false);

    const handleLogout = async () => {
        setLoading(true);
        try {
            const promise = async () => {
                const supabase = createClient();
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                router.push("/login?message=Logged out successfully");
                router.refresh();
            };

            await toast.promise(promise(), {
                loading: "Logging out...",
                success: "Logged out successfully",
                error: (err) => `Error logging out: ${err.message}`,
            });
        } finally {
            setLoading(false);
        }
    };

    return (
        <button
            onClick={handleLogout}
            disabled={loading}
            className={`flex items-center gap-2 text-red-600 hover:text-red-700 hover:bg-red-50 px-3 py-2 rounded-lg transition-colors disabled:opacity-50 ${className}`}
            title="Sign Out"
        >
            <LogOut size={20} />
            {!iconOnly && <span className="font-bold">Logout</span>}
        </button>
    );
}
</file>

<file path="src/components/recovery/CollectionDrawer.tsx">
"use client"

import { useState } from "react"
import { useForm, SubmitHandler } from "react-hook-form"
import { zodResolver } from "@hookform/resolvers/zod"
import * as z from "zod"
import { Loader2, Plus } from "lucide-react"
import { toast } from "sonner"

import { Button } from "@/components/ui/button"
import {
    Drawer,
    DrawerClose,
    DrawerContent,
    DrawerDescription,
    DrawerFooter,
    DrawerHeader,
    DrawerTitle,
    DrawerTrigger,
} from "@/components/ui/drawer"
import {
    Form,
    FormControl,
    FormField,
    FormItem,
    FormLabel,
    FormMessage,
} from "@/components/ui/form"
import { Input } from "@/components/ui/input"
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group"
import { collectPayment } from "@/app/actions/recoveryActions"

const collectionSchema = z.object({
    amount: z.number().min(1, "Amount must be greater than 0"),
    paymentMode: z.union([
        z.literal("cash"),
        z.literal("cheque"),
        z.literal("bank"),
    ]),
    description: z.string().optional(),
})

export type CollectionFormValues = z.infer<typeof collectionSchema>;

interface CollectionDrawerProps {
    customer: {
        id: string
        name: string
        current_balance: number // Expecting negative value (debt)
    }
    children?: React.ReactNode
}

export function CollectionDrawer({ customer, children }: CollectionDrawerProps) {
    const [open, setOpen] = useState(false)
    const debt = Math.abs(customer.current_balance) // Display as positive debt

    const form = useForm<CollectionFormValues>({
        resolver: zodResolver(collectionSchema),
        defaultValues: {
            amount: 0, // Suggest full amount? or 0? 
            paymentMode: "cash",
            description: "",
        },
    })

    // Suggest full payment on open
    // useEffect(() => {
    //     if (open) form.setValue("amount", debt);
    // }, [open, debt, form]);

    const onSubmit: SubmitHandler<CollectionFormValues> = async (values) => {
        const formData = new FormData()
        formData.append("customer_id", customer.id)
        formData.append("amount", values.amount.toString())
        formData.append("payment_mode", values.paymentMode)
        if (values.description) formData.append("description", values.description)

        // Manual File Extraction (Simple & Effective)
        const fileInput = document.getElementById('proof_image_input') as HTMLInputElement;
        if (fileInput?.files?.[0]) {
            formData.append("proof_image", fileInput.files[0]);
        }

        const result = await collectPayment(formData)

        if (result.error) {
            toast.error(result.error)
        } else {
            toast.success(`Collected Rs ${values.amount} from ${customer.name}`)
            setOpen(false)
            form.reset()
        }
    }

    return (
        <Drawer open={open} onOpenChange={setOpen}>
            <DrawerTrigger asChild>
                {children ? children : (
                    <Button size="sm" className="bg-emerald-600 hover:bg-emerald-700 text-white w-full">
                        Collect Payment
                    </Button>
                )}
            </DrawerTrigger>
            <DrawerContent>
                <div className="mx-auto w-full max-w-sm">
                    <DrawerHeader>
                        <DrawerTitle>Collect Payment</DrawerTitle>
                        <DrawerDescription>
                            Collecting from <span className="font-bold text-foreground">{customer.name}</span>.<br />
                            Total Due: <span className="font-bold text-rose-600">Rs {debt.toLocaleString()}</span>
                        </DrawerDescription>
                    </DrawerHeader>

                    <Form {...form}>
                        <form onSubmit={form.handleSubmit(onSubmit)} className="p-4 space-y-4">

                            <FormField
                                control={form.control}
                                name="amount"
                                render={({ field }) => (
                                    <FormItem>
                                        <FormLabel>Amount Received</FormLabel>
                                        <FormControl>
                                            <div className="relative">
                                                <span className="absolute left-3 top-2.5 text-muted-foreground font-bold">Rs</span>
                                                <Input
                                                    type="number"
                                                    {...field}
                                                    className="pl-10 text-lg font-bold"
                                                    onChange={e => {
                                                        const val = parseFloat(e.target.value);
                                                        field.onChange(isNaN(val) ? 0 : val);
                                                    }}
                                                />
                                            </div>
                                        </FormControl>
                                        <FormMessage />
                                    </FormItem>
                                )}
                            />

                            <FormField
                                control={form.control}
                                name="paymentMode"
                                render={({ field }) => (
                                    <FormItem className="space-y-3">
                                        <FormLabel>Payment Mode</FormLabel>
                                        <FormControl>
                                            <RadioGroup
                                                onValueChange={field.onChange}
                                                defaultValue={field.value}
                                                className="flex flex-col space-y-1"
                                            >
                                                <FormItem className="flex items-center space-x-3 space-y-0">
                                                    <FormControl>
                                                        <RadioGroupItem value="cash" />
                                                    </FormControl>
                                                    <FormLabel className="font-normal">
                                                        Cash
                                                    </FormLabel>
                                                </FormItem>
                                                <FormItem className="flex items-center space-x-3 space-y-0">
                                                    <FormControl>
                                                        <RadioGroupItem value="cheque" />
                                                    </FormControl>
                                                    <FormLabel className="font-normal">
                                                        Cheque
                                                    </FormLabel>
                                                </FormItem>
                                                <FormItem className="flex items-center space-x-3 space-y-0">
                                                    <FormControl>
                                                        <RadioGroupItem value="bank" />
                                                    </FormControl>
                                                    <FormLabel className="font-normal">
                                                        Online / Bank Transfer
                                                    </FormLabel>
                                                </FormItem>
                                            </RadioGroup>
                                        </FormControl>
                                        <FormMessage />
                                    </FormItem>
                                )}
                            />

                            {/* WARNING FOR NON-CASH */}
                            {form.watch("paymentMode") !== 'cash' && (
                                <div className="bg-yellow-50 text-yellow-800 text-sm p-3 rounded-md border border-yellow-200">
                                    <strong>Pending Verification:</strong> Balance will update only after Admin approval.
                                </div>
                            )}

                            {/* PROOF UPLOAD FOR NON-CASH */}
                            {form.watch("paymentMode") !== 'cash' && (
                                <div className="space-y-2">
                                    <FormLabel>Upload Proof</FormLabel>
                                    <Input
                                        type="file"
                                        accept="image/*"
                                        onChange={(e) => {
                                            const file = e.target.files?.[0];
                                            if (file) {
                                                // We can't strictly bind file input to react-hook-form easily without custom component
                                                // So we'll just handle it in onSubmit via Ref or simpler state, 
                                                // BUT for simplicity in this drawer, let's attach it to a temp state or just read it from the DOM on submit?
                                                // Better: use a state for the file.
                                            }
                                        }}
                                        name="proof_image" // Important for native FormData extraction if we didn't use RHF's values
                                        id="proof_image_input" // ID to query it later
                                    />
                                    <p className="text-xs text-muted-foreground">Image of Cheque or Receipt</p>
                                </div>
                            )}

                            <FormField
                                control={form.control}
                                name="description"
                                render={({ field }) => (
                                    <FormItem>
                                        <FormLabel>Note / Ref #</FormLabel>
                                        <FormControl>
                                            <Input placeholder="Optional" {...field} />
                                        </FormControl>
                                        <FormMessage />
                                    </FormItem>
                                )}
                            />

                            <Button type="submit" className="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold h-12 text-lg mt-4" disabled={form.formState.isSubmitting}>
                                {form.formState.isSubmitting && <Loader2 className="mr-2 h-5 w-5 animate-spin" />}
                                Confirm Collection
                            </Button>
                        </form>
                    </Form>

                    <DrawerFooter>
                        <DrawerClose asChild>
                            <Button variant="outline">Cancel</Button>
                        </DrawerClose>
                    </DrawerFooter>
                </div>
            </DrawerContent>
        </Drawer>
    )
}
</file>

<file path="src/components/recovery/CustomerDebtCard.tsx">
"use client";

import { Card, CardContent } from "@/components/ui/card";
import { MapPin, Phone, ArrowBigRightDash } from "lucide-react";
import { CollectionDrawer } from "@/components/recovery/CollectionDrawer";
import { motion } from "framer-motion";

import { Database } from "@/types/database.types";

interface CustomerDebtCardProps {
    customer: Database['public']['Tables']['customers']['Row'];
}

export function CustomerDebtCard({ customer }: CustomerDebtCardProps) {
    return (
        <motion.div
            whileTap={{ scale: 0.98 }}
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            exit={{ opacity: 0, scale: 0.95 }}
            transition={{ duration: 0.3 }}
        >
            <Card className="group border-0 shadow-sm ring-1 ring-slate-100 hover:ring-brand-blue-200 transition-all duration-300 rounded-xl overflow-hidden bg-white">
                <CardContent className="p-5 relative">
                    {/* Left Border Indicator */}
                    <div className="absolute left-0 top-0 bottom-0 w-1.5 bg-emerald-500 rounded-r-md"></div>

                    <div className="flex justify-between items-start pl-2">

                        {/* Customer Info */}
                        <div className="flex-1 pr-4 min-w-0">
                            <h3 className="font-bold text-slate-800 text-lg leading-tight truncate font-inter">
                                {customer.name}
                            </h3>

                            <div className="flex flex-col space-y-1 mt-2">
                                {customer.address && (
                                    <div className="flex items-start gap-1.5 text-xs text-slate-500">
                                        <MapPin className="w-3.5 h-3.5 mt-0.5 text-slate-400 shrink-0" />
                                        <span className="line-clamp-1 break-words leading-snug">{customer.address}</span>
                                    </div>
                                )}
                                {customer.phone && (
                                    <div className="flex items-center gap-1.5 text-xs text-slate-500">
                                        <Phone className="w-3.5 h-3.5 text-slate-400 shrink-0" />
                                        <span className="font-medium tracking-wide">{customer.phone}</span>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Amount & Action */}
                        <div className="flex flex-col items-end gap-3 shrink-0">
                            <div className="text-right">
                                <div className="font-mono font-bold text-red-600 text-lg">
                                    Rs {Math.abs(customer.current_balance).toLocaleString()}
                                </div>
                                <div className="text-[10px] uppercase font-bold text-red-400/80 tracking-wider text-right">
                                    Due Amount
                                </div>
                            </div>

                            {/* Action Button Wrapper - logic handled by drawer, but styling can be passed if needed */}
                            <div className="w-full">
                                <CollectionDrawer customer={customer}>
                                    <div className="bg-emerald-600 hover:bg-emerald-700 text-white text-xs font-semibold px-4 py-2 rounded-lg flex items-center justify-center gap-1 shadow-emerald-200 shadow-md transition-colors cursor-pointer w-full">
                                        Collect <ArrowBigRightDash className="w-4 h-4" />
                                    </div>
                                </CollectionDrawer>
                            </div>
                        </div>
                    </div>
                </CardContent>
            </Card>
        </motion.div>
    );
}
</file>

<file path="src/components/recovery/EmptyRecoveryState.tsx">
import { CheckCircle2 } from "lucide-react";

export function EmptyRecoveryState() {
    return (
        <div className="flex flex-col items-center justify-center py-20 text-center space-y-6">
            <div className="relative">
                <div className="absolute inset-0 bg-emerald-100 rounded-full blur-xl opacity-50 animate-pulse"></div>
                <div className="h-24 w-24 bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-full flex items-center justify-center relative z-10 shadow-lg ring-4 ring-white">
                    <CheckCircle2 className="w-12 h-12 text-emerald-500" />
                </div>
            </div>

            <div className="space-y-2">
                <h3 className="text-slate-800 font-bold text-xl tracking-tight">All Clear!</h3>
                <p className="text-slate-500 text-sm max-w-[240px] mx-auto leading-relaxed">
                    No pending recoveries at the moment. You've hit zero active debts!
                </p>
            </div>
        </div>
    );
}
</file>

<file path="src/components/recovery/HandoverDialog.tsx">
"use client"

import { useState } from "react"
import { useForm } from "react-hook-form"
import { zodResolver } from "@hookform/resolvers/zod"
import * as z from "zod"
import { Loader2, ArrowRight } from "lucide-react"
import { toast } from "sonner"

import { Button } from "@/components/ui/button"
import {
    Dialog,
    DialogContent,
    DialogDescription,
    DialogFooter,
    DialogHeader,
    DialogTitle,
    DialogTrigger,
} from "@/components/ui/dialog"
import {
    Form,
    FormControl,
    FormField,
    FormItem,
    FormLabel,
    FormMessage,
} from "@/components/ui/form"
import {
    Select,
    SelectContent,
    SelectItem,
    SelectTrigger,
    SelectValue,
} from "@/components/ui/select"
import { Input } from "@/components/ui/input"
import { processRecoveryHandover } from "@/app/actions/recoveryActions"

const formSchema = z.object({
    amount: z.number().min(1, "Amount must be greater than 0"),
    receiverId: z.string().min(1, "Select a receiver"),
})

interface HandoverDialogProps {
    currentBalance: number
    receivers: { id: string; name: string; role: string }[]
}

export function HandoverDialog({ currentBalance, receivers }: HandoverDialogProps) {
    const [open, setOpen] = useState(false)

    const form = useForm<z.infer<typeof formSchema>>({
        resolver: zodResolver(formSchema),
        defaultValues: {
            amount: currentBalance || 0, // Default to full handover (fallsafe)
            receiverId: "",
        },
    })

    async function onSubmit(values: z.infer<typeof formSchema>) {
        const formData = new FormData()
        formData.append("amount", values.amount.toString())
        formData.append("receiver_id", values.receiverId)

        const result = await processRecoveryHandover(formData)

        if (result.error) {
            toast.error(result.error)
        } else {
            toast.success("Handover request sent successfully")
            setOpen(false)
            form.reset({ amount: 0, receiverId: "" }) // Reset 
        }
    }

    return (
        <Dialog open={open} onOpenChange={setOpen}>
            <DialogTrigger asChild>
                <Button className="font-bold bg-white text-emerald-900 border border-emerald-200 hover:bg-emerald-50">
                    Handover Cash <ArrowRight className="ml-2 h-4 w-4" />
                </Button>
            </DialogTrigger>
            <DialogContent className="sm:max-w-[425px]">
                <DialogHeader>
                    <DialogTitle>Cash Handover</DialogTitle>
                    <DialogDescription>
                        Transfer collected cash to an Office Admin.
                    </DialogDescription>
                </DialogHeader>

                <Form {...form}>
                    <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4 pt-2">

                        <div className="p-3 bg-emerald-50 rounded-lg mb-4 text-center">
                            <span className="text-sm text-emerald-800 uppercase font-semibold">Current Wallet Balance</span>
                            <div className="text-3xl font-bold text-emerald-900 mt-1">
                                Rs {currentBalance.toLocaleString()}
                            </div>
                        </div>

                        <FormField
                            control={form.control}
                            name="amount"
                            render={({ field }) => (
                                <FormItem>
                                    <FormLabel>Amount to Handover</FormLabel>
                                    <FormControl>
                                        <Input
                                            type="number"
                                            {...field}
                                            onChange={e => {
                                                const val = e.target.valueAsNumber;
                                                field.onChange(isNaN(val) ? 0 : val);
                                            }}
                                            className="font-bold text-lg"
                                            max={currentBalance} // Native Check
                                        />
                                    </FormControl>
                                    <FormMessage />
                                </FormItem>
                            )}
                        />

                        <FormField
                            control={form.control}
                            name="receiverId"
                            render={({ field }) => (
                                <FormItem>
                                    <FormLabel>Select Receiver (Admin)</FormLabel>
                                    <Select onValueChange={field.onChange} defaultValue={field.value}>
                                        <FormControl>
                                            <SelectTrigger>
                                                <SelectValue placeholder="Who is taking money?" />
                                            </SelectTrigger>
                                        </FormControl>
                                        <SelectContent>
                                            {receivers.map((r) => (
                                                <SelectItem key={r.id} value={r.id}>
                                                    {r.name} ({r.role})
                                                </SelectItem>
                                            ))}
                                        </SelectContent>
                                    </Select>
                                    <FormMessage />
                                </FormItem>
                            )}
                        />

                        <DialogFooter className="mt-4 gap-2">
                            <Button type="button" variant="ghost" onClick={() => setOpen(false)}>Cancel</Button>
                            <Button type="submit" className="bg-emerald-600 hover:bg-emerald-700 font-bold" disabled={form.formState.isSubmitting}>
                                {form.formState.isSubmitting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                                Confirm Handover
                            </Button>
                        </DialogFooter>
                    </form>
                </Form>
            </DialogContent>
        </Dialog>
    )
}
</file>

<file path="src/components/recovery/LogoutButton.tsx">
"use client";

import { createClient } from "@/utils/supabase/client";
import { LogOut } from "lucide-react";
import { useRouter } from "next/navigation";

export function LogoutButton() {
    const router = useRouter();
    const supabase = createClient();

    const handleLogout = async () => {
        await supabase.auth.signOut();
        router.push("/login");
    };

    return (
        <button
            onClick={handleLogout}
            className="h-10 w-10 bg-emerald-800/50 backdrop-blur-md rounded-full flex items-center justify-center border border-emerald-700/50 hover:bg-emerald-800/80 transition-colors cursor-pointer"
            aria-label="Logout"
            title="Logout"
        >
            <LogOut className="w-5 h-5 text-emerald-100" />
        </button>
    );
}
</file>

<file path="src/components/recovery/RecoveryList.tsx">
"use client";

import { motion, AnimatePresence } from "framer-motion";
import { CustomerDebtCard } from "./CustomerDebtCard";
import { EmptyRecoveryState } from "./EmptyRecoveryState";

interface RecoveryListProps {
    customers: any[]; // Replacing dueCustomers type
}

export function RecoveryList({ customers }: RecoveryListProps) {
    if (!customers || customers.length === 0) {
        return <EmptyRecoveryState />;
    }

    return (
        <div className="space-y-4 pb-4">
            <AnimatePresence mode="popLayout">
                {customers.map((customer, index) => (
                    <CustomerDebtCard key={customer.id} customer={customer} />
                ))}
            </AnimatePresence>
        </div>
    );
}
</file>

<file path="src/components/recovery/RecoverySkeleton.tsx">
import { Card, CardContent } from "@/components/ui/card";

export function RecoverySkeleton() {
    return (
        <div className="space-y-4">
            {/* Simulate Stats Widget */}
            <div className="h-24 w-full bg-slate-200 rounded-2xl animate-pulse mb-6" />

            {/* Simulate List Items */}
            {[1, 2, 3, 4].map((i) => (
                <Card key={i} className="border-0 shadow-sm ring-1 ring-slate-100 rounded-xl overflow-hidden">
                    <CardContent className="p-5 pl-7 relative">
                        <div className="flex justify-between items-start mb-3">
                            <div className="space-y-2 w-full">
                                {/* Name */}
                                <div className="h-6 w-1/2 bg-slate-200 rounded animate-pulse" />
                                {/* Details */}
                                <div className="h-4 w-2/3 bg-slate-100 rounded animate-pulse" />
                                <div className="h-4 w-1/3 bg-slate-100 rounded animate-pulse" />
                            </div>
                            {/* Amount */}
                            <div className="h-8 w-20 bg-slate-200 rounded animate-pulse" />
                        </div>
                    </CardContent>
                </Card>
            ))}
        </div>
    );
}
</file>

<file path="src/components/recovery/RecoveryStats.tsx">
import { Target, TrendingUp } from "lucide-react";
import { Card, CardContent } from "@/components/ui/card";

interface RecoveryStatsProps {
    totalDue: number;
    count: number;
}

export function RecoveryStats({ totalDue, count }: RecoveryStatsProps) {
    return (
        <Card className="border-0 bg-gradient-to-r from-emerald-900 to-teal-900 text-white shadow-lg overflow-hidden relative">
            <div className="absolute top-0 right-0 w-32 h-32 bg-white/5 rounded-full blur-2xl -mr-10 -mt-10 pointer-events-none"></div>

            <CardContent className="p-5 flex items-center justify-between relative z-10">
                <div>
                    <p className="text-slate-300 text-xs font-semibold uppercase tracking-wider mb-1 flex items-center gap-1.5">
                        <Target className="w-3.5 h-3.5" />
                        Collection Target
                    </p>
                    <div className="flex items-baseline gap-2">
                        <h2 className="text-2xl font-bold tracking-tight">
                            Rs {totalDue.toLocaleString()}
                        </h2>
                    </div>
                    <p className="text-slate-400 text-[10px] mt-1">
                        Across {count} active cases
                    </p>
                </div>

                <div className="h-10 w-10 bg-white/10 rounded-full flex items-center justify-center ring-1 ring-white/20">
                    <TrendingUp className="w-5 h-5 text-emerald-300" />
                </div>
            </CardContent>
        </Card>
    );
}
</file>

<file path="src/components/ui/alert-dialog.tsx">
"use client"

import * as React from "react"
import * as AlertDialogPrimitive from "@radix-ui/react-alert-dialog"

import { cn } from "@/lib/utils"
import { buttonVariants } from "@/components/ui/button"

const AlertDialog = AlertDialogPrimitive.Root

const AlertDialogTrigger = AlertDialogPrimitive.Trigger

const AlertDialogPortal = AlertDialogPrimitive.Portal

const AlertDialogOverlay = React.forwardRef<
    React.ElementRef<typeof AlertDialogPrimitive.Overlay>,
    React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
    <AlertDialogPrimitive.Overlay
        className={cn(
            "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
            className
        )}
        {...props}
        ref={ref}
    />
))
AlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName

const AlertDialogContent = React.forwardRef<
    React.ElementRef<typeof AlertDialogPrimitive.Content>,
    React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>
>(({ className, ...props }, ref) => (
    <AlertDialogPortal>
        <AlertDialogOverlay />
        <AlertDialogPrimitive.Content
            ref={ref}
            className={cn(
                "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
                className
            )}
            {...props}
        />
    </AlertDialogPortal>
))
AlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName

const AlertDialogHeader = ({
    className,
    ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
    <div
        className={cn(
            "flex flex-col space-y-2 text-center sm:text-left",
            className
        )}
        {...props}
    />
)
AlertDialogHeader.displayName = "AlertDialogHeader"

const AlertDialogFooter = ({
    className,
    ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
    <div
        className={cn(
            "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
            className
        )}
        {...props}
    />
)
AlertDialogFooter.displayName = "AlertDialogFooter"

const AlertDialogTitle = React.forwardRef<
    React.ElementRef<typeof AlertDialogPrimitive.Title>,
    React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>
>(({ className, ...props }, ref) => (
    <AlertDialogPrimitive.Title
        ref={ref}
        className={cn("text-lg font-semibold", className)}
        {...props}
    />
))
AlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName

const AlertDialogDescription = React.forwardRef<
    React.ElementRef<typeof AlertDialogPrimitive.Description>,
    React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>
>(({ className, ...props }, ref) => (
    <AlertDialogPrimitive.Description
        ref={ref}
        className={cn("text-sm text-muted-foreground", className)}
        {...props}
    />
))
AlertDialogDescription.displayName =
    AlertDialogPrimitive.Description.displayName

const AlertDialogAction = React.forwardRef<
    React.ElementRef<typeof AlertDialogPrimitive.Action>,
    React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>
>(({ className, ...props }, ref) => (
    <AlertDialogPrimitive.Action
        ref={ref}
        className={cn(buttonVariants(), className)}
        {...props}
    />
))
AlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName

const AlertDialogCancel = React.forwardRef<
    React.ElementRef<typeof AlertDialogPrimitive.Cancel>,
    React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>
>(({ className, ...props }, ref) => (
    <AlertDialogPrimitive.Cancel
        ref={ref}
        className={cn(
            buttonVariants({ variant: "outline" }),
            "mt-2 sm:mt-0",
            className
        )}
        {...props}
    />
))
AlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName

export {
    AlertDialog,
    AlertDialogPortal,
    AlertDialogOverlay,
    AlertDialogTrigger,
    AlertDialogContent,
    AlertDialogHeader,
    AlertDialogFooter,
    AlertDialogTitle,
    AlertDialogDescription,
    AlertDialogAction,
    AlertDialogCancel,
}
</file>

<file path="src/components/ui/badge.tsx">
import { HTMLAttributes, forwardRef } from "react";
import { cn } from "@/lib/utils";

export interface BadgeProps extends HTMLAttributes<HTMLDivElement> {
    variant?: "default" | "secondary" | "destructive" | "outline" | "success" | "warning";
}

const Badge = forwardRef<HTMLDivElement, BadgeProps>(
    ({ className, variant = "default", ...props }, ref) => {

        const variants = {
            default: "border-transparent bg-primary text-primary-foreground hover:bg-primary/80",
            secondary: "border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",
            destructive: "border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",
            outline: "text-foreground",
            success: "border-transparent bg-emerald-100 text-emerald-700 hover:bg-emerald-200", // Custom for ERP
            warning: "border-transparent bg-amber-100 text-amber-700 hover:bg-amber-200", // Custom for ERP
        };

        return (
            <div
                ref={ref}
                className={cn(
                    "inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",
                    variants[variant],
                    className
                )}
                {...props}
            />
        );
    }
);
Badge.displayName = "Badge";

export { Badge };
</file>

<file path="src/components/ui/button.tsx">
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"
import { Loader2 } from "lucide-react"

import { cn } from "@/lib/utils"

const buttonVariants = cva(
    "inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",
    {
        variants: {
            variant: {
                default: "bg-primary text-primary-foreground hover:bg-primary/90",
                destructive:
                    "bg-destructive text-destructive-foreground hover:bg-destructive/90",
                outline:
                    "border border-input bg-background hover:bg-accent hover:text-accent-foreground",
                secondary:
                    "bg-secondary text-secondary-foreground hover:bg-secondary/80",
                ghost: "hover:bg-accent hover:text-accent-foreground",
                link: "text-primary underline-offset-4 hover:underline",
            },
            size: {
                default: "h-10 px-4 py-2",
                sm: "h-9 rounded-md px-3",
                lg: "h-11 rounded-md px-8",
                icon: "h-10 w-10",
            },
        },
        defaultVariants: {
            variant: "default",
            size: "default",
        },
    }
)

export interface ButtonProps
    extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {
    asChild?: boolean
    isLoading?: boolean
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
    ({ className, variant, size, asChild = false, isLoading, children, ...props }, ref) => {
        const Comp = asChild ? Slot : "button"
        return (
            <Comp
                className={cn(buttonVariants({ variant, size, className }))}
                ref={ref}
                disabled={isLoading || props.disabled}
                {...props}
            >
                {isLoading && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                {children}
            </Comp>
        )
    }
)
Button.displayName = "Button"

export { Button, buttonVariants }
</file>

<file path="src/components/ui/calendar.tsx">
"use client"

import * as React from "react"
import { ChevronLeft, ChevronRight } from "lucide-react"
import { DayPicker } from "react-day-picker"

import { cn } from "@/lib/utils"
import { buttonVariants } from "@/components/ui/button"

export type CalendarProps = React.ComponentProps<typeof DayPicker>

function Calendar({
    className,
    classNames,
    showOutsideDays = true,
    ...props
}: CalendarProps) {
    return (
        <DayPicker
            showOutsideDays={showOutsideDays}
            className={cn("p-3", className)}
            classNames={{
                months: "flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0",
                month: "space-y-4",
                caption: "flex justify-center pt-1 relative items-center",
                caption_label: "text-sm font-medium",
                nav: "space-x-1 flex items-center",
                nav_button: cn(
                    buttonVariants({ variant: "outline" }),
                    "h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100"
                ),
                nav_button_previous: "absolute left-1",
                nav_button_next: "absolute right-1",
                table: "w-full border-collapse space-y-1",
                head_row: "flex",
                head_cell:
                    "text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]",
                row: "flex w-full mt-2",
                cell: "h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20",
                day: cn(
                    buttonVariants({ variant: "ghost" }),
                    "h-9 w-9 p-0 font-normal aria-selected:opacity-100"
                ),
                day_range_end: "day-range-end",
                day_selected:
                    "bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground",
                day_today: "bg-accent text-accent-foreground",
                day_outside:
                    "day-outside text-muted-foreground opacity-50 aria-selected:bg-accent/50 aria-selected:text-muted-foreground aria-selected:opacity-30",
                day_disabled: "text-muted-foreground opacity-50",
                day_range_middle:
                    "aria-selected:bg-accent aria-selected:text-accent-foreground",
                day_hidden: "invisible",
                ...classNames,
            }}
            components={{
                Chevron: ({ ...props }) => <ChevronLeft className="h-4 w-4" />, // Map Chevron to ChevronLeft for v9 (if valid) or just omit to use default
            }}
            {...props}
        />
    )
}
Calendar.displayName = "Calendar"

export { Calendar }
</file>

<file path="src/components/ui/card.tsx">
import { HTMLAttributes, forwardRef } from "react";
import { cn } from "@/lib/utils";

const Card = forwardRef<HTMLDivElement, HTMLAttributes<HTMLDivElement>>(
    ({ className, ...props }, ref) => (
        <div
            ref={ref}
            className={cn("rounded-xl border bg-card text-card-foreground shadow-sm bg-white", className)}
            {...props}
        />
    )
);
Card.displayName = "Card";

const CardHeader = forwardRef<HTMLDivElement, HTMLAttributes<HTMLDivElement>>(
    ({ className, ...props }, ref) => (
        <div
            ref={ref}
            className={cn("flex flex-col space-y-1.5 p-6", className)}
            {...props}
        />
    )
);
CardHeader.displayName = "CardHeader";

const CardTitle = forwardRef<HTMLParagraphElement, HTMLAttributes<HTMLHeadingElement>>(
    ({ className, ...props }, ref) => (
        <h3
            ref={ref}
            className={cn("text-2xl font-semibold leading-none tracking-tight", className)}
            {...props}
        />
    )
);
CardTitle.displayName = "CardTitle";

const CardContent = forwardRef<HTMLDivElement, HTMLAttributes<HTMLDivElement>>(
    ({ className, ...props }, ref) => (
        <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
    )
);
CardContent.displayName = "CardContent";

export { Card, CardHeader, CardTitle, CardContent };
</file>

<file path="src/components/ui/dialog.tsx">
"use client"

import * as React from "react"
import * as DialogPrimitive from "@radix-ui/react-dialog"
import { X } from "lucide-react"

import { cn } from "@/lib/utils"

const Dialog = DialogPrimitive.Root

const DialogTrigger = DialogPrimitive.Trigger

const DialogPortal = DialogPrimitive.Portal

const DialogClose = DialogPrimitive.Close

const DialogOverlay = React.forwardRef<
    React.ElementRef<typeof DialogPrimitive.Overlay>,
    React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
    <DialogPrimitive.Overlay
        ref={ref}
        className={cn(
            "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
            className
        )}
        {...props}
    />
))
DialogOverlay.displayName = DialogPrimitive.Overlay.displayName

const DialogContent = React.forwardRef<
    React.ElementRef<typeof DialogPrimitive.Content>,
    React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>
>(({ className, children, ...props }, ref) => (
    <DialogPortal>
        <DialogOverlay />
        <DialogPrimitive.Content
            ref={ref}
            className={cn(
                "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
                className
            )}
            {...props}
        >
            {children}
            <DialogPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground">
                <X className="h-4 w-4" />
                <span className="sr-only">Close</span>
            </DialogPrimitive.Close>
        </DialogPrimitive.Content>
    </DialogPortal>
))
DialogContent.displayName = DialogPrimitive.Content.displayName

const DialogHeader = ({
    className,
    ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
    <div
        className={cn(
            "flex flex-col space-y-1.5 text-center sm:text-left",
            className
        )}
        {...props}
    />
)
DialogHeader.displayName = "DialogHeader"

const DialogFooter = ({
    className,
    ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
    <div
        className={cn(
            "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
            className
        )}
        {...props}
    />
)
DialogFooter.displayName = "DialogFooter"

const DialogTitle = React.forwardRef<
    React.ElementRef<typeof DialogPrimitive.Title>,
    React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>
>(({ className, ...props }, ref) => (
    <DialogPrimitive.Title
        ref={ref}
        className={cn(
            "text-lg font-semibold leading-none tracking-tight",
            className
        )}
        {...props}
    />
))
DialogTitle.displayName = DialogPrimitive.Title.displayName

const DialogDescription = React.forwardRef<
    React.ElementRef<typeof DialogPrimitive.Description>,
    React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>
>(({ className, ...props }, ref) => (
    <DialogPrimitive.Description
        ref={ref}
        className={cn("text-sm text-muted-foreground", className)}
        {...props}
    />
))
DialogDescription.displayName = DialogPrimitive.Description.displayName

export {
    Dialog,
    DialogPortal,
    DialogOverlay,
    DialogClose,
    DialogTrigger,
    DialogContent,
    DialogHeader,
    DialogFooter,
    DialogTitle,
    DialogDescription,
}
</file>

<file path="src/components/ui/drawer.tsx">
"use client"

import * as React from "react"
import { Drawer as DrawerPrimitive } from "vaul"

import { cn } from "@/lib/utils"

const Drawer = ({
    shouldScaleBackground = true,
    ...props
}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (
    <DrawerPrimitive.Root
        shouldScaleBackground={shouldScaleBackground}
        {...props}
    />
)
Drawer.displayName = "Drawer"

const DrawerTrigger = DrawerPrimitive.Trigger

const DrawerPortal = DrawerPrimitive.Portal

const DrawerClose = DrawerPrimitive.Close

const DrawerOverlay = React.forwardRef<
    React.ElementRef<typeof DrawerPrimitive.Overlay>,
    React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>
>(({ className, ...props }, ref) => (
    <DrawerPrimitive.Overlay
        ref={ref}
        className={cn("fixed inset-0 z-50 bg-black/80", className)}
        {...props}
    />
))
DrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName

const DrawerContent = React.forwardRef<
    React.ElementRef<typeof DrawerPrimitive.Content>,
    React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>
>(({ className, children, ...props }, ref) => (
    <DrawerPortal>
        <DrawerOverlay />
        <DrawerPrimitive.Content
            ref={ref}
            className={cn(
                "fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background",
                className
            )}
            {...props}
        >
            <div className="mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted" />
            {children}
        </DrawerPrimitive.Content>
    </DrawerPortal>
))
DrawerContent.displayName = "DrawerContent"

const DrawerHeader = ({
    className,
    ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
    <div
        className={cn("grid gap-1.5 p-4 text-center sm:text-left", className)}
        {...props}
    />
)
DrawerHeader.displayName = "DrawerHeader"

const DrawerFooter = ({
    className,
    ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
    <div
        className={cn("mt-auto flex flex-col gap-2 p-4", className)}
        {...props}
    />
)
DrawerFooter.displayName = "DrawerFooter"

const DrawerTitle = React.forwardRef<
    React.ElementRef<typeof DrawerPrimitive.Title>,
    React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>
>(({ className, ...props }, ref) => (
    <DrawerPrimitive.Title
        ref={ref}
        className={cn(
            "text-lg font-semibold leading-none tracking-tight",
            className
        )}
        {...props}
    />
))
DrawerTitle.displayName = DrawerPrimitive.Title.displayName

const DrawerDescription = React.forwardRef<
    React.ElementRef<typeof DrawerPrimitive.Description>,
    React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>
>(({ className, ...props }, ref) => (
    <DrawerPrimitive.Description
        ref={ref}
        className={cn("text-sm text-muted-foreground", className)}
        {...props}
    />
))
DrawerDescription.displayName = DrawerPrimitive.Description.displayName

export {
    Drawer,
    DrawerPortal,
    DrawerOverlay,
    DrawerTrigger,
    DrawerClose,
    DrawerContent,
    DrawerHeader,
    DrawerFooter,
    DrawerTitle,
    DrawerDescription,
}
</file>

<file path="src/components/ui/dropdown-menu.tsx">
"use client"

import * as React from "react"
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu"
import { Check, ChevronRight, Circle } from "lucide-react"

import { cn } from "@/lib/utils"

const DropdownMenu = DropdownMenuPrimitive.Root

const DropdownMenuTrigger = DropdownMenuPrimitive.Trigger

const DropdownMenuGroup = DropdownMenuPrimitive.Group

const DropdownMenuPortal = DropdownMenuPrimitive.Portal

const DropdownMenuSub = DropdownMenuPrimitive.Sub

const DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup

const DropdownMenuSubTrigger = React.forwardRef<
    React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,
    React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {
        inset?: boolean
    }
>(({ className, inset, children, ...props }, ref) => (
    <DropdownMenuPrimitive.SubTrigger
        ref={ref}
        className={cn(
            "flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent",
            inset && "pl-8",
            className
        )}
        {...props}
    >
        {children}
        <ChevronRight className="ml-auto h-4 w-4" />
    </DropdownMenuPrimitive.SubTrigger>
))
DropdownMenuSubTrigger.displayName =
    DropdownMenuPrimitive.SubTrigger.displayName

const DropdownMenuSubContent = React.forwardRef<
    React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,
    React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>
>(({ className, ...props }, ref) => (
    <DropdownMenuPrimitive.SubContent
        ref={ref}
        className={cn(
            "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
            className
        )}
        {...props}
    />
))
DropdownMenuSubContent.displayName =
    DropdownMenuPrimitive.SubContent.displayName

const DropdownMenuContent = React.forwardRef<
    React.ElementRef<typeof DropdownMenuPrimitive.Content>,
    React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
    <DropdownMenuPrimitive.Portal>
        <DropdownMenuPrimitive.Content
            ref={ref}
            sideOffset={sideOffset}
            className={cn(
                "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
                className
            )}
            {...props}
        />
    </DropdownMenuPrimitive.Portal>
))
DropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName

const DropdownMenuItem = React.forwardRef<
    React.ElementRef<typeof DropdownMenuPrimitive.Item>,
    React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {
        inset?: boolean
    }
>(({ className, inset, ...props }, ref) => (
    <DropdownMenuPrimitive.Item
        ref={ref}
        className={cn(
            "relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
            inset && "pl-8",
            className
        )}
        {...props}
    />
))
DropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName

const DropdownMenuCheckboxItem = React.forwardRef<
    React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,
    React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>
>(({ className, children, checked, ...props }, ref) => (
    <DropdownMenuPrimitive.CheckboxItem
        ref={ref}
        className={cn(
            "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
            className
        )}
        checked={checked}
        {...props}
    >
        <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
            <DropdownMenuPrimitive.ItemIndicator>
                <Check className="h-4 w-4" />
            </DropdownMenuPrimitive.ItemIndicator>
        </span>
        {children}
    </DropdownMenuPrimitive.CheckboxItem>
))
DropdownMenuCheckboxItem.displayName =
    DropdownMenuPrimitive.CheckboxItem.displayName

const DropdownMenuRadioItem = React.forwardRef<
    React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,
    React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>
>(({ className, children, ...props }, ref) => (
    <DropdownMenuPrimitive.RadioItem
        ref={ref}
        className={cn(
            "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
            className
        )}
        {...props}
    >
        <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
            <DropdownMenuPrimitive.ItemIndicator>
                <Circle className="h-2 w-2 fill-current" />
            </DropdownMenuPrimitive.ItemIndicator>
        </span>
        {children}
    </DropdownMenuPrimitive.RadioItem>
))
DropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName

const DropdownMenuLabel = React.forwardRef<
    React.ElementRef<typeof DropdownMenuPrimitive.Label>,
    React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {
        inset?: boolean
    }
>(({ className, inset, ...props }, ref) => (
    <DropdownMenuPrimitive.Label
        ref={ref}
        className={cn(
            "px-2 py-1.5 text-sm font-semibold",
            inset && "pl-8",
            className
        )}
        {...props}
    />
))
DropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName

const DropdownMenuSeparator = React.forwardRef<
    React.ElementRef<typeof DropdownMenuPrimitive.Separator>,
    React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>
>(({ className, ...props }, ref) => (
    <DropdownMenuPrimitive.Separator
        ref={ref}
        className={cn("-mx-1 my-1 h-px bg-muted", className)}
        {...props}
    />
))
DropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName

const DropdownMenuShortcut = ({
    className,
    ...props
}: React.HTMLAttributes<HTMLSpanElement>) => {
    return (
        <span
            className={cn("ml-auto text-xs tracking-widest opacity-60", className)}
            {...props}
        />
    )
}
DropdownMenuShortcut.displayName = "DropdownMenuShortcut"

export {
    DropdownMenu,
    DropdownMenuTrigger,
    DropdownMenuContent,
    DropdownMenuItem,
    DropdownMenuCheckboxItem,
    DropdownMenuRadioItem,
    DropdownMenuLabel,
    DropdownMenuSeparator,
    DropdownMenuShortcut,
    DropdownMenuGroup,
    DropdownMenuPortal,
    DropdownMenuSub,
    DropdownMenuSubContent,
    DropdownMenuSubTrigger,
    DropdownMenuRadioGroup,
}
</file>

<file path="src/components/ui/form.tsx">
"use client"

import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"
import { Slot } from "@radix-ui/react-slot"
import {
    Controller,
    ControllerProps,
    FieldPath,
    FieldValues,
    FormProvider,
    useFormContext,
} from "react-hook-form"

import { cn } from "@/lib/utils"
import { Label } from "@/components/ui/label"

const Form = FormProvider

type FormFieldContextValue<
    TFieldValues extends FieldValues = FieldValues,
    TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>
> = {
    name: TName
}

const FormFieldContext = React.createContext<FormFieldContextValue>(
    {} as FormFieldContextValue
)

const FormField = <
    TFieldValues extends FieldValues = FieldValues,
    TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>
>({
    ...props
}: ControllerProps<TFieldValues, TName>) => {
    return (
        <FormFieldContext.Provider value={{ name: props.name }}>
            <Controller {...props} />
        </FormFieldContext.Provider>
    )
}

const useFormField = () => {
    const fieldContext = React.useContext(FormFieldContext)
    const itemContext = React.useContext(FormItemContext)
    const { getFieldState, formState } = useFormContext()

    const fieldState = getFieldState(fieldContext.name, formState)

    if (!fieldContext) {
        throw new Error("useFormField should be used within <FormField>")
    }

    const { id } = itemContext

    return {
        id,
        name: fieldContext.name,
        formItemId: `${id}-form-item`,
        formDescriptionId: `${id}-form-item-description`,
        formMessageId: `${id}-form-item-message`,
        ...fieldState,
    }
}

type FormItemContextValue = {
    id: string
}

const FormItemContext = React.createContext<FormItemContextValue>(
    {} as FormItemContextValue
)

const FormItem = React.forwardRef<
    HTMLDivElement,
    React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => {
    const id = React.useId()

    return (
        <FormItemContext.Provider value={{ id }}>
            <div ref={ref} className={cn("space-y-2", className)} {...props} />
        </FormItemContext.Provider>
    )
})
FormItem.displayName = "FormItem"

const FormLabel = React.forwardRef<
    React.ElementRef<typeof LabelPrimitive.Root>,
    React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>
>(({ className, ...props }, ref) => {
    const { error, formItemId } = useFormField()

    return (
        <Label
            ref={ref}
            className={cn(error && "text-destructive", className)}
            htmlFor={formItemId}
            {...props}
        />
    )
})
FormLabel.displayName = "FormLabel"

const FormControl = React.forwardRef<
    React.ElementRef<typeof Slot>,
    React.ComponentPropsWithoutRef<typeof Slot>
>(({ ...props }, ref) => {
    const { error, formItemId, formDescriptionId, formMessageId } = useFormField()

    return (
        <Slot
            ref={ref}
            id={formItemId}
            aria-describedby={
                !error
                    ? `${formDescriptionId}`
                    : `${formDescriptionId} ${formMessageId}`
            }
            aria-invalid={!!error}
            {...props}
        />
    )
})
FormControl.displayName = "FormControl"

const FormDescription = React.forwardRef<
    HTMLParagraphElement,
    React.HTMLAttributes<HTMLParagraphElement>
>(({ className, ...props }, ref) => {
    const { formDescriptionId } = useFormField()

    return (
        <p
            ref={ref}
            id={formDescriptionId}
            className={cn("text-sm text-muted-foreground", className)}
            {...props}
        />
    )
})
FormDescription.displayName = "FormDescription"

const FormMessage = React.forwardRef<
    HTMLParagraphElement,
    React.HTMLAttributes<HTMLParagraphElement>
>(({ className, children, ...props }, ref) => {
    const { error, formMessageId } = useFormField()
    const body = error ? String(error?.message) : children

    if (!body) {
        return null
    }

    return (
        <p
            ref={ref}
            id={formMessageId}
            className={cn("text-sm font-medium text-destructive", className)}
            {...props}
        >
            {body}
        </p>
    )
})
FormMessage.displayName = "FormMessage"

export {
    useFormField,
    Form,
    FormItem,
    FormLabel,
    FormControl,
    FormDescription,
    FormMessage,
    FormField,
}
</file>

<file path="src/components/ui/IconBtn.tsx">
import React from 'react';
import { LucideIcon } from 'lucide-react';
import { clsx } from 'clsx';
import { twMerge } from 'tailwind-merge';

interface IconBtnProps {
  icon: LucideIcon;
  label: string;
  onClick?: () => void;
  color?: 'green' | 'red' | 'blue' | 'slate';
  className?: string; // Allow extra styling if needed
}

export function IconBtn({ icon: Icon, label, onClick, color = 'blue', className }: IconBtnProps) {
  const colorStyles = {
    green: 'bg-green-600 hover:bg-green-700 text-white border-green-800',
    red: 'bg-red-600 hover:bg-red-700 text-white border-red-800',
    blue: 'bg-blue-600 hover:bg-blue-700 text-white border-blue-800',
    slate: 'bg-slate-700 hover:bg-slate-800 text-white border-slate-900',
  };

  return (
    <button
      onClick={onClick}
      className={twMerge(
        'flex flex-col items-center justify-center p-6 rounded-2xl shadow-lg active:scale-95 transition-transform duration-100 border-b-4 h-48 w-full',
        colorStyles[color],
        className
      )}
    >
      <Icon size={64} className="mb-4" />
      <span className="text-2xl font-bold text-center leading-tight">{label}</span>
    </button>
  );
}
</file>

<file path="src/components/ui/input.tsx">
import { InputHTMLAttributes, forwardRef } from "react";
import { cn } from "@/lib/utils";

export interface InputProps extends InputHTMLAttributes<HTMLInputElement> {
    error?: boolean;
}

const Input = forwardRef<HTMLInputElement, InputProps>(
    ({ className, type, error, ...props }, ref) => {
        return (
            <input
                type={type}
                className={cn(
                    "flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50",
                    error && "border-destructive focus-visible:ring-destructive",
                    className
                )}
                ref={ref}
                {...props}
            />
        );
    }
);
Input.displayName = "Input";

export { Input };
</file>

<file path="src/components/ui/label.tsx">
import { LabelHTMLAttributes, forwardRef } from "react";
import { cn } from "@/lib/utils";

const Label = forwardRef<HTMLLabelElement, LabelHTMLAttributes<HTMLLabelElement>>(
    ({ className, ...props }, ref) => (
        <label
            ref={ref}
            className={cn(
                "text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70",
                className
            )}
            {...props}
        />
    )
);
Label.displayName = "Label";

export { Label };
</file>

<file path="src/components/ui/popover.tsx">
"use client"

import * as React from "react"
import * as PopoverPrimitive from "@radix-ui/react-popover"

import { cn } from "@/lib/utils"

const Popover = PopoverPrimitive.Root

const PopoverTrigger = PopoverPrimitive.Trigger

const PopoverContent = React.forwardRef<
    React.ElementRef<typeof PopoverPrimitive.Content>,
    React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>
>(({ className, align = "center", sideOffset = 4, ...props }, ref) => (
    <PopoverPrimitive.Portal>
        <PopoverPrimitive.Content
            ref={ref}
            align={align}
            sideOffset={sideOffset}
            className={cn(
                "z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
                className
            )}
            {...props}
        />
    </PopoverPrimitive.Portal>
))
PopoverContent.displayName = PopoverPrimitive.Content.displayName

export { Popover, PopoverTrigger, PopoverContent }
</file>

<file path="src/components/ui/radio-group.tsx">
"use client"

import * as React from "react"
import * as RadioGroupPrimitive from "@radix-ui/react-radio-group"
import { Circle } from "lucide-react"

import { cn } from "@/lib/utils"

const RadioGroup = React.forwardRef<
    React.ElementRef<typeof RadioGroupPrimitive.Root>,
    React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>
>(({ className, ...props }, ref) => (
    <RadioGroupPrimitive.Root
        className={cn("grid gap-2", className)}
        {...props}
        ref={ref}
    />
))
RadioGroup.displayName = RadioGroupPrimitive.Root.displayName

const RadioGroupItem = React.forwardRef<
    React.ElementRef<typeof RadioGroupPrimitive.Item>,
    React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>
>(({ className, ...props }, ref) => (
    <RadioGroupPrimitive.Item
        ref={ref}
        className={cn(
            "aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
            className
        )}
        {...props}
    >
        <RadioGroupPrimitive.Indicator className="flex items-center justify-center">
            <Circle className="h-2.5 w-2.5 fill-current text-current" />
        </RadioGroupPrimitive.Indicator>
    </RadioGroupPrimitive.Item>
))
RadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName

export { RadioGroup, RadioGroupItem }
</file>

<file path="src/components/ui/select.tsx">
"use client"

import * as React from "react"
import * as SelectPrimitive from "@radix-ui/react-select"
import { Check, ChevronDown, ChevronUp } from "lucide-react"

import { cn } from "@/lib/utils"

const Select = SelectPrimitive.Root

const SelectGroup = SelectPrimitive.Group

const SelectValue = SelectPrimitive.Value

const SelectTrigger = React.forwardRef<
    React.ElementRef<typeof SelectPrimitive.Trigger>,
    React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
    <SelectPrimitive.Trigger
        ref={ref}
        className={cn(
            "flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",
            className
        )}
        {...props}
    >
        {children}
        <SelectPrimitive.Icon asChild>
            <ChevronDown className="h-4 w-4 opacity-50" />
        </SelectPrimitive.Icon>
    </SelectPrimitive.Trigger>
))
SelectTrigger.displayName = SelectPrimitive.Trigger.displayName

const SelectScrollUpButton = React.forwardRef<
    React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,
    React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>
>(({ className, ...props }, ref) => (
    <SelectPrimitive.ScrollUpButton
        ref={ref}
        className={cn(
            "flex cursor-default items-center justify-center py-1",
            className
        )}
        {...props}
    >
        <ChevronUp className="h-4 w-4" />
    </SelectPrimitive.ScrollUpButton>
))
SelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName

const SelectScrollDownButton = React.forwardRef<
    React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,
    React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>
>(({ className, ...props }, ref) => (
    <SelectPrimitive.ScrollDownButton
        ref={ref}
        className={cn(
            "flex cursor-default items-center justify-center py-1",
            className
        )}
        {...props}
    >
        <ChevronDown className="h-4 w-4" />
    </SelectPrimitive.ScrollDownButton>
))
SelectScrollDownButton.displayName =
    SelectPrimitive.ScrollDownButton.displayName

const SelectContent = React.forwardRef<
    React.ElementRef<typeof SelectPrimitive.Content>,
    React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>
>(({ className, children, position = "popper", ...props }, ref) => (
    <SelectPrimitive.Portal>
        <SelectPrimitive.Content
            ref={ref}
            className={cn(
                "relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
                position === "popper" &&
                "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
                className
            )}
            position={position}
            {...props}
        >
            <SelectScrollUpButton />
            <SelectPrimitive.Viewport
                className={cn(
                    "p-1",
                    position === "popper" &&
                    "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"
                )}
            >
                {children}
            </SelectPrimitive.Viewport>
            <SelectScrollDownButton />
        </SelectPrimitive.Content>
    </SelectPrimitive.Portal>
))
SelectContent.displayName = SelectPrimitive.Content.displayName

const SelectLabel = React.forwardRef<
    React.ElementRef<typeof SelectPrimitive.Label>,
    React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>
>(({ className, ...props }, ref) => (
    <SelectPrimitive.Label
        ref={ref}
        className={cn("py-1.5 pl-8 pr-2 text-sm font-semibold", className)}
        {...props}
    />
))
SelectLabel.displayName = SelectPrimitive.Label.displayName

const SelectItem = React.forwardRef<
    React.ElementRef<typeof SelectPrimitive.Item>,
    React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>
>(({ className, children, ...props }, ref) => (
    <SelectPrimitive.Item
        ref={ref}
        className={cn(
            "relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
            className
        )}
        {...props}
    >
        <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
            <SelectPrimitive.ItemIndicator>
                <Check className="h-4 w-4" />
            </SelectPrimitive.ItemIndicator>
        </span>

        <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
    </SelectPrimitive.Item>
))
SelectItem.displayName = SelectPrimitive.Item.displayName

const SelectSeparator = React.forwardRef<
    React.ElementRef<typeof SelectPrimitive.Separator>,
    React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>
>(({ className, ...props }, ref) => (
    <SelectPrimitive.Separator
        ref={ref}
        className={cn("-mx-1 my-1 h-px bg-muted", className)}
        {...props}
    />
))
SelectSeparator.displayName = SelectPrimitive.Separator.displayName

export {
    Select,
    SelectGroup,
    SelectValue,
    SelectTrigger,
    SelectContent,
    SelectLabel,
    SelectItem,
    SelectSeparator,
    SelectScrollUpButton,
    SelectScrollDownButton,
}
</file>

<file path="src/lib/shifts.ts">
/**
 * Logic for Raza Gas Shift Validation
 * Day: 9:00 AM - 9:00 PM (21:00)
 * Night: 9:00 PM (21:00) - 9:00 AM
 */

export function isShiftTime(shift: string): boolean {
    if (!shift || shift === 'Any') return true;

    const now = new Date();
    const hour = now.getHours();

    // DAY SHIFT: 09:00 to 21:00
    if (shift === 'Day') {
        return hour >= 9 && hour < 21;
    }

    // NIGHT SHIFT: 21:00 to 09:00 (Midnight Crossing)
    if (shift === 'Night') {
        // Active if >= 21:00 OR < 09:00
        return hour >= 21 || hour < 9;
    }

    return true; // Default fallthrough
}

export function canBypassShift(role: string): boolean {
    const bypassRoles = ['admin', 'manager', 'cashier', 'owner']; // Lowercase check
    return bypassRoles.includes(role?.toLowerCase());
}
</file>

<file path="src/lib/utils.ts">
import { type ClassValue, clsx } from 'clsx';
import { twMerge } from 'tailwind-merge';

export function cn(...inputs: ClassValue[]) {
    return twMerge(clsx(inputs));
}
</file>

<file path="src/middleware.ts">
import { type NextRequest, NextResponse } from 'next/server'
import { updateSession } from '@/utils/supabase/middleware'

export async function middleware(request: NextRequest) {
    try {
        // 1. Refresh Session (This sets response cookies)
        const { response, user } = await updateSession(request)

        const path = request.nextUrl.pathname

        // 2. Define Public Routes
        // /auth includes callback, confirm, etc.
        const isPublicRoute =
            path.startsWith('/login') ||
            path.startsWith('/signup') ||
            path.startsWith('/auth');

        // 3. User is NOT Logged In
        if (!user) {
            // Allow public routes
            if (isPublicRoute) {
                return response
            }
            // Redirect unrelated paths to login
            // Exclude static files (handled by matcher, but good to be safe)
            const url = request.nextUrl.clone()
            url.pathname = '/login'
            // Preserve original destination for redirectback (optional, not implemented here for simplicity)
            return NextResponse.redirect(url)
        }

        // 4. User IS Logged In
        if (user) {
            const role = user.user_metadata?.role || '';

            // A. Redirect Logged-In Users away from Login/Signup
            if (path.startsWith('/login') || path.startsWith('/signup')) {
                const url = request.nextUrl.clone()
                // Default Redirect based on Role
                if (role === 'super_admin') url.pathname = '/super-admin'
                else if (role === 'driver') url.pathname = '/driver'
                else if (role === 'recovery_agent') url.pathname = '/recovery'
                else url.pathname = '/' // Admin / Manager
                return NextResponse.redirect(url)
            }

            // B. Strict Role Enforcement

            // SUPER ADMIN
            if (role === 'super_admin') {
                // STRICT: Block /admin
                if (path.startsWith('/admin')) {
                    const url = request.nextUrl.clone()
                    url.pathname = '/super-admin'
                    return NextResponse.redirect(url)
                }
                // Redirect Root to Super Admin
                if (path === '/') {
                    const url = request.nextUrl.clone()
                    url.pathname = '/super-admin'
                    return NextResponse.redirect(url)
                }
            }

            // DRIVER
            if (role === 'driver') {
                // Must NOT access /admin or /super-admin or / (Root Dashboard)
                // User Request: "Allow `/driver`. Redirect away from Admin pages."
                if (path.startsWith('/admin') || path.startsWith('/super-admin') || path === '/') {
                    const url = request.nextUrl.clone()
                    url.pathname = '/driver'
                    return NextResponse.redirect(url)
                }
            }

            // RECOVERY AGENT
            if (role === 'recovery_agent') {
                // Must NOT access /admin or /super-admin or /driver
                if (path.startsWith('/admin') || path.startsWith('/super-admin') || path.startsWith('/driver') || path === '/') {
                    const url = request.nextUrl.clone()
                    url.pathname = '/recovery'
                    return NextResponse.redirect(url)
                }
            }

            // ADMIN / SHOP MANAGER
            if (role === 'admin' || role === 'shop_manager') {
                // Block /super-admin
                if (path.startsWith('/super-admin')) {
                    const url = request.nextUrl.clone()
                    url.pathname = '/'
                    return NextResponse.redirect(url)
                }
            }
        }

        return response
    } catch (e) {
        // Prevent sync issues from crashing the site
        console.error("Middleware Error:", e);
        return NextResponse.next({
            request: {
                headers: request.headers,
            },
        });
    }
}

export const config = {
    matcher: [
        /*
         * Match all request paths except for the ones starting with:
         * - _next/static (static files)
         * - _next/image (image optimization files)
         * - favicon.ico (favicon file)
         * Feel free to modify this pattern to include more paths.
         */
        '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
    ],
}
</file>

<file path="src/types/database.types.ts">
export type Json =
    | string
    | number
    | boolean
    | null
    | { [key: string]: Json | undefined }
    | Json[]

export interface Database {
    public: {
        Tables: {
            users: {
                Row: {
                    id: string
                    tenant_id: string
                    email: string
                    name: string | null
                    role: string | null
                    shift: string | null
                    status: string | null
                    created_at: string
                    [key: string]: any
                }
                Insert: {
                    id?: string
                    tenant_id?: string
                    email: string
                    name?: string | null
                    role?: string | null
                    shift?: string | null
                    status?: string | null
                    created_at?: string
                    [key: string]: any
                }
                Update: {
                    id?: string
                    tenant_id?: string
                    email?: string
                    name?: string | null
                    role?: string | null
                    shift?: string | null
                    status?: string | null
                    created_at?: string
                    [key: string]: any
                }
            }
            orders: {
                Row: {
                    id: string
                    tenant_id: string
                    created_at: string
                    [key: string]: any
                }
                Insert: { [key: string]: any }
                Update: { [key: string]: any }
            }
            cylinders: {
                Row: {
                    id: string
                    tenant_id: string
                    created_at: string
                    [key: string]: any
                }
                Insert: { [key: string]: any }
                Update: { [key: string]: any }
            }
            customers: {
                Row: {
                    id: string
                    tenant_id: string
                    created_at: string
                    [key: string]: any
                }
                Insert: { [key: string]: any }
                Update: { [key: string]: any }
            }
            trips: {
                Row: {
                    id: string
                    tenant_id: string
                    created_at: string
                    [key: string]: any
                }
                Insert: { [key: string]: any }
                Update: { [key: string]: any }
            }
            employee_wallets: {
                Row: {
                    id: string
                    tenant_id: string
                    created_at: string
                    [key: string]: any
                }
                Insert: { [key: string]: any }
                Update: { [key: string]: any }
            }
        }
        Views: {
            [_ in never]: never
        }
        Functions: {
            [_ in never]: never
        }
        Enums: {
            [_ in never]: never
        }
    }
}
</file>

<file path="src/utils/supabase/admin.ts">
import { createClient } from "@supabase/supabase-js";

export function createAdminClient() {
    return createClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.SUPABASE_SERVICE_ROLE_KEY!,
        {
            auth: {
                autoRefreshToken: false,
                persistSession: false,
            },
        }
    );
}
</file>

<file path="src/utils/supabase/client.ts">
import { createBrowserClient } from '@supabase/ssr'

export function createClient() {
    return createBrowserClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
    )
}
</file>

<file path="src/utils/supabase/server.ts">
import { createServerClient } from '@supabase/ssr'
import { cookies } from 'next/headers'

export const createClient = async () => {
    const cookieStore = await cookies()

    return createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        {
            cookies: {
                getAll() {
                    return cookieStore.getAll()
                },
                setAll(cookiesToSet) {
                    try {
                        cookiesToSet.forEach(({ name, value, options }) =>
                            cookieStore.set(name, value, options)
                        )
                    } catch {
                        // The `setAll` method was called from a Server Component.
                        // This can be ignored if you have middleware refreshing
                        // user sessions.
                    }
                },
            },
        }
    )
}
</file>

<file path="supabase/migrations/20250101000000_saas_baseline.sql">
-- SAAS BASELINE MIGRATION
-- Enables Multi-Tenancy, RLS, and Auth Isolation

-- 1. ENABLE EXTENSIONS
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

-- 2. CREATE TENANTS TABLE
CREATE TABLE IF NOT EXISTS public.tenants (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    name TEXT NOT NULL,
    subscription_plan TEXT DEFAULT 'free',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc', now())
);

-- 3. INSERT DEFAULT TENANT (Raza Gas)
-- Uses a static UUID to ensure consistency across environments
INSERT INTO public.tenants (name, subscription_plan)
VALUES ('Raza Gas', 'enterprise')
ON CONFLICT (id) DO NOTHING;

-- 4. ADD tenant_id COLUMN TO ALL TABLES
DO $$ 
DECLARE
    t_name text;
    v_tenant_id uuid;
BEGIN 
    -- Get the Raza Gas tenant ID (created above)
    SELECT id INTO v_tenant_id FROM public.tenants WHERE name = 'Raza Gas' LIMIT 1;

    -- List of tables that require multi-tenancy
    FOR t_name IN 
        SELECT unnest(ARRAY['users', 'orders', 'cylinders', 'customers', 'trips', 'employee_wallets', 'handover_logs', 'transactions'])
    LOOP
        -- Add column if it doesn't exist
        IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = t_name AND column_name = 'tenant_id') THEN
            EXECUTE format('ALTER TABLE public.%I ADD COLUMN tenant_id UUID REFERENCES public.tenants(id)', t_name);
            
            -- Backfill existing data to Raza Gas if ID found
            IF v_tenant_id IS NOT NULL THEN
                EXECUTE format('UPDATE public.%I SET tenant_id = %L WHERE tenant_id IS NULL', t_name, v_tenant_id);
            END IF;
            
            -- Enforce NOT NULL after backfill
            EXECUTE format('ALTER TABLE public.%I ALTER COLUMN tenant_id SET NOT NULL', t_name);
        END IF;
    END LOOP;
END $$;

-- 5. RLS BYPASS FUNCTION ("Secret Tunnel")
-- Allows Auth triggers to lookup tenant_id without recursion
CREATE OR REPLACE FUNCTION public.get_my_tenant_id()
RETURNS UUID
LANGUAGE sql
SECURITY DEFINER
SET search_path = public, auth
AS $$
  SELECT tenant_id FROM public.users WHERE id = auth.uid();
$$;

-- 6. ENABLE RLS & APPLY POLICIES
DO $$ 
DECLARE
    t_name text;
BEGIN 
    FOR t_name IN 
        SELECT unnest(ARRAY['users', 'orders', 'cylinders', 'customers', 'trips', 'employee_wallets', 'handover_logs', 'transactions'])
    LOOP
        -- Enable RLS
        EXECUTE format('ALTER TABLE public.%I ENABLE ROW LEVEL SECURITY', t_name);
        
        -- Drop existing policies to prevent conflicts
        EXECUTE format('DROP POLICY IF EXISTS "Tenant Isolation" ON public.%I', t_name);
        
        -- Create Standard Isolation Policy
        -- Users can only see rows where tenant_id matches their own tenant_id
        EXECUTE format('CREATE POLICY "Tenant Isolation" ON public.%I FOR ALL USING (tenant_id = public.get_my_tenant_id())', t_name);
    END LOOP;
END $$;

-- 7. SPECIAL POLICY FOR USERS TABLE (Recursion Fix)
-- Users need to read their own record to find their tenant_id
DROP POLICY IF EXISTS "Tenant Isolation" ON public.users;
CREATE POLICY "Tenant Isolation" ON public.users 
FOR ALL USING (
    id = auth.uid() OR tenant_id = public.get_my_tenant_id()
);

-- 8. TRIGGER: AUTO-ASSIGN TENANT ID ON INSERT
-- Ensures that new rows automatically inherit the user's tenant_id
CREATE OR REPLACE FUNCTION public.set_tenant_id()
RETURNS trigger AS $$
BEGIN
  IF NEW.tenant_id IS NULL THEN
    NEW.tenant_id := public.get_my_tenant_id();
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Apply trigger to all tables
DO $$
DECLARE
    t_name text;
BEGIN
    FOR t_name IN 
        SELECT unnest(ARRAY['orders', 'cylinders', 'customers', 'trips', 'employee_wallets', 'handover_logs', 'transactions'])
    LOOP
        EXECUTE format('DROP TRIGGER IF EXISTS set_tenant_id_trigger ON public.%I', t_name);
        EXECUTE format('CREATE TRIGGER set_tenant_id_trigger BEFORE INSERT ON public.%I FOR EACH ROW EXECUTE PROCEDURE public.set_tenant_id()', t_name);
    END LOOP;
END $$;
</file>

<file path="supabase/migrations/20250101000001_fix_auth_trigger.sql">
-- REPLACES the old handler to strictly enforce tenant_id from metadata
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS trigger AS $$
BEGIN
  INSERT INTO public.users (id, email, name, role, shift, status, tenant_id)
  VALUES (
    new.id, 
    new.email, 
    COALESCE(new.raw_user_meta_data->>'full_name', new.raw_user_meta_data->>'name', 'New Employee'),
    COALESCE(new.raw_user_meta_data->>'role', 'driver'),
    COALESCE(new.raw_user_meta_data->>'shift', 'Day'),
    'active',
    (new.raw_user_meta_data->>'tenant_id')::uuid -- CRITICAL: Reads tenant_id passed by Admin
  );
  RETURN new;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
</file>

<file path="supabase/migrations/20250101000002_fix_cylinder_schema.sql">
-- 1. Remove global uniqueness on serial_number
ALTER TABLE public.cylinders DROP CONSTRAINT IF EXISTS cylinders_serial_number_key;

-- 2. Enforce Tenant-Scoped Uniqueness
-- A serial number must only be unique WITHIN a tenant
ALTER TABLE public.cylinders 
ADD CONSTRAINT cylinders_tenant_serial_unique UNIQUE (tenant_id, serial_number);

-- 3. Add QR Metadata Columns
ALTER TABLE public.cylinders 
ADD COLUMN IF NOT EXISTS qr_code_data TEXT GENERATED ALWAYS AS (
  'tenant=' || tenant_id || '&id=' || serial_number
) STORED;
</file>

<file path="supabase/migrations/20250101000003_secure_tenant_isolation.sql">
-- Secure Helper Function to get Tenant ID without Recursion
-- This function runs with "SECURITY DEFINER" privileges, meaning it bypasses RLS.
-- This allows us to look up the user's tenant_id safely inside an RLS policy.

CREATE OR REPLACE FUNCTION public.get_auth_tenant_id()
RETURNS uuid
LANGUAGE sql
SECURITY DEFINER
AS $$
  SELECT tenant_id FROM public.users WHERE id = auth.uid() LIMIT 1;
$$;

-- Enable RLS
ALTER TABLE public.users ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.cylinders ENABLE ROW LEVEL SECURITY;

-- Reset Policies
DROP POLICY IF EXISTS "Tenant Isolation" ON public.users;
DROP POLICY IF EXISTS "Cylinder Isolation" ON public.cylinders;

-- USERS POLICY
CREATE POLICY "Tenant Isolation" ON public.users
FOR ALL
TO authenticated
USING (
    -- 1. My Tenant matches the row's Tenant
    tenant_id = public.get_auth_tenant_id()
    OR
    -- 2. I am the System Owner
    public.get_auth_tenant_id() = '00000000-0000-0000-0000-000000000000'
);

-- CYLINDERS POLICY
CREATE POLICY "Cylinder Isolation" ON public.cylinders
FOR ALL
TO authenticated
USING (
    tenant_id = public.get_auth_tenant_id()
    OR
    public.get_auth_tenant_id() = '00000000-0000-0000-0000-000000000000'
);
</file>

<file path="supabase/migrations/20250101000004_iron_dome_rls.sql">
-- IRON DOME SECURITY MIGRATION
-- Switches RLS from DB-lookup to stateless JWT Metadata check for critical tables.

-- 1. Customers
DROP POLICY IF EXISTS "Tenant Isolation" ON public.customers;

CREATE POLICY "Tenant Isolation" ON public.customers
FOR ALL
USING (
    tenant_id = (auth.jwt() -> 'app_metadata' ->> 'tenant_id')::uuid
)
WITH CHECK (
    tenant_id = (auth.jwt() -> 'app_metadata' ->> 'tenant_id')::uuid
);

-- 2. Orders
DROP POLICY IF EXISTS "Tenant Isolation" ON public.orders;

CREATE POLICY "Tenant Isolation" ON public.orders
FOR ALL
USING (
    tenant_id = (auth.jwt() -> 'app_metadata' ->> 'tenant_id')::uuid
)
WITH CHECK (
    tenant_id = (auth.jwt() -> 'app_metadata' ->> 'tenant_id')::uuid
);

-- Note: This ensures that even if the Application Code fails to filter (Lock 1),
-- the Database (Lock 2) rejects access if the JWT doesn't match.
-- Code explicitly overrides tenant_id, so the WITH CHECK should pass valid writes.
</file>

<file path="supabase/migrations/20250102000001_add_created_by_to_orders.sql">
-- Add created_by to orders table
ALTER TABLE public.orders
ADD COLUMN IF NOT EXISTS created_by uuid REFERENCES auth.users(id);

-- Ensure RLS allows insert if authenticated
-- (Assuming existing policy allows insert for authenticated users with matching tenant_id)
-- If not, we might need:
-- CREATE POLICY "Enable insert for authenticated users" ON "public"."orders"
-- FOR INSERT TO authenticated
-- WITH CHECK ((select auth.uid()) = created_by);
</file>

<file path="supabase/migrations/20260102000200_reset_sequence.sql">
-- Reset friendly_id sequence to 1
-- Check if sequence exists first to avoid error, or just run it. 
-- Standard naming for serial column friendly_id on table orders is orders_friendly_id_seq

DO $$
BEGIN
    IF EXISTS (SELECT 1 FROM pg_class WHERE relname = 'orders_friendly_id_seq') THEN
        ALTER SEQUENCE orders_friendly_id_seq RESTART WITH 1;
    END IF;
END $$;
</file>

<file path="supabase/migrations/20260103000000_add_handover_flow.sql">
-- Add status and receiver_id to transactions
ALTER TABLE "public"."transactions" ADD COLUMN IF NOT EXISTS "status" text NOT NULL DEFAULT 'completed';
ALTER TABLE "public"."transactions" ADD COLUMN IF NOT EXISTS "receiver_id" uuid REFERENCES "public"."users"("id");

-- Add check constraint for transactions status
ALTER TABLE "public"."transactions" DROP CONSTRAINT IF EXISTS "transactions_status_check";
ALTER TABLE "public"."transactions" ADD CONSTRAINT "transactions_status_check" CHECK (status IN ('pending', 'completed', 'rejected'));

-- Update check constraint for cylinders status to include 'handover_pending'
ALTER TABLE "public"."cylinders" DROP CONSTRAINT IF EXISTS "cylinders_status_check";
ALTER TABLE "public"."cylinders" ADD CONSTRAINT "cylinders_status_check" CHECK (status IN ('full', 'empty', 'missing', 'maintenance', 'at_customer', 'handover_pending'));
</file>

<file path="supabase/migrations/20260104000000_add_org_settings.sql">
-- MIGRATION: Organization Settings
-- Purpose: Centralized configuration for branding, rates, and alerts.

-- 1. Create Table
CREATE TABLE IF NOT EXISTS public.organization_settings (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    tenant_id UUID NOT NULL REFERENCES public.tenants(id) UNIQUE, -- One settings row per tenant
    company_name TEXT DEFAULT 'Ali Gas  ',
    company_address TEXT,
    company_phone TEXT,
    invoice_footer TEXT DEFAULT 'Thank you for your business!',
    default_gas_rate NUMERIC DEFAULT 0,
    low_stock_threshold INTEGER DEFAULT 15,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc', now()),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc', now())
);

-- 2. Enable RLS
ALTER TABLE public.organization_settings ENABLE ROW LEVEL SECURITY;

-- 3. RLS Policies
-- Policy: View Own Settings
CREATE POLICY "View Own Settings" ON public.organization_settings
    FOR SELECT
    USING (tenant_id = public.get_my_tenant_id());

-- Policy: Update Own Settings
CREATE POLICY "Update Own Settings" ON public.organization_settings
    FOR UPDATE
    USING (tenant_id = public.get_my_tenant_id());

-- Policy: Insert Own Settings (Usually handled by trigger, but allow if needed for initialization)
CREATE POLICY "Insert Own Settings" ON public.organization_settings
    FOR INSERT
    WITH CHECK (tenant_id = public.get_my_tenant_id());


-- 4. Auto-Seed Trigger (When a new Tenant is created)
CREATE OR REPLACE FUNCTION public.seed_org_settings()
RETURNS trigger AS $$
BEGIN
  INSERT INTO public.organization_settings (tenant_id, company_name)
  VALUES (NEW.id, 'My Organization')
  ON CONFLICT DO NOTHING;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Trigger on Tenants table
DROP TRIGGER IF EXISTS seed_org_settings_trigger ON public.tenants;
CREATE TRIGGER seed_org_settings_trigger
  AFTER INSERT ON public.tenants
  FOR EACH ROW EXECUTE PROCEDURE public.seed_org_settings();

-- 5. Backfill Existing Tenants
INSERT INTO public.organization_settings (tenant_id, company_name)
SELECT id, name FROM public.tenants
ON CONFLICT (tenant_id) DO NOTHING;
</file>

<file path="supabase/migrations/20260104000001_customer_ledger_upgrade.sql">
-- MIGRATION: Customer Ledger Upgrade
-- 1. Add Credit Limit
ALTER TABLE public.customers 
ADD COLUMN IF NOT EXISTS credit_limit INTEGER DEFAULT 50000;

-- 2. Self-Healing Script: Create 'Opening Balance' for customers with disconnected balances
DO $$
DECLARE
    cust RECORD;
    tx_count INTEGER;
BEGIN
    FOR cust IN 
        SELECT id, tenant_id, current_balance, name 
        FROM public.customers 
        WHERE current_balance != 0
    LOOP
        -- Check if transaction history exists
        SELECT COUNT(*) INTO tx_count 
        FROM public.transactions 
        WHERE customer_id = cust.id;

        -- If history is empty but balance exists, this is a disconnected state.
        IF tx_count = 0 THEN
            INSERT INTO public.transactions (
                tenant_id,
                customer_id,
                amount,
                type,
                description,
                created_at
            ) VALUES (
                cust.tenant_id,
                cust.id,
                cust.current_balance, -- Preserves sign (Positive = Debt, Negative = Advance)
                'opening_balance',
                'System Correction / Opening Balance',
                NOW()
            );
            RAISE NOTICE 'Fixed disconnected ledger for customer: % (Balance: %)', cust.name, cust.current_balance;
        END IF;
    END LOOP;
END $$;
</file>

<file path="supabase/migrations/20260104000002_customer_dashboard_upgrade.sql">
-- Upgrade: Customer Dashboard Features
-- Adds is_active and last_order_at columns
-- Safe migration: IDEMPOTENT

-- 1. Add is_active column
DO $$ 
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'customers' AND column_name = 'is_active') THEN
        ALTER TABLE customers ADD COLUMN is_active BOOLEAN DEFAULT TRUE;
    END IF;
END $$;

-- 2. Add last_order_at column
DO $$ 
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'customers' AND column_name = 'last_order_at') THEN
        ALTER TABLE customers ADD COLUMN last_order_at TIMESTAMPTZ;
    END IF;
END $$;
</file>

<file path="supabase/migrations/20260105_auto_update_last_order.sql">
-- Trigger to automatically update customer.last_order_at when an order is created

CREATE OR REPLACE FUNCTION public.update_last_order_timestamp()
RETURNS TRIGGER AS $$
BEGIN
    UPDATE public.customers
    SET last_order_at = NEW.created_at
    WHERE id = NEW.customer_id;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Drop trigger if exists to prevent duplication error on re-runs
DROP TRIGGER IF EXISTS on_order_created_update_customer ON public.orders;

CREATE TRIGGER on_order_created_update_customer
AFTER INSERT ON public.orders
FOR EACH ROW
EXECUTE FUNCTION public.update_last_order_timestamp();
</file>

<file path="supabase/migrations/20260105_handover_rpc.sql">
-- Function to handle Handover Requests Atomically
-- Prevents "Zombie Cylinders" where cylinders update but transaction fails.

CREATE OR REPLACE FUNCTION submit_handover_request(
    p_driver_id UUID,
    p_receiver_id UUID,
    p_tenant_id UUID,
    p_amount NUMERIC,
    p_serial_numbers TEXT[]
)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER -- Runs with privileges of creator (admin) to ensure writes happen
AS $$
DECLARE
    v_txn_id UUID;
    v_updated_count INT;
BEGIN
    -- 1. Validate Receiver
    IF p_receiver_id IS NULL THEN
        RETURN jsonb_build_object('success', false, 'error', 'Receiver is required');
    END IF;

    -- 2. Update Cylinder Status (Lock Assets)
    IF array_length(p_serial_numbers, 1) > 0 THEN
        UPDATE public.cylinders
        SET 
            status = 'handover_pending',
            updated_at = NOW()
        WHERE 
            serial_number = ANY(p_serial_numbers) 
            AND tenant_id = p_tenant_id 
            AND current_holder_id = p_driver_id;
            
        GET DIAGNOSTICS v_updated_count = ROW_COUNT;
    END IF;

    -- 3. Create Transaction Record
    INSERT INTO public.transactions (
        tenant_id, 
        user_id, 
        receiver_id, 
        type, 
        status, 
        amount, 
        description, 
        payment_method, 
        created_at
    )
    VALUES (
        p_tenant_id,
        p_driver_id,
        p_receiver_id,
        'handover_request',
        'pending',
        p_amount,
        'Handover Request: Rs ' || p_amount || ' + ' || COALESCE(array_length(p_serial_numbers, 1), 0) || ' Cylinders',
        'cash',
        NOW()
    )
    RETURNING id INTO v_txn_id;

    -- 4. Return Success
    RETURN jsonb_build_object(
        'success', true, 
        'transaction_id', v_txn_id, 
        'cylinders_updated', v_updated_count
    );

EXCEPTION WHEN OTHERS THEN
    -- Rollback is automatic in PL/PGSQL functions on error, but we return explicit error
    RETURN jsonb_build_object('success', false, 'error', SQLERRM);
END;
$$;
</file>

<file path="supabase/migrations/20260109120000_fix_expenses_fk.sql">
-- Fix missing Foreign Key on expenses.user_id

DO $$
BEGIN
    -- Check if constraint exists, if not add it
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.table_constraints 
        WHERE constraint_name = 'expenses_user_id_fkey'
    ) THEN
        ALTER TABLE public.expenses
        ADD CONSTRAINT expenses_user_id_fkey
        FOREIGN KEY (user_id)
        REFERENCES public.users(id)
        ON UPDATE CASCADE
        ON DELETE CASCADE; -- If user is deleted, expense records might as well be deleted or set to null. Driver app usually implies tight coupling.
    END IF;
END $$;
</file>

<file path="supabase/migrations/20260115000000_remove_wallet_deduction.sql">
-- Migration: Remove Wallet Deduction from Expense Approval (CORRECTED)
-- Objective: Approve expenses for record-keeping ONLY. Do NOT deduct from Driver Wallet.
-- Fixes: Removes reference to non-existent 'updated_at', uses 'approved_at' and 'approved_by'.

CREATE OR REPLACE FUNCTION public.approve_expense(p_expense_id UUID, p_admin_id UUID)
RETURNS json
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_expense public.expenses%ROWTYPE;
BEGIN
    -- 1. Verify Expense Exists
    SELECT * INTO v_expense FROM public.expenses WHERE id = p_expense_id;
    
    IF NOT FOUND THEN
        RETURN json_build_object('success', false, 'message', 'Expense not found');
    END IF;

    -- 2. Verify Status (Idempotency)
    IF v_expense.status = 'approved' THEN
        RETURN json_build_object('success', false, 'message', 'Expense already approved');
    END IF;

    -- 3. Update Status and Audit Fields
    -- Using 'approved_at' and 'approved_by' as confirmed by schema diagnosis.
    UPDATE public.expenses
    SET status = 'approved',
        approved_at = NOW(),
        approved_by = p_admin_id
    WHERE id = p_expense_id;

    -- 4. LOGIC REMOVED:
    -- UPDATE public.employee_wallets ... SET balance = balance - amount ... 
    -- ^ The above logic is intentionally OMITTED to fulfill the requirement.

    RETURN json_build_object('success', true);
EXCEPTION WHEN OTHERS THEN
    RETURN json_build_object('success', false, 'message', SQLERRM);
END;
$$;
</file>

<file path="supabase/migrations/20260117000000_company_treasury.sql">
-- Migration: Company Treasury & Ledger
-- Date: 2026-01-17
-- Description: Adds company_ledger table and updates handover approval to track cash.

-- 1. Create Company Ledger Table
CREATE TABLE IF NOT EXISTS public.company_ledger (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    tenant_id UUID NOT NULL REFERENCES public.tenants(id),
    amount NUMERIC NOT NULL, -- Positive = Inflow, Negative = Outflow
    transaction_type TEXT NOT NULL CHECK (transaction_type IN ('driver_deposit', 'vendor_payment', 'owner_withdrawal', 'adjustment')),
    description TEXT,
    reference_id UUID, -- Link to transactions.id (e.g. the handover transaction)
    admin_id UUID REFERENCES public.users(id), -- Who performed the action
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc', now())
);

-- 2. Enable RLS
ALTER TABLE public.company_ledger ENABLE ROW LEVEL SECURITY;

-- 3. RLS Policy: Tenant Isolation
DROP POLICY IF EXISTS "Tenant Isolation" ON public.company_ledger;
CREATE POLICY "Tenant Isolation" ON public.company_ledger
    FOR ALL USING (tenant_id = public.get_my_tenant_id());

-- 4. Trigger: Auto-assign Tenant ID
DROP TRIGGER IF EXISTS set_tenant_id_trigger ON public.company_ledger;
CREATE TRIGGER set_tenant_id_trigger
    BEFORE INSERT ON public.company_ledger
    FOR EACH ROW
    EXECUTE PROCEDURE public.set_tenant_id();


-- 5. UPGRADE: Approve Driver Handover RPC
-- This function now includes Step 4: Ledger Entry
CREATE OR REPLACE FUNCTION public.approve_driver_handover(
    p_transaction_id UUID,
    p_admin_user_id UUID
)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_txn RECORD;
    v_driver_name TEXT;
    v_cylinders_count INT;
BEGIN
    -- 1. Fetch Transaction & Verify
    SELECT * INTO v_txn FROM public.transactions WHERE id = p_transaction_id;

    IF NOT FOUND THEN
        RETURN jsonb_build_object('success', false, 'message', 'Transaction not found');
    END IF;

    IF v_txn.status = 'completed' THEN
        RETURN jsonb_build_object('success', false, 'message', 'Transaction already completed');
    END IF;

    IF v_txn.type != 'handover_request' THEN
        RETURN jsonb_build_object('success', false, 'message', 'Invalid transaction type');
    END IF;

    -- Fetch Driver Name for Description
    SELECT name INTO v_driver_name FROM public.users WHERE id = v_txn.user_id;

    -- 2. ASSET HANDOVER: Move Cylinders (Handover Pending -> Warehouse)
    -- We assume these are EMPTIES being returned.
    WITH moved_cylinders AS (
        UPDATE public.cylinders
        SET 
            status = 'empty',
            current_location_type = 'warehouse',
            current_holder_id = NULL, -- Returned to stock
            updated_at = NOW()
        WHERE 
            status = 'handover_pending' 
            AND current_holder_id = v_txn.user_id
            AND tenant_id = v_txn.tenant_id
        RETURNING id
    )
    SELECT count(*) INTO v_cylinders_count FROM moved_cylinders;

    -- 3. FINANCIAL: Deduct from Driver Wallet
    IF v_txn.amount > 0 THEN
        UPDATE public.employee_wallets
        SET 
            balance = balance - v_txn.amount,
            updated_at = NOW()
        WHERE user_id = v_txn.user_id;
    END IF;

    -- 4. [NEW] TREASURY: Add to Company Ledger
    IF v_txn.amount > 0 THEN
        INSERT INTO public.company_ledger (
            tenant_id,
            amount,
            transaction_type,
            description,
            reference_id,
            admin_id
        ) VALUES (
            v_txn.tenant_id,
            v_txn.amount,
            'driver_deposit',
            'Handover from ' || COALESCE(v_driver_name, 'Driver'),
            v_txn.id,
            p_admin_user_id
        );
    END IF;

    -- 5. COMPLETE TRANSACTION
    UPDATE public.transactions
    SET 
        status = 'completed',
        receiver_id = p_admin_user_id -- Stamp the approver
    WHERE id = p_transaction_id;

    RETURN jsonb_build_object(
        'success', true, 
        'message', 'Handover Approved. Cash: ' || v_txn.amount || ', Cylinders: ' || v_cylinders_count
    );

EXCEPTION WHEN OTHERS THEN
    RETURN jsonb_build_object('success', false, 'message', SQLERRM);
END;
$$;
</file>

<file path="supabase/migrations/20260117100000_expand_ledger.sql">
-- Migration: Expand Company Ledger
-- Date: 2026-01-17 22:00
-- Description: Adds category column and expands transaction_type constraint to allow generic credit/debit.

-- 1. Add Category Column (for granular description/grouping)
ALTER TABLE public.company_ledger 
ADD COLUMN IF NOT EXISTS category TEXT;

-- 2. Drop Strict Constraint
ALTER TABLE public.company_ledger 
DROP CONSTRAINT IF EXISTS company_ledger_transaction_type_check;

-- 3. Add New Flexible Constraint
-- We keep legacy types to avoid breaking existing data, but add 'credit' and 'debit' for manual entries.
ALTER TABLE public.company_ledger 
ADD CONSTRAINT company_ledger_transaction_type_check 
CHECK (transaction_type IN (
    'credit',             -- Generic Money In
    'debit',              -- Generic Money Out
    'driver_deposit',     -- Legacy / Specific
    'vendor_payment',     -- Legacy / Specific
    'owner_withdrawal',   -- Legacy / Specific
    'adjustment'          -- Legacy / Specific
));
</file>

<file path="supabase/migrations/20260118110000_fix_handle_new_user.sql">
CREATE OR REPLACE FUNCTION handle_new_user()
RETURNS TRIGGER AS $$
DECLARE
    v_public_user_id UUID;
    v_tenant_id UUID;
    v_full_name TEXT;
    v_role TEXT;
BEGIN
    -- Extract Metadata safely
    v_tenant_id := (new.raw_user_meta_data->>'tenant_id')::uuid;
    v_full_name := COALESCE(new.raw_user_meta_data->>'full_name', new.raw_user_meta_data->>'name', 'New User');
    v_role := COALESCE(new.raw_user_meta_data->>'role', 'driver');

    -- 1. Insert/Link Public User
    -- We try to find a public user by EMAIL. 
    -- If found, we UPDATE the auth_id to link them.
    -- If not found, we INSERT a new one.
    INSERT INTO public.users (
        email, 
        name, 
        role, 
        tenant_id, 
        auth_id,
        phone_number -- Sync phone if available
    )
    VALUES (
        new.email,
        v_full_name,
        v_role, -- Assuming specific cast not needed if column is text, else ::user_role
        v_tenant_id,
        new.id,
        new.raw_user_meta_data->>'phone_number'
    )
    ON CONFLICT (email) DO UPDATE SET 
        auth_id = new.id,          -- CRITICAL: Repair the link
        updated_at = NOW()
    RETURNING id INTO v_public_user_id;

    -- 2. Create Profile
    -- Uses the v_public_user_id (which satisfies the FK to public.users)
    INSERT INTO public.profiles (id, full_name, role, tenant_id, phone_number)
    VALUES (
        v_public_user_id,
        v_full_name,
        v_role,
        v_tenant_id,
        new.raw_user_meta_data->>'phone_number'
    )
    ON CONFLICT (id) DO NOTHING; 
    -- If profile exists, we assume it's fine.

    -- 3. Create Wallet
    -- Also uses v_public_user_id
    INSERT INTO public.employee_wallets (user_id, balance, tenant_id)
    VALUES (
        v_public_user_id,
        0,
        v_tenant_id
    )
    ON CONFLICT (user_id) DO NOTHING;

    RETURN new;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
</file>

<file path="supabase/migrations/20260118120000_verify_payment_rpc.sql">
-- Function to atomically verify a payment logic
-- Handles: Transaction Status Update, Customer Balance Credit, Company Ledger Entry
create or replace function verify_payment_transaction(
  p_transaction_id uuid,
  p_admin_id uuid
)
returns json
language plpgsql
security definer
as $$
declare
  v_txn record;
  v_customer_exists boolean;
begin
  -- 1. Fetch Transaction with Lock
  select * into v_txn 
  from transactions 
  where id = p_transaction_id 
  for update;

  if not found then
    return json_build_object('success', false, 'message', 'Transaction not found');
  end if;

  if v_txn.status != 'pending_verification' then
    return json_build_object('success', false, 'message', 'Transaction is not pending verification');
  end if;

  -- 2. Update Transaction Status
  update transactions 
  set 
    status = 'verified',
    updated_at = now()
  where id = p_transaction_id;

  -- 3. Update Customer Balance (Credit/Reduce Debt)
  -- Check if customer exists first to be safe
  select exists(select 1 from customers where id = v_txn.user_id) into v_customer_exists;
  
  if v_customer_exists then
    update customers 
    set current_balance = current_balance - abs(v_txn.amount)
    where id = v_txn.user_id;
  end if;

  -- 4. Insert into Company Ledger
  insert into company_ledger (
    tenant_id,
    amount,
    transaction_type,
    category,
    description,
    admin_id,
    created_at
  ) values (
    v_txn.tenant_id,
    abs(v_txn.amount),
    'credit',
    'customer_payment_verified',
    'Verified ' || v_txn.payment_method || ' Payment (Txn #' || substring(p_transaction_id::text, 1, 8) || ')',
    p_admin_id,
    now()
  );

  return json_build_object('success', true, 'message', 'Payment verified successfully');

exception when others then
  -- Automatic Rollback happens here
  return json_build_object('success', false, 'message', 'Database Error: ' || SQLERRM);
end;
$$;
</file>

<file path="supabase/migrations/20260127000000_fix_users_rls.sql">
-- Migration: Fix Invisible Staff Issue (RLS Recursion)
-- Date: 2026-01-27
-- Description: 
-- 1. Drops conflicting/permissive policies on public.users.
-- 2. Creates a strict "Tenant Isolation" policy that breaks RLS recursion by explicitly allowing self-access.

-- 1. Cleanup Conflicting Policies
DROP POLICY IF EXISTS "Allow auth select all" ON public.users;
DROP POLICY IF EXISTS "Allow authenticated select" ON public.users;
DROP POLICY IF EXISTS "Enable read for all users" ON public.users;
DROP POLICY IF EXISTS "Tenant Isolation" ON public.users;

-- 2. Create Corrected Policy
-- Logic: 
-- A. User can ALWAYS see their own record (id = auth.uid()) -> Resolves recursion
-- B. User can see other users in their tenant -> (tenant_id = public.get_my_tenant_id())
CREATE POLICY "Tenant Isolation" ON public.users 
FOR ALL USING (
    id = auth.uid() 
    OR 
    tenant_id = public.get_my_tenant_id()
);
</file>

<file path="supabase/migrations/20260128000000_audit_performance_fixes.sql">
-- Migration: Audit Performance Fixes
-- Date: 2026-01-28
-- Description: 
-- 1. Adds missing indexes to tenant_id columns (CRITICAL for RLS performance).
-- 2. Adds missing indexes to Foreign Keys (orders.created_by, etc.).
-- 3. Marks RLS helper functions as STABLE to reduce function call overhead.

-- 1. INDEX tenant_id ON ALL TABLES
-- These are used in every RLS policy, so they must be indexed.
CREATE INDEX IF NOT EXISTS idx_users_tenant_id ON public.users(tenant_id);
CREATE INDEX IF NOT EXISTS idx_orders_tenant_id ON public.orders(tenant_id);
CREATE INDEX IF NOT EXISTS idx_cylinders_tenant_id ON public.cylinders(tenant_id);
CREATE INDEX IF NOT EXISTS idx_customers_tenant_id ON public.customers(tenant_id);
CREATE INDEX IF NOT EXISTS idx_trips_tenant_id ON public.trips(tenant_id);
CREATE INDEX IF NOT EXISTS idx_employee_wallets_tenant_id ON public.employee_wallets(tenant_id);
CREATE INDEX IF NOT EXISTS idx_handover_logs_tenant_id ON public.handover_logs(tenant_id);
CREATE INDEX IF NOT EXISTS idx_transactions_tenant_id ON public.transactions(tenant_id);
CREATE INDEX IF NOT EXISTS idx_company_ledger_tenant_id ON public.company_ledger(tenant_id);
CREATE INDEX IF NOT EXISTS idx_expenses_tenant_id ON public.expenses(tenant_id);
CREATE INDEX IF NOT EXISTS idx_profiles_tenant_id ON public.profiles(tenant_id);

-- 2. INDEX OTHER FOREIGN KEYS
-- Postgres does not index FKs automatically.
CREATE INDEX IF NOT EXISTS idx_orders_created_by ON public.orders(created_by);
CREATE INDEX IF NOT EXISTS idx_transactions_receiver_id ON public.transactions(receiver_id);
CREATE INDEX IF NOT EXISTS idx_company_ledger_admin_id ON public.company_ledger(admin_id);
CREATE INDEX IF NOT EXISTS idx_expenses_user_id ON public.expenses(user_id);

-- 3. OPTIMIZE RLS HELPER FUNCTIONS
-- Mark them as STABLE so Postgres knows they don't change within a statement.
-- This allows the optimizer to call them once per query instead of once per row!

-- Re-declaring get_my_tenant_id with STABLE
CREATE OR REPLACE FUNCTION public.get_my_tenant_id()
RETURNS UUID
LANGUAGE sql
STABLE
AS $$
  SELECT tenant_id FROM public.users WHERE id = (current_setting('request.jwt.claim.sub', true)::uuid);
$$;

-- Re-declaring get_auth_tenant_id with STABLE
-- (Used in some older policies, keeping it consistent)
CREATE OR REPLACE FUNCTION public.get_auth_tenant_id()
RETURNS uuid
LANGUAGE sql
SECURITY DEFINER
STABLE
AS $$
  SELECT tenant_id FROM public.users WHERE id = auth.uid() LIMIT 1;
$$;
</file>

<file path="supabase/migrations/20260128000001_fix_multi_tenancy_critical.sql">
-- Migration: Fix Critical Multi-Tenancy Failure (RLS Recursion)
-- Date: 2026-01-28
-- Description: 
-- 1. Redefines public.get_my_tenant_id() with SECURITY DEFINER to strictly bypass RLS during tenant lookup.
-- 2. Resets public.users RLS policies to a single, strict "Tenant Isolation" policy.

-- 1. Fix the Function (Break Recursion)
CREATE OR REPLACE FUNCTION public.get_my_tenant_id()
RETURNS UUID
LANGUAGE sql
SECURITY DEFINER -- CRITICAL: Runs with owner permissions to bypass RLS
SET search_path = public, auth
STABLE
AS $$
  SELECT tenant_id FROM public.users WHERE id = auth.uid();
$$;

-- 2. Cleanup ANY existing confused policies
DROP POLICY IF EXISTS "Allow auth select all" ON public.users;
DROP POLICY IF EXISTS "Allow authenticated select" ON public.users;
DROP POLICY IF EXISTS "Enable read for all users" ON public.users;
DROP POLICY IF EXISTS "Tenant Isolation" ON public.users;

-- 3. Apply Strict Tenant Isolation
-- Logic:
-- A. Users must ALWAYS be able to see their own record (id = auth.uid()) to bootstrap.
-- B. Once authenticated, they can see other users in their tenant.
-- Note: get_my_tenant_id() now works safely inside this policy because it is SECURITY DEFINER.
CREATE POLICY "Tenant Isolation" ON public.users 
FOR ALL USING (
    id = auth.uid() 
    OR 
    tenant_id = public.get_my_tenant_id()
);
</file>

<file path="supabase/migrations/20260128000002_fix_profiles_rls.sql">
-- Migration: Secure Profiles & Sync Tenant Data
-- Date: 2026-01-28
-- Description: 
-- 1. Syncs tenant_id from users to profiles to ensure data integrity.
-- 2. Enables RLS on public.profiles.
-- 3. Applies strict "Tenant Isolation" policy to profiles using the secure get_my_tenant_id() function.

-- 1. Sync Data (Fix broken relationships)
UPDATE public.profiles p
SET tenant_id = u.tenant_id
FROM public.users u
WHERE p.id = u.id
AND (p.tenant_id IS DISTINCT FROM u.tenant_id);

-- 2. Enable RLS
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;

-- 3. Cleanup Old Policies (Safety Measure)
DROP POLICY IF EXISTS "Public profiles are viewable by everyone" ON public.profiles;
DROP POLICY IF EXISTS "Users can insert their own profile" ON public.profiles;
DROP POLICY IF EXISTS "Users can update own profile" ON public.profiles;
DROP POLICY IF EXISTS "Tenant Isolation" ON public.profiles;

-- 4. Create Strict Tenant Policy
-- Logic:
-- A. User can see their own profile.
-- B. User can see profiles of other users in the SAME tenant.
CREATE POLICY "Tenant Isolation" ON public.profiles
FOR ALL USING (
  id = auth.uid()
  OR
  tenant_id = public.get_my_tenant_id()
);

-- 5. Grant Access (Ensure roles have permission)
GRANT SELECT, INSERT, UPDATE ON public.profiles TO authenticated;
GRANT SELECT ON public.profiles TO service_role;
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts"
  ],
  "exclude": ["node_modules"]
}
</file>

<file path="src/app/(dashboard)/admin/layout.tsx">
import { AdminSidebar } from "@/components/admin/AdminSidebar";
import { createClient } from "@/utils/supabase/server";
import { redirect } from "next/navigation";

export default async function AdminLayout({
    children,
}: {
    children: React.ReactNode;
}) {
    const supabase = await createClient();

    // 1. Verify Auth
    const { data: { user }, error: authError } = await supabase.auth.getUser();
    if (authError || !user) {
        redirect('/login');
    }

    // 2. Verify Role (Metadata Strategy)
    // Using metadata is faster and avoids RLS/DB loops.
    // Syncs with middleware logic.
    const role = user.user_metadata?.role || user.app_metadata?.role;

    const allowedRoles = ['admin', 'shop_manager', 'finance', 'super_admin'];

    if (!role || !allowedRoles.includes(role)) {
        // Redirect based on role, or kick out
        if (role === 'recovery_agent') redirect('/recovery');
        if (role === 'driver') redirect('/driver');

        // If unknown role, send to login (which will likely loop if we are not careful, 
        // but middleware handles logged in users. 
        // If we are here, we are logged in but have wrong role for this page.)
        // Better to redirect to root to let page.tsx sort it out, or specific error page.
        // But for now, let's assume if it's not allowed, we shouldn't be here.

        // If we redirect to /login, middleware will redirect to / (if logged in).
        // If / redirects to /admin, and we block it here... LOOP.

        // Break the loop:
        // If role is missing/invalid, force logout or show 403.
        // But for safely, let's redirect to /login and rely on middleware to route correct roles.
        // The issue was 'finance'/'shop_manager' getting blocked here.
        redirect('/login');
    }

    return (
        <div className="flex min-h-screen bg-slate-50/50">
            <AdminSidebar />
            <main className="flex-1 overflow-y-auto h-screen">
                <div className="p-8 max-w-7xl mx-auto">
                    {children}
                </div>
            </main>
        </div>
    );
}
</file>

<file path="src/app/actions/adminActions.ts">
"use server";

import { createClient } from "@/utils/supabase/server";
import { createClient as createSupabaseClient } from '@supabase/supabase-js';
import { revalidatePath } from "next/cache";

const supabaseAdmin = createSupabaseClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!,
    {
        auth: {
            autoRefreshToken: false,
            persistSession: false,
        },
    }
);

export async function getAdminStats() {
    const supabase = await createClient();

    // 1. Get Tenant Context
    const { data: { user } } = await supabase.auth.getUser();
    const tenantId = user?.app_metadata?.tenant_id;

    if (!tenantId) {
        console.error("Critical: No Tenant ID found for stats.");
        return { totalCylinders: 0, activeDrivers: 0, emptyCylinders: 0, distributedStock: 0 };
    }

    // 2. Fetch with Explicit Filter (Double Lock)
    const [cylResult, driverResult, emptyResult, activityResult, distributedResult] = await Promise.allSettled([
        supabase.from("cylinders").select("*", { count: 'exact', head: true }).eq("current_location_type", "warehouse").eq("tenant_id", tenantId),
        supabase.from("users").select("*", { count: 'exact', head: true }).eq("role", "driver").eq("tenant_id", tenantId),
        supabase.from("cylinders").select("*", { count: 'exact', head: true }).eq("status", "empty").eq("tenant_id", tenantId),
        // Recent Activity (Orders)
        supabase.from('orders')
            .select('id, friendly_id, status, total_amount, created_at, customers(name)')
            .eq('tenant_id', tenantId)
            .order('created_at', { ascending: false })
            .limit(5),
        // Active Assets (Distributed / Not in Godown)
        supabase.from("cylinders").select("*", { count: 'exact', head: true }).neq("current_location_type", "warehouse").eq("tenant_id", tenantId)
    ]);

    // Helpers to extract data or log error
    const processResult = (result: PromiseSettledResult<any>, label: string) => {
        if (result.status === 'rejected') {
            console.error(`Error fetching ${label}:`, result.reason);
            return 0;
        }
        if (result.value.error) {
            console.error(`Error fetching ${label}:`, result.value.error.message);
            return 0;
        }
        return result.value.count || 0;
    };

    const getActivity = (result: PromiseSettledResult<any>) => {
        if (result.status === 'fulfilled' && result.value.data) return result.value.data;
        return [];
    };

    return {
        totalCylinders: processResult(cylResult, "Total Cylinders"),
        activeDrivers: processResult(driverResult, "Active Drivers"),
        emptyCylinders: processResult(emptyResult, "Empty Cylinders"),
        distributedStock: processResult(distributedResult, "Distributed Stock"),
        recentActivity: getActivity(activityResult)
    };
}

export async function getTenantInfo() {
    const supabase = await createClient();

    // 1. Get User to identify Tenant
    const { data: { user } } = await supabase.auth.getUser();
    const tenantId = user?.app_metadata?.tenant_id;

    if (!user || !tenantId) return { name: "Tenant Information" };

    // 2. Fetch Tenant Name via Users Join (or metadata if reliable, but DB join is safer for fresh name)
    // Assuming 'users' has 'tenant_id' and we join 'tenants'.
    const { data: profile } = await supabase
        .from("users")
        .select("tenant_id, tenants(name)")
        .eq("id", user.id)
        .eq("tenant_id", tenantId)
        .single();

    // Type assertion or check
    const tenantName = (profile as any)?.tenants?.name || "My Organization";
    return { name: tenantName };
}

export async function getTenantUsers() {
    const supabase = await createClient();

    // 1. Get Current User (Auth Check)
    const { data: { user }, error: authError } = await supabase.auth.getUser();

    if (authError || !user) {
        console.error("Auth error:", authError);
        return [];
    }

    // 2. Verified Query using RLS
    // We rely on the "Tenant Isolation" policy on 'profiles' to filter data automatically.
    // If the policy is working, this returns only the profiles for the user's tenant.
    const { data: profiles, error } = await supabase
        .from("profiles")
        .select("*");

    if (error) {
        console.error("Error fetching available profiles:", error);
        return [];
    }

    // Map profiles to Employee shape
    const mappedUsers = profiles?.map((p: any) => ({
        id: p.id,
        name: p.full_name || 'Unknown',
        email: 'N/A', // Email is not in profiles usually
        role: p.role || 'staff',
        phone_number: p.phone_number,
        shift: 'Day', // Default as shift is not in profiles
        created_at: p.updated_at || new Date().toISOString(),
        profiles: {
            vehicle_number: p.vehicle_number,
            phone_number: p.phone_number
        }
    })) || [];

    return mappedUsers;
}

export async function getDrivers() {
    const supabase = await createClient();

    // 1. Session & Metadata
    const { data: { user } } = await supabase.auth.getUser();
    const tenantId = user?.app_metadata?.tenant_id;

    if (!user || !tenantId) return [];

    // 2. Verified Query
    const { data, error } = await supabase
        .from('users')
        .select('id, name')
        .eq('role', 'driver')
        .eq('tenant_id', tenantId) // Double Lock
        .order('name');

    if (error) {
        console.error("Error fetching drivers:", error);
        return [];
    }

    return data || [];
}

// 4. GET PENDING HANDOVERS (Approvals)
export async function getPendingHandovers() {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return [];
    const tenantId = user.user_metadata?.tenant_id || user.app_metadata?.tenant_id;

    // 1. Get raw handovers from view
    const { data: handovers } = await supabase
        .from('view_admin_approvals')
        .select('*')
        .eq('tenant_id', tenantId)
        .order('created_at', { ascending: false });

    if (!handovers || handovers.length === 0) return [];

    // 2. Fetch Roles manually (since view doesn't have it and join is tricky with permissions)
    const userIds = Array.from(new Set(handovers.map(h => h.user_id).filter(Boolean)));

    const { data: users } = await supabase
        .from('users')
        .select('id, role')
        .in('id', userIds);

    // 3. Merge Role into result as 'users' object to match frontend expectation
    const enrichedData = handovers.map(h => {
        const u = users?.find(u => u.id === h.user_id);
        return {
            ...h,
            users: { role: u?.role || 'driver' } // Default to driver if checking fails
        };
    });

    return enrichedData;
}

// 4.5 HELPER: Get Pending Cylinder Details (For UI)
export async function getPendingCylinderDetails() {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return [];
    const tenantId = user.user_metadata?.tenant_id || user.app_metadata?.tenant_id;

    const { data } = await supabase
        .from('cylinders')
        .select('id, serial_number, current_holder_id, status')
        .eq('status', 'handover_pending')
        .eq('tenant_id', tenantId);

    return data || [];
}

// 5. APPROVE HANDOVER
// 5. APPROVE HANDOVER (With Reconciliation Logic)
// 5. APPROVE HANDOVER (With Reconciliation Logic)
// 5. APPROVE HANDOVER (RPC-Based)
export async function approveHandover(transactionId: string, _confirmedQty?: number) {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();

    if (!user) return { error: "Unauthorized" };
    if (!transactionId) return { error: "Transaction ID is missing" };

    // 1. Call Secure RPC
    // This handles Transaction Status Update + Asset Move + Wallet Deduction atomically on the DB side.
    const { data: rpcData, error: rpcError } = await supabase.rpc('approve_driver_handover', {
        p_transaction_id: transactionId,
        p_admin_user_id: user.id
    });

    if (rpcError) {
        console.error("Approval RPC Error:", rpcError);
        return { error: rpcError.message || "Admin Approval Failed (RPC Error)" };
    }

    // RPC returns JSON object { success: boolean, message: string }
    // We check success flag
    const result = rpcData as any;

    if (!result || !result.success) {
        console.error("Approval RPC returned failure:", result);
        return { error: result?.message || "Admin Approval Failed (Logic Error)" };
    }

    revalidatePath('/admin/approvals');
    revalidatePath('/admin/inventory');
    return { success: true, message: "Handover Approved Successfully" };
}

// 5.1 GET PENDING PAYMENTS
export async function getPendingPayments() {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return [];
    const tenantId = user.user_metadata?.tenant_id || user.app_metadata?.tenant_id;

    // Fetch transactions waiting for verificaion
    const { data, error } = await supabase
        .from('transactions')
        .select(`
            *,
            customers (name)
        `)
        .eq('tenant_id', tenantId)
        .eq('type', 'payment')
        .eq('status', 'pending_verification') // Explicit status for Bank/Cheque
        .order('created_at', { ascending: false });

    if (error) {
        console.error("Error fetching pending payments:", error);
        return [];
    }

    return data || [];
}

// 5.2 VERIFY PAYMENT (Bank/Cheque)
export async function verifyPayment(transactionId: string) {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return { error: "Unauthorized" };
    const tenantId = user.user_metadata?.tenant_id || user.app_metadata?.tenant_id;

    if (!transactionId) return { error: "Transaction ID missing" };

    // 1. Get Transaction Details
    const { data: txn, error: txnError } = await supabase
        .from('transactions')
        .select('*')
        .eq('id', transactionId)
        .eq('tenant_id', tenantId)
        .single();

    if (txnError || !txn) return { error: "Transaction not found" };
    if (txn.status !== 'pending_verification') return { error: "Transaction already processed" };

    // 2. Perform Atomic Updates (Ideally RPC, but doing manual for now as per plan/speed)
    // A. Update Transaction Status
    const { error: updateError } = await supabase
        .from('transactions')
        .update({ status: 'verified', updated_at: new Date().toISOString() })
        .eq('id', transactionId);

    if (updateError) return { error: "Failed to update transaction status" };

    // B. Credit Customer Balance (Reduce Debt)
    // Fetch current first
    const { data: customer } = await supabase.from('customers').select('current_balance').eq('id', txn.user_id).single();
    if (customer) {
        const newBalance = (customer.current_balance || 0) - Math.abs(txn.amount); // Reduce debt
        await supabase.from('customers').update({ current_balance: newBalance }).eq('id', txn.user_id);
    }

    // C. Update Company Ledger (Real Money In)
    await supabase.from('company_ledger').insert({
        tenant_id: tenantId,
        amount: Math.abs(txn.amount), // Positive Income
        transaction_type: 'credit',
        category: 'customer_payment_verified',
        description: `Verified ${txn.payment_method} from Customer (Txn #${txn.id.slice(0, 8)})`,
        admin_id: user.id
    });

    revalidatePath('/admin/approvals');
    revalidatePath('/admin/finance');
    revalidatePath('/admin/customers');

    return { success: true, message: "Payment Verified Successfully" };
}

// 5.3 REJECT PAYMENT
export async function rejectPayment(transactionId: string) {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return { error: "Unauthorized" };

    // Just mark as rejected. No financial rollback needed as it was never applied.
    const { error } = await supabase
        .from('transactions')
        .update({ status: 'rejected', updated_at: new Date().toISOString() })
        .eq('id', transactionId);

    if (error) return { error: "Failed to reject payment" };

    revalidatePath('/admin/approvals');
    return { success: true, message: "Payment Rejected" };
}

// 6. REJECT HANDOVER
export async function rejectHandover(transactionId: string) {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();
    const tenantId = user?.user_metadata?.tenant_id || user?.app_metadata?.tenant_id;

    if (!user || !tenantId) return { error: "Unauthorized" };

    const { data: txn } = await supabase
        .from('transactions')
        .select('*')
        .eq('id', transactionId)
        .eq('receiver_id', user.id)
        .single();

    if (!txn) return { error: "Transaction not found" };

    // 1. Revert Cylinder Status (handover_pending -> full/empty?)
    // This is tricky. We don't know previous status.
    // We will set them to 'empty' (safe bet for returns) or keeps them with driver?
    // If rejected, they stay with Driver. Status should probably revert to 'empty' (as they were likely empty returns)
    // OR 'full' if they were full returns?
    // Safe bet: Revert to 'empty' as most returns are empty. Or just 'empty'.
    // Actually, let's set them to 'empty' but keep with driver.

    await supabase.from('cylinders').update({
        status: 'empty', // Revert to empty
        updated_at: new Date().toISOString()
    })
        .eq('current_holder_id', txn.user_id)
        .eq('status', 'handover_pending')
        .eq('tenant_id', tenantId);

    // 2. Mark Transaction Rejected
    await supabase.from('transactions').update({
        status: 'rejected'
    }).eq('id', transactionId);

    revalidatePath('/admin/approvals');
    return { success: true };
}

// 7. DASHBOARD STATS (Consolidated)
export async function getDashboardStats() {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();
    const tenantId = user?.app_metadata?.tenant_id;

    if (!tenantId) {
        return {
            totalCash: 0,
            activeDrivers: 0,
            totalAssets: 0,
            emptyCylinders: 0,
            chartData: [],
            recentActivity: []
        };
    }

    // Parallel Fetching
    const [cashResult, driversResult, assetsResult, emptyResult, ordersResult, recentResult] = await Promise.allSettled([
        // 1. Total Cash (Sum of Ledger)
        supabase.from('company_ledger').select('amount').eq('tenant_id', tenantId),

        // 2. Active Drivers
        supabase.from('users').select('*', { count: 'exact', head: true }).eq('role', 'driver').eq('tenant_id', tenantId),

        // 3. Total Assets
        supabase.from('cylinders').select('*', { count: 'exact', head: true }).eq('tenant_id', tenantId),

        // 4. Empty Cylinders
        supabase.from('cylinders').select('*', { count: 'exact', head: true }).eq('status', 'empty').eq('tenant_id', tenantId),

        // 5. Chart Data (Last 7 Days)
        supabase.from('orders')
            .select('created_at, total_amount')
            .gte('created_at', new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString())
            .eq('tenant_id', tenantId)
            .order('created_at', { ascending: true }),

        // 6. Recent Activity
        supabase.from('orders')
            .select('id, friendly_id, status, total_amount, created_at, customers(name)')
            .eq('tenant_id', tenantId)
            .order('created_at', { ascending: false })
            .limit(5)
    ]);

    // Process Cash
    let totalCash = 0;
    if (cashResult.status === 'fulfilled' && cashResult.value.data) {
        totalCash = cashResult.value.data.reduce((acc, curr) => acc + (curr.amount || 0), 0);
    }

    // Process Counts
    const activeDrivers = driversResult.status === 'fulfilled' ? (driversResult.value.count || 0) : 0;
    const totalAssets = assetsResult.status === 'fulfilled' ? (assetsResult.value.count || 0) : 0;
    const emptyCylinders = emptyResult.status === 'fulfilled' ? (emptyResult.value.count || 0) : 0;
    const recentActivity = recentResult.status === 'fulfilled' && recentResult.value.data ? recentResult.value.data : [];

    // Process Chart Data (Group by Day)
    const chartMap = new Map<string, number>();

    // Initialize last 7 days with 0
    for (let i = 6; i >= 0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const dateStr = d.toLocaleDateString('en-US', { weekday: 'short' }); // Mon, Tue
        chartMap.set(dateStr, 0);
    }

    if (ordersResult.status === 'fulfilled' && ordersResult.value.data) {
        ordersResult.value.data.forEach((order) => {
            const dateStr = new Date(order.created_at).toLocaleDateString('en-US', { weekday: 'short' });
            if (chartMap.has(dateStr)) {
                chartMap.set(dateStr, (chartMap.get(dateStr) || 0) + 1);
            }
        });
    }

    const chartData = Array.from(chartMap.entries()).map(([name, value]) => ({ name, value }));

    return {
        totalCash,
        activeDrivers,
        totalAssets,
        emptyCylinders,
        chartData,
        recentActivity
    };
}
</file>

<file path="src/app/actions/driverActions.ts">
"use server";

import { createClient } from "@/utils/supabase/server";
import { revalidatePath } from "next/cache";

/**
 * DRIVER LOGISTICS ACTIONS - SECURE DOUBLE-LOCK
 */

// 0. FETCH DRIVER INVENTORY (New Schema)
export async function getDriverInventory() {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();

    if (!user) return { count: 0, cylinders: [] };
    const tenantId = user.app_metadata?.tenant_id;
    if (!tenantId) return { count: 0, cylinders: [] };

    const { data, error, count } = await supabase
        .from('cylinders')
        .select('id, serial_number, size, status, current_location_type', { count: 'exact' })
        .eq('current_holder_id', user.id)
        .eq('current_location_type', 'driver')
        .eq('status', 'full') // Only count full cylinders available for delivery
        .eq('tenant_id', tenantId);

    if (error) {
        console.error("Fetch Driver Inventory Error:", error);
        return { count: 0, cylinders: [] };
    }

    return { count: count || 0, cylinders: data || [] };
}

// 1. FETCH MY ROUTE (Assigned Orders)
export async function getDriverOrders() {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();

    if (!user) return [];
    const tenantId = user.app_metadata?.tenant_id;
    if (!tenantId) return [];

    const { data, error } = await supabase
        .from('orders')
        .select(`
            id, 
            friendly_id,
            total_amount, 
            status, 
            created_at,
            customer_id,
            customers (name, address, phone, current_balance),
            order_items (product_name, quantity),
            cylinders (serial_number) 
        `)
        .eq('driver_id', user.id)
        .in('status', ['assigned', 'on_trip', 'on-the-road', 'delivering']) // Active statuses
        .eq('tenant_id', tenantId)
        .order('created_at', { ascending: true });

    if (error) {
        console.error("Fetch Route Error:", error);
        return [];
    }
    return data || [];
}

// 2. START TRIP (Updates Status)
export async function startTrip(orderIds: string[]) {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();
    const tenantId = user?.app_metadata?.tenant_id;

    if (!user || !tenantId) return { error: "Unauthorized" };

    if (!orderIds || orderIds.length === 0) return { error: "No orders selected" };

    const { error } = await supabase
        .from('orders')
        .update({ status: 'on_trip', trip_started_at: new Date().toISOString() })
        .in('id', orderIds)
        .eq('driver_id', user.id) // Security: Only my orders
        .eq('tenant_id', tenantId);

    if (error) return { error: error.message };

    revalidatePath('/driver');
    return { success: true };
}

// 3. COMPLETE DELIVERY (The Complex Transaction)
export async function completeDelivery(formData: FormData) {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();
    const tenantId = user?.app_metadata?.tenant_id;

    if (!user || !tenantId) return { error: "Unauthorized" };

    // Extract Data
    const orderId = formData.get('order_id')?.toString();
    const receivedAmount = parseFloat(formData.get('received_amount')?.toString() || '0');
    const paymentMethod = formData.get('payment_method')?.toString(); // 'cash' | 'credit' | 'bank'
    const proofFile = formData.get('proof_file') as File;
    const notes = formData.get('notes')?.toString() || '';

    // Inventory Returns (Specific Serials)
    const returnedSerialsJson = formData.get('returned_serials')?.toString();
    const returnedSerials: string[] = returnedSerialsJson ? JSON.parse(returnedSerialsJson) : [];

    // Legacy/Fallback Count (If no serials provided but count exists)
    const returnedEmptyCount = parseInt(formData.get('returned_empty_count')?.toString() || '0');

    if (!orderId) return { error: "Missing Order ID" };

    // A. FETCH ORDER DETAILS (Validation)
    const { data: order } = await supabase
        .from('orders')
        .select('id, friendly_id, total_amount, customer_id, tenant_id, order_items(quantity, product_name)')
        .eq('id', orderId)
        .eq('driver_id', user.id)
        .eq('tenant_id', tenantId)
        .single();

    if (!order) return { error: "Order not found or access denied" };

    // SAFETY CHECK: Verify Driver Has Stock
    // Calculate total quantity needed for this order
    let requiredQty = 0;
    order.order_items.forEach((item: any) => requiredQty += item.quantity);

    if (requiredQty > 0) {
        const { count } = await supabase
            .from('cylinders')
            .select('*', { count: 'exact', head: true })
            .eq('current_holder_id', user.id)
            .eq('current_location_type', 'driver')
            .eq('status', 'full')
            .eq('tenant_id', tenantId);

        const availableStock = count || 0;
        // Strictly block if stock is 0, but maybe allow if stock is just less than needed? 
        // User instruction: "If the driver tries to deliver but has 0 stock, throw a clear error"
        if (availableStock === 0) {
            return { error: "No cylinders found on truck! Cannot complete delivery." };
        }
        if (availableStock < requiredQty) {
            return { error: `Insufficient stock! You have ${availableStock}, but order needs ${requiredQty}.` };
        }
    }


    // B. UPLOAD PROOF (If exists)
    let proofUrl = null;
    if (proofFile && proofFile.size > 0) {
        const fileExt = proofFile.name.split(".").pop();
        const fileName = `delivery_${orderId}_${Date.now()}.${fileExt}`;
        const { error: uploadError } = await supabase.storage
            .from("receipts")
            .upload(fileName, proofFile);

        if (!uploadError) {
            const { data: { publicUrl } } = supabase.storage.from("receipts").getPublicUrl(fileName);
            proofUrl = publicUrl;
        }
    }

    // C. UPDATE ORDER STATUS
    const { error: updateError } = await supabase
        .from('orders')
        .update({
            status: 'delivered', // or 'completed'
            amount_received: receivedAmount,
            payment_method: paymentMethod,
            trip_completed_at: new Date().toISOString(),
            notes: notes
            // proof_url column might not exist on orders table, kept in transaction
        })
        .eq('id', orderId)
        .eq('tenant_id', tenantId);

    if (updateError) return { error: `Order Update Failed: ${updateError.message}` };

    // D. FINANCIALS
    const totalDue = order.total_amount;
    const remainingBalance = totalDue - receivedAmount;

    // 1. Log Transactions (Double-Entry Style)
    // We STRICTLY record the Sale (Debit) and the Payment (Credit) separately.
    try {
        // Step 1: Record Sales (Debit) - ALWAYS
        const { error: saleError } = await supabase.from('transactions').insert({
            tenant_id: tenantId,
            order_id: orderId,
            customer_id: order.customer_id,
            user_id: user.id,
            type: 'sale', // Always a sale
            amount: totalDue, // POSITIVE (Increases Debt)
            payment_method: paymentMethod || 'pending',
            description: `Order #${order.friendly_id || orderId} - Delivered`,
            proof_url: proofUrl,
            created_at: new Date().toISOString()
        });

        if (saleError) throw new Error(`Failed to record Sale Transaction: ${saleError.message}`);

        // Step 2: Record Payment (Credit) - IF PAID
        if (receivedAmount > 0) {
            // Add slight delay to ensure Payment appears AFTER Sale in time-sorted lists if ms resolution matches
            const paymentDate = new Date();
            paymentDate.setSeconds(paymentDate.getSeconds() + 1);

            const { error: payError } = await supabase.from('transactions').insert({
                tenant_id: tenantId,
                order_id: orderId,
                customer_id: order.customer_id,
                user_id: user.id,
                type: 'payment', // Credit
                amount: -receivedAmount, // NEGATIVE (Decreases Debt)
                payment_method: paymentMethod || 'cash',
                description: `Payment Received (Order #${order.friendly_id || orderId})`,
                proof_url: proofUrl,
                created_at: paymentDate.toISOString()
            });

            if (payError) throw new Error(`Failed to record Payment Transaction: ${payError.message}`);

            // Update Driver Wallet (Liability) if CASH
            // Update Driver Wallet (Liability)
            // Fix: Allow wallet update for 'credit' orders if they have a partial cash payment.
            // We assume 'cash' and 'credit' (partial) involve physical money. 'bank' does not.
            // Update Driver Wallet (Liability)
            // Fix: We unconditionally update wallet if ANY cash is received (amount > 0), 
            // regardless of whether the order is marked 'cash' or 'credit'.
            // This handles partial payments correctly.
            const { data: w } = await supabase.from('employee_wallets').select('balance').eq('user_id', user.id).single();
            const current = w?.balance || 0;
            await supabase.from('employee_wallets').upsert({
                user_id: user.id,
                balance: current + receivedAmount,
                updated_at: new Date().toISOString()
            }, { onConflict: 'user_id' });
        }
    } catch (err: any) {
        console.error("Critical Financial Error:", err);
        return { error: `Financial Record Failed: ${err.message}` };
    }

    // 2. Update Customer Balance (Debt)
    // Formula: New = Old + Sale - Paid
    const { data: cust } = await supabase.from('customers').select('current_balance').eq('id', order.customer_id).single();
    const currentBalance = cust?.current_balance || 0;
    const newBalance = currentBalance + remainingBalance; // remainingBalance is (total - paid). We ADD to increase positive debt.

    if (newBalance !== currentBalance) {
        await supabase.from('customers')
            .update({ current_balance: newBalance })
            .eq('id', order.customer_id)
            .eq('tenant_id', tenantId);
    }

    // E. INVENTORY: MOVE DELIVERED STOCK (Driver -> Customer)
    // 1. Move using Robust Link (Last Order ID)
    const { data: movedCylinders } = await supabase.from('cylinders').update({
        current_location_type: 'customer',
        current_holder_id: order.customer_id,
        status: 'at_customer',
        updated_at: new Date().toISOString()
    })
        .eq('last_order_id', order.id)
        .eq('tenant_id', tenantId)
        .select('id');

    // 2. Fallback
    const hasMoved = movedCylinders && movedCylinders.length > 0;

    if (!hasMoved && requiredQty > 0) {
        const { data: fallbackStock } = await supabase
            .from('cylinders')
            .select('id')
            .eq('current_holder_id', user.id)
            .eq('current_location_type', 'driver')
            .eq('status', 'full')
            .eq('tenant_id', tenantId)
            .limit(requiredQty);

        if (fallbackStock && fallbackStock.length > 0) {
            const ids = fallbackStock.map(c => c.id);
            await supabase.from('cylinders').update({
                current_location_type: 'customer',
                current_holder_id: order.customer_id,
                status: 'at_customer',
                last_order_id: order.id
            }).in('id', ids).eq('tenant_id', tenantId);
        }
    }

    // F. INVENTORY: PROCESS RETURNS (ASSET SWAP) (Customer -> Driver)
    if (returnedSerials.length > 0) {
        // Specific Asset Return
        await supabase.from('cylinders').update({
            current_location_type: 'driver',
            current_holder_id: user.id,
            status: 'empty', // Mark as Empty on return
            updated_at: new Date().toISOString()
        })
            .in('serial_number', returnedSerials)
            .eq('tenant_id', tenantId);
    }
    // Legacy Fallback (Count Only - Grab ANY cylinder from customer)
    // Only if no serials provided but count > 0
    else if (returnedEmptyCount > 0) {
        const { data: customerStock } = await supabase
            .from('cylinders')
            .select('id')
            .eq('current_holder_id', order.customer_id)
            .eq('current_location_type', 'customer')
            .eq('tenant_id', tenantId)
            .limit(returnedEmptyCount);

        if (customerStock && customerStock.length > 0) {
            const returnIds = customerStock.map(c => c.id);
            await supabase.from('cylinders').update({
                current_location_type: 'driver',
                current_holder_id: user.id,
                status: 'empty',
                updated_at: new Date().toISOString()
            }).in('id', returnIds).eq('tenant_id', tenantId);
        }
    }

    revalidatePath('/driver');
    revalidatePath('/admin/orders');
    revalidatePath('/admin/customers');
    revalidatePath('/admin/inventory');

    return { success: true };
}


// 4. GET MY COMPLETED ORDERS (History)
export async function getCompletedOrders(dateString?: string) {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return [];
    const tenantId = user.app_metadata?.tenant_id;

    // Determine Date Range
    const targetDate = dateString ? new Date(dateString) : new Date();
    const startOfDay = new Date(targetDate.setHours(0, 0, 0, 0)).toISOString();
    const endOfDay = new Date(targetDate.setHours(23, 59, 59, 999)).toISOString();

    const { data } = await supabase
        .from('orders')
        .select('id, friendly_id, total_amount, amount_received, payment_method, created_at, customers(name)')
        .eq('driver_id', user.id)
        .eq('status', 'delivered')
        .eq('tenant_id', tenantId)
        .gte('created_at', startOfDay)
        .lte('created_at', endOfDay)
        .order('created_at', { ascending: false });

    return data || [];
}

// 5. DRIVER HUD STATS
export async function getDriverStats() {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return { cashLiability: 0, emptiesOnHand: 0 };
    const tenantId = user.app_metadata?.tenant_id;

    // 1. Get Cash Liability from Employee Wallet
    const { data: wallet } = await supabase
        .from('employee_wallets')
        .select('balance')
        .eq('user_id', user.id)
        .single();

    // 2. Get Empty Cylinders Count
    const { count: empties } = await supabase
        .from('cylinders')
        .select('*', { count: 'exact', head: true })
        .eq('current_holder_id', user.id)
        .eq('current_location_type', 'driver')
        .eq('status', 'empty')
        .eq('tenant_id', tenantId);

    return {
        cashLiability: wallet?.balance || 0,
        emptiesOnHand: empties || 0
    };
}

// 6. END SHIFT (HANDOVER)
// 6. FETCH ALL ASSETS ON TRUCK (Full & Empty for Handover)
export async function getDriverAllAssets() {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return [];
    const tenantId = user.app_metadata?.tenant_id;

    const { data } = await supabase
        .from('cylinders')
        .select('id, serial_number, size, status, current_location_type')
        .eq('current_holder_id', user.id)
        .eq('current_location_type', 'driver')
        .eq('tenant_id', tenantId)
        .order('status', { ascending: false }); // Full first

    return data || [];
}
// 7. FETCH RECEIVERS (Admins/Managers)
export async function getReceivers() {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();

    if (!user) return [];

    // Safety: Ensure Tenant context
    const tenantId = user.user_metadata?.tenant_id || user.app_metadata?.tenant_id;
    if (!tenantId) return [];

    const { data } = await supabase
        .from('users')
        .select('id, name, role')
        .in('role', ['admin', 'manager', 'cashier'])
        .eq('tenant_id', tenantId) // STRICT SECURITY: Only my tenant
        .order('name', { ascending: true });

    if (!data) return [];

    // Deduplicate by ID (Safety Check) - Type 'any' for item to avoid lint error quickly
    const uniqueReceivers = Array.from(new Map(data.map((item: any) => [item.id, item])).values());

    return uniqueReceivers;
}

// 8. PROCESS HANDOVER REQUEST (Maker-Checker)
export async function processHandover(formData: FormData) {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();
    // Robust Tenant ID: Prefer app_metadata (secure), fallback to user_metadata
    const tenantId = user?.app_metadata?.tenant_id || user?.user_metadata?.tenant_id;

    if (!user || !tenantId) return { error: "Unauthorized" };

    // 1. Parse Inputs
    const depositAmount = parseFloat(formData.get('deposit_amount')?.toString() || '0');
    const returnedSerialsJson = formData.get('returned_serials')?.toString();
    const selectedCylinderIds: string[] = returnedSerialsJson ? JSON.parse(returnedSerialsJson) : []; // Using Serials as IDs for now (Frontend sends serials)
    const receiverId = formData.get('receiver_id')?.toString();

    if (!receiverId) return { error: "Please select a receiver." };

    // 2. Validate Cash (If applicable)
    if (depositAmount > 0) {
        const { data: wallet } = await supabase.from('employee_wallets')
            .select('balance')
            .eq('user_id', user.id)
            .single();

        const currentBalance = wallet?.balance || 0;
        if (depositAmount > currentBalance) {
            return { error: `Insufficient Funds. Wallet Balance: Rs ${currentBalance}` };
        }
    }

    // 3. ATOMIC-LIKE HANDOVER SEQUENCE
    // We explicitly verify ownership AND lock in one go.

    // A. Lock Assets (Set status to 'handover_pending')
    // Validation: current_holder_id = user.id AND current_location_type = 'driver'
    let lockedCount = 0;

    if (selectedCylinderIds.length > 0) {
        // Attempt to update. Postgres will only update rows that match conditions.
        const { data: lockedAssets, error: lockError } = await supabase
            .from('cylinders')
            .update({
                status: 'handover_pending',
                updated_at: new Date().toISOString()
            })
            .in('serial_number', selectedCylinderIds) // Frontend sends Serials. If it sent IDs, we'd use .in('id', ...)
            .eq('current_holder_id', user.id)        // <--- VALIDATION 1
            .eq('current_location_type', 'driver')   // <--- VALIDATION 2
            .eq('tenant_id', tenantId)
            .select('id');

        // STRICT CHECK 1: Database Error (RLS Policy Violation often throws this)
        if (lockError) {
            console.error("Handover Asset Lock Error:", lockError);
            return { error: "Permission Denied: Cannot lock assets. Check your connection or permissions." };
        }

        lockedCount = lockedAssets?.length || 0;

        // STRICT CHECK 2: Zero Rows Updated (RLS Policy hiding rows or condition mismatch)
        if (lockedCount === 0) {
            console.error("Critical: Lock attempt returned 0 rows. Serials:", selectedCylinderIds);
            return { error: "Update failed. No assets locked. Ensure you possess these cylinders." };
        }

        // STRICT CHECK 3: Partial Lock (Data Integrity Issue)
        if (lockedCount !== selectedCylinderIds.length) {
            console.error("Asset Mismatch:", { expected: selectedCylinderIds.length, actual: lockedCount });

            // Revert the ones we JUST changed
            if (lockedCount > 0) {
                const lockedIds = lockedAssets?.map(a => a.id) || [];
                await supabase.from('cylinders')
                    .update({ status: 'empty' })
                    .in('id', lockedIds);
            }
            return { error: "Ownership Validation Failed: You do not possess all selected cylinders." };
        }
    }

    // B. Create Transaction
    const { error: txnError } = await supabase.from('transactions').insert({
        tenant_id: tenantId,
        user_id: user.id,
        receiver_id: receiverId,
        type: 'handover_request',
        status: 'pending',
        amount: depositAmount,
        description: `Handover Request: Rs ${depositAmount} + ${lockedCount} Cylinders`,
        payment_method: 'cash',
        created_at: new Date().toISOString()
        // Note: Linked assets aren't stored in transaction directly, but inferred via status='handover_pending' + holder=user
    });

    // C. ROLLBACK ON FAILURE
    if (txnError) {
        console.error("Handover Transaction Failed:", txnError);

        // Attempt RPC Revert (if possible) or just Warn.
        // Since we used a secure RPC to lock, a direct update to unlock might also fail RLS.
        // Ideally, we'd have a 'revert_driver_handover' RPC.
        // For now, we will try to direct revert but suppress errors if it fails, as the Admin can manually reject.
        if (lockedCount > 0) {
            console.log("Attempting to rollback asset lock...");
            const { error: revertError } = await supabase.from('cylinders')
                .update({
                    status: 'empty', // Revert to empty
                    updated_at: new Date().toISOString()
                })
                .in('serial_number', selectedCylinderIds)
                .eq('current_holder_id', user.id);

            if (revertError) {
                console.error("Rollback failed (likely RLS). Admin must handle manually.", revertError);
            }
        }

        return { error: `Transaction Creation Failed: ${txnError.message}. Assets are locked - please contact Admin.` };
    }

    revalidatePath('/driver');
    return { success: true };
}

// 9. GET DRIVER PROFILE
export async function getDriverProfile() {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();

    if (!user) return null;

    // Fetch from 'profiles' table as per instruction
    const { data, error } = await supabase
        .from('profiles')
        .select('*')
        .eq('id', user.id)
        .single();

    if (error) {
        console.error("Fetch Profile Error:", error);
        return null;
    }

    return data;
}
</file>

<file path="src/components/admin/QRCodeGenerator.tsx">
import React, { useEffect, useState } from 'react';
import QRCode from 'react-qr-code';
import { X, Printer } from 'lucide-react';
import { Dialog, DialogContent, DialogTrigger } from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';

interface QRCodeGeneratorProps {
    serialNumbers: string[];
    tenantId: string;
    onClose: () => void;
}

export default function QRCodeGenerator({ serialNumbers, tenantId, onClose }: QRCodeGeneratorProps) {
    const [isOpen, setIsOpen] = useState(true);

    // Sync external open state if needed, but since it's mounted conditionally likely, we just default true.
    // However, if the parent controls mounting, we can just render the Dialog open={true}.

    const handlePrint = () => {
        window.print();
    };

    const handleOpenChange = (open: boolean) => {
        setIsOpen(open);
        if (!open) {
            onClose();
        }
    }

    return (
        <Dialog open={isOpen} onOpenChange={handleOpenChange}>
            <DialogContent className="max-w-4xl p-0 overflow-hidden bg-white sm:rounded-2xl print:shadow-none print:w-full print:max-w-none print:rounded-none">
                {/* Header - Hidden in Print */}
                <div className="p-6 border-b border-slate-100 flex justify-between items-center print:hidden">
                    <div>
                        <h2 className="text-xl font-bold text-slate-900">Print QR Codes</h2>
                        <p className="text-sm text-slate-500 font-medium">Ready to print {serialNumbers.length} labels</p>
                    </div>
                    <div className="flex gap-3">
                        <Button
                            onClick={handlePrint}
                            className="bg-slate-900 text-white font-bold gap-2 hover:bg-slate-800"
                        >
                            <Printer size={18} /> Print Labels
                        </Button>
                        <Button
                            variant="secondary"
                            onClick={() => handleOpenChange(false)}
                            className="bg-slate-100 text-slate-600 font-bold hover:bg-slate-200"
                        >
                            <X size={18} />
                        </Button>
                    </div>
                </div>

                {/* Grid */}
                <div className="p-8 print:p-0 max-h-[80vh] overflow-y-auto print:max-h-none print:overflow-visible">
                    <div className="grid grid-cols-3 gap-8 print:grid-cols-3 print:gap-4">
                        {serialNumbers.map((serial) => (
                            <div key={serial} className="flex flex-col items-center justify-center p-4 border-2 border-slate-900 rounded-xl print:border-2 print:border-black print:break-inside-avoid">
                                <div className="mb-2">
                                    <QRCode
                                        value={`tenant=${tenantId}&id=${serial}`}
                                        size={128}
                                        style={{ height: "auto", maxWidth: "100%", width: "100%" }}
                                        viewBox={`0 0 256 256`}
                                    />
                                </div>
                                <div className="text-center">
                                    <div className="text-xl font-black text-slate-900 leading-none mb-1">{serial}</div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            </DialogContent>
        </Dialog>
    );
}
</file>

<file path="src/components/BottomNav.tsx">
'use client';

import { usePathname } from 'next/navigation';
import Link from 'next/link';
import { LayoutDashboard, RefreshCcw, Store, Truck, Package } from 'lucide-react';
import { cn } from '@/lib/utils';

export function BottomNav() {
    const pathname = usePathname();

    const navItems = [
        { label: 'Home', href: '/', icon: LayoutDashboard }, // Admin is treated as Home/CEO View
        { label: 'Dispatch', href: '/orders/new', icon: Package },
        { label: 'Recover', href: '/recovery', icon: RefreshCcw },
        { label: 'Shop', href: '/shop', icon: Store },
        { label: 'Driver', href: '/driver', icon: Truck },
    ];

    if (pathname === '/login') return null;

    return (
        <nav className="fixed bottom-0 left-0 right-0 bg-background border-t border-border p-2 pb-safe z-50 flex justify-around items-center shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
            {navItems.map((item) => {
                const Icon = item.icon;
                const isActive = pathname === item.href;

                return (
                    <Link
                        key={item.href}
                        href={item.href}
                        className={cn(
                            "flex flex-col items-center justify-center p-2 rounded-xl transition-colors min-w-[4rem]",
                            isActive ? "text-primary bg-primary/10" : "text-muted-foreground hover:text-foreground"
                        )}
                    >
                        <Icon size={24} className={cn("mb-1", isActive && "fill-current text-primary")} strokeWidth={isActive ? 2.5 : 2} />
                        <span className="text-[10px] font-bold tracking-wide">{item.label}</span>
                    </Link>
                );
            })}
        </nav>
    );
}
</file>

<file path="src/components/ReturnCheckInModal.tsx">
"use client";

import { useState, useEffect } from "react";
import { createClient } from "@/utils/supabase/client";
import { CheckCircle, RefreshCw, Loader2 } from "lucide-react";
import { toast } from "sonner";
import { cn } from "@/lib/utils";
import {
    Dialog,
    DialogContent,
    DialogDescription,
    DialogHeader,
    DialogTitle,
} from "@/components/ui/dialog";
import {
    Select,
    SelectContent,
    SelectItem,
    SelectTrigger,
    SelectValue,
} from "@/components/ui/select";
import { Button } from "@/components/ui/button";

interface TripMetric {
    trip_id: string;
    driver_name: string;
    start_time: string;
    end_time: string | null;
    completed_orders_count: number;
    expected_empty_returns: number;
}

interface TripCylinder {
    cylinder_id: string;
    serial_number: string;
    size: string;
    current_status: string;
    return_status: string; // Ensure string type to match state init
}

export default function ReturnCheckInModal({
    isOpen,
    onClose,
}: {
    isOpen: boolean;
    onClose: () => void;
}) {
    const [trips, setTrips] = useState<TripMetric[]>([]);
    const [loading, setLoading] = useState(false);
    const [selectedTripId, setSelectedTripId] = useState<string | null>(null);
    const [cylinders, setCylinders] = useState<TripCylinder[]>([]);
    const [processing, setProcessing] = useState(false);

    const supabase = createClient();

    useEffect(() => {
        if (isOpen) {
            fetchTripMetrics();
            setSelectedTripId(null);
            setCylinders([]);
        }
    }, [isOpen]);

    const fetchTripMetrics = async () => {
        setLoading(true);
        const { data, error } = await supabase.rpc("get_trip_return_metrics");
        if (error) {
            console.error("Error fetching metrics:", error);
            toast.error("Failed to load active trips.");
        } else {
            setTrips(data || []);
        }
        setLoading(false);
    };

    const handleSelectTrip = async (tripId: string) => {
        setSelectedTripId(tripId);
        setLoading(true);
        const { data, error } = await supabase.rpc("get_trip_cylinders", {
            p_trip_id: tripId,
        });

        if (error) {
            toast.error("Failed to fetch cylinders");
            setSelectedTripId(null);
        } else {
            const mapped = (data || []).map((c: any) => ({
                ...c,
                return_status: 'empty'
            }));
            setCylinders(mapped);
        }
        setLoading(false);
    };

    const updateCylinderStatus = (id: string, status: string) => {
        setCylinders(prev => prev.map(c =>
            c.cylinder_id === id ? { ...c, return_status: status } : c
        ));
    };

    const handleFinalizeReturn = async () => {
        if (!selectedTripId) return;
        setProcessing(true);

        const payload = cylinders.map(c => ({
            id: c.cylinder_id,
            status: c.return_status
        }));

        try {
            const { data, error } = await supabase.rpc("process_trip_returns", {
                p_trip_id: selectedTripId,
                p_returned_items: payload
            });

            if (error) throw error;

            toast.success(`Processed ${data.cylinders_processed} cylinders.`);
            setSelectedTripId(null);
            fetchTripMetrics();
        } catch (err: any) {
            toast.error(`Error: ${err.message}`);
        } finally {
            setProcessing(false);
        }
    };

    return (
        <Dialog open={isOpen} onOpenChange={(open) => !open && onClose()}>
            <DialogContent className="max-w-4xl max-h-[90vh] overflow-hidden flex flex-col p-0">
                <div className="p-6 pb-0 flex-shrink-0">
                    <DialogHeader>
                        <DialogTitle className="flex items-center gap-2">
                            <span className="bg-emerald-100 p-1.5 rounded-lg">
                                <RefreshCw className="w-5 h-5 text-emerald-600" />
                            </span>
                            {selectedTripId ? "Verify Return Items" : "Return Check-in"}
                        </DialogTitle>
                        <DialogDescription>
                            {selectedTripId
                                ? "Select the condition of each returned cylinder"
                                : "Verify empty cylinders returned by drivers"}
                        </DialogDescription>
                    </DialogHeader>
                </div>

                <div className="flex-1 overflow-y-auto p-6">
                    {loading ? (
                        <div className="flex flex-col items-center justify-center py-12 text-muted-foreground animate-in fade-in">
                            <Loader2 className="w-8 h-8 animate-spin mb-4" />
                            <p>Loading...</p>
                        </div>
                    ) : selectedTripId ? (
                        // RECONCILIATION VIEW
                        <div className="space-y-6">
                            <div className="flex justify-between items-center">
                                <h3 className="font-semibold text-foreground">Cylinders Expected ({cylinders.length})</h3>
                                <Button
                                    variant="link"
                                    onClick={() => setSelectedTripId(null)}
                                    className="text-muted-foreground hover:text-foreground p-0 h-auto font-normal"
                                >
                                    Back to Trips
                                </Button>
                            </div>

                            {cylinders.length === 0 ? (
                                <div className="text-center py-12 text-muted-foreground border border-dashed rounded-lg bg-muted/30">
                                    <p>No cylinders found for this trip's orders.</p>
                                </div>
                            ) : (
                                <div className="border rounded-md overflow-hidden">
                                    <table className="w-full text-left text-sm">
                                        <thead className="bg-muted/50 border-b">
                                            <tr>
                                                <th className="p-4 font-medium text-muted-foreground">Serial</th>
                                                <th className="p-4 font-medium text-muted-foreground">Size</th>
                                                <th className="p-4 font-medium text-muted-foreground">Condition</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y">
                                            {cylinders.map((cyl) => (
                                                <tr key={cyl.cylinder_id} className="group hover:bg-muted/30 transition-colors">
                                                    <td className="p-4 font-mono text-foreground font-medium">{cyl.serial_number}</td>
                                                    <td className="p-4 text-muted-foreground">{cyl.size}</td>
                                                    <td className="p-3">
                                                        <Select
                                                            value={cyl.return_status}
                                                            onValueChange={(val) => updateCylinderStatus(cyl.cylinder_id, val)}
                                                        >
                                                            <SelectTrigger className="h-9 w-[150px]">
                                                                <SelectValue />
                                                            </SelectTrigger>
                                                            <SelectContent>
                                                                <SelectItem value="empty">
                                                                    <div className="flex items-center gap-2">
                                                                        <div className="w-2 h-2 rounded-full bg-emerald-500" /> Empty
                                                                    </div>
                                                                </SelectItem>
                                                                <SelectItem value="full">
                                                                    <div className="flex items-center gap-2">
                                                                        <div className="w-2 h-2 rounded-full bg-blue-500" /> Full (Return)
                                                                    </div>
                                                                </SelectItem>
                                                                <SelectItem value="defective">
                                                                    <div className="flex items-center gap-2">
                                                                        <div className="w-2 h-2 rounded-full bg-rose-500" /> Defective
                                                                    </div>
                                                                </SelectItem>
                                                            </SelectContent>
                                                        </Select>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </div>
                    ) : (
                        // TRIP LIST VIEW
                        trips.length === 0 ? (
                            <div className="flex flex-col items-center justify-center py-16 text-muted-foreground border border-dashed rounded-xl bg-muted/30">
                                <CheckCircle className="w-12 h-12 mb-4 text-muted-foreground/50" />
                                <p>No pending returns found</p>
                            </div>
                        ) : (
                            <div className="border rounded-md overflow-hidden">
                                <table className="w-full text-left text-sm">
                                    <thead className="bg-muted/50 border-b">
                                        <tr>
                                            <th className="p-4 font-medium text-muted-foreground">Driver</th>
                                            <th className="p-4 font-medium text-muted-foreground">Start Time</th>
                                            <th className="p-4 font-medium text-center text-muted-foreground">Delivered</th>
                                            <th className="p-4 font-medium text-center text-muted-foreground">Expected</th>
                                            <th className="p-4 font-medium text-right text-muted-foreground">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y">
                                        {trips.map((trip) => (
                                            <tr
                                                key={trip.trip_id}
                                                className="group hover:bg-muted/30 transition-colors"
                                            >
                                                <td className="p-4 font-medium text-foreground">
                                                    <div className="flex items-center gap-2">
                                                        {trip.driver_name}
                                                        {!trip.end_time && (
                                                            <span className="flex h-2 w-2 rounded-full bg-emerald-500 animate-pulse" />
                                                        )}
                                                    </div>
                                                </td>
                                                <td className="p-4 text-muted-foreground">
                                                    {new Date(trip.start_time).toLocaleTimeString([], {
                                                        hour: "2-digit",
                                                        minute: "2-digit",
                                                    })}
                                                </td>
                                                <td className="p-4 text-center font-medium">{trip.completed_orders_count}</td>
                                                <td className="p-4 text-center">
                                                    <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                                                        {trip.expected_empty_returns}
                                                    </span>
                                                </td>
                                                <td className="p-4 text-right">
                                                    <Button
                                                        size="sm"
                                                        onClick={() => handleSelectTrip(trip.trip_id)}
                                                    >
                                                        Process
                                                    </Button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )
                    )}
                </div>

                {/* Footer Area for Actions */}
                {selectedTripId && (
                    <div className="p-6 pt-2 border-t mt-auto bg-muted/20 flex justify-end gap-3 flex-shrink-0">
                        <Button
                            variant="outline"
                            onClick={() => setSelectedTripId(null)}
                        >
                            Cancel
                        </Button>
                        <Button
                            onClick={handleFinalizeReturn}
                            disabled={processing || cylinders.length === 0}
                            className={cn(processing && "opacity-80")}
                        >
                            {processing && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                            Confirm & Restock
                        </Button>
                    </div>
                )}
            </DialogContent>
        </Dialog>
    );
}
</file>

<file path="src/utils/supabase/middleware.ts">
import { createServerClient } from '@supabase/ssr'
import { NextResponse, type NextRequest } from 'next/server'

export async function updateSession(request: NextRequest) {
    let response = NextResponse.next({
        request: {
            headers: request.headers,
        },
    })

    const supabase = createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        {
            cookies: {
                getAll() {
                    return request.cookies.getAll()
                },
                setAll(cookiesToSet) {
                    cookiesToSet.forEach(({ name, value, options }) => request.cookies.set(name, value))
                    response = NextResponse.next({
                        request: {
                            headers: request.headers,
                        },
                    })
                    cookiesToSet.forEach(({ name, value, options }) =>
                        response.cookies.set(name, value, options)
                    )
                },
            },
        }
    )

    const {
        data: { user },
        error: authError
    } = await supabase.auth.getUser()

    if (authError && authError.message !== 'Auth session missing!') {
        console.log("Middleware Auth Check:", authError.message);
    }

    // Return user to let middleware.ts handle redirects
    return { response, user, supabase }
}
</file>

<file path="supabase/migrations/20260126000000_critical_fixes.sql">
-- Migration: Critical Fixes (Security & Logic)
-- Date: 2026-01-26
-- Description: 
-- 1. Reverts 'cylinders' RLS to strict Iron Dome policy.
-- 2. Updates 'process_trip_returns' to handle explicit return items.
-- 3. Adds 'verification_status' to 'company_ledger'.


-- 0. SECURITY FIX: Permission Denied on get_my_tenant_id
-- We redefine this function to remove ', auth' 
-- which caused failures when called by RLS policies.
CREATE OR REPLACE FUNCTION public.get_my_tenant_id()
RETURNS UUID
LANGUAGE sql
AS $$
  SELECT tenant_id FROM public.users WHERE id = (current_setting('request.jwt.claim.sub', true)::uuid);
$$;

-- 1. SECURITY: Revert Cylinders RLS to Iron Dome
-- Drop permissive policies and legacy zombie policies
DROP POLICY IF EXISTS "Enable read access for all users" ON cylinders;
DROP POLICY IF EXISTS "Enable insert access for all users" ON cylinders;
DROP POLICY IF EXISTS "Enable update access for all users" ON cylinders;
DROP POLICY IF EXISTS "Admins can update cylinders" ON cylinders;
DROP POLICY IF EXISTS "Allow auth select all" ON cylinders;
DROP POLICY IF EXISTS "Cylinder Isolation" ON cylinders;
DROP POLICY IF EXISTS "Drivers can update their own cylinders" ON cylinders;
DROP POLICY IF EXISTS "Drivers can view their own cylinders" ON cylinders;
DROP POLICY IF EXISTS "Public_Full_Access" ON cylinders;
DROP POLICY IF EXISTS "Tenant Isolation Cylinders" ON cylinders;

-- Cleanup Zombies on Orders & Trips (Fixes 'permission denied' during Join validation)
DROP POLICY IF EXISTS "Allow auth select all" ON orders;
DROP POLICY IF EXISTS "Enable all access for all users" ON orders;
DROP POLICY IF EXISTS "Enable read access for tenant users" ON orders;
DROP POLICY IF EXISTS "Tenant Isolation Orders" ON orders;

-- Fix Orders Isolation (Remove jwt() dependency)
DROP POLICY IF EXISTS "Tenant Isolation" ON orders;
CREATE POLICY "Tenant Isolation" ON orders
    FOR ALL
    USING (tenant_id = public.get_my_tenant_id());

DROP POLICY IF EXISTS "Allow auth select all" ON trips;
DROP POLICY IF EXISTS "Auto read policy" ON trips;

-- Re-apply strict tenant isolation
DROP POLICY IF EXISTS "Tenant Isolation" ON cylinders;
CREATE POLICY "Tenant Isolation" ON cylinders
    FOR ALL
    USING (tenant_id = public.get_my_tenant_id());

-- Helper to get specific cylinders for a trip (for UI reconciliation)
CREATE OR REPLACE FUNCTION get_trip_cylinders(p_trip_id UUID)
RETURNS TABLE (
    cylinder_id UUID,
    serial_number TEXT,
    size TEXT,
    current_status TEXT
)
LANGUAGE plpgsql

AS $$
BEGIN
    RETURN QUERY
    SELECT 
        c.id,
        c.serial_number,
        c.size,
        c.status
    FROM cylinders c
    JOIN orders o ON c.last_order_id = o.id
    JOIN trips t ON t.id = p_trip_id
    WHERE o.driver_id = t.driver_id
      AND o.status = 'completed'
      AND o.trip_started_at >= t.start_time
      AND o.trip_completed_at <= coalesce(t.end_time, now())
      -- Only include items that are logically 'at customer' or currently being returned
      -- We assume if last_order was delivered in this trip, it's a candidate for return.
      AND c.tenant_id = public.get_my_tenant_id();
END;
$$;

-- 2. LOGIC: Update process_trip_returns
-- New signature: accepts explicit items array
-- Input: p_trip_id, p_returned_items JSONB
-- JSON Structure: [{ "id": "uuid", "status": "empty" | "full" | "defective" }]
DROP FUNCTION IF EXISTS process_trip_returns(uuid);

CREATE OR REPLACE FUNCTION process_trip_returns(
    p_trip_id UUID,
    p_returned_items JSONB
)
RETURNS JSONB
LANGUAGE plpgsql

AS $$
DECLARE
    v_item JSONB;
    v_cylinder_id UUID;
    v_new_status TEXT;
    v_count INT := 0;
BEGIN
    -- Loop through the returned items
    FOR v_item IN SELECT * FROM jsonb_array_elements(p_returned_items)
    LOOP
        v_cylinder_id := (v_item->>'id')::UUID;
        v_new_status := v_item->>'status';
        
        -- Validate Status
        IF v_new_status NOT IN ('empty', 'full', 'defective') THEN
            v_new_status := 'empty'; -- Default fallback
        END IF;

        -- Update Cylinder
        -- Logic: Move to 'godown' (warehouse) and set status
        UPDATE cylinders
        SET 
            current_location_type = 'godown',
            status = v_new_status,
            updated_at = NOW()
        WHERE id = v_cylinder_id
          AND tenant_id = public.get_my_tenant_id(); -- Security Check
        
        IF FOUND THEN
            v_count := v_count + 1;
        END IF;
    END LOOP;

    -- Mark Trip as Verified
    UPDATE trips 
    SET returns_verified = true 
    WHERE id = p_trip_id
      AND tenant_id = public.get_my_tenant_id();

    RETURN jsonb_build_object(
        'success', true,
        'trip_id', p_trip_id,
        'cylinders_processed', v_count
    );
EXCEPTION WHEN OTHERS THEN
    RETURN jsonb_build_object('success', false, 'message', SQLERRM);
END;
$$;

-- 3. LOGIC: Add verification_status to company_ledger
ALTER TABLE company_ledger 
ADD COLUMN IF NOT EXISTS verification_status TEXT DEFAULT 'pending' 
CHECK (verification_status IN ('pending', 'verified', 'rejected'));

-- Update existing rows to 'verified' to avoid breaking UI for old data
UPDATE company_ledger SET verification_status = 'verified' WHERE verification_status = 'pending';

-- 4. LOGIC: Update handle_new_user to capture vehicle_number
CREATE OR REPLACE FUNCTION handle_new_user()
RETURNS TRIGGER AS $$
DECLARE
    v_public_user_id UUID;
    v_tenant_id UUID;
    v_full_name TEXT;
    v_role TEXT;
    v_vehicle_number TEXT;
BEGIN
    -- Extract Metadata safely
    v_tenant_id := (new.raw_user_meta_data->>'tenant_id')::uuid;
    v_full_name := COALESCE(new.raw_user_meta_data->>'full_name', new.raw_user_meta_data->>'name', 'New User');
    v_role := COALESCE(new.raw_user_meta_data->>'role', 'driver');
    v_vehicle_number := new.raw_user_meta_data->>'vehicle_number';

    -- 1. Insert/Link Public User
    -- We try to find a public user by EMAIL. 
    -- If found, we UPDATE the auth_id to link them.
    -- If not found, we INSERT a new one.
    INSERT INTO public.users (
        email, 
        name, 
        role, 
        tenant_id, 
        auth_id,
        phone_number -- Sync phone if available
    )
    VALUES (
        new.email,
        v_full_name,
        v_role,
        v_tenant_id,
        new.id,
        new.raw_user_meta_data->>'phone_number'
    )
    ON CONFLICT (email) DO UPDATE SET 
        auth_id = new.id,          -- CRITICAL: Repair the link
        updated_at = NOW()
    RETURNING id INTO v_public_user_id;

    -- 2. Create Profile
    -- Uses the v_public_user_id (which satisfies the FK to public.users)
    INSERT INTO public.profiles (id, full_name, role, tenant_id, phone_number, vehicle_number)
    VALUES (
        v_public_user_id,
        v_full_name,
        v_role,
        v_tenant_id,
        new.raw_user_meta_data->>'phone_number',
        v_vehicle_number
    )
    ON CONFLICT (id) DO UPDATE SET
        vehicle_number = EXCLUDED.vehicle_number; -- Update if exists

    -- 3. Create Wallet
    -- Also uses v_public_user_id
    INSERT INTO public.employee_wallets (user_id, balance, tenant_id)
    VALUES (
        v_public_user_id,
        0,
        v_tenant_id
    )
    ON CONFLICT (user_id) DO NOTHING;

    RETURN new;
END;
$$ LANGUAGE plpgsql;
</file>

</files>
